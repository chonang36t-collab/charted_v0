{% extends 'base.html' %}
{% block content %}
<h3>Dashboard</h3>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <label class="form-label">Locations</label>
    <select id="locations" class="form-select" multiple></select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Clients</label>
    <input id="clients_input" list="clientsList" class="form-control" placeholder="Start typing to search...">
    <datalist id="clientsList"></datalist>
    <div id="clients_chips" class="d-flex flex-wrap gap-2 mt-2"></div>
  </div>
  <div class="col-md-3">
    <label class="form-label">Start date</label>
    <input type="date" id="start" class="form-control">
  </div>
  <div class="col-md-3">
    <label class="form-label">End date</label>
    <input type="date" id="end" class="form-control">
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card text-bg-light"><div class="card-body"><h5>Total Pay</h5><h3 id="kpi-totalpay">0</h3></div></div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-light"><div class="card-body"><h5>Paid Hours</h5><h3 id="kpi-hours">0</h3></div></div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-light"><div class="card-body"><h5>Avg Hour Rate</h5><h3 id="kpi-avgrate">0</h3></div></div>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-12">
    <h5 class="mb-2">Time Series: Total Pay, Client Net, Paid Hours</h5>
    <div id="ts" style="height:380px;"></div>
  </div>
  </div>
<div class="row g-3 mt-3">
  <div class="col-md-6">
    <h5 class="mb-2">Top Clients by Total Pay</h5>
    <div id="top_clients" style="height:360px;"></div>
  </div>
  <div class="col-md-6">
    <h5 class="mb-2">Top Locations by Total Pay</h5>
    <div id="top_locations" style="height:360px;"></div>
  </div>
  </div>

<script>
async function fetchData() {
  const params = new URLSearchParams();
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  // Append all selected clients
  const locations = Array.from(document.getElementById('locations').selectedOptions).map(o=>o.value);
  if (start) params.append('start', start);
  if (end) params.append('end', end);
  for (const c of selectedClients) params.append('clients', c);
  for (const l of locations) params.append('locations', l);
  const res = await fetch('/api/metrics?' + params.toString());
  return await res.json();
}

const fmtCurrency = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 2 });
const fmtNumber = new Intl.NumberFormat('en-GB');
// Unique RGB colors per item based on label hashing
function hslToRgbString(h, s, l){
  s/=100; l/=100;
  const k = n => (n + h/30) % 12;
  const a = s * Math.min(l, 1 - l);
  const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n), 1)));
  const r = Math.round(255 * f(0));
  const g = Math.round(255 * f(8));
  const b = Math.round(255 * f(4));
  return `rgb(${r}, ${g}, ${b})`;
}
function hashToHue(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))>>>0; } return h % 360; }
function colorForLabel(label, s=70, l=55){ return hslToRgbString(hashToHue(String(label)), s, l); }
function colorsFromLabels(labels){ return labels.map(l => colorForLabel(l)); }

async function refresh() {
  const data = await fetchData();
  // KPIs
  document.getElementById('kpi-totalpay').innerText = fmtCurrency.format(data.kpis.total_pay);
  document.getElementById('kpi-hours').innerText = fmtNumber.format(data.kpis.paid_hours);
  document.getElementById('kpi-avgrate').innerText = fmtCurrency.format(data.kpis.avg_hour_rate);

  // Filters values
  const clientInput = document.getElementById('clients_input');
  const clientList = document.getElementById('clientsList');
  const locSel = document.getElementById('locations');
  if (clientList.options.length === 0) {
    for (const c of data.filters.clients) {
      const opt = document.createElement('option'); opt.value=c; clientList.appendChild(opt);
    }
  }
  if (locSel.options.length === 0) {
    for (const l of data.filters.locations) {
      const opt = document.createElement('option'); opt.value=l; opt.textContent=l; locSel.appendChild(opt);
    }
  }

  // Time series
  Plotly.newPlot('ts', [
    {x:data.timeseries.x, y:data.timeseries.total_pay, name:'Total Pay', type:'scatter', line:{color: colorForLabel('Total Pay'), width:2.5}, hovertemplate:'£%{y:,.2f}<extra>%{x}</extra>'},
    {x:data.timeseries.x, y:data.timeseries.client_net, name:'Client Net', type:'scatter', line:{color: colorForLabel('Client Net'), width:2.5}, hovertemplate:'£%{y:,.2f}<extra>%{x}</extra>'},
    {x:data.timeseries.x, y:data.timeseries.paid_hours, name:'Paid Hours', type:'scatter', yaxis:'y2', line:{color: colorForLabel('Paid Hours'), width:2.5, dash:'dash'}, hovertemplate:'%{y:,.2f} h<extra>%{x}</extra>'}
  ], {title:'Time Series: Total Pay, Client Net, Paid Hours', margin:{t:40}, legend:{orientation:'h'}, yaxis:{tickprefix:'£', hoverformat:',.2f', title:'GBP'}, yaxis2:{overlaying:'y', side:'right', title:'Hours'}});

  // Top clients
  Plotly.newPlot('top_clients', [{x:data.top_clients.labels, y:data.top_clients.values, type:'bar', marker:{color: colorsFromLabels(data.top_clients.labels)}, hovertemplate:'%{x}<br>£%{y:,.2f}<extra></extra>'}], {title:'Top Clients by Total Pay', margin:{t:40}, xaxis:{automargin:true}, yaxis:{tickprefix:'£', hoverformat:',.2f', title:'GBP'}});

  // Top locations
  Plotly.newPlot('top_locations', [{x:data.top_locations.labels, y:data.top_locations.values, type:'bar', marker:{color: colorsFromLabels(data.top_locations.labels)}, hovertemplate:'%{x}<br>£%{y:,.2f}<extra></extra>'}], {title:'Top Locations by Total Pay', margin:{t:40}, xaxis:{automargin:true}, yaxis:{tickprefix:'£', hoverformat:',.2f', title:'GBP'}});
}

// --- Clients multi-select chips ---
let selectedClients = [];
function renderClientChips(){
  const box = document.getElementById('clients_chips');
  box.innerHTML = '';
  selectedClients.forEach(cl => {
    const chip = document.createElement('span');
    chip.className = 'badge rounded-pill text-bg-primary';
    chip.textContent = cl + ' ';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-light ms-1 py-0 px-1';
    btn.textContent = '×';
    btn.title = 'Remove';
    btn.addEventListener('click', () => { selectedClients = selectedClients.filter(x=>x!==cl); renderClientChips(); refresh(); });
    chip.appendChild(btn);
    box.appendChild(chip);
  });
}
function addClient(value){
  const v = (value||'').trim();
  if (!v) return;
  if (!selectedClients.includes(v)){
    selectedClients.push(v);
    renderClientChips();
    refresh();
  }
}

document.getElementById('clients_input').addEventListener('change', (e)=>{
  addClient(e.target.value);
  e.target.value = '';
});

['start','end','locations'].forEach(id=>{
  document.getElementById(id).addEventListener('change', refresh);
});

refresh();
</script>
{% endblock %}
