import{c as os,h as cs,r as o,U as ds,p as hs,j as e,v as us,P as oe,q as xe,w as ms,e as ye,B as z,I as ke,L as xs,y as k,ab as gs,u as vs,d as js,a3 as fs,a4 as ps,a5 as ys,a6 as bs,a7 as Ns,a8 as Ss,a9 as Cs,aa as Ts,A as re}from"./index-TOsQvIUj.js";import{D as Rs}from"./DashboardLayout-BOaTVYZ3.js";import{C as w,d as M,a as ie,b as le}from"./card-BkXDOWoK.js";import{c as Ee,R as As,I as Ls,P as Ds}from"./index-BQEw4tkr.js";import{D as ks}from"./DashboardHeader-BUEHzGjr.js";import{u as ws,O as Ms,T as Es}from"./TargetPerformanceChart-DkqJED40.js";import{u as Fs,L as Ps,R as $s}from"./LoadingOverlay-DEynTb0g.js";import{R as be,C as Fe,X as Pe,Y as $e,T as Ne,B as Ie,a as Se,L as Is}from"./generateCategoricalChart-DKGmDqXn.js";import{B as Oe}from"./BarChart-DP4T3el9.js";import{P as Os,a as Bs}from"./PieChart-BdqtZ-lD.js";import{T as je,a as fe,b as B,c as N,d as pe,e as b,f as _s}from"./table-Chy-LvoV.js";import{P as Vs}from"./pen-B0UzXS5N.js";import{T as zs}from"./trash-2-gZhLqwXI.js";import{D as Hs,b as Gs,c as Ks,d as Us,f as Ys,e as qs}from"./dialog-B_oOeglG.js";import{L as $}from"./label-Zyd1usDD.js";import{S as U,a as Y,b as q,c as J,d as V}from"./select-ov5oIKLf.js";import{u as Js}from"./useRecords-CMzJ0k9d.js";import{f as D}from"./popover-CuEre14U.js";import"./users-BmK4y1FD.js";import"./locationUtils--M_SVaRa.js";import"./index-QAMDYcWw.js";import"./AreaChart-Bj_0QoYl.js";import"./useQuery-BfzuJ8fS.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ws=os("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var ce="Tabs",[Xs,wt]=cs(ce,[Ee]),Be=Ee(),[Qs,Ce]=Xs(ce),_e=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:i,onValueChange:c,defaultValue:d,orientation:m="horizontal",dir:f,activationMode:u="automatic",...y}=t,h=ds(f),[v,j]=hs({prop:i,onChange:c,defaultProp:d??"",caller:ce});return e.jsx(Qs,{scope:s,baseId:us(),value:v,onValueChange:j,orientation:m,dir:h,activationMode:u,children:e.jsx(oe.div,{dir:h,"data-orientation":m,...y,ref:a})})});_e.displayName=ce;var Ve="TabsList",ze=o.forwardRef((t,a)=>{const{__scopeTabs:s,loop:i=!0,...c}=t,d=Ce(Ve,s),m=Be(s);return e.jsx(As,{asChild:!0,...m,orientation:d.orientation,dir:d.dir,loop:i,children:e.jsx(oe.div,{role:"tablist","aria-orientation":d.orientation,...c,ref:a})})});ze.displayName=Ve;var He="TabsTrigger",Ge=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:i,disabled:c=!1,...d}=t,m=Ce(He,s),f=Be(s),u=Ye(m.baseId,i),y=qe(m.baseId,i),h=i===m.value;return e.jsx(Ls,{asChild:!0,...f,focusable:!c,active:h,children:e.jsx(oe.button,{type:"button",role:"tab","aria-selected":h,"aria-controls":y,"data-state":h?"active":"inactive","data-disabled":c?"":void 0,disabled:c,id:u,...d,ref:a,onMouseDown:xe(t.onMouseDown,v=>{!c&&v.button===0&&v.ctrlKey===!1?m.onValueChange(i):v.preventDefault()}),onKeyDown:xe(t.onKeyDown,v=>{[" ","Enter"].includes(v.key)&&m.onValueChange(i)}),onFocus:xe(t.onFocus,()=>{const v=m.activationMode!=="manual";!h&&!c&&v&&m.onValueChange(i)})})})});Ge.displayName=He;var Ke="TabsContent",Ue=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:i,forceMount:c,children:d,...m}=t,f=Ce(Ke,s),u=Ye(f.baseId,i),y=qe(f.baseId,i),h=i===f.value,v=o.useRef(h);return o.useEffect(()=>{const j=requestAnimationFrame(()=>v.current=!1);return()=>cancelAnimationFrame(j)},[]),e.jsx(ms,{present:c||h,children:({present:j})=>e.jsx(oe.div,{"data-state":h?"active":"inactive","data-orientation":f.orientation,role:"tabpanel","aria-labelledby":u,hidden:!j,id:y,tabIndex:0,...m,ref:a,style:{...t.style,animationDuration:v.current?"0s":void 0},children:j&&d})})});Ue.displayName=Ke;function Ye(t,a){return`${t}-trigger-${a}`}function qe(t,a){return`${t}-content-${a}`}var Zs=_e,Je=ze,We=Ge,Xe=Ue;const et=Zs,Qe=o.forwardRef(({className:t,...a},s)=>e.jsx(Je,{ref:s,className:ye("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));Qe.displayName=Je.displayName;const I=o.forwardRef(({className:t,...a},s)=>e.jsx(We,{ref:s,className:ye("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));I.displayName=We.displayName;const O=o.forwardRef(({className:t,...a},s)=>e.jsx(Xe,{ref:s,className:ye("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));O.displayName=Xe.displayName;const st=({active:t,payload:a,label:s,metric:i})=>{if(t&&a&&a.length){const c=["clients","employees","shifts","hours"].includes(i),d=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:c?d.toLocaleString():d.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},ge=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(w,{children:e.jsx(M,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(Oe,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(Fe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(Pe,{type:"number",hide:!0}),e.jsx($e,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(Ne,{content:e.jsx(st,{metric:a})}),e.jsx(Ie,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((i,c)=>e.jsx(Se,{fill:"hsl(var(--primary))",fillOpacity:.8+c*.05},`cell-${c}`))})]})})})})}),we=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],tt=({active:t,payload:a})=>t&&a&&a.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]}):null,ne=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(w,{children:e.jsx(M,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((d,m)=>m.value-d.value),i=s.reduce((d,m)=>d+m.value,0),c=s.map(d=>({...d,percentage:i>0?d.value/i*100:0}));return e.jsx(w,{children:e.jsx(M,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(Os,{children:[e.jsx(Bs,{data:c,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:c.map((d,m)=>e.jsx(Se,{fill:we[m%we.length]},`cell-${m}`))}),e.jsx(Ne,{content:e.jsx(tt,{})}),e.jsx(Is,{})]})})})})})},at=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(w,{children:[e.jsx(ie,{children:e.jsx(le,{children:"Overheads Details"})}),e.jsx(M,{children:e.jsxs(je,{children:[e.jsx(fe,{children:e.jsxs(B,{children:[e.jsx(N,{children:"Title"}),e.jsx(N,{children:"Month"}),e.jsx(N,{children:"Location"}),e.jsx(N,{children:"Site"}),e.jsx(N,{className:"text-right",children:"Amount"}),e.jsx(N,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(pe,{children:t.map(i=>e.jsxs(B,{children:[e.jsx(b,{className:"font-medium",children:i.name}),e.jsxs(b,{children:[i.month," ",i.year]}),e.jsx(b,{children:i.location||"-"}),e.jsx(b,{children:i.site||"-"}),e.jsx(b,{className:"text-right",children:i.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(i),children:e.jsx(Vs,{className:"h-4 w-4"})}),e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(i.id),children:e.jsx(zs,{className:"h-4 w-4"})})]})})]},i.id))})]})})]}),rt=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},nt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},it=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const i=rt(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:i}});return e.jsxs(w,{children:[e.jsxs(ie,{children:[e.jsx(le,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(M,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(Oe,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(Fe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(Pe,{type:"number",hide:!0}),e.jsx($e,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(Ne,{content:e.jsx(nt,{})}),a.map((s,i)=>s.clients.map((c,d)=>e.jsx(Ie,{dataKey:()=>c.revenue,stackId:i,fill:s.colors[d],radius:d===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((m,f)=>{const u=f===i;return e.jsx(Se,{fill:u?s.colors[d]:"transparent",stroke:u?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:y=>{u&&(y.target.style.opacity="0.8")},onMouseLeave:y=>{u&&(y.target.style.opacity="1")}},`cell-${i}-${d}-${f}`)})},`${i}-${d}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,i)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((c,d)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[d]}}),e.jsx("span",{className:"truncate",title:`${c.name}: £${c.revenue.toLocaleString()}`,children:c.name})]},d))})]},i))})]})]})},ve=["January","February","March","April","May","June","July","August","September","October","November","December"],Me=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],lt=({open:t,onOpenChange:a,initialData:s,onSave:i})=>{var Z,ee;const{data:c}=Js(),[d,m]=o.useState(!1),[f,u]=o.useState(new Date().getFullYear()),[y,h]=o.useState(ve[new Date().getMonth()]),[v,j]=o.useState(""),[W,S]=o.useState(""),[E,F]=o.useState(""),[X,C]=o.useState(""),[P,H]=o.useState("");o.useEffect(()=>{t&&(s?(u(s.year),h(s.month),j(s.location||""),S(s.site||""),H(s.value.toString()),Me.includes(s.name)?(F(s.name),C("")):(F("Custom..."),C(s.name))):(u(new Date().getFullYear()),h(ve[new Date().getMonth()]),j(""),S(""),F(""),C(""),H("")))},[t,s]);const Q=async()=>{if(!v||!E||!P){k.error("Please fill in all required fields");return}const n=E==="Custom..."?X:E;if(!n){k.error("Please specify the overhead name");return}m(!0);try{await i({id:s==null?void 0:s.id,year:f,month:y,location:v,site:W||null,name:n,value:parseFloat(P)}),a(!1)}catch(G){console.error("Failed to save overhead:",G)}finally{m(!1)}},_=((Z=c==null?void 0:c.jobs)==null?void 0:Z.filter(n=>n.location===v&&n.site).map(n=>n.site).filter((n,G,se)=>se.indexOf(n)===G))||[];return e.jsx(Hs,{open:t,onOpenChange:a,children:e.jsxs(Gs,{className:"sm:max-w-[500px]",children:[e.jsxs(Ks,{children:[e.jsx(Us,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(Ys,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Year"}),e.jsxs(U,{value:f.toString(),onValueChange:n=>u(Number(n)),children:[e.jsx(Y,{children:e.jsx(q,{})}),e.jsx(J,{children:[2024,2025,2026,2027,2028].map(n=>e.jsx(V,{value:n.toString(),children:n},n))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Month"}),e.jsxs(U,{value:y,onValueChange:h,children:[e.jsx(Y,{children:e.jsx(q,{})}),e.jsx(J,{children:ve.map(n=>e.jsx(V,{value:n,children:n},n))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Location"}),e.jsxs(U,{value:v,onValueChange:n=>{j(n),S("")},children:[e.jsx(Y,{children:e.jsx(q,{placeholder:"Select location..."})}),e.jsx(J,{children:Array.from(new Set((ee=c==null?void 0:c.jobs)==null?void 0:ee.map(n=>n.location).filter(Boolean))).map(n=>e.jsx(V,{value:n,children:n},n))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Site (Optional)"}),e.jsxs(U,{value:W,onValueChange:S,disabled:!v||_.length===0,children:[e.jsx(Y,{children:e.jsx(q,{placeholder:_.length===0?"No sites available":"Select site..."})}),e.jsxs(J,{children:[e.jsx(V,{value:"all_sites",children:"All Sites (if applicable)"}),_.map(n=>e.jsx(V,{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Category"}),e.jsxs(U,{value:E,onValueChange:F,children:[e.jsx(Y,{children:e.jsx(q,{placeholder:"Select category..."})}),e.jsx(J,{children:Me.map(n=>e.jsx(V,{value:n,children:n},n))})]})]}),E==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Custom Name"}),e.jsx(ke,{placeholder:"Enter overhead name",value:X,onChange:n=>C(n.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Value (£)"}),e.jsx(ke,{type:"number",placeholder:"0.00",value:P,onChange:n=>H(n.target.value)})]})]}),e.jsxs(qs,{children:[e.jsx(z,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(z,{onClick:Q,disabled:d,children:[d&&e.jsx(xs,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Mt=()=>{const{metricId:t}=gs(),a=vs(),{dateRange:s,setDateRange:i}=js(),[c,d]=o.useState(!1),[m,f]=o.useState(s),[u,y]=o.useState([]),[h,v]=o.useState([]),[j,W]=o.useState("trend"),[S,E]=o.useState([]),[F,X]=o.useState([]),[C,P]=o.useState([]),[H,Q]=o.useState(!1),[_,Z]=o.useState([]),[ee,n]=o.useState(!1),[G,se]=o.useState(null),[te,de]=o.useState(null),K=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),ae=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),he=t==="overheads",{operationalData:R,isLoading:Ze}=ws(s,u,h),{financialData:A,isLoading:es}=Fs(s,u,h),ss=K?es:ae?Ze:!1;console.log("MetricDetail Debug:",{metricId:t,isOperational:ae,isFinancial:K,targetsPerformanceData:_}),o.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const l=new URLSearchParams({start:D(s.from,"yyyy-MM-dd"),end:D(s.to,"yyyy-MM-dd")}),g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`${re.TARGETS_PERFORMANCE}?${l.toString()}`,{headers:g});if(x.ok){const p=await x.json();Z(p)}}catch(l){console.error("Error fetching targets performance:",l)}})()},[s,t]),o.useEffect(()=>{if(j==="trend"||!t)return;(async()=>{Q(!0);try{const l=new URLSearchParams({start:D(s.from,"yyyy-MM-dd"),end:D(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});u&&u.length>0&&u.forEach(x=>l.append("locations",x)),h&&h.length>0&&h.forEach(x=>l.append("sites",x));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(j==="details"&&he){const x=await fetch(`${re.FINANCIAL_METRICS_LIST}?${l.toString()}`,{headers:g});if(x.ok){const p=await x.json();P(p)}}else if(["location","site","client"].includes(j)){l.append("dimension",j);const x=await fetch(`${re.BREAKDOWN}?${l.toString()}`,{headers:g});if(x.ok){const p=await x.json();E(p)}}}catch(l){console.error("Error fetching breakdown:",l)}finally{Q(!1)}})()},[j,t,s,u,h]),o.useEffect(()=>{t==="clients"&&j==="revenueTier"&&(async()=>{try{const l=new URLSearchParams({start:D(s.from,"yyyy-MM-dd"),end:D(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(p=>l.append("locations",p)),h&&h.length>0&&h.forEach(p=>l.append("sites",p));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`/api/dashboard/client-revenue-tiers?${l.toString()}`,{headers:g});if(x.ok){const T=(await x.json()).tiers.map(L=>({name:L.tier,value:L.totalRevenue,clientCount:L.clientCount,avgRevenue:L.avgRevenue,clients:L.clients||[]}));X(T)}}catch(l){console.error("Error fetching revenue tiers:",l)}})()},[t,j,s,u,h]);const ts=()=>{se(null),n(!0)},as=r=>{se(r),n(!0)},rs=async()=>{if(te)try{const r=await fetch(`/api/admin/financial-metrics/${te}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(r.ok)k.success("Overhead deleted"),j==="details"&&P(l=>l.filter(g=>g.id!==te));else{const l=await r.json();k.error(l.error||"Failed to delete")}}catch(r){console.error(r),k.error("Failed to delete")}finally{de(null)}},ns=async r=>{try{const l=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(r)});if(l.ok){k.success("Overhead saved"),n(!1);const g=new URLSearchParams({start:D(s.from,"yyyy-MM-dd"),end:D(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});u&&u.forEach(T=>g.append("locations",T)),h&&h.forEach(T=>g.append("sites",T));const x={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},p=await fetch(`${re.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:x});if(p.ok){const T=await p.json();P(T)}}else{const g=await l.json();k.error(g.error||"Failed to save")}}catch(l){console.error(l),k.error("Failed to save")}},Te=r=>{switch(r){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},is=(r,l)=>{var g,x,p,T,L,Re,Ae,Le,De;if(!r)return"-";switch(l){case"revenue":return`£${((g=r.revenue)==null?void 0:g.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"cost":return`£${((x=r.cost)==null?void 0:x.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"profit":const me=r.profit??r.revenue-r.cost-(r.overheads||0);return`£${(me==null?void 0:me.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"shifts":return((p=r.totalShifts)==null?void 0:p.toLocaleString())??0;case"hours":return((T=r.paidHours)==null?void 0:T.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"clients":return((L=r.clientCount)==null?void 0:L.toLocaleString())??0;case"employees":return((Re=r.paidHours)==null?void 0:Re.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"targetAchievement":return`${((Ae=r.achievementPercentage)==null?void 0:Ae.toFixed(1))??0}%`;case"missedTargets":return`${((Le=r.achievementPercentage)==null?void 0:Le.toFixed(1))??0}%`;case"clientRate":return`£${(r.revenue/r.paidHours||0).toFixed(2)}`;case"staffRate":return`£${(r.cost/r.paidHours||0).toFixed(2)}`;case"overheads":return`£${((De=r.overheads)==null?void 0:De.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;default:return"-"}},ls=o.useMemo(()=>{if(!C||C.length===0)return[];const r=C.reduce((l,g)=>{const x=g.name||"Unknown";return l[x]||(l[x]=0),l[x]+=g.value,l},{});return Object.entries(r).map(([l,g])=>({name:l,value:g}))},[C]),ue=K?A==null?void 0:A.timeSeries:R==null?void 0:R.timeSeries;return e.jsx(Rs,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(ks,{dateRange:s,onDateRangeChange:i,calendarOpen:c,onCalendarOpenChange:d,tempDateRange:m,onTempDateRangeChange:f,selectedLocations:u,onLocationsChange:y,selectedSites:h,onSitesChange:v}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(ss||H)&&e.jsx(Ps,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(z,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(Ws,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:Te(t)})]}),e.jsxs(et,{value:j,onValueChange:W,className:"space-y-4",children:[e.jsxs(Qe,{children:[e.jsx(I,{value:"trend",children:"Trend"}),e.jsx(I,{value:"location",children:"By Location"}),e.jsx(I,{value:"site",children:"By Site"}),t==="clients"?e.jsx(I,{value:"revenueTier",children:"By Revenue Tier"}):!he&&e.jsx(I,{value:"client",children:"By Client"}),he&&e.jsx(I,{value:"details",children:"All Details"})]}),e.jsx(O,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[K&&e.jsx($s,{data:(A==null?void 0:A.timeSeries)||[],aggregationLevel:(A==null?void 0:A.aggregationLevel)||"monthly",selectedMetric:t}),ae&&t!=="missedTargets"&&e.jsx(Ms,{data:(R==null?void 0:R.timeSeries)||[],aggregationLevel:(R==null?void 0:R.aggregationLevel)||"monthly",selectedMetric:t}),t==="missedTargets"&&e.jsx(Es,{data:_}),!K&&!ae&&e.jsx(w,{children:e.jsx(M,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})}),e.jsxs(w,{children:[e.jsx(ie,{children:e.jsx(le,{children:"Historical Data"})}),e.jsx(M,{children:e.jsxs(je,{children:[e.jsxs(_s,{children:["Detailed historical data for ",Te(t)]}),e.jsx(fe,{children:e.jsxs(B,{children:[e.jsx(N,{children:"Period"}),e.jsx(N,{className:"text-right",children:"Value"})]})}),e.jsx(pe,{children:ue&&ue.length>0?[...ue].reverse().map((r,l)=>e.jsxs(B,{children:[e.jsx(b,{className:"font-medium",children:r.display}),e.jsx(b,{className:"text-right font-medium",children:is(r,t)})]},l)):e.jsx(B,{children:e.jsx(b,{colSpan:2,className:"text-center",children:"No data available"})})})]})})]})]})}),e.jsx(O,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ne,{data:S,metric:t||"revenue"})]})}),e.jsx(O,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ne,{data:S,metric:t||"revenue"})]})}),e.jsx(O,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(it,{data:F}),e.jsxs(w,{children:[e.jsx(ie,{children:e.jsx(le,{children:"Tier Breakdown"})}),e.jsx(M,{children:e.jsxs(je,{children:[e.jsx(fe,{children:e.jsxs(B,{children:[e.jsx(N,{children:"Tier"}),e.jsx(N,{className:"text-right",children:"Clients"}),e.jsx(N,{className:"text-right",children:"Total Revenue"}),e.jsx(N,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(pe,{children:F.map(r=>e.jsxs(B,{children:[e.jsx(b,{className:"font-medium",children:r.name}),e.jsx(b,{className:"text-right",children:r.clientCount}),e.jsxs(b,{className:"text-right",children:["£",r.value.toLocaleString()]}),e.jsxs(b,{className:"text-right",children:["£",r.avgRevenue.toLocaleString()]})]},r.name))})]})})]})]})}),e.jsx(O,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ne,{data:S,metric:t||"revenue"})]})}),e.jsx(O,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(ne,{data:ls,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(z,{onClick:ts,className:"gap-2",children:[e.jsx(Ds,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(at,{data:C,onEdit:as,onDelete:de}),e.jsx(lt,{open:ee,onOpenChange:n,initialData:G,onSave:ns}),e.jsx(fs,{open:!!te,onOpenChange:r=>!r&&de(null),children:e.jsxs(ps,{children:[e.jsxs(ys,{children:[e.jsx(bs,{children:"Are you sure?"}),e.jsx(Ns,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Ss,{children:[e.jsx(Cs,{children:"Cancel"}),e.jsx(Ts,{onClick:rs,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Mt as default};
