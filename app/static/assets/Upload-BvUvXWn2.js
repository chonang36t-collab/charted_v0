import{c as R,r as i,a as O,j as e,I as z,f as F,g as E,B as A,A as q}from"./index-KBKckM5-.js";import{D as V,a as $,F as H}from"./DashboardLayout-U9LvDCGx.js";import{C as c,a as d,b as n,d as o}from"./card-DvVuRYSq.js";import{L as W}from"./label-DRWnnzO0.js";import{P as G}from"./progress-dMXeb_I8.js";import"./users-DQFAguqE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=R("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=R("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function le(){const[x,j]=i.useState(null),[p,S]=i.useState(!1),[C,h]=i.useState(0),[k,Y]=i.useState({}),[u,m]=i.useState("idle"),[M,g]=i.useState(""),[r,N]=i.useState(null),y=i.useRef(null),{toast:v}=O(),B=s=>{var l;const t=(l=s.target.files)==null?void 0:l[0];t&&(t.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.type==="application/vnd.ms-excel"||t.name.endsWith(".csv")?(j(t),m("idle"),g("")):(v({title:"Invalid file type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file",variant:"destructive"}),j(null)))},I=async()=>{if(!x)return;S(!0),h(0),m("idle"),g(""),N(null);const s=new FormData;s.append("file",x);try{const t=localStorage.getItem("auth_token"),l=await fetch(q.UPLOAD,{method:"POST",body:s,headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!l.ok)throw new Error(`Upload failed: ${l.statusText}`);if(!l.body)throw new Error("No response body");const f=l.body.getReader(),T=new TextDecoder;let b="",U=!1;for(;;){const{done:P,value:_}=await f.read();if(P)break;b+=T.decode(_,{stream:!0});const D=b.split(`
`);b=D.pop()||"";for(const w of D)if(w.trim())try{const a=JSON.parse(w);if(a.status==="progress")a.progress&&h(a.progress);else if(a.status==="complete")m("success"),N(a.data),h(100),v({title:"Upload successful",description:"Your file has been uploaded and processed successfully"}),U=!0;else if(a.status==="error")throw new Error(a.message)}catch(a){if(console.error("Error parsing stream:",a),w.trim().startsWith("<"))throw new Error("Server error occurred during processing")}}if(!U&&u!=="success")throw new Error("Upload interrupted. The server may have run out of memory or timed out.")}catch(t){m("error"),g(t.message||"An unexpected error occurred"),v({title:"Upload failed",description:t.message||"An unexpected error occurred",variant:"destructive"})}finally{S(!1)}},L=s=>{if(s===0)return"0 Bytes";const t=1024,l=["Bytes","KB","MB","GB"],f=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,f)).toFixed(2))+" "+l[f]};return e.jsx(V,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Upload Data"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload your Excel or CSV files to import data into the system"})]}),e.jsxs(c,{children:[e.jsx(d,{children:e.jsxs(n,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"File Upload"]})}),e.jsxs(o,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"file-upload",children:"Select File"}),e.jsx(z,{id:"file-upload",type:"file",ref:y,onChange:B,accept:".xlsx,.xls,.csv",disabled:p}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Supported formats: Excel (.xlsx, .xls) and CSV files"})]}),x&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border rounded-lg",children:[e.jsx(H,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:x.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:L(x.size)})]})]}),p&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Uploading..."}),e.jsxs("span",{children:[C,"%"]})]}),e.jsx(G,{value:C})]}),u==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{className:"border-green-200 bg-green-50",children:[e.jsx(K,{className:"h-4 w-4 text-green-600"}),e.jsx(E,{className:"text-green-800",children:"File uploaded successfully!"})]}),r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(c,{children:[e.jsx(d,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium",children:"Rows Inserted"})}),e.jsx(o,{children:e.jsx("div",{className:"text-2xl font-bold",children:r.inserted.toLocaleString()})})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium",children:"Duplicate Rows"})}),e.jsx(o,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:r.skipped_details.filter(s=>s.reason==="Duplicate").length.toLocaleString()})})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium",children:"Skipped Rows"})}),e.jsx(o,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:r.skipped_details.filter(s=>s.reason!=="Duplicate").length.toLocaleString()})})]}),e.jsxs(c,{children:[e.jsx(d,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium",children:"Revenue Match"})}),e.jsxs(o,{children:[e.jsx("div",{className:`text-2xl font-bold ${r.verification.match?"text-green-600":"text-red-600"}`,children:r.verification.match?"MATCHED":"MISMATCH"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Excel: £",r.verification.excel_revenue.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["DB: £",r.verification.db_revenue.toLocaleString()]})]})]})]}),r.skipped_details.length>0&&e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(n,{className:"text-base",children:"Skipped Rows Details"})}),e.jsx(o,{children:e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-md",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-muted sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 font-medium",children:"Row"}),e.jsx("th",{className:"p-2 font-medium",children:"Reason"}),e.jsx("th",{className:"p-2 font-medium",children:"Details"})]})}),e.jsx("tbody",{children:r.skipped_details.map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/50",children:[e.jsx("td",{className:"p-2",children:s.row}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${s.reason==="Duplicate"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.reason})}),e.jsx("td",{className:"p-2 text-muted-foreground",children:s.details})]},t))})]})})})]})]}),e.jsx(A,{onClick:()=>{m("idle"),h(0),j(null),N(null),y.current&&(y.current.value="")},variant:"outline",className:"w-full",children:"Upload New File"})]}),u==="error"&&e.jsxs(F,{className:"border-red-200 bg-red-50",children:[e.jsx(J,{className:"h-4 w-4 text-red-600"}),e.jsx(E,{className:"text-red-800",children:M})]}),u!=="success"&&e.jsx(A,{onClick:I,disabled:p,className:"w-full",children:p?"Uploading...":"Upload File"})]})]})]}),Object.keys(k).length>0&&e.jsxs(c,{children:[e.jsx(d,{children:e.jsx(n,{children:"Required Columns"})}),e.jsx(o,{children:e.jsx("div",{className:"space-y-4",children:Object.entries(k).map(([s,t])=>e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:s}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.map(l=>e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-sm",children:l},l))})]},s))})})]})]})})}export{le as default};
