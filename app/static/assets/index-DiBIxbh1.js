import{r as c,a2 as J,j as e,B as b,I as D,X as _,y as T}from"./index-DDv7Lrbb.js";import{D as K,C as P}from"./DashboardLayout-Cw1DOnFG.js";import{C as Q,a as Y,b as U,d as W}from"./card-CcF08ii2.js";import{L as C}from"./label-DXo220xP.js";import{S as A,a as L,b as O,c as I,d as V}from"./select-CEargT7e.js";import{T as X,a as G,b as k,c as E,d as Z,e as f}from"./table-C6UEjM4Y.js";import{u as z}from"./useQuery-C36aiEPQ.js";import{u as ee,e as q}from"./useRecords-ztsJwoP4.js";import{D as se,a as ae,b as te,c as ne,d as re,f as ie}from"./dialog-qGiIEdVX.js";import{a as le,C as oe}from"./index-CdMLpSuT.js";import"./users-Bm5swaj8.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],ce=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Se=()=>{const[t,v]=c.useState(new Date().getFullYear()),[r,j]=c.useState(B[new Date().getMonth()]),[d,N]=c.useState(new Set),m=J(),{data:h}=ee(),{data:l}=z({queryKey:["admin-targets",t],queryFn:async()=>{const s=await fetch(`/api/admin/targets?year=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch targets");return s.json()}}),{data:u}=z({queryKey:["admin-financials",t],queryFn:async()=>{const s=await fetch(`/api/admin/financial-metrics?year=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch metrics");return s.json()}}),x=q({mutationFn:async s=>{const a=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!a.ok)throw new Error("Failed to save target");return a.json()},onSuccess:()=>{m.invalidateQueries({queryKey:["admin-targets"]}),T.success("Target saved")},onError:s=>T.error(s.message)}),w=q({mutationFn:async s=>{const a=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!a.ok)throw new Error("Failed to save metric");return a.json()},onSuccess:()=>{m.invalidateQueries({queryKey:["admin-financials"]}),T.success("Metric saved")},onError:s=>T.error(s.message)}),S=c.useMemo(()=>{if(!(h!=null&&h.jobs))return{};const s={};return h.jobs.forEach(a=>{a.location&&(s[a.location]||(s[a.location]=new Set),a.site&&s[a.location].add(a.site))}),s},[h]),g=s=>{const a=new Set(d);a.has(s)?a.delete(s):a.add(s),N(a)},y=(s,a)=>{var p;if(a){const i=(p=l==null?void 0:l.find(o=>o.month===r&&o.location===s&&o.site===a))==null?void 0:p.target;return i??1e3}const F=S[s]?Array.from(S[s]):[];let n=0;return F.forEach(i=>{var $;const o=($=l==null?void 0:l.find(M=>M.month===r&&M.location===s&&M.site===i))==null?void 0:$.target;n+=o??1e3}),n};return e.jsxs(K,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(Q,{className:"mb-6",children:[e.jsx(Y,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{children:"Year:"}),e.jsxs(A,{value:t.toString(),onValueChange:s=>v(Number(s)),children:[e.jsx(L,{className:"w-[100px]",children:e.jsx(O,{})}),e.jsx(I,{children:[2024,2025,2026,2027,2028].map(s=>e.jsx(V,{value:s.toString(),children:s},s))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{children:"Month:"}),e.jsxs(A,{value:r,onValueChange:j,children:[e.jsx(L,{className:"w-[120px]",children:e.jsx(O,{})}),e.jsx(I,{children:B.map(s=>e.jsx(V,{value:s,children:s},s))})]})]})]})]})}),e.jsx(W,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(k,{children:[e.jsx(E,{className:"w-[300px]",children:"Location / Site"}),e.jsx(E,{className:"w-[150px]",children:"Shift Target"}),e.jsx(E,{className:"w-[150px]",children:"Total Overheads"}),e.jsx(E,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Z,{children:Object.entries(S).map(([s,a])=>{const F=(u||[]).filter(n=>n.location===s&&n.site===null&&n.month===r&&n.year===t).reduce((n,p)=>n+p.value,0);return e.jsxs(e.Fragment,{children:[e.jsxs(k,{className:"bg-muted/30",children:[e.jsxs(f,{className:"font-medium",children:[e.jsx(b,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>g(s),children:d.has(s)?e.jsx(le,{className:"h-4 w-4"}):e.jsx(P,{className:"h-4 w-4"})}),s]}),e.jsx(f,{children:a.size===0?e.jsx(H,{value:y(s,null)||1e3,onSave:n=>x.mutate({year:t,month:r,location:s,site:null,target:n})}):e.jsx("span",{className:"text-muted-foreground font-semibold px-2",children:y(s,null).toLocaleString()})}),e.jsx(f,{children:e.jsxs("span",{className:"font-mono",children:["£",F.toLocaleString()]})}),e.jsx(f,{children:e.jsx(R,{location:s,site:null,year:t,month:r,metrics:u||[],onSave:(n,p)=>w.mutate({year:t,month:r,location:s,site:null,name:n,value:p})})})]},s),d.has(s)&&Array.from(a).map(n=>{const p=(u||[]).filter(i=>i.location===s&&i.site===n&&i.month===r&&i.year===t).reduce((i,o)=>i+o.value,0);return e.jsxs(k,{children:[e.jsx(f,{className:"pl-10 text-sm text-muted-foreground",children:n}),e.jsx(f,{children:e.jsx(H,{value:y(s,n),onSave:i=>x.mutate({year:t,month:r,location:s,site:n,target:i})})}),e.jsx(f,{children:e.jsxs("span",{className:"font-mono",children:["£",p.toLocaleString()]})}),e.jsx(f,{children:e.jsx(R,{location:s,site:n,year:t,month:r,metrics:u||[],onSave:(i,o)=>w.mutate({year:t,month:r,location:s,site:n,name:i,value:o})})})]},`${s}-${n}`)})]})})})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on Target value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Locations without sites have a default target of 1000."}),e.jsx("p",{children:'• Use "Edit Financials" to add multiple overheads per location/site.'})]})]})},R=({location:t,site:v,year:r,month:j,metrics:d,onSave:N})=>{const[m,h]=c.useState(!1),[l,u]=c.useState(""),[x,w]=c.useState(""),S=d.filter(a=>a.year===r&&a.month===j&&a.location===t&&a.site===v),[g,y]=c.useState(""),s=()=>{const a=g==="Custom..."?l:g;!a||!x||(N(a,parseFloat(x)),u(""),y(""),w(""))};return e.jsxs(se,{open:m,onOpenChange:h,children:[e.jsx(ae,{asChild:!0,children:e.jsx(b,{variant:"outline",size:"sm",children:"Edit Financials"})}),e.jsxs(te,{className:"sm:max-w-[500px]",children:[e.jsxs(ne,{children:[e.jsx(re,{children:"Manage Financials"}),e.jsxs(ie,{children:[t," ",v?` - ${v}`:""," (",j," ",r,")"]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-2 max-h-[200px] overflow-y-auto space-y-2",children:[S.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No metrics added yet."}),S.map(a=>e.jsxs("div",{className:"flex items-center justify-between bg-secondary/20 p-2 rounded",children:[e.jsx("span",{className:"text-sm font-medium",children:a.name}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-sm",children:["£",a.value.toLocaleString()]})})]},a.id))]}),e.jsxs("div",{className:"grid gap-4 border-t pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(C,{children:"Category"}),e.jsxs(A,{value:g,onValueChange:y,children:[e.jsx(L,{children:e.jsx(O,{placeholder:"Select..."})}),e.jsx(I,{children:ce.map(a=>e.jsx(V,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(C,{htmlFor:"val",children:"Value (£)"}),e.jsx(D,{id:"val",type:"number",placeholder:"0",value:x,onChange:a=>w(a.target.value)})]})]}),g==="Custom..."&&e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(C,{htmlFor:"custom-name",children:"Custom Name"}),e.jsx(D,{id:"custom-name",placeholder:"Enter overhead name...",value:l,onChange:a=>u(a.target.value)})]}),e.jsx(b,{onClick:s,disabled:!g||g==="Custom..."&&!l||!x,children:"Add Overhead"})]})]})]})]})},H=({value:t,onSave:v,prefix:r=""})=>{const[j,d]=c.useState(!1),[N,m]=c.useState(t);c.useEffect(()=>{j||m(t)},[t,j]);const h=()=>{m(t),d(!0)},l=()=>{N!==t&&v(N),d(!1)},u=()=>{d(!1),m(t)};return j?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{type:"number",value:N,onChange:x=>m(Number(x.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:l,children:e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:u,children:e.jsx(_,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:h,children:t?`${r}${t.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{Se as default};
