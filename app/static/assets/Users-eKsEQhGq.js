import{c as H,r as l,j as e,I,B as C,A as S,a as O,L as M}from"./index-qmHMotBB.js";import{D as J}from"./DashboardLayout-315UYd6d.js";import{C as V,a as q,b as G,d as K}from"./card-B0L1jahn.js";import{o as Q,s as _,e as D,a as W,b as X,u as Y,t as Z,T as ee,c as se,d as A,f as g,g as te,h as i,P as ae,i as re}from"./types-B18GnQ88.js";import{B as L}from"./badge-DvWpxlPd.js";import{L as y}from"./label-DC-A4_da.js";import{S as P,a as $,b as R,c as B,d as k}from"./select-Ym0ujYOA.js";import{D as le,a as ce,b as oe,c as ne,d as ie}from"./dialog-8gfzBFz7.js";import{S as de}from"./switch-B5Re8vxB.js";import"./users-BgvCnXLm.js";import"./index-C2daEtVZ.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=H("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),me=Q({name:_().min(2,{message:"Name must be at least 2 characters"}),email:_().email({message:"Please enter a valid email"}),role:D(["admin","manager","viewer"]),status:D(["Active","Inactive"]),password:_().refine(o=>o===""||o.length>=6,{message:"Password must be at least 6 characters"}),locations:W(_()).optional(),two_factor_enabled:X().default(!0)});function xe({open:o,onOpenChange:E,onSubmit:F,defaultValues:d={role:"viewer",status:"Active",locations:[],two_factor_enabled:!0},isEditing:n=!1}){const[x,h]=l.useState([]),[v,b]=l.useState(d.role||"viewer"),{register:N,handleSubmit:u,reset:U,setValue:m,watch:p,formState:{errors:r}}=Y({resolver:Z(me),defaultValues:d});l.useEffect(()=>{o&&(async()=>{try{const j=await fetch(`${S.USERS.replace("/users","")}/locations`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(j.ok){const s=await j.json();h(s)}}catch(j){console.error("Failed to fetch locations:",j)}})()},[o]),l.useEffect(()=>{o&&(n?d&&(U(d),b(d.role||"viewer")):(U({role:"viewer",status:"Active",name:"",email:"",password:"",locations:[],two_factor_enabled:!0}),b("viewer")))},[o,n]);const w=p("role");l.useEffect(()=>{b(w)},[w]);const T=t=>{console.log("Form submitted with data:",t),F(t),n||U()};return e.jsx(le,{open:o,onOpenChange:E,children:e.jsxs(ce,{className:"sm:max-w-[600px]",children:[e.jsx(oe,{children:e.jsx(ne,{children:n?"Edit User":"Add New User"})}),e.jsxs("form",{onSubmit:u(T),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"name",children:"Name"}),e.jsx(I,{id:"name",...N("name"),placeholder:"John Doe"}),r.name&&e.jsx("p",{className:"text-sm text-red-500",children:r.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"email",children:"Email"}),e.jsx(I,{id:"email",type:"email",...N("email"),placeholder:"john@example.com"}),r.email&&e.jsx("p",{className:"text-sm text-red-500",children:r.email.message})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"role",children:"Role"}),e.jsxs(P,{value:p("role"),onValueChange:t=>m("role",t),children:[e.jsx($,{children:e.jsx(R,{placeholder:"Select role"})}),e.jsxs(B,{children:[e.jsx(k,{value:"admin",children:"Admin"}),e.jsx(k,{value:"manager",children:"Manager"}),e.jsx(k,{value:"viewer",children:"Viewer"})]})]}),r.role&&e.jsx("p",{className:"text-sm text-red-500",children:r.role.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"status",children:"Status"}),e.jsxs(P,{value:p("status"),onValueChange:t=>m("status",t),children:[e.jsx($,{children:e.jsx(R,{placeholder:"Select status"})}),e.jsxs(B,{children:[e.jsx(k,{value:"Active",children:"Active"}),e.jsx(k,{value:"Inactive",children:"Inactive"})]})]}),r.status&&e.jsx("p",{className:"text-sm text-red-500",children:r.status.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{htmlFor:"password",children:["Password ",n&&"(leave blank to keep current)"]}),e.jsx(I,{id:"password",type:"password",...N("password"),placeholder:n?"Leave blank to keep current":"Enter password"}),r.password&&e.jsx("p",{className:"text-sm text-red-500",children:r.password.message})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md bg-muted/30",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(y,{htmlFor:"two-factor",className:"text-base font-semibold",children:"Two-Factor Authentication"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Force this user to use an Authenticator app for security."})]}),e.jsx(de,{id:"two-factor",checked:p("two_factor_enabled"),onCheckedChange:t=>m("two_factor_enabled",t)})]}),v==="manager"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Locations (select multiple)"}),e.jsx("div",{className:"border rounded-md p-3 max-h-48 overflow-y-auto space-y-2",children:x.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No locations available"}):x.map(t=>{const s=(p("locations")||[]).includes(t);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`location-${t}`,checked:s,onChange:a=>{const c=p("locations")||[];a.target.checked?m("locations",[...c,t]):m("locations",c.filter(f=>f!==t))},className:"h-4 w-4 rounded border-gray-300"}),e.jsx("label",{htmlFor:`location-${t}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:t})]},t)})}),r.locations&&e.jsx("p",{className:"text-sm text-red-500",children:r.locations.message})]}),e.jsxs(ie,{children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>E(!1),children:"Cancel"}),e.jsx(C,{type:"submit",children:n?"Update User":"Create User"})]})]})]})})}function Ue(){const[o,E]=l.useState([]),[F,d]=l.useState(!1),[n,x]=l.useState(!1),[h,v]=l.useState(null),[b,N]=l.useState(null),{toast:u}=O(),[U,m]=l.useState(!1),[p,r]=l.useState(null);l.useEffect(()=>{w(),(async()=>{var a;try{const c=await fetch(`${S.USERS.replace("/users","")}/user/profile`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(c.ok){const f=await c.json();N((a=f.id)==null?void 0:a.toString()),r(f)}}catch(c){console.error("Failed to fetch current user:",c)}})()},[]);const w=async()=>{d(!0);try{const s=await fetch(S.USERS,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(!s.ok)throw new Error("Failed to fetch users");const a=await s.json();E(a)}catch(s){console.error("Error fetching users:",s),u({title:"Error",description:"Failed to load users. Please try again later.",variant:"destructive"})}finally{d(!1)}},T=async s=>{if(confirm("Are you sure you want to delete this user?")){m(!0);try{const a=await fetch(`${S.USERS}/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(!a.ok){const c=await a.json();throw new Error(c.error||"Failed to delete user")}u({title:"Success",description:"User deleted successfully"}),w()}catch(a){u({title:"Error",description:a.message||"Failed to delete user",variant:"destructive"})}finally{m(!1)}}},t=s=>{v(s),x(!0)},j=async s=>{try{const a=h?`${S.USERS}/${h.id}`:S.USERS,f=await fetch(a,{method:h?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include",body:JSON.stringify(s)});if(!f.ok){const z=await f.json();throw new Error(z.error||"Failed to save user")}await w(),u({title:"Success",description:h?"User updated successfully":"User created successfully"}),x(!1),v(null)}catch(a){console.error("Error saving user:",a),u({title:"Error",description:a.message||"Failed to save user. Please try again.",variant:"destructive"})}};return e.jsx(J,{children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"User Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage users and their permissions"})]}),e.jsxs(C,{onClick:()=>{v(null),x(!0)},children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(V,{children:[e.jsx(q,{children:e.jsx(G,{children:"All Users"})}),e.jsx(K,{children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(g,{children:"Name"}),e.jsx(g,{children:"Email"}),e.jsx(g,{children:"Role"}),e.jsx(g,{children:"Locations"}),e.jsx(g,{children:"Status"}),e.jsx(g,{children:"Security"}),e.jsx(g,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:F?e.jsx(A,{children:e.jsx(i,{colSpan:7,className:"text-center py-8",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(M,{className:"h-6 w-6 animate-spin mr-2"}),"Loading users..."]})})}):o.length===0?e.jsx(A,{children:e.jsx(i,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:"No users found"})}):o.map(s=>e.jsxs(A,{children:[e.jsx(i,{className:"font-medium",children:s.name}),e.jsx(i,{children:s.email}),e.jsx(i,{children:e.jsx(L,{variant:s.role==="admin"?"default":"secondary",children:s.role.charAt(0).toUpperCase()+s.role.slice(1)})}),e.jsx(i,{children:s.locations&&s.locations.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.locations.map((a,c)=>e.jsx("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:a},c))}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(i,{children:e.jsx(L,{variant:s.status==="Active"?"default":"outline",children:s.status})}),e.jsx(i,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(L,{variant:s.two_factor_enabled?"default":"outline",children:["2FA: ",s.two_factor_enabled?"Enabled":"Disabled"]}),s.two_factor_enabled&&!s.two_factor_setup_complete&&e.jsx("span",{className:"text-[10px] text-amber-600 font-bold uppercase animate-pulse",children:"Setup Pending"})]})}),e.jsxs(i,{className:"text-right",children:[e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>t(s),disabled:F,children:e.jsx(ae,{className:"h-4 w-4"})}),b!==s.id.toString()&&e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>T(s.id.toString()),disabled:U,children:e.jsx(re,{className:"h-4 w-4 text-destructive"})})]})]},s.id))})]})})]}),e.jsx(xe,{open:n,onOpenChange:s=>{x(s),s||v(null)},onSubmit:j,defaultValues:h||void 0,isEditing:!!h})]})})}export{Ue as default};
