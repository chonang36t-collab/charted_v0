const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MetricPalette-CvQ_lcJj.js","assets/index-T_FCZlXq.js","assets/index-DRuvYLBY.css","assets/card-BXe0tpeY.js","assets/pound-sterling-DVTwQQuq.js","assets/users-CtluV95c.js","assets/locationUtils-C51Yjht1.js","assets/popover-CRpwizYy.js","assets/DashboardLayout-DEuGe1C7.js","assets/button-CyG16ZRo.js","assets/ChartCanvas-BmbFpqqq.js","assets/badge-S-1zzaNw.js","assets/generateCategoricalChart-BRgzUcOy.js","assets/BarChart-D0G34bbx.js","assets/Line-CyL5MA5y.js","assets/AreaChart-B9r90gIG.js"])))=>i.map(i=>d[i]);
import{r as l,j as e,P as ne,d as I,X as ie,T as le,n as ce,o as de,p as me,a as he,S as pe,_ as H}from"./index-T_FCZlXq.js";import{D as fe}from"./DashboardLayout-DEuGe1C7.js";import{L as V}from"./label-GlUTRKi_.js";import{S as xe,a as ue,b as ge,c as je,d as E}from"./select-DGgbJLRf.js";import{B}from"./button-CyG16ZRo.js";import{P as _,a as P,b as R,f as L}from"./popover-CRpwizYy.js";import{g as Y,c as Se,C as F,a as U}from"./locationUtils-C51Yjht1.js";import{C as ye,a as ve,b as Ce,c as Ne,d as we,e as be}from"./command-DNofn8MJ.js";import{C as Ae,a as De,b as Te,d as Me}from"./card-BXe0tpeY.js";import{C as Ee}from"./index-O4k-ZWSK.js";import{S as q}from"./switch-CCriByZy.js";import"./users-CtluV95c.js";import"./dialog-CH8vLRsG.js";const Le=()=>{const[t,i]=l.useState(()=>{const o=localStorage.getItem("chartBuilderState"),r={dimensions:[],metrics:[],chartType:"bar",dateRange:{from:void 0,to:void 0},customMetrics:[],chartData:[],draggedItem:void 0};if(o)try{const c=JSON.parse(o);return{...r,dimensions:c.dimensions||[],metrics:c.metrics||[],chartType:c.chartType||"bar"}}catch(c){console.error("Error parsing saved chart builder state",c)}return r});return l.useEffect(()=>{const{dimensions:o,metrics:r,chartType:c}=t;localStorage.setItem("chartBuilderState",JSON.stringify({dimensions:o,metrics:r,chartType:c}))},[t.dimensions,t.metrics,t.chartType]),{state:t,setDimensions:o=>{i(r=>({...r,dimensions:o}))},setMetrics:o=>{i(r=>({...r,metrics:o}))},setChartType:o=>{i(r=>({...r,chartType:o}))},setDateRange:o=>{i(r=>({...r,dateRange:o}))},addCustomMetric:o=>{i(r=>({...r,customMetrics:[...r.customMetrics,o]}))},setChartData:o=>{i(r=>({...r,chartData:o}))},setDraggedItem:o=>{i(r=>({...r,draggedItem:o}))}}};var Be="Separator",G="horizontal",Ie=["horizontal","vertical"],W=l.forwardRef((t,i)=>{const{decorative:d,orientation:f=G,...y}=t,h=Oe(f)?f:G,j=d?{role:"none"}:{"aria-orientation":h==="vertical"?h:void 0,role:"separator"};return e.jsx(ne.div,{"data-orientation":h,...j,...y,ref:i})});W.displayName=Be;function Oe(t){return Ie.includes(t)}var X=W;const K=l.forwardRef(({className:t,orientation:i="horizontal",decorative:d=!0,...f},y)=>e.jsx(X,{ref:y,decorative:d,orientation:i,className:I("shrink-0 bg-border",i==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",t),...f}));K.displayName=X.displayName;function b({title:t,options:i,selected:d,onChange:f,placeholder:y="Select...",isLocation:h=!1}){const[a,j]=l.useState(!1),m=r=>{d.includes(r)?f(d.filter(c=>c!==r)):f([...d,r])},o=r=>{r.stopPropagation(),f([])};return e.jsxs("div",{className:"flex flex-col gap-1.5 min-w-[180px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:t}),e.jsxs(_,{open:a,onOpenChange:j,children:[e.jsx(P,{asChild:!0,children:e.jsxs(B,{variant:"outline",role:"combobox","aria-expanded":a,className:"w-full justify-between h-9 px-3 text-sm",children:[e.jsxs("div",{className:"flex flex-wrap gap-1 items-center overflow-hidden",children:[d.length===0&&e.jsx("span",{className:"text-muted-foreground font-normal truncate",children:y}),d.length===1&&e.jsx("span",{className:"truncate",children:h?Y(d[0]):d[0]}),d.length>1&&e.jsxs("span",{className:"truncate",children:[d.length," selected"]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 opacity-50 ml-2",children:[d.length>0&&e.jsx(ie,{className:"h-3 w-3 cursor-pointer hover:opacity-100",onClick:o}),e.jsx(ye,{className:"h-3 w-3"})]})]})}),e.jsx(R,{className:"w-[200px] p-0",align:"start",children:e.jsxs(ve,{children:[e.jsx(Ce,{placeholder:`Search ${t.toLowerCase()}...`}),e.jsxs(Ne,{children:["No ",t.toLowerCase()," found."]}),e.jsx(we,{className:"max-h-64 overflow-auto",children:i.map(r=>e.jsxs(be,{value:r,onSelect:()=>m(r),children:[e.jsx(Ee,{className:I("mr-2 h-4 w-4",d.includes(r)?"opacity-100":"opacity-0")}),h?e.jsx(le,{delayDuration:300,children:e.jsxs(ce,{children:[e.jsx(de,{asChild:!0,children:e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-medium",children:Y(r)}),e.jsx("span",{className:"text-[10px] text-muted-foreground truncate opacity-70",children:r})]})}),e.jsx(me,{side:"right",children:e.jsx("p",{children:r})})]})}):r]},r))})]})})]})]})}function ke({availableFilters:t,filters:i,onFilterChange:d,orientation:f="vertical",hideSites:y=!1}){l.useMemo(()=>{if(i.locations.length===0)return t.clients;const o=t.locations.filter(c=>i.locations.includes(c.name)),r=new Set;return o.forEach(c=>{c.clients&&c.clients.forEach(w=>r.add(w))}),Array.from(r).sort()},[t,i.locations]);const h=l.useMemo(()=>{if(i.locations.length===0)return Array.from(new Set(t.locations.flatMap(c=>c.sites))).sort();const o=t.locations.filter(c=>i.locations.includes(c.name)),r=new Set;return o.forEach(c=>{c.sites.forEach(w=>r.add(w))}),Array.from(r).sort()},[t.locations,i.locations]),a=o=>{const r=t.locations.filter(p=>o.includes(p.name)),c=o.length===0?t.clients:Array.from(new Set(r.flatMap(p=>p.clients||[]))),w=o.length===0?Array.from(new Set(t.locations.flatMap(p=>p.sites))):Array.from(new Set(r.flatMap(p=>p.sites)));d({...i,locations:o,clients:i.clients.filter(p=>c.includes(p)),sites:i.sites.filter(p=>w.includes(p))})},j=o=>{d({...i,clients:o})},m=o=>{d({...i,sites:o})};return f==="horizontal"?e.jsxs("div",{className:"flex flex-wrap items-end gap-4 p-1",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground mr-2 pb-2",children:e.jsx("span",{children:"ðŸŒªï¸ Filters:"})}),e.jsx(b,{title:"Clients",options:t.clients,selected:i.clients,onChange:j,placeholder:"All Clients"}),e.jsx(b,{title:"Locations",options:t.locations.map(o=>o.name),selected:i.locations,onChange:a,placeholder:"All Locations",isLocation:!0}),!y&&e.jsx(b,{title:"Sites",options:h,selected:i.sites,onChange:m,placeholder:"All Sites"})]}):e.jsxs(Ae,{className:"h-full flex flex-col",children:[e.jsx(De,{className:"pb-3",children:e.jsx(Te,{className:"text-lg flex items-center gap-2",children:"ðŸŒªï¸ Filters"})}),e.jsxs(Me,{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsx(b,{title:"Clients",options:t.clients,selected:i.clients,onChange:j,placeholder:"All Clients"}),e.jsx(K,{}),e.jsx(b,{title:"Locations",options:t.locations.map(o=>o.name),selected:i.locations,onChange:a,placeholder:"All Locations",isLocation:!0}),e.jsx(b,{title:"Sites",options:h,selected:i.sites,onChange:m,placeholder:"All Sites"})]})]})}const _e=l.lazy(()=>H(()=>import("./MetricPalette-CvQ_lcJj.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),A=l.lazy(()=>H(()=>import("./ChartCanvas-BmbFpqqq.js"),__vite__mapDeps([10,1,2,11,12,13,14,15])));function Xe(){const{state:t,setDimensions:i,setMetrics:d,setChartType:f,setDateRange:y}=Le(),{toast:h}=he(),[a,j]=l.useState(()=>{const s=localStorage.getItem("chartBuilderDate");if(s)try{const n=JSON.parse(s);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return{from:new Date,to:Se(new Date,30)}}),[m,o]=l.useState(()=>{const s=localStorage.getItem("chartBuilderAppliedDate");if(s)try{const n=JSON.parse(s);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return a});l.useEffect(()=>{a&&localStorage.setItem("chartBuilderDate",JSON.stringify(a))},[a]),l.useEffect(()=>{m&&localStorage.setItem("chartBuilderAppliedDate",JSON.stringify(m))},[m]);const[r,c]=l.useState(!1),[w,p]=l.useState(!1),[N,z]=l.useState(()=>localStorage.getItem("chartBuilderSplitByLocation")==="true"),[v,O]=l.useState(()=>localStorage.getItem("chartBuilderSplitBySite")==="true"&&!N);l.useEffect(()=>{localStorage.setItem("chartBuilderSplitByLocation",String(N))},[N]),l.useEffect(()=>{localStorage.setItem("chartBuilderSplitBySite",String(v))},[v]);const[D,Q]=l.useState({clients:[],locations:[]}),[u,Z]=l.useState({clients:[],locations:[],sites:[]});l.useEffect(()=>{(async()=>{try{const n=await fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(n.ok){const x=await n.json();Q(x)}}catch(n){console.error("Error fetching filters:",n)}})()},[]);const ee=()=>{o(a)},[C,T]=l.useState([]),[te,M]=l.useState([]);l.useEffect(()=>{(async()=>{var $;if(t.dimensions.length===0||t.metrics.length===0||!(m!=null&&m.from)||!(m!=null&&m.to)){T([]),M([]);return}const n=t.dimensions[0],x=t.metrics,re=L(m.from,"yyyy-MM-dd"),oe=L(m.to,"yyyy-MM-dd");try{const g=new URLSearchParams;g.append("start",re),g.append("end",oe),g.append("dimension",n),x.forEach(S=>g.append("metrics",S)),u.clients.forEach(S=>g.append("clients",S)),u.locations.forEach(S=>g.append("locations",S)),u.sites.forEach(S=>g.append("sites",S)),N&&g.append("split_by_location","true"),v&&g.append("split_by_site","true");const J=await fetch(`/api/chart-data?${g.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(J.ok){const S=await J.json();T(S.data||[]),M((($=S.summary)==null?void 0:$.topClients)||[])}else console.error("Failed to fetch chart data"),T([]),M([])}catch(g){console.error("Error fetching chart data:",g),T([]),M([])}})()},[t.dimensions,t.metrics,m,u,N,v]);const{showSiteFilter:se,showSiteSplit:k}=l.useMemo(()=>{const s=u.locations.length===0?D.locations.flatMap(x=>x.sites):D.locations.filter(x=>u.locations.includes(x.name)).flatMap(x=>x.sites),n=Array.from(new Set(s));return{showSiteFilter:n.length>1,showSiteSplit:n.length>1}},[D.locations,u.locations]);l.useEffect(()=>{!k&&v&&O(!1)},[k,v]);const ae=s=>{s.type==="dimension"?t.dimensions.includes(s.name)?(i([]),h({description:`Removed ${s.name} from chart`,duration:2e3})):(i([s.name]),h({description:`Added ${s.name} to chart`,duration:2e3})):s.type==="metric"&&(t.metrics.includes(s.name)?(d(t.metrics.filter(n=>n!==s.name)),h({description:`Removed ${s.name} from chart`,duration:2e3})):(d([...t.metrics,s.name]),h({description:`Added ${s.name} to chart`,duration:2e3})))};return e.jsx(fe,{noPadding:!0,fullWidth:!0,children:e.jsx("div",{className:"p-2 md:p-3 h-full flex flex-col",children:e.jsxs("div",{className:"space-y-4 h-full flex flex-col",children:[e.jsx("div",{className:"sticky lg:top-0 z-30 pb-2 border-b -mx-4 md:-mx-6 px-4 md:px-6 pt-1 shadow-sm bg-background",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-xl font-bold",children:"Chart Builder"})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"w-32",children:e.jsxs(xe,{value:t.chartType,onValueChange:f,children:[e.jsx(ue,{className:"h-8 text-xs",children:e.jsx(ge,{placeholder:"Chart Type"})}),e.jsxs(je,{children:[e.jsx(E,{value:"bar",children:"Bar Chart"}),e.jsx(E,{value:"line",children:"Line Chart"}),e.jsx(E,{value:"area",children:"Area Chart"}),e.jsx(E,{value:"pie",children:"Pie Chart"})]})]})}),e.jsxs("div",{className:"flex items-center gap-6 px-2 border-l ml-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{id:"split-location",checked:N,onCheckedChange:s=>{z(s),s&&O(!1)}}),e.jsx(V,{htmlFor:"split-location",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Location"})]}),k&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{id:"split-site",checked:v,onCheckedChange:s=>{O(s),s&&z(!1)}}),e.jsx(V,{htmlFor:"split-site",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Site"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{open:r,onOpenChange:c,children:[e.jsx(P,{asChild:!0,children:e.jsxs(B,{variant:"outline",className:I("w-32 justify-start text-left font-normal h-8 text-xs",!(a!=null&&a.from)&&"text-muted-foreground"),children:[e.jsx(F,{className:"mr-2 h-3 w-3"}),a!=null&&a.from?L(a.from,"MMM dd, y"):e.jsx("span",{children:"From"})]})}),e.jsx(R,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:a==null?void 0:a.from,onSelect:s=>{j(n=>({...n,from:s})),c(!1)},defaultMonth:a==null?void 0:a.from,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsxs(_,{open:w,onOpenChange:p,children:[e.jsx(P,{asChild:!0,children:e.jsxs(B,{variant:"outline",className:I("w-32 justify-start text-left font-normal h-8 text-xs",!(a!=null&&a.to)&&"text-muted-foreground"),children:[e.jsx(F,{className:"mr-2 h-3 w-3"}),a!=null&&a.to?L(a.to,"MMM dd, y"):e.jsx("span",{children:"To"})]})}),e.jsx(R,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:a==null?void 0:a.to,onSelect:s=>{j(n=>({...n,to:s})),p(!1)},defaultMonth:a==null?void 0:a.to,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsx(B,{onClick:ee,className:"h-8 text-xs px-4",disabled:!(a!=null&&a.from)||!(a!=null&&a.to),children:"Apply Range"})]})]})]})}),e.jsx(l.Suspense,{fallback:e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(pe,{className:"h-8 w-8 rounded-full"})}),children:e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row gap-2 min-h-0 h-full",children:[e.jsx("div",{className:"lg:w-72 shrink-0 h-full flex flex-col overflow-hidden",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2",children:e.jsx(_e,{selectedDimensions:t.dimensions,selectedMetrics:t.metrics,onItemClick:ae})})}),e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"shrink-0 pb-2 border-b mb-2",children:e.jsx(ke,{availableFilters:D,filters:u,onFilterChange:Z,orientation:"horizontal",hideSites:!se})}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2 custom-scrollbar",children:[!N&&!v&&e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 h-full min-h-[500px]",children:e.jsx(A,{chartData:C,chartType:t.chartType,metrics:t.metrics,title:"Aggregated View",topClients:te})}),N&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[u.locations.length>0?u.locations.map(s=>{const n=C.filter(x=>x.location===s);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(A,{chartData:n,chartType:t.chartType,metrics:t.metrics,title:s,isCompact:!0})},s)}):Array.from(new Set(C.map(s=>s.location).filter(Boolean))).map(s=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(A,{chartData:C.filter(n=>n.location===s),chartType:t.chartType,metrics:t.metrics,title:s,isCompact:!0})},s)),C.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected locations"})]}),v&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[u.sites.length>0?u.sites.map(s=>{const n=C.filter(x=>x.site===s);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(A,{chartData:n,chartType:t.chartType,metrics:t.metrics,title:s,isCompact:!0})},s)}):Array.from(new Set(C.map(s=>s.site).filter(Boolean))).map(s=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(A,{chartData:C.filter(n=>n.site===s),chartType:t.chartType,metrics:t.metrics,title:s,isCompact:!0})},s)),C.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected sites"})]})]})]})]})})]})})})}export{Xe as default};
