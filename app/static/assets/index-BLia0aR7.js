import{e as de,z as se,A,r as n,j as e,L as F,B as R,I as g,E as h}from"./index-CDroaHSZ.js";import{D as he}from"./DashboardLayout-CJVeL389.js";import{u as ue,a as ae,P as me}from"./useMutation-B1lU8FZI.js";import{T as H,a as Q,b as u,c as j,d as G,e as o}from"./table-DaQqwPBn.js";import{S as T,a as b,b as N,c as C,d as m}from"./select-DAl1v6q6.js";import{T as xe,a as ge,b as K,c as Y}from"./tabs-BPYIsFCl.js";import{C as J,a as U,b as W,c as X,d as Z}from"./card-J_6EM37L.js";import"./users-LrjzOdzo.js";import"./index-waWzOxJe.js";import"./index-NC-xYqE5.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=de("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),je=(r,i)=>ue({queryKey:["parameters",r,i],queryFn:async()=>{const t=new URLSearchParams;r&&t.append("month",r.toString()),i&&t.append("year",i.toString());const[p,x]=await Promise.all([fetch(`${A.PARAMETERS}/targets?${t.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}),fetch(`${A.PARAMETERS}/overheads?${t.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}})]);if(!p.ok||!x.ok)throw new Error("Failed to fetch parameters");return{targets:await p.json(),overheads:await x.json()}}}),pe=()=>{const r=se();return ae({mutationFn:async i=>{const t=await fetch(`${A.PARAMETERS}/targets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(i)});if(!t.ok)throw new Error("Failed to save targets");return t.json()},onSuccess:()=>{r.invalidateQueries({queryKey:["parameters"]})}})},ve=()=>{const r=se();return ae({mutationFn:async i=>{const t=await fetch(`${A.PARAMETERS}/overheads`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(i)});if(!t.ok)throw new Error("Failed to save overheads");return t.json()},onSuccess:()=>{r.invalidateQueries({queryKey:["parameters"]})}})};function Pe(){var _;const[r,i]=n.useState(new Date().getMonth()+1),[t,p]=n.useState(new Date().getFullYear()),[x,te]=n.useState({locations:[]}),[v,L]=n.useState(new Map),[M,$]=n.useState(new Map),[f,V]=n.useState(""),[E,z]=n.useState(""),[c,B]=n.useState(""),[P,k]=n.useState(""),[S,D]=n.useState(""),{data:d,isLoading:re,refetch:fe}=je(r,t),y=pe(),O=ve();n.useEffect(()=>{fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}).then(s=>s.json()).then(s=>te(s)).catch(s=>console.error("Failed to fetch filters",s))},[]);const ne=async()=>{if(!(!c||!S))try{await y.mutateAsync([{month:r,year:t,location:c==="null"?null:c,site:P==="null"?null:P,target:parseInt(S)||0}]),h.success("Target added successfully"),B(""),k(""),D("")}catch{h.error("Failed to add target")}},le=(s,a,l)=>{const w=`${s}::${a}`;L(new Map(v.set(w,parseInt(l)||0)))},oe=(s,a)=>{const l=s;$(new Map(M.set(l,parseFloat(a)||0)))},ie=async()=>{if(v.size===0)return;const s=[];v.forEach((a,l)=>{const[w,q]=l.split("::");s.push({month:r,year:t,location:w==="null"?null:w,site:q==="null"?null:q,target:a})});try{await y.mutateAsync(s),h.success("Targets saved successfully"),L(new Map)}catch{h.error("Failed to save targets")}},ce=async()=>{const s=[];if(M.forEach((a,l)=>{s.push({month:r,year:t,category:l,amount:a})}),f&&E&&s.push({month:r,year:t,category:f,amount:parseFloat(E)||0}),s.length!==0)try{await O.mutateAsync(s),h.success("Overheads saved successfully"),$(new Map),V(""),z("")}catch{h.error("Failed to save overheads")}},I=new Map;return d==null||d.targets.forEach(s=>{var l;const a=s.location||"Global";I.has(a)||I.set(a,[]),(l=I.get(a))==null||l.push(s)}),e.jsx(he,{children:e.jsxs("div",{className:"flex flex-col gap-6 p-6 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Business Parameters"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(T,{value:r.toString(),onValueChange:s=>i(parseInt(s)),children:[e.jsx(b,{className:"w-[120px]",children:e.jsx(N,{placeholder:"Month"})}),e.jsx(C,{children:Array.from({length:12},(s,a)=>e.jsx(m,{value:(a+1).toString(),children:new Date(0,a).toLocaleString("default",{month:"long"})},a+1))})]}),e.jsxs(T,{value:t.toString(),onValueChange:s=>p(parseInt(s)),children:[e.jsx(b,{className:"w-[100px]",children:e.jsx(N,{placeholder:"Year"})}),e.jsx(C,{children:[2024,2025,2026,2027].map(s=>e.jsx(m,{value:s.toString(),children:s},s))})]})]})]}),re?e.jsx("div",{className:"flex justify-center items-center h-64 border rounded-lg bg-muted/10",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(xe,{defaultValue:"targets",children:[e.jsxs(ge,{children:[e.jsx(K,{value:"targets",children:"Shift Targets"}),e.jsx(K,{value:"overheads",children:"Monthly Overheads"})]}),e.jsx(Y,{value:"targets",children:e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Monthly Shift Targets"}),e.jsx(X,{children:"Set monthly shift goals per location or site."})]}),e.jsxs(R,{onClick:ie,disabled:v.size===0||y.isPending,children:[y.isPending?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Save Changes"]})]})}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(u,{children:[e.jsx(j,{className:"w-[300px]",children:"Location"}),e.jsx(j,{className:"w-[300px]",children:"Site"}),e.jsx(j,{children:"Target Shifts"})]})}),e.jsxs(G,{children:[d==null?void 0:d.targets.map(s=>e.jsxs(u,{children:[e.jsx(o,{children:s.location||"Global"}),e.jsx(o,{children:s.site||"All Sites"}),e.jsx(o,{children:e.jsx(g,{type:"number",defaultValue:s.target,onChange:a=>le(s.location||"null",s.site||"null",a.target.value),className:"w-32"})})]},s.id)),e.jsxs(u,{className:"bg-muted/30",children:[e.jsx(o,{children:e.jsxs(T,{value:c,onValueChange:s=>{B(s),k("null")},children:[e.jsx(b,{className:"w-full",children:e.jsx(N,{placeholder:"Select Location"})}),e.jsxs(C,{children:[e.jsx(m,{value:"null",children:"Global"}),x.locations.map(s=>e.jsx(m,{value:s.name,children:s.name},s.name))]})]})}),e.jsx(o,{children:e.jsxs(T,{value:P,onValueChange:k,disabled:!c||c==="null",children:[e.jsx(b,{className:"w-full",children:e.jsx(N,{placeholder:"Select Site (Optional)"})}),e.jsxs(C,{children:[e.jsx(m,{value:"null",children:"All Sites"}),(_=x.locations.find(s=>s.name===c))==null?void 0:_.sites.map(s=>e.jsx(m,{value:s,children:s},s))]})]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(g,{type:"number",placeholder:"0",value:S,onChange:s=>D(s.target.value),className:"w-32"}),e.jsx(R,{size:"sm",variant:"ghost",onClick:ne,disabled:!S||!c&&c!=="null",children:e.jsx(me,{className:"h-4 w-4"})})]})})]})]})]})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:'Use the bottom row to add targets for new locations/sites. Changes for existing targets must be saved using the "Save Changes" button.'})]})})]})}),e.jsx(Y,{value:"overheads",children:e.jsxs(J,{children:[e.jsxs(U,{children:[e.jsx(W,{children:"Monthly Overheads"}),e.jsx(X,{children:"Track fixed costs for the month (e.g., Rent, Software, Insurance)."})]}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(H,{children:[e.jsx(Q,{children:e.jsxs(u,{children:[e.jsx(j,{children:"Category"}),e.jsx(j,{children:"Amount (Â£)"})]})}),e.jsxs(G,{children:[d==null?void 0:d.overheads.map(s=>e.jsxs(u,{children:[e.jsx(o,{children:s.category}),e.jsx(o,{children:e.jsx(g,{type:"number",defaultValue:s.amount,onChange:a=>oe(s.category,a.target.value),className:"w-32"})})]},s.id)),e.jsxs(u,{className:"bg-muted/30",children:[e.jsx(o,{children:e.jsx(g,{placeholder:"New Category (e.g. Marketing)",value:f,onChange:s=>V(s.target.value)})}),e.jsx(o,{children:e.jsx(g,{type:"number",placeholder:"0.00",value:E,onChange:s=>z(s.target.value),className:"w-32"})})]})]})]})}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsxs(R,{onClick:ce,disabled:M.size===0&&!f||O.isPending,children:[O.isPending?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Save Changes"]})})]})})]})})]})]})})}export{Pe as default};
