import{f as ye,D as R,A as y,r as h,j as e,L as z,B as S,I as p,s as u}from"./index-xBVSQyN9.js";import{D as Se}from"./DashboardLayout-D7-9ID1Z.js";import{u as Te,a as L}from"./useMutation-Ct-Th_ZS.js";import{T as X,a as Z,b as f,c as g,d as ee,e as c}from"./table-CDFEnQ71.js";import{S as M,a as O,b as $,c as k,d as w}from"./select-sDuqbd3f.js";import{T as Ne,a as be,b as te,c as ae}from"./tabs-DWaYKTar.js";import{C as se,a as re,b as ne,c as le,d as oe}from"./card-BJv0IlGP.js";import{T as ie}from"./trash-2-ChU0OHr6.js";import{P as Ce}from"./plus-C5yPFgbR.js";import"./users-DVkhtm4k.js";import"./index-CUZU75tp.js";import"./index-BeTbb22s.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=ye("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),Ae=(n,d)=>Te({queryKey:["parameters",n,d],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("month",n.toString()),d&&s.append("year",d.toString());const[T,v]=await Promise.all([fetch(`${y.PARAMETERS}/targets?${s.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}),fetch(`${y.PARAMETERS}/overheads?${s.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}})]);if(!T.ok||!v.ok)throw new Error("Failed to fetch parameters");return{targets:await T.json(),overheads:await v.json()}}}),Ee=()=>{const n=R();return L({mutationFn:async d=>{const s=await fetch(`${y.PARAMETERS}/targets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(d)});if(!s.ok)throw new Error("Failed to save targets");return s.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})},Me=()=>{const n=R();return L({mutationFn:async d=>{const s=await fetch(`${y.PARAMETERS}/overheads`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(d)});if(!s.ok)throw new Error("Failed to save overheads");return s.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})},Oe=()=>{const n=R();return L({mutationFn:async d=>{const s=await fetch(`${y.PARAMETERS}/targets/${d}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to delete target");return s.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})},$e=()=>{const n=R();return L({mutationFn:async d=>{const s=await fetch(`${y.PARAMETERS}/overheads/${d}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to delete overhead");return s.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})};function Qe(){var W;const[n,d]=h.useState(new Date().getMonth()+1),[s,T]=h.useState(new Date().getFullYear()),[v,de]=h.useState({locations:[]}),[N,B]=h.useState(new Map),[b,q]=h.useState(new Map),[C,_]=h.useState(""),[G,Q]=h.useState(""),[P,H]=h.useState(""),[o,K]=h.useState(""),[x,F]=h.useState(""),[A,Y]=h.useState(""),{data:r,isLoading:he,refetch:ke}=Ae(n,s),E=Ee(),I=Me(),ue=Oe(),me=$e(),D=()=>{var l;if(!(r!=null&&r.targets))return 0;const t=((l=r.targets.find(i=>!i.location))==null?void 0:l.target)||0,a=r.targets.filter(i=>i.location&&!i.site).reduce((i,m)=>i+m.target,0);return Math.max(0,t-a)},J=t=>{var m;if(!(r!=null&&r.targets))return 0;const a=(m=r.targets.find(j=>j.location===t&&!j.site))==null?void 0:m.target,l=a!==void 0?a:D()/(v.locations.length||1),i=r.targets.filter(j=>j.location===t&&j.site).reduce((j,we)=>j+we.target,0);return Math.max(0,l-i)};h.useEffect(()=>{fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}).then(t=>t.json()).then(t=>de(t)).catch(t=>console.error("Failed to fetch filters",t))},[]);const ge=async()=>{if(!o||!A)return;const t=parseInt(A)||0;if(o!=="null")if(x!=="null"&&x!==""){const a=J(o);if(t>a){u.error(`Value exceeds remaining Location target (${a.toLocaleString()})`);return}}else{const a=D();if(t>a){u.error(`Value exceeds remaining Global target (${a.toLocaleString()})`);return}}try{await E.mutateAsync([{month:n,year:s,location:o==="null"?null:o,site:x==="null"?null:x,target:t}]),u.success("Target added successfully"),K(""),F(""),Y("")}catch{u.error("Failed to add target")}},xe=async t=>{if(confirm("Are you sure you want to delete this target?"))try{await ue.mutateAsync(t),u.success("Target deleted")}catch{u.error("Failed to delete target")}},je=async t=>{if(confirm("Are you sure you want to delete this overhead?"))try{await me.mutateAsync(t),u.success("Overhead deleted")}catch{u.error("Failed to delete overhead")}},pe=(t,a,l)=>{const i=`${t}::${a}`;B(new Map(N.set(i,parseInt(l)||0)))},U=(t,a,l)=>{const i=b.get(t)||{},m=new Map(b);m.set(t,{...i,[a]:a==="amount"?parseFloat(l)||0:l}),q(m)},ve=async()=>{if(N.size===0)return;const t=[];N.forEach((a,l)=>{const[i,m]=l.split("::");t.push({month:n,year:s,location:i==="null"?null:i,site:m==="null"?null:m,target:a})});try{await E.mutateAsync(t),u.success("Targets saved successfully"),B(new Map)}catch{u.error("Failed to save targets")}},fe=async()=>{const t=[];if(Array.from(b.entries()).forEach(([a,l])=>{t.push({month:n,year:s,category:a,amount:l.amount,description:l.description})}),C&&P&&t.push({month:n,year:s,category:C,description:G,amount:parseFloat(P)||0}),t.length!==0)try{await I.mutateAsync(t),u.success("Overheads saved successfully"),q(new Map),_(""),Q(""),H("")}catch{u.error("Failed to save overheads")}},V=new Map;return r==null||r.targets.forEach(t=>{var l;const a=t.location||"Global";V.has(a)||V.set(a,[]),(l=V.get(a))==null||l.push(t)}),e.jsx(Se,{children:e.jsxs("div",{className:"flex flex-col gap-6 p-6 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Business Parameters"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(M,{value:n.toString(),onValueChange:t=>d(parseInt(t)),children:[e.jsx(O,{className:"w-[120px]",children:e.jsx($,{placeholder:"Month"})}),e.jsx(k,{children:Array.from({length:12},(t,a)=>e.jsx(w,{value:(a+1).toString(),children:new Date(0,a).toLocaleString("default",{month:"long"})},a+1))})]}),e.jsxs(M,{value:s.toString(),onValueChange:t=>T(parseInt(t)),children:[e.jsx(O,{className:"w-[100px]",children:e.jsx($,{placeholder:"Year"})}),e.jsx(k,{children:[2024,2025,2026,2027].map(t=>e.jsx(w,{value:t.toString(),children:t},t))})]})]})]}),he?e.jsx("div",{className:"flex justify-center items-center h-64 border rounded-lg bg-muted/10",children:e.jsx(z,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(Ne,{defaultValue:"targets",children:[e.jsxs(be,{children:[e.jsx(te,{value:"targets",children:"Shift Targets"}),e.jsx(te,{value:"overheads",children:"Monthly Overheads"})]}),e.jsx(ae,{value:"targets",children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(ne,{children:"Monthly Shift Targets"}),e.jsx(le,{children:"Set monthly shift goals per location or site."})]}),e.jsxs(S,{onClick:ve,disabled:N.size===0||E.isPending,children:[E.isPending?e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ce,{className:"mr-2 h-4 w-4"}),"Save Changes"]})]})}),e.jsx(oe,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(X,{children:[e.jsx(Z,{children:e.jsxs(f,{children:[e.jsx(g,{className:"w-[300px]",children:"Location"}),e.jsx(g,{className:"w-[300px]",children:"Site"}),e.jsx(g,{children:"Target Shifts"}),e.jsx(g,{className:"w-[50px]"})]})}),e.jsxs(ee,{children:[r==null?void 0:r.targets.map(t=>e.jsxs(f,{children:[e.jsx(c,{children:t.location||"Global"}),e.jsx(c,{children:t.site||"All Sites"}),e.jsx(c,{children:e.jsx(p,{type:"number",defaultValue:t.target,onChange:a=>pe(t.location||"null",t.site||"null",a.target.value),className:"w-32 h-8"})}),e.jsx(c,{children:e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>xe(t.id),children:e.jsx(ie,{className:"h-4 w-4"})})})]},t.id)),e.jsxs(f,{className:"bg-muted/30",children:[e.jsx(c,{children:e.jsxs(M,{value:o,onValueChange:t=>{K(t),F("null")},children:[e.jsx(O,{className:"w-full h-8",children:e.jsx($,{placeholder:"Select Location"})}),e.jsxs(k,{children:[e.jsx(w,{value:"null",children:"Global"}),v.locations.map(t=>e.jsx(w,{value:t.name,children:t.name},t.name))]})]})}),e.jsx(c,{children:e.jsxs(M,{value:x,onValueChange:F,disabled:!o||o==="null",children:[e.jsx(O,{className:"w-full h-8",children:e.jsx($,{placeholder:"Select Site (Optional)"})}),e.jsxs(k,{children:[e.jsx(w,{value:"null",children:"All Sites"}),(W=v.locations.find(t=>t.name===o))==null?void 0:W.sites.map(t=>e.jsx(w,{value:t,children:t},t))]})]})}),e.jsx(c,{colSpan:2,children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(p,{type:"number",placeholder:"0",value:A,onChange:t=>Y(t.target.value),className:"w-32 h-8"}),e.jsx(S,{size:"sm",variant:"ghost",onClick:ge,disabled:!A||!o&&o!=="null",className:"h-8 w-8 p-0",children:e.jsx(Ce,{className:"h-4 w-4"})})]}),o!=="null"&&o!==""&&e.jsx("span",{className:"text-[10px] text-muted-foreground",children:x!=="null"&&x!==""?`Remaining in ${o}: ${J(o).toLocaleString()}`:`Remaining in Global: ${D().toLocaleString()}`})]})})]})]})]})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:'Use the bottom row to add targets for new locations/sites. Changes for existing targets must be saved using the "Save Changes" button.'})]})})]})}),e.jsx(ae,{value:"overheads",children:e.jsxs(se,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Monthly Overheads"}),e.jsx(le,{children:"Track fixed costs for the month (e.g., Rent, Software, Insurance)."})]}),e.jsx(oe,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(X,{children:[e.jsx(Z,{children:e.jsxs(f,{children:[e.jsx(g,{className:"w-[200px]",children:"Category"}),e.jsx(g,{className:"w-[400px]",children:"Description"}),e.jsx(g,{children:"Amount (Â£)"}),e.jsx(g,{className:"w-[50px]"})]})}),e.jsxs(ee,{children:[r==null?void 0:r.overheads.map(t=>e.jsxs(f,{children:[e.jsx(c,{className:"font-medium",children:t.category}),e.jsx(c,{children:e.jsx(p,{defaultValue:t.description||"",placeholder:"Add details...",onChange:a=>U(t.category,"description",a.target.value),className:"h-8"})}),e.jsx(c,{children:e.jsx(p,{type:"number",defaultValue:t.amount,onChange:a=>U(t.category,"amount",a.target.value),className:"w-32 h-8"})}),e.jsx(c,{children:e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>je(t.id),children:e.jsx(ie,{className:"h-4 w-4"})})})]},t.id)),e.jsxs(f,{className:"bg-muted/30",children:[e.jsx(c,{children:e.jsx(p,{placeholder:"e.g. Rent",value:C,onChange:t=>_(t.target.value),className:"h-8"})}),e.jsx(c,{children:e.jsx(p,{placeholder:"Monthly office rent",value:G,onChange:t=>Q(t.target.value),className:"h-8"})}),e.jsx(c,{colSpan:2,children:e.jsx(p,{type:"number",placeholder:"0.00",value:P,onChange:t=>H(t.target.value),className:"w-32 h-8"})})]})]})]})}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsxs(S,{onClick:fe,disabled:b.size===0&&!C||I.isPending,children:[I.isPending?e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ce,{className:"mr-2 h-4 w-4"}),"Save Changes"]})})]})})]})})]})]})})}export{Qe as default};
