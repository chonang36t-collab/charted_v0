import{c as ps,h as vs,r as i,U as ys,p as Ns,j as e,v as bs,P as oe,q as ve,w as Ss,e as Te,B as X,I as Ie,L as Cs,y as z,ab as Ts,u as ks,d as ws,b as As,a3 as Ls,a4 as Ds,a5 as Ms,a6 as Rs,a7 as Es,a8 as $s,a9 as Fs,aa as Ps,A as ne}from"./index-BQ0Diz76.js";import{D as Is}from"./DashboardLayout-Hp9cyCcE.js";import{C as R,d as E,a as G,b as K}from"./card-Cfyz7VXX.js";import{c as ze,R as _s,I as Os}from"./index-DaEmysrH.js";import{D as Bs}from"./DashboardHeader-CJ5DtWt4.js";import{S as Ve,Z as Hs,u as zs,O as Vs,T as Ws}from"./TargetPerformanceChart-Dg2p2ToX.js";import{u as Us,L as Gs,R as Ks}from"./LoadingOverlay-C-7TVSW2.js";import{g as qs,X as le,Y as ce,f as Ys,R as de,C as ke,T as he,B as We,a as we,L as Js,b as _e,c as Oe}from"./generateCategoricalChart-qHx1dFly.js";import{B as Ue}from"./BarChart-YWhRLcxb.js";import{P as Xs,a as Zs}from"./PieChart-4UTmIZl4.js";import{T as be,a as Se,b as U,c as M,d as Ce,e as L,f as Qs}from"./table-BISYqpgp.js";import{P as et}from"./pen-C3f4uEp9.js";import{T as st}from"./trash-2-DaldRNEP.js";import{f as A}from"./popover-kTn1qIvM.js";import{D as tt,b as at,c as rt,d as nt,f as it,e as ot}from"./dialog-CdO8Durm.js";import{L as W}from"./label-Ba7EggHx.js";import{S as Z,a as Q,b as ee,c as se,d as J}from"./select-VrD022aI.js";import{u as lt}from"./useRecords-DJ0OYT_d.js";import{P as ct}from"./plus-CqZl7B88.js";import"./users-PyHRMWDc.js";import"./locationUtils-BxpFpIO6.js";import"./checkbox-Cnw5qfkv.js";import"./index-BhFb3IKQ.js";import"./AreaChart-CoGXj-r9.js";import"./useQuery-C6V7WUes.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dt=ps("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var ht=qs({chartName:"ScatterChart",GraphicalChild:Ve,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:le},{axisType:"yAxis",AxisComp:ce},{axisType:"zAxis",AxisComp:Hs}],formatAxisMap:Ys}),ue="Tabs",[ut,Jt]=vs(ue,[ze]),Ge=ze(),[mt,Ae]=ut(ue),Ke=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,onValueChange:d,defaultValue:h,orientation:x="horizontal",dir:v,activationMode:b="automatic",...u}=t,y=ys(v),[l,k]=Ns({prop:r,onChange:d,defaultProp:h??"",caller:ue});return e.jsx(mt,{scope:s,baseId:bs(),value:l,onValueChange:k,orientation:x,dir:y,activationMode:b,children:e.jsx(oe.div,{dir:y,"data-orientation":x,...u,ref:a})})});Ke.displayName=ue;var qe="TabsList",Ye=i.forwardRef((t,a)=>{const{__scopeTabs:s,loop:r=!0,...d}=t,h=Ae(qe,s),x=Ge(s);return e.jsx(_s,{asChild:!0,...x,orientation:h.orientation,dir:h.dir,loop:r,children:e.jsx(oe.div,{role:"tablist","aria-orientation":h.orientation,...d,ref:a})})});Ye.displayName=qe;var Je="TabsTrigger",Xe=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,disabled:d=!1,...h}=t,x=Ae(Je,s),v=Ge(s),b=es(x.baseId,r),u=ss(x.baseId,r),y=r===x.value;return e.jsx(Os,{asChild:!0,...v,focusable:!d,active:y,children:e.jsx(oe.button,{type:"button",role:"tab","aria-selected":y,"aria-controls":u,"data-state":y?"active":"inactive","data-disabled":d?"":void 0,disabled:d,id:b,...h,ref:a,onMouseDown:ve(t.onMouseDown,l=>{!d&&l.button===0&&l.ctrlKey===!1?x.onValueChange(r):l.preventDefault()}),onKeyDown:ve(t.onKeyDown,l=>{[" ","Enter"].includes(l.key)&&x.onValueChange(r)}),onFocus:ve(t.onFocus,()=>{const l=x.activationMode!=="manual";!y&&!d&&l&&x.onValueChange(r)})})})});Xe.displayName=Je;var Ze="TabsContent",Qe=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,forceMount:d,children:h,...x}=t,v=Ae(Ze,s),b=es(v.baseId,r),u=ss(v.baseId,r),y=r===v.value,l=i.useRef(y);return i.useEffect(()=>{const k=requestAnimationFrame(()=>l.current=!1);return()=>cancelAnimationFrame(k)},[]),e.jsx(Ss,{present:d||y,children:({present:k})=>e.jsx(oe.div,{"data-state":y?"active":"inactive","data-orientation":v.orientation,role:"tabpanel","aria-labelledby":b,hidden:!k,id:u,tabIndex:0,...x,ref:a,style:{...t.style,animationDuration:l.current?"0s":void 0},children:k&&h})})});Qe.displayName=Ze;function es(t,a){return`${t}-trigger-${a}`}function ss(t,a){return`${t}-content-${a}`}var xt=Ke,ts=Ye,as=Xe,rs=Qe;const ns=xt,Le=i.forwardRef(({className:t,...a},s)=>e.jsx(ts,{ref:s,className:Te("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));Le.displayName=ts.displayName;const _=i.forwardRef(({className:t,...a},s)=>e.jsx(as,{ref:s,className:Te("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));_.displayName=as.displayName;const O=i.forwardRef(({className:t,...a},s)=>e.jsx(rs,{ref:s,className:Te("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));O.displayName=rs.displayName;const ft=({active:t,payload:a,label:s,metric:r})=>{if(t&&a&&a.length){const d=["clients","employees","shifts","hours"].includes(r),h=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:d?h.toLocaleString():h.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},ye=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(R,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(de,{width:"100%",height:"100%",children:e.jsxs(Ue,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(ke,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(le,{type:"number",hide:!0}),e.jsx(ce,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(he,{content:e.jsx(ft,{metric:a})}),e.jsx(We,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((r,d)=>e.jsx(we,{fill:"hsl(var(--primary))",fillOpacity:.8+d*.05},`cell-${d}`))})]})})})})}),Be=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],gt=({active:t,payload:a,metric:s})=>{if(t&&a&&a.length){const r=["revenue","costs","profit","overheads"].includes(s);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:r?Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(a[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]})}return null},ie=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(R,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((h,x)=>x.value-h.value),r=s.reduce((h,x)=>h+x.value,0),d=s.map(h=>({...h,percentage:r>0?h.value/r*100:0}));return e.jsx(R,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(de,{width:"100%",height:"100%",children:e.jsxs(Xs,{children:[e.jsx(Zs,{data:d,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:d.map((h,x)=>e.jsx(we,{fill:Be[x%Be.length]},`cell-${x}`))}),e.jsx(he,{content:e.jsx(gt,{metric:a})}),e.jsx(Js,{})]})})})})})},jt=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(R,{children:[e.jsx(G,{children:e.jsx(K,{children:"Overheads Details"})}),e.jsx(E,{children:e.jsxs(be,{children:[e.jsx(Se,{children:e.jsxs(U,{children:[e.jsx(M,{children:"Title"}),e.jsx(M,{children:"Month"}),e.jsx(M,{children:"Location"}),e.jsx(M,{children:"Site"}),e.jsx(M,{className:"text-right",children:"Amount"}),e.jsx(M,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Ce,{children:t.map(r=>e.jsxs(U,{children:[e.jsx(L,{className:"font-medium",children:r.name}),e.jsxs(L,{children:[r.month," ",r.year]}),e.jsx(L,{children:r.location||"-"}),e.jsx(L,{children:r.site||"-"}),e.jsx(L,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(L,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(r),children:e.jsx(et,{className:"h-4 w-4"})}),e.jsx(X,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx(st,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),pt=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},vt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},yt=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const r=pt(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:r}});return e.jsxs(R,{children:[e.jsxs(G,{children:[e.jsx(K,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(E,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(de,{width:"100%",height:"100%",children:e.jsxs(Ue,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(ke,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(le,{type:"number",hide:!0}),e.jsx(ce,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(he,{content:e.jsx(vt,{})}),a.map((s,r)=>s.clients.map((d,h)=>e.jsx(We,{dataKey:()=>d.revenue,stackId:r,fill:s.colors[h],radius:h===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((x,v)=>{const b=v===r;return e.jsx(we,{fill:b?s.colors[h]:"transparent",stroke:b?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:u=>{b&&(u.target.style.opacity="0.8")},onMouseLeave:u=>{b&&(u.target.style.opacity="1")}},`cell-${r}-${h}-${v}`)})},`${r}-${h}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((d,h)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[h]}}),e.jsx("span",{className:"truncate",title:`${d.name}: £${d.revenue.toLocaleString()}`,children:d.name})]},h))})]},r))})]})]})},Nt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},bt=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(R,{children:[e.jsx(G,{children:e.jsx(K,{children:"Client Workload vs Staff Coverage"})}),e.jsx(E,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(R,{children:[e.jsxs(G,{children:[e.jsx(K,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(E,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(de,{width:"100%",height:"100%",children:e.jsxs(ht,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(ke,{strokeDasharray:"3 3"}),e.jsx(le,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(_e,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(ce,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(_e,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(he,{content:e.jsx(Nt,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(Oe,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(Oe,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(Ve,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,d)=>r+d.shiftCount,0).toLocaleString()})]})]})]})]}),St=({dateRange:t,locations:a=[],sites:s=[]})=>{const[r,d]=i.useState("calendar"),[h,x]=i.useState([]),[v,b]=i.useState([]),[u,y]=i.useState([]),[l,k]=i.useState([]),[S,$]=i.useState(!1);i.useEffect(()=>{(async()=>{$(!0);try{const j=new URLSearchParams({start:A(t.from,"yyyy-MM-dd"),end:A(t.to,"yyyy-MM-dd"),view_type:r});a&&a.length>0&&a.forEach(p=>j.append("locations",p)),s&&s.length>0&&s.forEach(p=>j.append("sites",p));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},D=await fetch(`/api/dashboard/shifts-heatmap?${j.toString()}`,{headers:C,credentials:"include"});if(D.ok){const p=await D.json();p.view_type==="calendar"?x(p.data||[]):(b(p.data||[]),y(p.locations||[]),k(p.dates||[]))}}catch(j){console.error("Error fetching heatmap data:",j)}finally{$(!1)}})()},[t,a,s,r]);const w=()=>Math.max(...r==="calendar"?h.map(m=>m.shift_count):v.map(m=>m.shift_count),1),F=m=>{const j=w(),C=m/j;return C===0?"#f8f9fa":C<.33?"#d4edda":C<.67?"#fff3cd":"#f8d7da"},V=(m,j)=>{const C=v.find(D=>D.location===m&&D.date===j);return C?C.shift_count:0};return e.jsxs(R,{children:[e.jsxs(G,{children:[e.jsx(K,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"})]}),e.jsx(E,{children:e.jsxs(ns,{value:r,onValueChange:m=>d(m),children:[e.jsxs(Le,{className:"mb-4",children:[e.jsx(_,{value:"calendar",children:"Calendar View"}),e.jsx(_,{value:"location_day",children:"By Location"})]}),e.jsx(O,{value:"calendar",children:S?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):h.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:h.map((m,j)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:F(m.shift_count)},title:`${m.date} (${m.day_of_week}): ${m.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:A(new Date(m.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:m.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:m.shift_count})]},j))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(O,{value:"location_day",children:S?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):u.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),l.slice(0,31).map((m,j)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:A(new Date(m),"MMM d")},j))]})}),e.jsx("tbody",{children:u.map((m,j)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:m}),l.slice(0,31).map((C,D)=>{const p=V(m,C);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:F(p)},title:`${m} - ${C}: ${p} shifts`,children:p>0?p:""},D)})]},j))})]})}),l.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},Ne=["January","February","March","April","May","June","July","August","September","October","November","December"],He=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Ct=({open:t,onOpenChange:a,initialData:s,onSave:r})=>{var B,q;const{data:d}=lt(),[h,x]=i.useState(!1),[v,b]=i.useState(new Date().getFullYear()),[u,y]=i.useState(Ne[new Date().getMonth()]),[l,k]=i.useState(""),[S,$]=i.useState(""),[w,F]=i.useState(""),[V,m]=i.useState(""),[j,C]=i.useState("");i.useEffect(()=>{t&&(s?(b(s.year),y(s.month),k(s.location||""),$(s.site||""),C(s.value.toString()),He.includes(s.name)?(F(s.name),m("")):(F("Custom..."),m(s.name))):(b(new Date().getFullYear()),y(Ne[new Date().getMonth()]),k(""),$(""),F(""),m(""),C("")))},[t,s]);const D=async()=>{if(!l||!w||!j){z.error("Please fill in all required fields");return}const c=w==="Custom..."?V:w;if(!c){z.error("Please specify the overhead name");return}x(!0);try{await r({id:s==null?void 0:s.id,year:v,month:u,location:l,site:S||null,name:c,value:parseFloat(j)}),a(!1)}catch(Y){console.error("Failed to save overhead:",Y)}finally{x(!1)}},p=((B=d==null?void 0:d.jobs)==null?void 0:B.filter(c=>c.location===l&&c.site).map(c=>c.site).filter((c,Y,me)=>me.indexOf(c)===Y))||[];return e.jsx(tt,{open:t,onOpenChange:a,children:e.jsxs(at,{className:"sm:max-w-[500px]",children:[e.jsxs(rt,{children:[e.jsx(nt,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(it,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Year"}),e.jsxs(Z,{value:v.toString(),onValueChange:c=>b(Number(c)),children:[e.jsx(Q,{children:e.jsx(ee,{})}),e.jsx(se,{children:[2024,2025,2026,2027,2028].map(c=>e.jsx(J,{value:c.toString(),children:c},c))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Month"}),e.jsxs(Z,{value:u,onValueChange:y,children:[e.jsx(Q,{children:e.jsx(ee,{})}),e.jsx(se,{children:Ne.map(c=>e.jsx(J,{value:c,children:c},c))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Location"}),e.jsxs(Z,{value:l,onValueChange:c=>{k(c),$("")},children:[e.jsx(Q,{children:e.jsx(ee,{placeholder:"Select location..."})}),e.jsx(se,{children:Array.from(new Set((q=d==null?void 0:d.jobs)==null?void 0:q.map(c=>c.location).filter(Boolean))).map(c=>e.jsx(J,{value:c,children:c},c))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Site (Optional)"}),e.jsxs(Z,{value:S,onValueChange:$,disabled:!l||p.length===0,children:[e.jsx(Q,{children:e.jsx(ee,{placeholder:p.length===0?"No sites available":"Select site..."})}),e.jsxs(se,{children:[e.jsx(J,{value:"all_sites",children:"All Sites (if applicable)"}),p.map(c=>e.jsx(J,{value:c,children:c},c))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Category"}),e.jsxs(Z,{value:w,onValueChange:F,children:[e.jsx(Q,{children:e.jsx(ee,{placeholder:"Select category..."})}),e.jsx(se,{children:He.map(c=>e.jsx(J,{value:c,children:c},c))})]})]}),w==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Custom Name"}),e.jsx(Ie,{placeholder:"Enter overhead name",value:V,onChange:c=>m(c.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(W,{children:"Value (£)"}),e.jsx(Ie,{type:"number",placeholder:"0.00",value:j,onChange:c=>C(c.target.value)})]})]}),e.jsxs(ot,{children:[e.jsx(X,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(X,{onClick:D,disabled:h,children:[h&&e.jsx(Cs,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Xt=()=>{const{metricId:t}=Ts(),a=ks(),{dateRange:s,setDateRange:r}=ws(),{role:d}=As(),[h,x]=i.useState(!1),[v,b]=i.useState(s),[u,y]=i.useState([]),[l,k]=i.useState([]),[S,$]=i.useState("trend"),[w,F]=i.useState([]),[V,m]=i.useState([]),[j,C]=i.useState([]),[D,p]=i.useState({hours:0,staffCount:0}),[B,q]=i.useState([]),[c,Y]=i.useState(!1),[me,is]=i.useState([]),[os,te]=i.useState(!1),[ls,De]=i.useState(null),[ae,xe]=i.useState(null),re=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),fe=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),Me=t==="overheads",ge=d==="admin",{operationalData:P,isLoading:cs}=zs(s,u,l),{financialData:I,isLoading:ds}=Us(s,u,l),hs=re?ds:fe?cs:!1;i.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const o=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")}),g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},f=await fetch(`${ne.TARGETS_PERFORMANCE}?${o.toString()}`,{headers:g});if(f.ok){const N=await f.json();is(N)}}catch(o){console.error("Error fetching targets performance:",o)}})()},[s,t]),i.useEffect(()=>{if(S==="trend"||!t)return;(async()=>{Y(!0);try{const o=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});u&&u.length>0&&u.forEach(f=>o.append("locations",f)),l&&l.length>0&&l.forEach(f=>o.append("sites",f));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(S==="details"&&Me){const f=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${o.toString()}`,{headers:g});if(f.ok){const N=await f.json();q(N)}}else if(["location","site","client"].includes(S)){o.append("dimension",S);const f=await fetch(`${ne.BREAKDOWN}?${o.toString()}`,{headers:g});if(f.ok){const N=await f.json();F(N)}}}catch(o){console.error("Error fetching breakdown:",o)}finally{Y(!1)}})()},[S,t,s,u,l]),i.useEffect(()=>{t==="clients"&&S==="revenueTier"&&ge&&(async()=>{try{const o=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(N=>o.append("locations",N)),l&&l.length>0&&l.forEach(N=>o.append("sites",N));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},f=await fetch(`/api/dashboard/client-revenue-tiers?${o.toString()}`,{headers:g});if(f.ok){const T=(await f.json()).tiers.map(H=>({name:H.tier,value:H.totalRevenue,clientCount:H.clientCount,avgRevenue:H.avgRevenue,clients:H.clients||[]}));m(T)}}catch(o){console.error("Error fetching revenue tiers:",o)}})()},[t,S,ge,s,u,l]),i.useEffect(()=>{S==="trend"&&(async()=>{try{const o=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(T=>o.append("locations",T)),l&&l.length>0&&l.forEach(T=>o.append("sites",T));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},f=await fetch(`/api/dashboard/client-workload-scatter?${o.toString()}`,{headers:g});if(!f.ok){console.error(`❌ Workload scatter API failed (${f.status}): /api/dashboard/client-workload-scatter`);const T=await f.text();console.error("Response preview:",T.substring(0,200));return}const N=await f.json();C(N.data||[]),p(N.medians||{hours:0,staffCount:0})}catch(o){console.error("Error fetching workload data:",o)}})()},[S,s,u,l]);const us=()=>{De(null),te(!0)},ms=n=>{De(n),te(!0)},xs=async()=>{if(ae)try{const n=await fetch(`/api/admin/financial-metrics/${ae}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(n.ok)z.success("Overhead deleted"),S==="details"&&q(o=>o.filter(g=>g.id!==ae));else{const o=await n.json();z.error(o.error||"Failed to delete")}}catch(n){console.error(n),z.error("Failed to delete")}finally{xe(null)}},fs=async n=>{try{const o=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(n)});if(o.ok){z.success("Overhead saved"),te(!1);const g=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});u&&u.forEach(T=>g.append("locations",T)),l&&l.forEach(T=>g.append("sites",T));const f={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},N=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:f});if(N.ok){const T=await N.json();q(T)}}else{const g=await o.json();z.error(g.error||"Failed to save")}}catch(o){console.error(o),z.error("Failed to save")}},Re=n=>{switch(n){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},gs=(n,o)=>{var g,f,N,T,H,Ee,$e,Fe,Pe;if(!n)return"-";switch(o){case"revenue":return`£${((g=n.revenue)==null?void 0:g.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"cost":return`£${((f=n.cost)==null?void 0:f.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"profit":const pe=n.profit??n.revenue-n.cost-(n.overheads||0);return`£${(pe==null?void 0:pe.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"shifts":return((N=n.totalShifts)==null?void 0:N.toLocaleString())??0;case"hours":return((T=n.paidHours)==null?void 0:T.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"clients":return((H=n.clientCount)==null?void 0:H.toLocaleString())??0;case"employees":return((Ee=n.paidHours)==null?void 0:Ee.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"targetAchievement":return`${(($e=n.achievementPercentage)==null?void 0:$e.toFixed(1))??0}%`;case"missedTargets":return`${((Fe=n.achievementPercentage)==null?void 0:Fe.toFixed(1))??0}%`;case"clientRate":return`£${(n.revenue/n.paidHours||0).toFixed(2)}`;case"staffRate":return`£${(n.cost/n.paidHours||0).toFixed(2)}`;case"overheads":return`£${((Pe=n.overheads)==null?void 0:Pe.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;default:return"-"}},js=i.useMemo(()=>{if(!B||B.length===0)return[];const n=B.reduce((o,g)=>{const f=g.name||"Unknown";return o[f]||(o[f]=0),o[f]+=g.value,o},{});return Object.entries(n).map(([o,g])=>({name:o,value:g}))},[B]),je=re?I==null?void 0:I.timeSeries:P==null?void 0:P.timeSeries;return e.jsx(Is,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Bs,{dateRange:s,onDateRangeChange:r,calendarOpen:h,onCalendarOpenChange:x,tempDateRange:v,onTempDateRangeChange:b,selectedLocations:u,onLocationsChange:y,selectedSites:l,onSitesChange:k}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(hs||c)&&e.jsx(Gs,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(X,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(dt,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:Re(t)})]}),e.jsxs(ns,{value:S,onValueChange:$,className:"space-y-4",children:[e.jsxs(Le,{children:[e.jsx(_,{value:"trend",children:"Trend"}),e.jsx(_,{value:"location",children:"By Location"}),e.jsx(_,{value:"site",children:"By Site"}),t!=="clients"&&e.jsx(_,{value:"client",children:"By Clients"}),t==="clients"&&ge&&e.jsx(_,{value:"revenueTier",children:"By Revenue Tier"}),Me&&e.jsx(_,{value:"details",children:"All Details"})]}),e.jsx(O,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(bt,{data:j,medianHours:D.hours,medianStaff:D.staffCount}),t==="shifts"&&e.jsx(St,{dateRange:s,locations:u,sites:l}),re&&e.jsx(Ks,{data:(I==null?void 0:I.timeSeries)||[],aggregationLevel:(I==null?void 0:I.aggregationLevel)||"monthly",selectedMetric:t}),fe&&t!=="missedTargets"&&e.jsx(Vs,{data:(P==null?void 0:P.timeSeries)||[],aggregationLevel:(P==null?void 0:P.aggregationLevel)||"monthly",selectedMetric:t}),t==="missedTargets"&&e.jsx(Ws,{data:me}),!re&&!fe&&e.jsx(R,{children:e.jsx(E,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})}),e.jsxs(R,{children:[e.jsx(G,{children:e.jsx(K,{children:"Historical Data"})}),e.jsx(E,{children:e.jsxs(be,{children:[e.jsxs(Qs,{children:["Detailed historical data for ",Re(t)]}),e.jsx(Se,{children:e.jsxs(U,{children:[e.jsx(M,{children:"Period"}),e.jsx(M,{className:"text-right",children:"Value"})]})}),e.jsx(Ce,{children:je&&je.length>0?[...je].reverse().map((n,o)=>e.jsxs(U,{children:[e.jsx(L,{className:"font-medium",children:n.display}),e.jsx(L,{className:"text-right font-medium",children:gs(n,t)})]},o)):e.jsx(U,{children:e.jsx(L,{colSpan:2,className:"text-center",children:"No data available"})})})]})})]})]})}),e.jsx(O,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ye,{data:w,metric:t||"revenue"}),e.jsx(ie,{data:w,metric:t||"revenue"})]})}),e.jsx(O,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ye,{data:w,metric:t||"revenue"}),e.jsx(ie,{data:w,metric:t||"revenue"})]})}),e.jsx(O,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ye,{data:w,metric:t||"revenue"}),e.jsx(ie,{data:w,metric:t||"revenue"})]})}),e.jsx(O,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(yt,{data:V}),e.jsxs(R,{children:[e.jsx(G,{children:e.jsx(K,{children:"Tier Breakdown"})}),e.jsx(E,{children:e.jsxs(be,{children:[e.jsx(Se,{children:e.jsxs(U,{children:[e.jsx(M,{children:"Tier"}),e.jsx(M,{className:"text-right",children:"Clients"}),e.jsx(M,{className:"text-right",children:"Total Revenue"}),e.jsx(M,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Ce,{children:V.map(n=>e.jsxs(U,{children:[e.jsx(L,{className:"font-medium",children:n.name}),e.jsx(L,{className:"text-right",children:n.clientCount}),e.jsxs(L,{className:"text-right",children:["£",n.value.toLocaleString()]}),e.jsxs(L,{className:"text-right",children:["£",n.avgRevenue.toLocaleString()]})]},n.name))})]})})]})]})}),e.jsx(O,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(ie,{data:js,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(X,{onClick:us,className:"gap-2",children:[e.jsx(ct,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(jt,{data:B,onEdit:ms,onDelete:xe}),e.jsx(Ct,{open:os,onOpenChange:te,initialData:ls,onSave:fs}),e.jsx(Ls,{open:!!ae,onOpenChange:n=>!n&&xe(null),children:e.jsxs(Ds,{children:[e.jsxs(Ms,{children:[e.jsx(Rs,{children:"Are you sure?"}),e.jsx(Es,{children:"This will permanently delete this overhead record."})]}),e.jsxs($s,{children:[e.jsx(Fs,{children:"Cancel"}),e.jsx(Ps,{onClick:xs,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Xt as default};
