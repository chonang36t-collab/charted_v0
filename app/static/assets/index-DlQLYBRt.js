import{ab as L,r as h,j as t,e as P,B as M,ac as re,I as $}from"./index-ieSOKHGs.js";import{D as se,T as ae}from"./DashboardLayout-0-NyRSXD.js";import{T as B}from"./trash-2-CshL0iz1.js";import{e as le,C as oe,b as ne}from"./calendar-B_SB9GzB.js";import{f as E,s as ie,P as ue,a as ce,b as de}from"./popover-Ds_vjVzd.js";import{D as z,a as J,b as V,c as G,d as K,e as W}from"./dialog-pz6WzJsz.js";import{P as U}from"./plus-BYkmN0QT.js";import"./users-C4psMWZy.js";function fe(e,a){const l=L(e.start),o=L(e.end);let u=+l>+o;const c=u?+l:+o,n=u?o:l;n.setHours(0,0,0,0),n.setDate(1);let f=1;const b=[];for(;+n<=c;)b.push(L(n)),n.setMonth(n.getMonth()+f);return u?b.reverse():b}function me(e){const a=L(e),l=a.getFullYear();return a.setFullYear(l+1,0,0),a.setHours(23,59,59,999),a}function Z(e,a){return e===null||e===0?"":a.isPercentage?`${e.toFixed(2)}%`:a.isCurrency?`Â£${e.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}`:e.toLocaleString("en-GB",{maximumFractionDigits:2})}function pe({rowId:e,colId:a,value:l,row:o,isActive:u,onFocus:c,onUpdate:n,onNavigate:f}){const[b,_]=h.useState(!1),[g,v]=h.useState(""),w=h.useRef(null),k=h.useCallback(()=>{_(!0),v(l!==null?String(l):""),setTimeout(()=>{var i;return(i=w.current)==null?void 0:i.focus()},0)},[l]),A=h.useCallback(()=>{_(!1);const i=parseFloat(g);n(g===""?null:isNaN(i)?l:i)},[g,n,l]),j=i=>{b?i.key==="Enter"||i.key==="Tab"?(i.preventDefault(),A(),f(i.shiftKey?"up":"down")):i.key==="Escape"&&_(!1):i.key==="Enter"||i.key==="F2"?(i.preventDefault(),k()):i.key==="ArrowUp"?(i.preventDefault(),f("up")):i.key==="ArrowDown"?(i.preventDefault(),f("down")):i.key==="ArrowLeft"?(i.preventDefault(),f("left")):i.key==="ArrowRight"?(i.preventDefault(),f("right")):i.key==="Delete"||i.key==="Backspace"?(i.preventDefault(),n(null)):/^[0-9.\-]$/.test(i.key)&&(i.preventDefault(),v(i.key),_(!0),setTimeout(()=>{var r;return(r=w.current)==null?void 0:r.focus()},0))};return t.jsx("td",{className:P("border border-border px-2 py-1 text-right text-sm min-w-[110px] cursor-cell transition-colors",u&&"ring-2 ring-primary ring-inset bg-primary/5",!u&&"hover:bg-muted/50"),onClick:c,onDoubleClick:k,onKeyDown:j,tabIndex:0,onFocus:c,children:b?t.jsx("input",{ref:w,type:"text",value:g,onChange:i=>v(i.target.value),onBlur:A,className:"w-full bg-transparent text-right outline-none text-sm font-mono"}):t.jsx("span",{className:"font-mono text-sm",children:Z(l,o)})})}function he({value:e,row:a}){return t.jsx("td",{className:P("border border-border px-2 py-1 text-right text-sm min-w-[110px]",a.isHeader?"bg-primary/10 font-semibold":"bg-muted/30"),children:t.jsx("span",{className:"font-mono text-sm",children:Z(e,a)})})}function be({rows:e,columns:a,data:l,activeCell:o,setActiveCell:u,updateCell:c,deleteRow:n,deleteColumn:f,navigateCell:b,onRenameColumn:_}){const[g,v]=h.useState(null),[w,k]=h.useState(""),A=h.useRef(null),j=r=>{v(r.id),k(r.label),setTimeout(()=>{var s;return(s=A.current)==null?void 0:s.focus()},0)},i=()=>{g&&_&&_(g,w),v(null)};return t.jsx("div",{className:"overflow-x-auto border border-border rounded-lg bg-card max-w-full",children:t.jsxs("table",{className:"border-collapse w-full text-xs",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{className:"sticky left-0 z-20 bg-card border border-border px-2 py-2 text-left font-semibold text-muted-foreground uppercase tracking-wider w-[200px] min-w-[200px]",children:"Description"}),a.map(r=>t.jsx("th",{className:P("sticky top-0 z-10 border border-border px-1 py-1 text-center font-semibold uppercase tracking-wider min-w-[80px]",r.isYearEnd?"bg-primary/10 text-primary":"bg-muted/50 text-muted-foreground"),onDoubleClick:()=>!r.isProtected&&j(r),children:t.jsx("div",{className:"flex items-center justify-center gap-1 h-8 group relative px-2",children:g===r.id?t.jsx("input",{ref:A,value:w,onChange:s=>k(s.target.value),onBlur:i,onKeyDown:s=>s.key==="Enter"&&i(),className:"w-full bg-background border rounded px-1 text-center"}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"truncate",children:r.label}),!r.isProtected&&t.jsx(M,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 absolute -right-1 hover:text-destructive hover:bg-destructive/10",onClick:s=>{s.stopPropagation(),f(r.id)},children:t.jsx(B,{className:"h-3 w-3"})})]})})},r.id)),t.jsx("th",{className:"sticky top-0 z-10 bg-card border border-border w-8"})]})}),t.jsx("tbody",{children:e.map(r=>t.jsxs("tr",{className:P("group hover:bg-muted/20",r.isHeader&&"bg-primary/5"),children:[t.jsx("td",{className:P("sticky left-0 z-10 border border-border px-2 py-1 whitespace-nowrap bg-card text-xs truncate max-w-[200px]",r.isHeader&&"font-bold text-primary bg-primary/5",r.isAutoCalculated&&!r.isHeader&&"text-muted-foreground italic"),title:r.label,children:r.label}),a.map(s=>{var p;const d=(p=l[r.id])==null?void 0:p[s.id];return(d==null?void 0:d.isEditable)&&!r.isAutoCalculated&&!s.isYearEnd?t.jsx(pe,{rowId:r.id,colId:s.id,value:(d==null?void 0:d.value)??null,row:r,isActive:(o==null?void 0:o.row)===r.id&&(o==null?void 0:o.col)===s.id,onFocus:()=>u({row:r.id,col:s.id}),onUpdate:x=>c(r.id,s.id,x),onNavigate:b},s.id):t.jsx(he,{value:(d==null?void 0:d.value)??null,row:r},s.id)}),t.jsx("td",{className:"border border-border bg-card w-8 text-center p-0",children:!r.isAutoCalculated&&t.jsx(M,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 hover:text-destructive",onClick:()=>n(r.id),children:t.jsx(B,{className:"h-3 w-3"})})})]},r.id))})]})})}const T=e=>{if(!(e!=null&&e.from)||!(e!=null&&e.to))return new Date().getFullYear(),[{id:"jan",label:"January",isProtected:!0},{id:"feb",label:"February",isProtected:!0},{id:"mar",label:"March",isProtected:!0},{id:"apr",label:"April",isProtected:!0},{id:"may",label:"May",isProtected:!0},{id:"jun",label:"June",isProtected:!0},{id:"jul",label:"July",isProtected:!0},{id:"aug",label:"August",isProtected:!0},{id:"sep",label:"September",isProtected:!0},{id:"oct",label:"October",isProtected:!0},{id:"nov",label:"November",isProtected:!0},{id:"dec",label:"December",isProtected:!0},{id:"year_end",label:"Year End",isProtected:!0,isYearEnd:!0}];const l=fe({start:re(e.from),end:le(e.to)}).map(o=>({id:E(o,"MMM-yyyy").toLowerCase(),label:E(o,"MMM yyyy"),isProtected:!0}));return l.push({id:"year_end",label:"Period Total",isProtected:!0,isYearEnd:!0}),l},F=(e,a,l)=>a.reduce((o,u)=>{var n,f;const c=((f=(n=e[u])==null?void 0:n[l])==null?void 0:f.value)??0;return o+c},0),q=["cost_sales_se","cost_sales_paye","employee_ni","employee_pension"],Q=["apprenticeship_levy","annual_leave","other_expenses","recruitment_cost","overheads_mgmt","bank_interest","cooperation_tax"],Y=[{id:"total_sales",label:"Total Sales",isAutoCalculated:!1,isCurrency:!0},{id:"sales_split_pct",label:"% Sales Split for the Year",isAutoCalculated:!1,isPercentage:!0},{id:"cost_sales_se",label:"Cost of Sales SE",isAutoCalculated:!1,isCurrency:!0},{id:"cost_sales_paye",label:"Cost of Sales PAYE Gross",isAutoCalculated:!1,isCurrency:!0},{id:"employee_ni",label:"Employee NI",isAutoCalculated:!1,isCurrency:!0},{id:"employee_pension",label:"Employee Pension",isAutoCalculated:!1,isCurrency:!0},{id:"total_cost_sales",label:"Total Cost of Sales",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(e,a,l)=>F(e,q,l)},{id:"apprenticeship_levy",label:"Apprenticeship Levy",isAutoCalculated:!1,isCurrency:!0},{id:"annual_leave",label:"Annual Leave Accrual",isAutoCalculated:!1,isCurrency:!0},{id:"other_expenses",label:"Other Expenses",isAutoCalculated:!1,isCurrency:!0},{id:"recruitment_cost",label:"Recruitment and Pass Cost",isAutoCalculated:!1,isCurrency:!0},{id:"overheads_mgmt",label:"Overheads (Total Mgmt & Office Cost)",isAutoCalculated:!1,isCurrency:!0},{id:"bank_interest",label:"Bank Interest",isAutoCalculated:!1,isCurrency:!0},{id:"cooperation_tax",label:"Cooperation Tax",isAutoCalculated:!1,isCurrency:!0},{id:"total_overheads",label:"Total Overheads",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(e,a,l)=>F(e,Q,l)},{id:"total_cost",label:"Total Cost",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(e,a,l)=>{const o=F(e,q,l),u=F(e,Q,l);return o+u}},{id:"avg_hourly_charge",label:"Average Hourly Charge Rate",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_pay",label:"Gross Hourly Pay",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_margin",label:"Gross Hourly Margin",isAutoCalculated:!0,isCurrency:!0,formula:(e,a,l)=>{var c,n,f,b;const o=((n=(c=e.avg_hourly_charge)==null?void 0:c[l])==null?void 0:n.value)??0,u=((b=(f=e.gross_hourly_pay)==null?void 0:f[l])==null?void 0:b.value)??0;return o-u}},{id:"net_cost_per_hour",label:"Net Cost per Hour",isAutoCalculated:!1,isCurrency:!0},{id:"gross_pl_value",label:"Gross P&L Value",isAutoCalculated:!1,isCurrency:!0},{id:"net_pl",label:"Net P&L",isAutoCalculated:!1,isCurrency:!0},{id:"total_net_margin",label:"Total Net Margin",isAutoCalculated:!1,isPercentage:!0},{id:"worked_hours",label:"Worked Hours",isAutoCalculated:!1},{id:"hours_breakeven",label:"Hours for Breakeven",isAutoCalculated:!0,formula:(e,a,l)=>{var c,n,f,b;const o=((n=(c=e.total_cost)==null?void 0:c[l])==null?void 0:n.value)??0,u=((b=(f=e.gross_hourly_margin)==null?void 0:f[l])==null?void 0:b.value)??0;return u!==0?o/u:0}},{id:"value_breakeven",label:"Total Value for Breakeven",isAutoCalculated:!0,isCurrency:!0,formula:(e,a,l)=>{var c,n,f,b;const o=((n=(c=e.hours_breakeven)==null?void 0:c[l])==null?void 0:n.value)??0,u=((b=(f=e.avg_hourly_charge)==null?void 0:f[l])==null?void 0:b.value)??0;return o*u}},{id:"sales_budget_2026",label:"Projeted Sales Budget 30% Uplift",isAutoCalculated:!0,isCurrency:!0,formula:(e,a,l)=>{var u,c;return(((c=(u=e.total_sales)==null?void 0:u[l])==null?void 0:c.value)??0)*1.3}},{id:"avg_hourly_charge_2026",label:"Average Hourly Charge Rate Future",isAutoCalculated:!1,isCurrency:!0},{id:"sales_target_hours",label:"Sales Target in Hours",isAutoCalculated:!1},{id:"variance_2025",label:"Variance",isAutoCalculated:!1,isCurrency:!0}];function X(e,a){const l={};for(const o of e){l[o.id]={};for(const u of a)l[o.id][u.id]={value:null,isEditable:!o.isAutoCalculated&&!u.isYearEnd}}return l}function S(e,a,l){const o=JSON.parse(JSON.stringify(e));for(const c of l.filter(n=>!n.isYearEnd))for(const n of a)n.formula&&(o[n.id][c.id]={...o[n.id][c.id],value:n.formula(o,n.id,c.id),isEditable:!1});const u=l.find(c=>c.isYearEnd);if(u)for(const c of a){const n=l.filter(f=>!f.isYearEnd).reduce((f,b)=>{var _,g;return f+(((g=(_=o[c.id])==null?void 0:_[b.id])==null?void 0:g.value)??0)},0);o[c.id][u.id]={value:n,isEditable:!1}}return o}function ye(e){const[a,l]=h.useState(Y),[o,u]=h.useState(()=>T(e)),[c,n]=h.useState(()=>S(X(Y,T(e)),Y,T(e))),[f,b]=h.useState(null);h.useEffect(()=>{const r=T(e);u(r);let s=X(a,r);e!=null&&e.from&&(e!=null&&e.to)?(async()=>{try{const m=E(e.from,"yyyy-MM-dd"),p=E(e.to,"yyyy-MM-dd"),x=localStorage.getItem("auth_token"),C=await fetch(`undefined/api/financial-summary/metrics?start=${m}&end=${p}`,{headers:{Authorization:`Bearer ${x}`}});if(C.ok){const y=await C.json(),N={January:"jan",February:"feb",March:"mar",April:"apr",May:"may",June:"jun",July:"jul",August:"aug",September:"sep",October:"oct",November:"nov",December:"dec"};for(const[D,H]of Object.entries(y)){const[R,ee]=D.split("-"),I=N[ee];if(!I)continue;const O=`${I}-${R}`;r.find(te=>te.id===O)&&(s.total_sales&&s.total_sales[O]&&(s.total_sales[O].value=H.total_sales),s.cost_sales_paye&&s.cost_sales_paye[O]&&(s.cost_sales_paye[O].value=H.cost_sales_paye))}n(S(s,a,r))}else n(S(s,a,r))}catch(m){console.error("Failed to fetch metrics",m),n(S(s,a,r))}})():n(S(s,a,r))},[e,a]);const _=h.useCallback((r,s,d)=>{n(m=>{const p={...m};return p[r]={...p[r]},p[r][s]={...p[r][s],value:d},S(p,a,o)})},[a,o]),g=h.useCallback(r=>{const s=`custom_${Date.now()}`,d={id:s,label:r,isAutoCalculated:!1,isCurrency:!0};l(m=>{const p=[...m,d];return n(x=>{const C={...x};C[s]={};for(const y of o)C[s][y.id]={value:null,isEditable:!y.isYearEnd};return S(C,p,o)}),p})},[o]),v=h.useCallback(r=>{l(s=>s.filter(d=>d.id!==r)),n(s=>{const d={...s};return delete d[r],d})},[]),w=h.useCallback(r=>{const s=`col_${Date.now()}`,d={id:s,label:r};u(m=>{const p=m.findIndex(C=>C.isYearEnd),x=[...m];return x.splice(p,0,d),n(C=>{const y={...C};for(const N of a)y[N.id]={...y[N.id]},y[N.id][s]={value:null,isEditable:!N.isAutoCalculated};return S(y,a,x)}),x})},[a]),k=h.useCallback(r=>{u(s=>{const d=s.filter(m=>m.id!==r);return n(m=>{const p={...m};for(const x of Object.keys(p)){const{[r]:C,...y}=p[x];p[x]=y}return S(p,a,d)}),d})},[a]),A=h.useCallback((r,s)=>{u(d=>d.map(m=>m.id===r?{...m,label:s}:m))},[]),j=h.useCallback(r=>{if(!f)return;const s=a.filter(y=>!y.isAutoCalculated),d=o.filter(y=>!y.isYearEnd),m=s.findIndex(y=>y.id===f.row),p=d.findIndex(y=>y.id===f.col);if(m===-1||p===-1)return;let x=m,C=p;switch(r){case"up":x=Math.max(0,m-1);break;case"down":x=Math.min(s.length-1,m+1);break;case"left":C=Math.max(0,p-1);break;case"right":C=Math.min(d.length-1,p+1);break}b({row:s[x].id,col:d[C].id})},[f,a,o]),i=h.useCallback(async r=>{if(r)try{const s={year:new Date().getFullYear(),data:c,rows:a,columns:o},d=localStorage.getItem("auth_token");if(!(await fetch("undefined/api/financial-summary/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify(s)})).ok)throw new Error("Failed to save")}catch(s){throw console.error("Save failed",s),s}},[c,a,o]);return{rows:a,columns:o,data:c,activeCell:f,setActiveCell:b,updateCell:_,addRow:g,deleteRow:v,addColumn:w,deleteColumn:k,renameColumn:A,navigateCell:j,saveData:i}}function Ae(){const[e,a]=h.useState({from:ie(new Date),to:me(new Date)}),{rows:l,columns:o,data:u,activeCell:c,setActiveCell:n,updateCell:f,addRow:b,deleteRow:_,addColumn:g,deleteColumn:v,navigateCell:w,renameColumn:k,saveData:A}=ye(e),[j,i]=h.useState(""),[r,s]=h.useState(""),[d,m]=h.useState(!1),[p,x]=h.useState(!1);h.useState(!1);const C=()=>{j.trim()&&(b(j.trim()),i(""),m(!1))},y=()=>{r.trim()&&(g(r.trim()),s(""),x(!1))},N=e!=null&&e.from&&(e!=null&&e.to)?`Financial Summary for ${E(e.from,"MMM yyyy")} - ${E(e.to,"MMM yyyy")}`:"Financial Summary";return t.jsx(se,{noPadding:!0,fullWidth:!0,children:t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-border bg-card/50 shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:t.jsx(ae,{className:"h-5 w-5 text-primary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-foreground",children:N}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Annual budget and performance spreadsheet"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(ue,{children:[t.jsx(ce,{asChild:!0,children:t.jsxs(M,{variant:"outline",className:P("w-[240px] justify-start text-left font-normal",!e&&"text-muted-foreground"),children:[t.jsx(oe,{className:"mr-2 h-4 w-4"}),e!=null&&e.from?e.to?t.jsxs(t.Fragment,{children:[E(e.from,"LLL dd, y")," -"," ",E(e.to,"LLL dd, y")]}):E(e.from,"LLL dd, y"):t.jsx("span",{children:"Pick a date"})]})}),t.jsx(de,{className:"w-auto p-0",align:"end",children:t.jsx(ne,{initialFocus:!0,mode:"range",defaultMonth:e==null?void 0:e.from,selected:e,onSelect:a,numberOfMonths:2,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),t.jsxs(z,{open:d,onOpenChange:m,children:[t.jsx(J,{asChild:!0,children:t.jsxs(M,{variant:"outline",size:"sm",children:[t.jsx(U,{className:"h-4 w-4 mr-1"})," Add Row"]})}),t.jsxs(V,{children:[t.jsx(G,{children:t.jsx(K,{children:"Add New Row"})}),t.jsx($,{placeholder:"Row label...",value:j,onChange:D=>i(D.target.value),onKeyDown:D=>D.key==="Enter"&&C()}),t.jsx(W,{children:t.jsx(M,{onClick:C,disabled:!j.trim(),children:"Add"})})]})]}),t.jsxs(z,{open:p,onOpenChange:x,children:[t.jsx(J,{asChild:!0,children:t.jsxs(M,{variant:"outline",size:"sm",children:[t.jsx(U,{className:"h-4 w-4 mr-1"})," Add Column"]})}),t.jsxs(V,{children:[t.jsx(G,{children:t.jsx(K,{children:"Add New Column"})}),t.jsx($,{placeholder:"Column label...",value:r,onChange:D=>s(D.target.value),onKeyDown:D=>D.key==="Enter"&&y()}),t.jsx(W,{children:t.jsx(M,{onClick:y,disabled:!r.trim(),children:"Add"})})]})]}),t.jsx(M,{variant:"default",size:"sm",onClick:()=>A(!0),children:"Save Changes"})]})]}),t.jsx("div",{className:"flex-1 overflow-auto p-4",children:t.jsx(be,{rows:l,columns:o,data:u,activeCell:c,setActiveCell:n,updateCell:f,deleteRow:_,deleteColumn:v,navigateCell:w,onRenameColumn:k})})]})})}export{Ae as default};
