import{r as d,a2 as R,j as e,B as S,I as D,X as K,y as b}from"./index-C-ijiT9j.js";import{D as Q,C as _}from"./DashboardLayout-B9aleQ7j.js";import{C as P,a as Y,b as U,d as W}from"./card-BTzBTY9M.js";import{L as T}from"./label-CCpCKZNO.js";import{S as A,a as O,b as $,c as z,d as I}from"./select-DdMmZe5p.js";import{T as X,a as G,b as M,c as C,d as Z,e as f}from"./table-D8GsFRbs.js";import{u as V}from"./useQuery-DkN6efKu.js";import{u as ee,e as q}from"./useRecords-DEXNDI91.js";import{D as se,a as ae,b as te,c as ne,d as re,f as ie}from"./dialog-3eaRI4BF.js";import{a as oe,C as le}from"./index-DG0gl-bB.js";import"./users-j0LY2CtT.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],Ne=()=>{const[a,v]=d.useState(new Date().getFullYear()),[r,g]=d.useState(B[new Date().getMonth()]),[h,N]=d.useState(new Set),m=R(),{data:u}=ee(),{data:l}=V({queryKey:["admin-targets",a],queryFn:async()=>{const s=await fetch(`/api/admin/targets?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch targets");return s.json()}}),{data:x}=V({queryKey:["admin-financials",a],queryFn:async()=>{const s=await fetch(`/api/admin/financial-metrics?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch metrics");return s.json()}}),j=q({mutationFn:async s=>{const t=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save target");return t.json()},onSuccess:()=>{m.invalidateQueries({queryKey:["admin-targets"]}),b.success("Target saved")},onError:s=>b.error(s.message)}),w=q({mutationFn:async s=>{const t=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save metric");return t.json()},onSuccess:()=>{m.invalidateQueries({queryKey:["admin-financials"]}),b.success("Metric saved")},onError:s=>b.error(s.message)}),y=d.useMemo(()=>{if(!(u!=null&&u.jobs))return{};const s={};return u.jobs.forEach(t=>{t.location&&(s[t.location]||(s[t.location]=new Set),t.site&&s[t.location].add(t.site))}),s},[u]),F=s=>{const t=new Set(h);t.has(s)?t.delete(s):t.add(s),N(t)},i=(s,t)=>{var p;if(t){const o=(p=l==null?void 0:l.find(c=>c.month===r&&c.location===s&&c.site===t))==null?void 0:p.target;return o??1e3}const k=y[s]?Array.from(y[s]):[];let n=0;return k.forEach(o=>{var L;const c=(L=l==null?void 0:l.find(E=>E.month===r&&E.location===s&&E.site===o))==null?void 0:L.target;n+=c??1e3}),n};return e.jsxs(Q,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(P,{className:"mb-6",children:[e.jsx(Y,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{children:"Year:"}),e.jsxs(A,{value:a.toString(),onValueChange:s=>v(Number(s)),children:[e.jsx(O,{className:"w-[100px]",children:e.jsx($,{})}),e.jsx(z,{children:[2024,2025,2026,2027,2028].map(s=>e.jsx(I,{value:s.toString(),children:s},s))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{children:"Month:"}),e.jsxs(A,{value:r,onValueChange:g,children:[e.jsx(O,{className:"w-[120px]",children:e.jsx($,{})}),e.jsx(z,{children:B.map(s=>e.jsx(I,{value:s,children:s},s))})]})]})]})]})}),e.jsx(W,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(M,{children:[e.jsx(C,{className:"w-[300px]",children:"Location / Site"}),e.jsx(C,{className:"w-[150px]",children:"Shift Target"}),e.jsx(C,{className:"w-[150px]",children:"Total Overheads"}),e.jsx(C,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Z,{children:Object.entries(y).map(([s,t])=>{const k=(x||[]).filter(n=>n.location===s&&n.site===null&&n.month===r&&n.year===a).reduce((n,p)=>n+p.value,0);return e.jsxs(e.Fragment,{children:[e.jsxs(M,{className:"bg-muted/30",children:[e.jsxs(f,{className:"font-medium",children:[e.jsx(S,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>F(s),children:h.has(s)?e.jsx(oe,{className:"h-4 w-4"}):e.jsx(_,{className:"h-4 w-4"})}),s]}),e.jsx(f,{children:t.size===0?e.jsx(J,{value:i(s,null)||1e3,onSave:n=>j.mutate({year:a,month:r,location:s,site:null,target:n})}):e.jsx("span",{className:"text-muted-foreground font-semibold px-2",children:i(s,null).toLocaleString()})}),e.jsx(f,{children:e.jsxs("span",{className:"font-mono",children:["£",k.toLocaleString()]})}),e.jsx(f,{children:e.jsx(H,{location:s,site:null,year:a,month:r,metrics:x||[],onSave:(n,p)=>w.mutate({year:a,month:r,location:s,site:null,name:n,value:p})})})]},s),h.has(s)&&Array.from(t).map(n=>{const p=(x||[]).filter(o=>o.location===s&&o.site===n&&o.month===r&&o.year===a).reduce((o,c)=>o+c.value,0);return e.jsxs(M,{children:[e.jsx(f,{className:"pl-10 text-sm text-muted-foreground",children:n}),e.jsx(f,{children:e.jsx(J,{value:i(s,n),onSave:o=>j.mutate({year:a,month:r,location:s,site:n,target:o})})}),e.jsx(f,{children:e.jsxs("span",{className:"font-mono",children:["£",p.toLocaleString()]})}),e.jsx(f,{children:e.jsx(H,{location:s,site:n,year:a,month:r,metrics:x||[],onSave:(o,c)=>w.mutate({year:a,month:r,location:s,site:n,name:o,value:c})})})]},`${s}-${n}`)})]})})})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on Target value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Locations without sites have a default target of 1000."}),e.jsx("p",{children:'• Use "Edit Financials" to add multiple overheads per location/site.'})]})]})},H=({location:a,site:v,year:r,month:g,metrics:h,onSave:N})=>{const[m,u]=d.useState(!1),[l,x]=d.useState(""),[j,w]=d.useState(""),y=h.filter(i=>i.year===r&&i.month===g&&i.location===a&&i.site===v),F=()=>{!l||!j||(N(l,parseFloat(j)),x(""),w(""))};return e.jsxs(se,{open:m,onOpenChange:u,children:[e.jsx(ae,{asChild:!0,children:e.jsx(S,{variant:"outline",size:"sm",children:"Edit Financials"})}),e.jsxs(te,{className:"sm:max-w-[500px]",children:[e.jsxs(ne,{children:[e.jsx(re,{children:"Manage Financials"}),e.jsxs(ie,{children:[a," ",v?` - ${v}`:""," (",g," ",r,")"]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-2 max-h-[200px] overflow-y-auto space-y-2",children:[y.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No metrics added yet."}),y.map(i=>e.jsxs("div",{className:"flex items-center justify-between bg-secondary/20 p-2 rounded",children:[e.jsx("span",{className:"text-sm font-medium",children:i.name}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-sm",children:["£",i.value.toLocaleString()]})})]},i.id))]}),e.jsxs("div",{className:"flex items-end gap-2 border-t pt-4",children:[e.jsxs("div",{className:"grid gap-1.5 flex-1",children:[e.jsx(T,{htmlFor:"name",children:"Name"}),e.jsx(D,{id:"name",placeholder:"e.g. Rent",value:l,onChange:i=>x(i.target.value)})]}),e.jsxs("div",{className:"grid gap-1.5 w-[100px]",children:[e.jsx(T,{htmlFor:"val",children:"Value (£)"}),e.jsx(D,{id:"val",type:"number",placeholder:"0",value:j,onChange:i=>w(i.target.value)})]}),e.jsx(S,{onClick:F,disabled:!l||!j,children:"Add"})]})]})]})]})},J=({value:a,onSave:v,prefix:r=""})=>{const[g,h]=d.useState(!1),[N,m]=d.useState(a);d.useEffect(()=>{g||m(a)},[a,g]);const u=()=>{m(a),h(!0)},l=()=>{N!==a&&v(N),h(!1)},x=()=>{h(!1),m(a)};return g?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{type:"number",value:N,onChange:j=>m(Number(j.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:l,children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:x,children:e.jsx(K,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:u,children:a?`${r}${a.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{Ne as default};
