const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MetricPalette-yiesye2M.js","assets/index-Cwa0VGn5.js","assets/index-CG_fmMaf.css","assets/card-CGBK-K6M.js","assets/pound-sterling-DpEWJDsJ.js","assets/users-V4lVAK-5.js","assets/clock-B5ze3fgQ.js","assets/locationUtils--34O4PAp.js","assets/popover-NxQMHS6k.js","assets/DashboardLayout-Blb4jY-C.js","assets/ChartCanvas-D5jnXVwz.js","assets/badge-RrlKDuub.js","assets/table-BwrTp2Bi.js","assets/generateCategoricalChart-BJNINWox.js","assets/BarChart-8DvxZqGM.js","assets/PieChart-DcMejkLx.js","assets/AreaChart-DrPCU_TJ.js","assets/LineChart-CB0R56fB.js","assets/Line-CvXfJEeI.js"])))=>i.map(i=>d[i]);
import{b as me,r as c,j as e,P as he,e as P,B as E,X as fe,T as pe,k as xe,l as ue,m as ge,a as je,n as ye,_ as Z}from"./index-Cwa0VGn5.js";import{D as Se}from"./DashboardLayout-Blb4jY-C.js";import{L as G}from"./label-BJtP0uMy.js";import{S as ve,a as Ce,b as Ne,c as we,d as I}from"./select-BrmXPpgU.js";import{P as J,a as U,b as Y,f as R}from"./popover-NxQMHS6k.js";import{g as H,a as be,C as W,b as X}from"./locationUtils--34O4PAp.js";import{C as De,a as Ae,b as Te,c as Me,d as Ee,e as Le}from"./command-DX7W0Pfg.js";import{C as Be,a as _e,b as ke,d as Oe}from"./card-CGBK-K6M.js";import{C as Ie}from"./index-Bb3Hx0GX.js";import{S as K}from"./switch-Cu4Xnj1W.js";import"./users-V4lVAK-5.js";import"./dialog-jMZg7LyU.js";const Re=()=>{const{role:s}=me(),[i,l]=c.useState(()=>{const a=localStorage.getItem("chartBuilderState"),o={dimensions:[],metrics:[],chartType:"bar",dateRange:{from:void 0,to:void 0},customMetrics:[],chartData:[],draggedItem:void 0};if(a)try{const m=JSON.parse(a);return{...o,dimensions:m.dimensions||[],metrics:m.metrics||[],chartType:m.chartType||"bar"}}catch(m){console.error("Error parsing saved chart builder state",m)}return o});return c.useEffect(()=>{const{dimensions:a,metrics:o,chartType:m}=i;localStorage.setItem("chartBuilderState",JSON.stringify({dimensions:a,metrics:o,chartType:m}))},[i.dimensions,i.metrics,i.chartType]),c.useEffect(()=>{if(s&&s!=="admin"){const a=["revenue","cost","gross_profit","labor_cost","net_profit","overheads"],o=i.metrics.filter(m=>!a.includes(m));if(o.length!==i.metrics.length){const m=o.length>0?o:["paid_hours"];l(p=>({...p,metrics:m}))}}},[s,i.metrics]),{state:i,setDimensions:a=>{l(o=>({...o,dimensions:a}))},setMetrics:a=>{l(o=>({...o,metrics:a}))},setChartType:a=>{l(o=>({...o,chartType:a}))},setDateRange:a=>{l(o=>({...o,dateRange:a}))},addCustomMetric:a=>{l(o=>({...o,customMetrics:[...o.customMetrics,a]}))},setChartData:a=>{l(o=>({...o,chartData:a}))},setDraggedItem:a=>{l(o=>({...o,draggedItem:a}))}}};var Pe="Separator",Q="horizontal",ze=["horizontal","vertical"],ee=c.forwardRef((s,i)=>{const{decorative:l,orientation:u=Q,...v}=s,x=$e(u)?u:Q,y=l?{role:"none"}:{"aria-orientation":x==="vertical"?x:void 0,role:"separator"};return e.jsx(he.div,{"data-orientation":x,...y,...v,ref:i})});ee.displayName=Pe;function $e(s){return ze.includes(s)}var te=ee;const se=c.forwardRef(({className:s,orientation:i="horizontal",decorative:l=!0,...u},v)=>e.jsx(te,{ref:v,decorative:l,orientation:i,className:P("shrink-0 bg-border",i==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...u}));se.displayName=te.displayName;function M({title:s,options:i,selected:l,onChange:u,placeholder:v="Select...",isLocation:x=!1}){const[r,y]=c.useState(!1),h=a=>{l.includes(a)?u(l.filter(o=>o!==a)):u([...l,a])},d=a=>{a.stopPropagation(),u([])};return e.jsxs("div",{className:"flex flex-col gap-1.5 min-w-[180px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:s}),e.jsxs(J,{open:r,onOpenChange:y,children:[e.jsx(U,{asChild:!0,children:e.jsxs(E,{variant:"outline",role:"combobox","aria-expanded":r,className:"w-full justify-between h-9 px-3 text-sm",children:[e.jsxs("div",{className:"flex flex-wrap gap-1 items-center overflow-hidden",children:[l.length===0&&e.jsx("span",{className:"text-muted-foreground font-normal truncate",children:v}),l.length===1&&e.jsx("span",{className:"truncate",children:x?H(l[0]):l[0]}),l.length>1&&e.jsxs("span",{className:"truncate",children:[l.length," selected"]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 opacity-50 ml-2",children:[l.length>0&&e.jsx(fe,{className:"h-3 w-3 cursor-pointer hover:opacity-100",onClick:d}),e.jsx(De,{className:"h-3 w-3"})]})]})}),e.jsx(Y,{className:"w-[200px] p-0",align:"start",children:e.jsxs(Ae,{children:[e.jsx(Te,{placeholder:`Search ${s.toLowerCase()}...`}),e.jsxs(Me,{children:["No ",s.toLowerCase()," found."]}),e.jsx(Ee,{className:"max-h-64 overflow-auto",children:i.map(a=>e.jsxs(Le,{value:a,onSelect:()=>h(a),children:[e.jsx(Ie,{className:P("mr-2 h-4 w-4",l.includes(a)?"opacity-100":"opacity-0")}),x?e.jsx(pe,{delayDuration:300,children:e.jsxs(xe,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-medium",children:H(a)}),e.jsx("span",{className:"text-[10px] text-muted-foreground truncate opacity-70",children:a})]})}),e.jsx(ge,{side:"right",children:e.jsx("p",{children:a})})]})}):a]},a))})]})})]})]})}function Ve({availableFilters:s,filters:i,onFilterChange:l,orientation:u="vertical",hideSites:v=!1}){c.useMemo(()=>{if(i.locations.length===0)return s.clients;const d=s.locations.filter(o=>i.locations.includes(o.name)),a=new Set;return d.forEach(o=>{o.clients&&o.clients.forEach(m=>a.add(m))}),Array.from(a).sort()},[s,i.locations]);const x=c.useMemo(()=>{if(i.locations.length===0)return Array.from(new Set(s.locations.flatMap(o=>o.sites))).sort();const d=s.locations.filter(o=>i.locations.includes(o.name)),a=new Set;return d.forEach(o=>{o.sites.forEach(m=>a.add(m))}),Array.from(a).sort()},[s.locations,i.locations]),r=d=>{const a=s.locations.filter(p=>d.includes(p.name)),o=d.length===0?s.clients:Array.from(new Set(a.flatMap(p=>p.clients||[]))),m=d.length===0?Array.from(new Set(s.locations.flatMap(p=>p.sites))):Array.from(new Set(a.flatMap(p=>p.sites)));l({...i,locations:d,clients:i.clients.filter(p=>o.includes(p)),sites:i.sites.filter(p=>m.includes(p))})},y=d=>{l({...i,clients:d})},h=d=>{l({...i,sites:d})};return u==="horizontal"?e.jsxs("div",{className:"flex flex-wrap items-end gap-4 p-1",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground mr-2 pb-2",children:e.jsx("span",{children:"ðŸŒªï¸ Filters:"})}),e.jsx(M,{title:"Clients",options:s.clients,selected:i.clients,onChange:y,placeholder:"All Clients"}),e.jsx(M,{title:"Locations",options:s.locations.map(d=>d.name),selected:i.locations,onChange:r,placeholder:"All Locations",isLocation:!0}),!v&&e.jsx(M,{title:"Sites",options:x,selected:i.sites,onChange:h,placeholder:"All Sites"})]}):e.jsxs(Be,{className:"h-full flex flex-col",children:[e.jsx(_e,{className:"pb-3",children:e.jsx(ke,{className:"text-lg flex items-center gap-2",children:"ðŸŒªï¸ Filters"})}),e.jsxs(Oe,{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsx(M,{title:"Clients",options:s.clients,selected:i.clients,onChange:y,placeholder:"All Clients"}),e.jsx(se,{}),e.jsx(M,{title:"Locations",options:s.locations.map(d=>d.name),selected:i.locations,onChange:r,placeholder:"All Locations",isLocation:!0}),e.jsx(M,{title:"Sites",options:x,selected:i.sites,onChange:h,placeholder:"All Sites"})]})]})}const Je=c.lazy(()=>Z(()=>import("./MetricPalette-yiesye2M.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),_=c.lazy(()=>Z(()=>import("./ChartCanvas-D5jnXVwz.js"),__vite__mapDeps([10,1,2,11,12,13,14,15,16,17,18])));function tt(){const{state:s,setDimensions:i,setMetrics:l,setChartType:u,setDateRange:v}=Re(),{toast:x}=je(),[r,y]=c.useState(()=>{const t=localStorage.getItem("chartBuilderDate");if(t)try{const n=JSON.parse(t);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return{from:new Date,to:be(new Date,30)}}),[h,d]=c.useState(()=>{const t=localStorage.getItem("chartBuilderAppliedDate");if(t)try{const n=JSON.parse(t);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return r});c.useEffect(()=>{r&&localStorage.setItem("chartBuilderDate",JSON.stringify(r))},[r]),c.useEffect(()=>{h&&localStorage.setItem("chartBuilderAppliedDate",JSON.stringify(h))},[h]);const[a,o]=c.useState(!1),[m,p]=c.useState(!1),[w,F]=c.useState(()=>localStorage.getItem("chartBuilderSplitByLocation")==="true"),[C,z]=c.useState(()=>localStorage.getItem("chartBuilderSplitBySite")==="true"&&!w);c.useEffect(()=>{localStorage.setItem("chartBuilderSplitByLocation",String(w))},[w]),c.useEffect(()=>{localStorage.setItem("chartBuilderSplitBySite",String(C))},[C]);const[k,ae]=c.useState({clients:[],locations:[]}),[g,re]=c.useState({clients:[],locations:[],sites:[]});c.useEffect(()=>{(async()=>{try{const n=await fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(n.ok){const f=await n.json();ae(f)}}catch(n){console.error("Error fetching filters:",n)}})()},[]);const ne=()=>{d(r)},[A,q]=c.useState("chart"),[N,T]=c.useState([]),[oe,L]=c.useState([]),B=t=>{T(n=>{const f=[...n];return t.forEach(b=>{const O=f.findIndex(D=>D.name===b.name&&(D.location===b.location||!D.location&&!b.location)&&(D.site===b.site||!D.site&&!b.site));O!==-1&&(f[O]=b)}),f})};c.useEffect(()=>{(async()=>{var D;if(s.dimensions.length===0||s.metrics.length===0||!(h!=null&&h.from)||!(h!=null&&h.to)){T([]),L([]);return}const n=s.dimensions[0],f=s.metrics,b=R(h.from,"yyyy-MM-dd"),O=R(h.to,"yyyy-MM-dd");try{const j=new URLSearchParams;j.append("start",b),j.append("end",O),j.append("dimension",n),f.forEach(S=>j.append("metrics",S)),g.clients.forEach(S=>j.append("clients",S)),g.locations.forEach(S=>j.append("locations",S)),g.sites.forEach(S=>j.append("sites",S)),w&&j.append("split_by_location","true"),C&&j.append("split_by_site","true");const V=await fetch(`/api/chart-data?${j.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(V.ok){const S=await V.json();T(S.data||[]),L(((D=S.summary)==null?void 0:D.topClients)||[])}else V.status===403?(console.warn("Access denied for selected metrics"),T([]),L([])):(console.error("Failed to fetch chart data"),T([]),L([]))}catch(j){console.error("Error fetching chart data:",j),T([]),L([])}})()},[s.dimensions,s.metrics,h,g,w,C]);const{showSiteFilter:ie,showSiteSplit:$}=c.useMemo(()=>{const t=g.locations.length===0?k.locations.flatMap(f=>f.sites):k.locations.filter(f=>g.locations.includes(f.name)).flatMap(f=>f.sites),n=Array.from(new Set(t));return{showSiteFilter:n.length>1,showSiteSplit:n.length>1}},[k.locations,g.locations]);c.useEffect(()=>{!$&&C&&z(!1)},[$,C]);const le=t=>{t.type==="dimension"?s.dimensions.includes(t.name)?(i([]),x({description:`Removed ${t.name} from chart`,duration:2e3})):(i([t.name]),x({description:`Added ${t.name} to chart`,duration:2e3})):t.type==="metric"&&(s.metrics.includes(t.name)?(l(s.metrics.filter(n=>n!==t.name)),x({description:`Removed ${t.name} from chart`,duration:2e3})):(l([...s.metrics,t.name]),x({description:`Added ${t.name} to chart`,duration:2e3})))},ce=t=>{i(s.dimensions.filter(n=>n!==t))},de=t=>{l(s.metrics.filter(n=>n!==t))};return e.jsx(Se,{noPadding:!0,fullWidth:!0,children:e.jsx("div",{className:"p-2 md:p-3 h-full flex flex-col",children:e.jsxs("div",{className:"space-y-4 h-full flex flex-col",children:[e.jsx("div",{className:"sticky lg:top-0 z-30 pb-2 border-b -mx-4 md:-mx-6 px-4 md:px-6 pt-1 shadow-sm bg-background",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-xl font-bold",children:"Chart Builder"})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"flex items-center bg-muted rounded-lg p-0.5 border mr-2",children:[e.jsx(E,{variant:A==="chart"?"secondary":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>q("chart"),children:"Chart"}),e.jsx(E,{variant:A==="table"?"secondary":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>q("table"),children:"Table"})]}),e.jsx("div",{className:"w-32",children:e.jsxs(ve,{value:s.chartType,onValueChange:u,children:[e.jsx(Ce,{className:"h-8 text-xs",children:e.jsx(Ne,{placeholder:"Chart Type"})}),e.jsxs(we,{children:[e.jsx(I,{value:"bar",children:"Bar Chart"}),e.jsx(I,{value:"line",children:"Line Chart"}),e.jsx(I,{value:"area",children:"Area Chart"}),e.jsx(I,{value:"pie",children:"Pie Chart"})]})]})}),e.jsxs("div",{className:"flex items-center gap-6 px-2 border-l ml-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{id:"split-location",checked:w,onCheckedChange:t=>{F(t),t&&z(!1)}}),e.jsx(G,{htmlFor:"split-location",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Location"})]}),$&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{id:"split-site",checked:C,onCheckedChange:t=>{z(t),t&&F(!1)}}),e.jsx(G,{htmlFor:"split-site",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Site"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(J,{open:a,onOpenChange:o,children:[e.jsx(U,{asChild:!0,children:e.jsxs(E,{variant:"outline",className:P("w-32 justify-start text-left font-normal h-8 text-xs",!(r!=null&&r.from)&&"text-muted-foreground"),children:[e.jsx(W,{className:"mr-2 h-3 w-3"}),r!=null&&r.from?R(r.from,"MMM dd, y"):e.jsx("span",{children:"From"})]})}),e.jsx(Y,{className:"w-auto p-0",align:"start",children:e.jsx(X,{mode:"single",selected:r==null?void 0:r.from,onSelect:t=>{y(n=>({...n,from:t})),o(!1)},defaultMonth:r==null?void 0:r.from,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsxs(J,{open:m,onOpenChange:p,children:[e.jsx(U,{asChild:!0,children:e.jsxs(E,{variant:"outline",className:P("w-32 justify-start text-left font-normal h-8 text-xs",!(r!=null&&r.to)&&"text-muted-foreground"),children:[e.jsx(W,{className:"mr-2 h-3 w-3"}),r!=null&&r.to?R(r.to,"MMM dd, y"):e.jsx("span",{children:"To"})]})}),e.jsx(Y,{className:"w-auto p-0",align:"start",children:e.jsx(X,{mode:"single",selected:r==null?void 0:r.to,onSelect:t=>{y(n=>({...n,to:t})),p(!1)},defaultMonth:r==null?void 0:r.to,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsx(E,{onClick:ne,className:"h-8 text-xs px-4",disabled:!(r!=null&&r.from)||!(r!=null&&r.to),children:"Apply Range"})]})]})]})}),e.jsx(c.Suspense,{fallback:e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(ye,{className:"h-8 w-8 rounded-full"})}),children:e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row gap-2 min-h-0 h-full",children:[e.jsx("div",{className:"lg:w-72 shrink-0 h-full flex flex-col overflow-hidden",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2",children:e.jsx(Je,{selectedDimensions:s.dimensions,selectedMetrics:s.metrics,onItemClick:le})})}),e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"shrink-0 pb-2 border-b mb-2",children:e.jsx(Ve,{availableFilters:k,filters:g,onFilterChange:re,orientation:"horizontal",hideSites:!ie})}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2 custom-scrollbar",children:[!w&&!C&&e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 h-full min-h-[500px]",children:e.jsx(_,{chartData:N,chartType:s.chartType,dimensions:s.dimensions,metrics:s.metrics,onRemoveDimension:ce,onRemoveMetric:de,title:"Aggregated View",topClients:oe,viewMode:A,onDataChange:B})}),w&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[g.locations.length>0?g.locations.map(t=>{const n=N.filter(f=>f.location===t);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(_,{chartData:n,chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:A,onDataChange:B})},t)}):Array.from(new Set(N.map(t=>t.location).filter(Boolean))).map(t=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(_,{chartData:N.filter(n=>n.location===t),chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:A,onDataChange:B})},t)),N.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected locations"})]}),C&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[g.sites.length>0?g.sites.map(t=>{const n=N.filter(f=>f.site===t);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(_,{chartData:n,chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:A,onDataChange:B})},t)}):Array.from(new Set(N.map(t=>t.site).filter(Boolean))).map(t=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(_,{chartData:N.filter(n=>n.site===t),chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:A,onDataChange:B})},t)),N.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected sites"})]})]})]})]})})]})})})}export{tt as default};
