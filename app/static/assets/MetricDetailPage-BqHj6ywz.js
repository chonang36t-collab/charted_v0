import{c as js,h as ps,r as l,U as vs,p as ys,j as e,v as bs,P as ie,q as pe,w as Ns,e as Ce,B as W,I as Pe,L as Ss,y as E,ab as Cs,u as Ts,d as As,b as ks,a3 as Rs,a4 as Ls,a5 as Ds,a6 as ws,a7 as Ms,a8 as Es,a9 as $s,aa as Ps,A as ne}from"./index-BqtMKZPn.js";import{D as Fs}from"./DashboardLayout-CC0mClA4.js";import{C as k,d as R,a as G,b as K}from"./card-c0KSrgfz.js";import{c as ze,R as Is,I as Os,P as Bs}from"./index-ayMdUQT1.js";import{D as _s}from"./DashboardHeader-BSLwKNmB.js";import{S as He,Z as zs,u as Hs,O as Vs,T as Ws}from"./TargetPerformanceChart-8-wmAAHz.js";import{u as Gs,L as Ks,R as Us}from"./LoadingOverlay-D6pYTSf1.js";import{g as Ys,X as oe,Y as le,f as qs,R as ce,C as Te,T as de,B as Ve,a as Ae,L as Js,b as Fe,c as Ie}from"./generateCategoricalChart-OW-BsXSX.js";import{B as We}from"./BarChart-C4CrbISJ.js";import{P as Xs,a as Zs}from"./PieChart-BPTWZ5o9.js";import{T as be,a as Ne,b as P,c as C,d as Se,e as N,f as Qs}from"./table-CeLQxKOR.js";import{P as et}from"./pen-BuTcUmrF.js";import{T as st}from"./trash-2-7ZvVRWQJ.js";import{D as tt,b as at,c as rt,d as nt,f as it,e as ot}from"./dialog-Ca-GvIPc.js";import{L as $}from"./label-D2C9uEwp.js";import{S as X,a as Z,b as Q,c as ee,d as z}from"./select-C045G8PX.js";import{u as lt}from"./useRecords-CD-aeIb9.js";import{f as A}from"./popover-C1_ClfRG.js";import"./users-mlLXqANX.js";import"./locationUtils-Br7TqDne.js";import"./index-DlOpa6eE.js";import"./AreaChart-CdErFBQt.js";import"./useQuery-_mKYDg__.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ct=js("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var dt=Ys({chartName:"ScatterChart",GraphicalChild:He,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:oe},{axisType:"yAxis",AxisComp:le},{axisType:"zAxis",AxisComp:zs}],formatAxisMap:qs}),he="Tabs",[ht,Ut]=ps(he,[ze]),Ge=ze(),[ut,ke]=ht(he),Ke=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,onValueChange:c,defaultValue:h,orientation:x="horizontal",dir:p,activationMode:v="automatic",...u}=t,j=vs(p),[d,S]=ys({prop:r,onChange:c,defaultProp:h??"",caller:he});return e.jsx(ut,{scope:s,baseId:bs(),value:d,onValueChange:S,orientation:x,dir:j,activationMode:v,children:e.jsx(ie.div,{dir:j,"data-orientation":x,...u,ref:a})})});Ke.displayName=he;var Ue="TabsList",Ye=l.forwardRef((t,a)=>{const{__scopeTabs:s,loop:r=!0,...c}=t,h=ke(Ue,s),x=Ge(s);return e.jsx(Is,{asChild:!0,...x,orientation:h.orientation,dir:h.dir,loop:r,children:e.jsx(ie.div,{role:"tablist","aria-orientation":h.orientation,...c,ref:a})})});Ye.displayName=Ue;var qe="TabsTrigger",Je=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,disabled:c=!1,...h}=t,x=ke(qe,s),p=Ge(s),v=Qe(x.baseId,r),u=es(x.baseId,r),j=r===x.value;return e.jsx(Os,{asChild:!0,...p,focusable:!c,active:j,children:e.jsx(ie.button,{type:"button",role:"tab","aria-selected":j,"aria-controls":u,"data-state":j?"active":"inactive","data-disabled":c?"":void 0,disabled:c,id:v,...h,ref:a,onMouseDown:pe(t.onMouseDown,d=>{!c&&d.button===0&&d.ctrlKey===!1?x.onValueChange(r):d.preventDefault()}),onKeyDown:pe(t.onKeyDown,d=>{[" ","Enter"].includes(d.key)&&x.onValueChange(r)}),onFocus:pe(t.onFocus,()=>{const d=x.activationMode!=="manual";!j&&!c&&d&&x.onValueChange(r)})})})});Je.displayName=qe;var Xe="TabsContent",Ze=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,forceMount:c,children:h,...x}=t,p=ke(Xe,s),v=Qe(p.baseId,r),u=es(p.baseId,r),j=r===p.value,d=l.useRef(j);return l.useEffect(()=>{const S=requestAnimationFrame(()=>d.current=!1);return()=>cancelAnimationFrame(S)},[]),e.jsx(Ns,{present:c||j,children:({present:S})=>e.jsx(ie.div,{"data-state":j?"active":"inactive","data-orientation":p.orientation,role:"tabpanel","aria-labelledby":v,hidden:!S,id:u,tabIndex:0,...x,ref:a,style:{...t.style,animationDuration:d.current?"0s":void 0},children:S&&h})})});Ze.displayName=Xe;function Qe(t,a){return`${t}-trigger-${a}`}function es(t,a){return`${t}-content-${a}`}var mt=Ke,ss=Ye,ts=Je,as=Ze;const xt=mt,rs=l.forwardRef(({className:t,...a},s)=>e.jsx(ss,{ref:s,className:Ce("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));rs.displayName=ss.displayName;const H=l.forwardRef(({className:t,...a},s)=>e.jsx(ts,{ref:s,className:Ce("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));H.displayName=ts.displayName;const V=l.forwardRef(({className:t,...a},s)=>e.jsx(as,{ref:s,className:Ce("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));V.displayName=as.displayName;const gt=({active:t,payload:a,label:s,metric:r})=>{if(t&&a&&a.length){const c=["clients","employees","shifts","hours"].includes(r),h=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:c?h.toLocaleString():h.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},Oe=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(k,{children:e.jsx(R,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ce,{width:"100%",height:"100%",children:e.jsxs(We,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(Te,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(oe,{type:"number",hide:!0}),e.jsx(le,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(de,{content:e.jsx(gt,{metric:a})}),e.jsx(Ve,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((r,c)=>e.jsx(Ae,{fill:"hsl(var(--primary))",fillOpacity:.8+c*.05},`cell-${c}`))})]})})})})}),Be=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ft=({active:t,payload:a})=>t&&a&&a.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]}):null,ve=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(k,{children:e.jsx(R,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((h,x)=>x.value-h.value),r=s.reduce((h,x)=>h+x.value,0),c=s.map(h=>({...h,percentage:r>0?h.value/r*100:0}));return e.jsx(k,{children:e.jsx(R,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ce,{width:"100%",height:"100%",children:e.jsxs(Xs,{children:[e.jsx(Zs,{data:c,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:c.map((h,x)=>e.jsx(Ae,{fill:Be[x%Be.length]},`cell-${x}`))}),e.jsx(de,{content:e.jsx(ft,{})}),e.jsx(Js,{})]})})})})})},jt=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(k,{children:[e.jsx(G,{children:e.jsx(K,{children:"Overheads Details"})}),e.jsx(R,{children:e.jsxs(be,{children:[e.jsx(Ne,{children:e.jsxs(P,{children:[e.jsx(C,{children:"Title"}),e.jsx(C,{children:"Month"}),e.jsx(C,{children:"Location"}),e.jsx(C,{children:"Site"}),e.jsx(C,{className:"text-right",children:"Amount"}),e.jsx(C,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Se,{children:t.map(r=>e.jsxs(P,{children:[e.jsx(N,{className:"font-medium",children:r.name}),e.jsxs(N,{children:[r.month," ",r.year]}),e.jsx(N,{children:r.location||"-"}),e.jsx(N,{children:r.site||"-"}),e.jsx(N,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(r),children:e.jsx(et,{className:"h-4 w-4"})}),e.jsx(W,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx(st,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),pt=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},vt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},yt=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const r=pt(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:r}});return e.jsxs(k,{children:[e.jsxs(G,{children:[e.jsx(K,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(R,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(ce,{width:"100%",height:"100%",children:e.jsxs(We,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(Te,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(oe,{type:"number",hide:!0}),e.jsx(le,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(de,{content:e.jsx(vt,{})}),a.map((s,r)=>s.clients.map((c,h)=>e.jsx(Ve,{dataKey:()=>c.revenue,stackId:r,fill:s.colors[h],radius:h===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((x,p)=>{const v=p===r;return e.jsx(Ae,{fill:v?s.colors[h]:"transparent",stroke:v?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:u=>{v&&(u.target.style.opacity="0.8")},onMouseLeave:u=>{v&&(u.target.style.opacity="1")}},`cell-${r}-${h}-${p}`)})},`${r}-${h}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((c,h)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[h]}}),e.jsx("span",{className:"truncate",title:`${c.name}: £${c.revenue.toLocaleString()}`,children:c.name})]},h))})]},r))})]})]})},bt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},Nt=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(k,{children:[e.jsx(G,{children:e.jsx(K,{children:"Client Workload vs Staff Coverage"})}),e.jsx(R,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(k,{children:[e.jsxs(G,{children:[e.jsx(K,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(R,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(ce,{width:"100%",height:"100%",children:e.jsxs(dt,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(Te,{strokeDasharray:"3 3"}),e.jsx(oe,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(Fe,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(le,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(Fe,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(de,{content:e.jsx(bt,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(Ie,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(Ie,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(He,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,c)=>r+c.shiftCount,0).toLocaleString()})]})]})]})]}),ye=["January","February","March","April","May","June","July","August","September","October","November","December"],_e=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],St=({open:t,onOpenChange:a,initialData:s,onSave:r})=>{var w,B;const{data:c}=lt(),[h,x]=l.useState(!1),[p,v]=l.useState(new Date().getFullYear()),[u,j]=l.useState(ye[new Date().getMonth()]),[d,S]=l.useState(""),[b,F]=l.useState(""),[T,I]=l.useState(""),[U,O]=l.useState(""),[Y,q]=l.useState("");l.useEffect(()=>{t&&(s?(v(s.year),j(s.month),S(s.location||""),F(s.site||""),q(s.value.toString()),_e.includes(s.name)?(I(s.name),O("")):(I("Custom..."),O(s.name))):(v(new Date().getFullYear()),j(ye[new Date().getMonth()]),S(""),F(""),I(""),O(""),q("")))},[t,s]);const se=async()=>{if(!d||!T||!Y){E.error("Please fill in all required fields");return}const o=T==="Custom..."?U:T;if(!o){E.error("Please specify the overhead name");return}x(!0);try{await r({id:s==null?void 0:s.id,year:p,month:u,location:d,site:b||null,name:o,value:parseFloat(Y)}),a(!1)}catch(_){console.error("Failed to save overhead:",_)}finally{x(!1)}},J=((w=c==null?void 0:c.jobs)==null?void 0:w.filter(o=>o.location===d&&o.site).map(o=>o.site).filter((o,_,ue)=>ue.indexOf(o)===_))||[];return e.jsx(tt,{open:t,onOpenChange:a,children:e.jsxs(at,{className:"sm:max-w-[500px]",children:[e.jsxs(rt,{children:[e.jsx(nt,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(it,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Year"}),e.jsxs(X,{value:p.toString(),onValueChange:o=>v(Number(o)),children:[e.jsx(Z,{children:e.jsx(Q,{})}),e.jsx(ee,{children:[2024,2025,2026,2027,2028].map(o=>e.jsx(z,{value:o.toString(),children:o},o))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Month"}),e.jsxs(X,{value:u,onValueChange:j,children:[e.jsx(Z,{children:e.jsx(Q,{})}),e.jsx(ee,{children:ye.map(o=>e.jsx(z,{value:o,children:o},o))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Location"}),e.jsxs(X,{value:d,onValueChange:o=>{S(o),F("")},children:[e.jsx(Z,{children:e.jsx(Q,{placeholder:"Select location..."})}),e.jsx(ee,{children:Array.from(new Set((B=c==null?void 0:c.jobs)==null?void 0:B.map(o=>o.location).filter(Boolean))).map(o=>e.jsx(z,{value:o,children:o},o))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Site (Optional)"}),e.jsxs(X,{value:b,onValueChange:F,disabled:!d||J.length===0,children:[e.jsx(Z,{children:e.jsx(Q,{placeholder:J.length===0?"No sites available":"Select site..."})}),e.jsxs(ee,{children:[e.jsx(z,{value:"all_sites",children:"All Sites (if applicable)"}),J.map(o=>e.jsx(z,{value:o,children:o},o))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Category"}),e.jsxs(X,{value:T,onValueChange:I,children:[e.jsx(Z,{children:e.jsx(Q,{placeholder:"Select category..."})}),e.jsx(ee,{children:_e.map(o=>e.jsx(z,{value:o,children:o},o))})]})]}),T==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Custom Name"}),e.jsx(Pe,{placeholder:"Enter overhead name",value:U,onChange:o=>O(o.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:"Value (£)"}),e.jsx(Pe,{type:"number",placeholder:"0.00",value:Y,onChange:o=>q(o.target.value)})]})]}),e.jsxs(ot,{children:[e.jsx(W,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(W,{onClick:se,disabled:h,children:[h&&e.jsx(Ss,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Yt=()=>{const{metricId:t}=Cs(),a=Ts(),{dateRange:s,setDateRange:r}=As(),{role:c}=ks(),[h,x]=l.useState(!1),[p,v]=l.useState(s),[u,j]=l.useState([]),[d,S]=l.useState([]),[b,F]=l.useState("trend"),[T,I]=l.useState([]),[U,O]=l.useState([]),[Y,q]=l.useState([]),[se,J]=l.useState({hours:0,staffCount:0}),[w,B]=l.useState([]),[o,_]=l.useState(!1),[ue,ns]=l.useState([]),[is,te]=l.useState(!1),[os,Re]=l.useState(null),[ae,me]=l.useState(null),re=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),xe=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),Le=t==="overheads",ge=c==="admin",{operationalData:L,isLoading:ls}=Hs(s,u,d),{financialData:D,isLoading:cs}=Gs(s,u,d),ds=re?cs:xe?ls:!1;l.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")}),g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},m=await fetch(`${ne.TARGETS_PERFORMANCE}?${i.toString()}`,{headers:g});if(m.ok){const f=await m.json();ns(f)}}catch(i){console.error("Error fetching targets performance:",i)}})()},[s,t]),l.useEffect(()=>{if(b==="trend"||!t)return;(async()=>{_(!0);try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});u&&u.length>0&&u.forEach(m=>i.append("locations",m)),d&&d.length>0&&d.forEach(m=>i.append("sites",m));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(b==="details"&&Le){const m=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${i.toString()}`,{headers:g});if(m.ok){const f=await m.json();B(f)}}else if(["location","site"].includes(b)){i.append("dimension",b);const m=await fetch(`${ne.BREAKDOWN}?${i.toString()}`,{headers:g});if(m.ok){const f=await m.json();I(f)}}}catch(i){console.error("Error fetching breakdown:",i)}finally{_(!1)}})()},[b,t,s,u,d]),l.useEffect(()=>{t==="clients"&&b==="revenueTier"&&ge&&(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(f=>i.append("locations",f)),d&&d.length>0&&d.forEach(f=>i.append("sites",f));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},m=await fetch(`/api/dashboard/client-revenue-tiers?${i.toString()}`,{headers:g});if(m.ok){const y=(await m.json()).tiers.map(M=>({name:M.tier,value:M.totalRevenue,clientCount:M.clientCount,avgRevenue:M.avgRevenue,clients:M.clients||[]}));O(y)}}catch(i){console.error("Error fetching revenue tiers:",i)}})()},[t,b,ge,s,u,d]),l.useEffect(()=>{b==="trend"&&(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(y=>i.append("locations",y)),d&&d.length>0&&d.forEach(y=>i.append("sites",y));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},m=await fetch(`/api/dashboard/client-workload-scatter?${i.toString()}`,{headers:g});if(!m.ok){console.error(`❌ Workload scatter API failed (${m.status}): /api/dashboard/client-workload-scatter`);const y=await m.text();console.error("Response preview:",y.substring(0,200));return}const f=await m.json();q(f.data||[]),J(f.medians||{hours:0,staffCount:0})}catch(i){console.error("Error fetching workload data:",i)}})()},[b,s,u,d]);const hs=()=>{Re(null),te(!0)},us=n=>{Re(n),te(!0)},ms=async()=>{if(ae)try{const n=await fetch(`/api/admin/financial-metrics/${ae}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(n.ok)E.success("Overhead deleted"),b==="details"&&B(i=>i.filter(g=>g.id!==ae));else{const i=await n.json();E.error(i.error||"Failed to delete")}}catch(n){console.error(n),E.error("Failed to delete")}finally{me(null)}},xs=async n=>{try{const i=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(n)});if(i.ok){E.success("Overhead saved"),te(!1);const g=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});u&&u.forEach(y=>g.append("locations",y)),d&&d.forEach(y=>g.append("sites",y));const m={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},f=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:m});if(f.ok){const y=await f.json();B(y)}}else{const g=await i.json();E.error(g.error||"Failed to save")}}catch(i){console.error(i),E.error("Failed to save")}},De=n=>{switch(n){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},gs=(n,i)=>{var g,m,f,y,M,we,Me,Ee,$e;if(!n)return"-";switch(i){case"revenue":return`£${((g=n.revenue)==null?void 0:g.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"cost":return`£${((m=n.cost)==null?void 0:m.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"profit":const je=n.profit??n.revenue-n.cost-(n.overheads||0);return`£${(je==null?void 0:je.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"shifts":return((f=n.totalShifts)==null?void 0:f.toLocaleString())??0;case"hours":return((y=n.paidHours)==null?void 0:y.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"clients":return((M=n.clientCount)==null?void 0:M.toLocaleString())??0;case"employees":return((we=n.paidHours)==null?void 0:we.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"targetAchievement":return`${((Me=n.achievementPercentage)==null?void 0:Me.toFixed(1))??0}%`;case"missedTargets":return`${((Ee=n.achievementPercentage)==null?void 0:Ee.toFixed(1))??0}%`;case"clientRate":return`£${(n.revenue/n.paidHours||0).toFixed(2)}`;case"staffRate":return`£${(n.cost/n.paidHours||0).toFixed(2)}`;case"overheads":return`£${(($e=n.overheads)==null?void 0:$e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;default:return"-"}},fs=l.useMemo(()=>{if(!w||w.length===0)return[];const n=w.reduce((i,g)=>{const m=g.name||"Unknown";return i[m]||(i[m]=0),i[m]+=g.value,i},{});return Object.entries(n).map(([i,g])=>({name:i,value:g}))},[w]),fe=re?D==null?void 0:D.timeSeries:L==null?void 0:L.timeSeries;return e.jsx(Fs,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(_s,{dateRange:s,onDateRangeChange:r,calendarOpen:h,onCalendarOpenChange:x,tempDateRange:p,onTempDateRangeChange:v,selectedLocations:u,onLocationsChange:j,selectedSites:d,onSitesChange:S}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(ds||o)&&e.jsx(Ks,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(W,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(ct,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:De(t)})]}),e.jsxs(xt,{value:b,onValueChange:F,className:"space-y-4",children:[e.jsxs(rs,{children:[e.jsx(H,{value:"trend",children:"Trend"}),e.jsx(H,{value:"location",children:"By Location"}),e.jsx(H,{value:"site",children:"By Site"}),t==="clients"&&ge&&e.jsx(H,{value:"revenueTier",children:"By Revenue Tier"}),Le&&e.jsx(H,{value:"details",children:"All Details"})]}),e.jsx(V,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx(Nt,{data:Y,medianHours:se.hours,medianStaff:se.staffCount}),re&&e.jsx(Us,{data:(D==null?void 0:D.timeSeries)||[],aggregationLevel:(D==null?void 0:D.aggregationLevel)||"monthly",selectedMetric:t}),xe&&t!=="missedTargets"&&e.jsx(Vs,{data:(L==null?void 0:L.timeSeries)||[],aggregationLevel:(L==null?void 0:L.aggregationLevel)||"monthly",selectedMetric:t}),t==="missedTargets"&&e.jsx(Ws,{data:ue}),!re&&!xe&&e.jsx(k,{children:e.jsx(R,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})}),e.jsxs(k,{children:[e.jsx(G,{children:e.jsx(K,{children:"Historical Data"})}),e.jsx(R,{children:e.jsxs(be,{children:[e.jsxs(Qs,{children:["Detailed historical data for ",De(t)]}),e.jsx(Ne,{children:e.jsxs(P,{children:[e.jsx(C,{children:"Period"}),e.jsx(C,{className:"text-right",children:"Value"})]})}),e.jsx(Se,{children:fe&&fe.length>0?[...fe].reverse().map((n,i)=>e.jsxs(P,{children:[e.jsx(N,{className:"font-medium",children:n.display}),e.jsx(N,{className:"text-right font-medium",children:gs(n,t)})]},i)):e.jsx(P,{children:e.jsx(N,{colSpan:2,className:"text-center",children:"No data available"})})})]})})]})]})}),e.jsx(V,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Oe,{data:T,metric:t||"revenue"}),e.jsx(ve,{data:T,metric:t||"revenue"})]})}),e.jsx(V,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Oe,{data:T,metric:t||"revenue"}),e.jsx(ve,{data:T,metric:t||"revenue"})]})}),e.jsx(V,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(yt,{data:U}),e.jsxs(k,{children:[e.jsx(G,{children:e.jsx(K,{children:"Tier Breakdown"})}),e.jsx(R,{children:e.jsxs(be,{children:[e.jsx(Ne,{children:e.jsxs(P,{children:[e.jsx(C,{children:"Tier"}),e.jsx(C,{className:"text-right",children:"Clients"}),e.jsx(C,{className:"text-right",children:"Total Revenue"}),e.jsx(C,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Se,{children:U.map(n=>e.jsxs(P,{children:[e.jsx(N,{className:"font-medium",children:n.name}),e.jsx(N,{className:"text-right",children:n.clientCount}),e.jsxs(N,{className:"text-right",children:["£",n.value.toLocaleString()]}),e.jsxs(N,{className:"text-right",children:["£",n.avgRevenue.toLocaleString()]})]},n.name))})]})})]})]})}),e.jsx(V,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(ve,{data:fs,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(W,{onClick:hs,className:"gap-2",children:[e.jsx(Bs,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(jt,{data:w,onEdit:us,onDelete:me}),e.jsx(St,{open:is,onOpenChange:te,initialData:os,onSave:xs}),e.jsx(Rs,{open:!!ae,onOpenChange:n=>!n&&me(null),children:e.jsxs(Ls,{children:[e.jsxs(Ds,{children:[e.jsx(ws,{children:"Are you sure?"}),e.jsx(Ms,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Es,{children:[e.jsx($s,{children:"Cancel"}),e.jsx(Ps,{onClick:ms,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Yt as default};
