import{c as St,ab as wa,R as O,ac as Sa,r as m,h as Ca,U as Aa,p as Ta,j as e,v as ka,P as Ee,q as De,w as $a,e as Ve,B as se,I as ae,A as ce,L as Ea,y as te,ad as _a,u as Ma,d as Oa,b as La,a3 as Ia,a4 as Da,a5 as Pa,a6 as Ra,a7 as Fa,a8 as Ba,a9 as Ka,aa as Ua}from"./index-swZt1NzH.js";import{D as Ha}from"./DashboardLayout-C7VJTVjw.js";import{C as F,d as B,a as X,b as Z}from"./card-CFeXvDoR.js";import{c as Ct,R as Va,I as Wa}from"./index-D4ojh5P-.js";import{D as za}from"./DashboardHeader-7-PdQ5oY.js";import{S as We,Z as Ga,C as ze,u as qa,O as Ya,T as Qa}from"./TargetPerformanceChart-DExgoxTn.js";import{u as Ja,L as Xa,R as Za}from"./LoadingOverlay-DXluBIXc.js";import{_ as At,e as es,k as Tt,i as Ge,a as kt,b as ts,c as as,d as ss,f as $t,g as rs,h as Et,s as ns,j as is,l as os,m as ls,n as qe,o as _t,p as Mt,q as Ot,r as cs,t as ds,u as hs,v as us,w as ms,x as fs,y as Lt,z as xs,D as gs,E as ps,F as vs,G as ys,H as js,I as bs,J as we,K as Ns,M as ws,N as Pe,O as Re,P as st,Q as rt,S as nt,U as Ss,V as Cs,W as As,Z as Ts,$ as ks,a0 as it,a1 as It,T as V,a2 as $s,X as ie,Y as re,a3 as Es,R as ne,C as he,B as Q,a4 as Ye,L as Dt,a5 as ot,a6 as lt}from"./generateCategoricalChart-CnZAfnPn.js";import{B as Pt,L as _s}from"./BarChart-DPNEHxl8.js";import{P as Ms,a as Os,b as Ls}from"./PieChart-HNsDHfL3.js";import{T as Rt,a as Ft,b as Ae,c as W,d as Bt,e as z}from"./table-B8PMtAxF.js";import{P as Is}from"./pen-CDR6bZeR.js";import{T as Ds}from"./trash-2-CGLXhqQL.js";import{L}from"./label-B9A1shjN.js";import{f as $,P as Ps,a as Rs,b as Fs}from"./popover-CSFExb3o.js";import{D as Bs,b as Ks,c as Us,d as Hs,f as Vs,e as Ws}from"./dialog-CAB_R868.js";import{S as me,a as fe,b as xe,c as ge,d as le}from"./select-C0-txmd9.js";import{u as zs}from"./useRecords-BUjOenV7.js";import{P as Gs}from"./plus-Bz8jjTj9.js";import"./users-BlPVlZji.js";import"./locationUtils-RKaD8Utm.js";import"./checkbox-B0lqUbZj.js";import"./index-aoQ5T--6.js";import"./AreaChart-3YGy4PkP.js";import"./useQuery-D3W3K5Ab.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qs=St("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=St("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);function Qs(t,s){for(var a=-1,r=t==null?0:t.length;++a<r&&s(t[a],a,t)!==!1;);return t}var Js=Qs,Xs=At,Zs=es,er=Object.prototype,tr=er.hasOwnProperty;function ar(t,s,a){var r=t[s];(!(tr.call(t,s)&&Zs(r,a))||a===void 0&&!(s in t))&&Xs(t,s,a)}var Kt=ar,sr=Kt,rr=At;function nr(t,s,a,r){var n=!a;a||(a={});for(var i=-1,l=s.length;++i<l;){var o=s[i],h=r?r(a[o],t[o],o,a,t):void 0;h===void 0&&(h=t[o]),n?rr(a,o,h):sr(a,o,h)}return a}var ye=nr,ir=ye,or=Tt;function lr(t,s){return t&&ir(s,or(s),t)}var cr=lr;function dr(t){var s=[];if(t!=null)for(var a in Object(t))s.push(a);return s}var hr=dr,ur=Ge,mr=kt,fr=hr,xr=Object.prototype,gr=xr.hasOwnProperty;function pr(t){if(!ur(t))return fr(t);var s=mr(t),a=[];for(var r in t)r=="constructor"&&(s||!gr.call(t,r))||a.push(r);return a}var vr=pr,yr=ts,jr=vr,br=as;function Nr(t){return br(t)?yr(t,!0):jr(t)}var Qe=Nr,wr=ye,Sr=Qe;function Cr(t,s){return t&&wr(s,Sr(s),t)}var Ar=Cr,Te={exports:{}};Te.exports;(function(t,s){var a=ss,r=s&&!s.nodeType&&s,n=r&&!0&&t&&!t.nodeType&&t,i=n&&n.exports===r,l=i?a.Buffer:void 0,o=l?l.allocUnsafe:void 0;function h(c,u){if(u)return c.slice();var d=c.length,g=o?o(d):new c.constructor(d);return c.copy(g),g}t.exports=h})(Te,Te.exports);var Tr=Te.exports;function kr(t,s){var a=-1,r=t.length;for(s||(s=Array(r));++a<r;)s[a]=t[a];return s}var $r=kr,Er=ye,_r=$t;function Mr(t,s){return Er(t,_r(t),s)}var Or=Mr,Lr=rs,Ir=Et,Dr=$t,Pr=ns,Rr=Object.getOwnPropertySymbols,Fr=Rr?function(t){for(var s=[];t;)Lr(s,Dr(t)),t=Ir(t);return s}:Pr,Ut=Fr,Br=ye,Kr=Ut;function Ur(t,s){return Br(t,Kr(t),s)}var Hr=Ur,Vr=is,Wr=Ut,zr=Qe;function Gr(t){return Vr(t,zr,Wr)}var Ht=Gr,qr=Object.prototype,Yr=qr.hasOwnProperty;function Qr(t){var s=t.length,a=new t.constructor(s);return s&&typeof t[0]=="string"&&Yr.call(t,"index")&&(a.index=t.index,a.input=t.input),a}var Jr=Qr,ct=os;function Xr(t){var s=new t.constructor(t.byteLength);return new ct(s).set(new ct(t)),s}var Je=Xr,Zr=Je;function en(t,s){var a=s?Zr(t.buffer):t.buffer;return new t.constructor(a,t.byteOffset,t.byteLength)}var tn=en,an=/\w*$/;function sn(t){var s=new t.constructor(t.source,an.exec(t));return s.lastIndex=t.lastIndex,s}var rn=sn,dt=ls,ht=dt?dt.prototype:void 0,ut=ht?ht.valueOf:void 0;function nn(t){return ut?Object(ut.call(t)):{}}var on=nn,ln=Je;function cn(t,s){var a=s?ln(t.buffer):t.buffer;return new t.constructor(a,t.byteOffset,t.length)}var dn=cn,hn=Je,un=tn,mn=rn,fn=on,xn=dn,gn="[object Boolean]",pn="[object Date]",vn="[object Map]",yn="[object Number]",jn="[object RegExp]",bn="[object Set]",Nn="[object String]",wn="[object Symbol]",Sn="[object ArrayBuffer]",Cn="[object DataView]",An="[object Float32Array]",Tn="[object Float64Array]",kn="[object Int8Array]",$n="[object Int16Array]",En="[object Int32Array]",_n="[object Uint8Array]",Mn="[object Uint8ClampedArray]",On="[object Uint16Array]",Ln="[object Uint32Array]";function In(t,s,a){var r=t.constructor;switch(s){case Sn:return hn(t);case gn:case pn:return new r(+t);case Cn:return un(t,a);case An:case Tn:case kn:case $n:case En:case _n:case Mn:case On:case Ln:return xn(t,a);case vn:return new r;case yn:case Nn:return new r(t);case jn:return mn(t);case bn:return new r;case wn:return fn(t)}}var Dn=In,Pn=Ge,mt=Object.create,Rn=function(){function t(){}return function(s){if(!Pn(s))return{};if(mt)return mt(s);t.prototype=s;var a=new t;return t.prototype=void 0,a}}(),Fn=Rn,Bn=Fn,Kn=Et,Un=kt;function Hn(t){return typeof t.constructor=="function"&&!Un(t)?Bn(Kn(t)):{}}var Vn=Hn,Wn=qe,zn=_t,Gn="[object Map]";function qn(t){return zn(t)&&Wn(t)==Gn}var Yn=qn,Qn=Yn,Jn=Ot,ft=Mt,xt=ft&&ft.isMap,Xn=xt?Jn(xt):Qn,Zn=Xn,ei=qe,ti=_t,ai="[object Set]";function si(t){return ti(t)&&ei(t)==ai}var ri=si,ni=ri,ii=Ot,gt=Mt,pt=gt&&gt.isSet,oi=pt?ii(pt):ni,li=oi,ci=cs,di=Js,hi=Kt,ui=cr,mi=Ar,fi=Tr,xi=$r,gi=Or,pi=Hr,vi=hs,yi=Ht,ji=qe,bi=Jr,Ni=Dn,wi=Vn,Si=us,Ci=ds,Ai=Zn,Ti=Ge,ki=li,$i=Tt,Ei=Qe,_i=1,Mi=2,Oi=4,Vt="[object Arguments]",Li="[object Array]",Ii="[object Boolean]",Di="[object Date]",Pi="[object Error]",Wt="[object Function]",Ri="[object GeneratorFunction]",Fi="[object Map]",Bi="[object Number]",zt="[object Object]",Ki="[object RegExp]",Ui="[object Set]",Hi="[object String]",Vi="[object Symbol]",Wi="[object WeakMap]",zi="[object ArrayBuffer]",Gi="[object DataView]",qi="[object Float32Array]",Yi="[object Float64Array]",Qi="[object Int8Array]",Ji="[object Int16Array]",Xi="[object Int32Array]",Zi="[object Uint8Array]",eo="[object Uint8ClampedArray]",to="[object Uint16Array]",ao="[object Uint32Array]",A={};A[Vt]=A[Li]=A[zi]=A[Gi]=A[Ii]=A[Di]=A[qi]=A[Yi]=A[Qi]=A[Ji]=A[Xi]=A[Fi]=A[Bi]=A[zt]=A[Ki]=A[Ui]=A[Hi]=A[Vi]=A[Zi]=A[eo]=A[to]=A[ao]=!0;A[Pi]=A[Wt]=A[Wi]=!1;function Ce(t,s,a,r,n,i){var l,o=s&_i,h=s&Mi,c=s&Oi;if(a&&(l=n?a(t,r,n,i):a(t)),l!==void 0)return l;if(!Ti(t))return t;var u=Si(t);if(u){if(l=bi(t),!o)return xi(t,l)}else{var d=ji(t),g=d==Wt||d==Ri;if(Ci(t))return fi(t,o);if(d==zt||d==Vt||g&&!n){if(l=h||g?{}:wi(t),!o)return h?pi(t,mi(l,t)):gi(t,ui(l,t))}else{if(!A[d])return n?t:{};l=Ni(t,d,o)}}i||(i=new ci);var p=i.get(t);if(p)return p;i.set(t,l),ki(t)?t.forEach(function(w){l.add(Ce(w,s,a,w,t,i))}):Ai(t)&&t.forEach(function(w,N){l.set(N,Ce(w,s,a,N,t,i))});var k=c?h?yi:vi:h?Ei:$i,y=u?void 0:k(t);return di(y||t,function(w,N){y&&(N=w,w=t[N]),hi(l,N,Ce(w,s,a,N,t,i))}),l}var so=Ce,ro=ms,no=fs;function io(t,s){return s.length<2?t:ro(t,no(s,0,-1))}var oo=io,lo=Lt,co=xs,ho=oo,uo=gs;function mo(t,s){return s=lo(s,t),t=ho(t,s),t==null||delete t[uo(co(s))]}var fo=mo,xo=ps;function go(t){return xo(t)?void 0:t}var po=go,vo=vs;function yo(t){var s=t==null?0:t.length;return s?vo(t,1):[]}var jo=yo,bo=jo,No=ys,wo=js;function So(t){return wo(No(t,void 0,bo),t+"")}var Co=So,Ao=bs,To=so,ko=fo,$o=Lt,Eo=ye,_o=po,Mo=Co,Oo=Ht,Lo=1,Io=2,Do=4,Po=Mo(function(t,s){var a={};if(t==null)return a;var r=!1;s=Ao(s,function(i){return i=$o(i,t),r||(r=i.length>1),i}),Eo(t,Oo(t),a),r&&(a=To(a,Lo|Io|Do,_o));for(var n=s.length;n--;)ko(a,s[n]);return a}),Ro=Po;const Fo=wa(Ro);var Bo=["#1890FF","#66B5FF","#41D9C7","#2FC25B","#6EDB8F","#9AE65C","#FACC14","#E6965C","#57AD71","#223273","#738AE6","#7564CC","#8543E0","#A877ED","#5C8EE6","#13C2C2","#70E0E0","#5CA3E6","#3436C7","#8082FF","#DD81E6","#F04864","#FA7D92","#D598D9"],Ko=["width","height","className","style","children","type"];function de(t){"@babel/helpers - typeof";return de=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},de(t)}function ke(){return ke=Object.assign?Object.assign.bind():function(t){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(t[r]=a[r])}return t},ke.apply(this,arguments)}function Uo(t,s){if(t==null)return{};var a=Ho(t,s),r,n;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],!(s.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(a[r]=t[r])}return a}function Ho(t,s){if(t==null)return{};var a={};for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){if(s.indexOf(r)>=0)continue;a[r]=t[r]}return a}function Vo(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}function vt(t,s){for(var a=0;a<s.length;a++){var r=s[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,qt(r.key),r)}}function Wo(t,s,a){return s&&vt(t.prototype,s),a&&vt(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function zo(t,s,a){return s=$e(s),Go(t,Gt()?Reflect.construct(s,a||[],$e(t).constructor):s.apply(t,a))}function Go(t,s){if(s&&(de(s)==="object"||typeof s=="function"))return s;if(s!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return qo(t)}function qo(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Gt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Gt=function(){return!!t})()}function $e(t){return $e=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(a){return a.__proto__||Object.getPrototypeOf(a)},$e(t)}function Yo(t,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(s&&s.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),s&&He(t,s)}function He(t,s){return He=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},He(t,s)}function yt(t,s){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);s&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),a.push.apply(a,r)}return a}function T(t){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?yt(Object(a),!0).forEach(function(r){J(t,r,a[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):yt(Object(a)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))})}return t}function J(t,s,a){return s=qt(s),s in t?Object.defineProperty(t,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[s]=a,t}function qt(t){var s=Qo(t,"string");return de(s)=="symbol"?s:s+""}function Qo(t,s){if(de(t)!="object"||!t)return t;var a=t[Symbol.toPrimitive];if(a!==void 0){var r=a.call(t,s||"default");if(de(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(t)}var ve="value",Fe=function t(s){var a=s.depth,r=s.node,n=s.index,i=s.valueKey,l=r.children,o=a+1,h=l&&l.length?l.map(function(u,d){return t({depth:o,node:u,index:d,valueKey:i})}):null,c;return l&&l.length?c=h.reduce(function(u,d){return u+d[ve]},0):c=It(r[i])||r[i]<=0?0:r[i],T(T({},r),{},J(J(J({children:h},ve,c),"depth",a),"index",n))},Jo=function(s){return{x:s.x,y:s.y,width:s.width,height:s.height}},Xo=function(s,a){var r=a<0?0:a;return s.map(function(n){var i=n[ve]*r;return T(T({},n),{},{area:It(i)||i<=0?0:i})})},Zo=function(s,a,r){var n=a*a,i=s.area*s.area,l=s.reduce(function(c,u){return{min:Math.min(c.min,u.area),max:Math.max(c.max,u.area)}},{min:1/0,max:0}),o=l.min,h=l.max;return i?Math.max(n*h*r/i,i/(n*o*r)):1/0},el=function(s,a,r,n){var i=a?Math.round(s.area/a):0;(n||i>r.height)&&(i=r.height);for(var l=r.x,o,h=0,c=s.length;h<c;h++)o=s[h],o.x=l,o.y=r.y,o.height=i,o.width=Math.min(i?Math.round(o.area/i):0,r.x+r.width-l),l+=o.width;return o.width+=r.x+r.width-l,T(T({},r),{},{y:r.y+i,height:r.height-i})},tl=function(s,a,r,n){var i=a?Math.round(s.area/a):0;(n||i>r.width)&&(i=r.width);for(var l=r.y,o,h=0,c=s.length;h<c;h++)o=s[h],o.x=r.x,o.y=l,o.width=i,o.height=Math.min(i?Math.round(o.area/i):0,r.y+r.height-l),l+=o.height;return o&&(o.height+=r.y+r.height-l),T(T({},r),{},{x:r.x+i,width:r.width-i})},jt=function(s,a,r,n){return a===r.width?el(s,a,r,n):tl(s,a,r,n)},Be=function t(s,a){var r=s.children;if(r&&r.length){var n=Jo(s),i=[],l=1/0,o,h,c=Math.min(n.width,n.height),u=Xo(r,n.width*n.height/s[ve]),d=u.slice();for(i.area=0;d.length>0;)i.push(o=d[0]),i.area+=o.area,h=Zo(i,c,a),h<=l?(d.shift(),l=h):(i.area-=i.pop().area,n=jt(i,c,n,!1),c=Math.min(n.width,n.height),i.length=i.area=0,l=1/0);return i.length&&(n=jt(i,c,n,!0),i.length=i.area=0),T(T({},s),{},{children:u.map(function(g){return t(g,a)})})}return s},al={isTooltipActive:!1,isAnimationFinished:!1,activeNode:null,formatRoot:null,currentRoot:null,nestIndex:[]},Xe=function(t){function s(){var a;Vo(this,s);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return a=zo(this,s,[].concat(n)),J(a,"state",T({},al)),J(a,"handleAnimationEnd",function(){var l=a.props.onAnimationEnd;a.setState({isAnimationFinished:!0}),we(l)&&l()}),J(a,"handleAnimationStart",function(){var l=a.props.onAnimationStart;a.setState({isAnimationFinished:!1}),we(l)&&l()}),a}return Yo(s,t),Wo(s,[{key:"handleMouseEnter",value:function(r,n){n.persist();var i=this.props,l=i.onMouseEnter,o=i.children,h=Pe(o,V);h?this.setState({isTooltipActive:!0,activeNode:r},function(){l&&l(r,n)}):l&&l(r,n)}},{key:"handleMouseLeave",value:function(r,n){n.persist();var i=this.props,l=i.onMouseLeave,o=i.children,h=Pe(o,V);h?this.setState({isTooltipActive:!1,activeNode:null},function(){l&&l(r,n)}):l&&l(r,n)}},{key:"handleClick",value:function(r){var n=this.props,i=n.onClick,l=n.type;if(l==="nest"&&r.children){var o=this.props,h=o.width,c=o.height,u=o.dataKey,d=o.aspectRatio,g=Fe({depth:0,node:T(T({},r),{},{x:0,y:0,width:h,height:c}),index:0,valueKey:u}),p=Be(g,d),k=this.state.nestIndex;k.push(r),this.setState({formatRoot:p,currentRoot:g,nestIndex:k})}i&&i(r)}},{key:"handleNestIndex",value:function(r,n){var i=this.state.nestIndex,l=this.props,o=l.width,h=l.height,c=l.dataKey,u=l.aspectRatio,d=Fe({depth:0,node:T(T({},r),{},{x:0,y:0,width:o,height:h}),index:0,valueKey:c}),g=Be(d,u);i=i.slice(0,n+1),this.setState({formatRoot:g,currentRoot:r,nestIndex:i})}},{key:"renderItem",value:function(r,n,i){var l=this,o=this.props,h=o.isAnimationActive,c=o.animationBegin,u=o.animationDuration,d=o.animationEasing,g=o.isUpdateAnimationActive,p=o.type,k=o.animationId,y=o.colorPanel,w=this.state.isAnimationFinished,N=n.width,_=n.height,M=n.x,K=n.y,ee=n.depth,U=parseInt("".concat((Math.random()*2-1)*N),10),I={};return(i||p==="nest")&&(I={onMouseEnter:this.handleMouseEnter.bind(this,n),onMouseLeave:this.handleMouseLeave.bind(this,n),onClick:this.handleClick.bind(this,n)}),h?O.createElement(st,{begin:c,duration:u,isActive:h,easing:d,key:"treemap-".concat(k),from:{x:M,y:K,width:N,height:_},to:{x:M,y:K,width:N,height:_},onAnimationStart:this.handleAnimationStart,onAnimationEnd:this.handleAnimationEnd},function(v){var f=v.x,E=v.y,D=v.width,P=v.height;return O.createElement(st,{from:"translate(".concat(U,"px, ").concat(U,"px)"),to:"translate(0, 0)",attributeName:"transform",begin:c,easing:d,isActive:h,duration:u},O.createElement(Re,I,function(){return ee>2&&!w?null:l.constructor.renderContentItem(r,T(T({},n),{},{isAnimationActive:h,isUpdateAnimationActive:!g,width:D,height:P,x:f,y:E}),p,y)}()))}):O.createElement(Re,I,this.constructor.renderContentItem(r,T(T({},n),{},{isAnimationActive:!1,isUpdateAnimationActive:!1,width:N,height:_,x:M,y:K}),p,y))}},{key:"renderNode",value:function(r,n){var i=this,l=this.props,o=l.content,h=l.type,c=T(T(T({},rt(this.props,!1)),n),{},{root:r}),u=!n.children||!n.children.length,d=this.state.currentRoot,g=(d.children||[]).filter(function(p){return p.depth===n.depth&&p.name===n.name});return!g.length&&r.depth&&h==="nest"?null:O.createElement(Re,{key:"recharts-treemap-node-".concat(c.x,"-").concat(c.y,"-").concat(c.name),className:"recharts-treemap-depth-".concat(n.depth)},this.renderItem(o,c,u),n.children&&n.children.length?n.children.map(function(p){return i.renderNode(n,p)}):null)}},{key:"renderAllNodes",value:function(){var r=this.state.formatRoot;return r?this.renderNode(r,r):null}},{key:"renderTooltip",value:function(){var r=this.props,n=r.children,i=r.nameKey,l=Pe(n,V);if(!l)return null;var o=this.props,h=o.width,c=o.height,u=this.state,d=u.isTooltipActive,g=u.activeNode,p={x:0,y:0,width:h,height:c},k=g?{x:g.x+g.width/2,y:g.y+g.height/2}:null,y=d&&g?[{payload:g,name:nt(g,i,""),value:nt(g,ve)}]:[];return O.cloneElement(l,{viewBox:p,active:d,coordinate:k,label:"",payload:y})}},{key:"renderNestIndex",value:function(){var r=this,n=this.props,i=n.nameKey,l=n.nestIndexContent,o=this.state.nestIndex;return O.createElement("div",{className:"recharts-treemap-nest-index-wrapper",style:{marginTop:"8px",textAlign:"center"}},o.map(function(h,c){var u=Ss(h,i,"root"),d=null;return O.isValidElement(l)&&(d=O.cloneElement(l,h,c)),we(l)?d=l(h,c):d=u,O.createElement("div",{onClick:r.handleNestIndex.bind(r,h,c),key:"nest-index-".concat(Cs()),className:"recharts-treemap-nest-index-box",style:{cursor:"pointer",display:"inline-block",padding:"0 7px",background:"#000",color:"#fff",marginRight:"3px"}},d)}))}},{key:"render",value:function(){if(!As(this))return null;var r=this.props,n=r.width,i=r.height,l=r.className,o=r.style,h=r.children,c=r.type,u=Uo(r,Ko),d=rt(u,!1);return O.createElement("div",{className:Sa("recharts-wrapper",l),style:T(T({},o),{},{position:"relative",cursor:"default",width:n,height:i}),role:"region"},O.createElement(Ts,ke({},d,{width:n,height:c==="nest"?i-30:i}),this.renderAllNodes(),ks(h)),this.renderTooltip(),c==="nest"&&this.renderNestIndex())}}],[{key:"getDerivedStateFromProps",value:function(r,n){if(r.data!==n.prevData||r.type!==n.prevType||r.width!==n.prevWidth||r.height!==n.prevHeight||r.dataKey!==n.prevDataKey||r.aspectRatio!==n.prevAspectRatio){var i=Fe({depth:0,node:{children:r.data,x:0,y:0,width:r.width,height:r.height},index:0,valueKey:r.dataKey}),l=Be(i,r.aspectRatio);return T(T({},n),{},{formatRoot:l,currentRoot:i,nestIndex:[i],prevAspectRatio:r.aspectRatio,prevData:r.data,prevWidth:r.width,prevHeight:r.height,prevDataKey:r.dataKey,prevType:r.type})}return null}},{key:"renderContentItem",value:function(r,n,i,l){if(O.isValidElement(r))return O.cloneElement(r,n);if(we(r))return r(n);var o=n.x,h=n.y,c=n.width,u=n.height,d=n.index,g=null;c>10&&u>10&&n.children&&i==="nest"&&(g=O.createElement(Ms,{points:[{x:o+2,y:h+u/2},{x:o+6,y:h+u/2+3},{x:o+2,y:h+u/2+6}]}));var p=null,k=Ns(n.name);c>20&&u>20&&k.width<c&&k.height<u&&(p=O.createElement("text",{x:o+8,y:h+u/2+7,fontSize:14},n.name));var y=l||Bo;return O.createElement("g",null,O.createElement(ws,ke({fill:n.depth<2?y[d%y.length]:"rgba(255,255,255,0)",stroke:"#fff"},Fo(n,"children"),{role:"img"})),g,p)}}])}(m.PureComponent);J(Xe,"displayName","Treemap");J(Xe,"defaultProps",{aspectRatio:.5*(1+Math.sqrt(5)),dataKey:"value",type:"flat",isAnimationActive:!it.isSsr,isUpdateAnimationActive:!it.isSsr,animationBegin:0,animationDuration:1500,animationEasing:"linear"});var sl=$s({chartName:"ScatterChart",GraphicalChild:We,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:ie},{axisType:"yAxis",AxisComp:re},{axisType:"zAxis",AxisComp:Ga}],formatAxisMap:Es}),_e="Tabs",[rl,Xl]=Ca(_e,[Ct]),Yt=Ct(),[nl,Ze]=rl(_e),Qt=m.forwardRef((t,s)=>{const{__scopeTabs:a,value:r,onValueChange:n,defaultValue:i,orientation:l="horizontal",dir:o,activationMode:h="automatic",...c}=t,u=Aa(o),[d,g]=Ta({prop:r,onChange:n,defaultProp:i??"",caller:_e});return e.jsx(nl,{scope:a,baseId:ka(),value:d,onValueChange:g,orientation:l,dir:u,activationMode:h,children:e.jsx(Ee.div,{dir:u,"data-orientation":l,...c,ref:s})})});Qt.displayName=_e;var Jt="TabsList",Xt=m.forwardRef((t,s)=>{const{__scopeTabs:a,loop:r=!0,...n}=t,i=Ze(Jt,a),l=Yt(a);return e.jsx(Va,{asChild:!0,...l,orientation:i.orientation,dir:i.dir,loop:r,children:e.jsx(Ee.div,{role:"tablist","aria-orientation":i.orientation,...n,ref:s})})});Xt.displayName=Jt;var Zt="TabsTrigger",ea=m.forwardRef((t,s)=>{const{__scopeTabs:a,value:r,disabled:n=!1,...i}=t,l=Ze(Zt,a),o=Yt(a),h=sa(l.baseId,r),c=ra(l.baseId,r),u=r===l.value;return e.jsx(Wa,{asChild:!0,...o,focusable:!n,active:u,children:e.jsx(Ee.button,{type:"button",role:"tab","aria-selected":u,"aria-controls":c,"data-state":u?"active":"inactive","data-disabled":n?"":void 0,disabled:n,id:h,...i,ref:s,onMouseDown:De(t.onMouseDown,d=>{!n&&d.button===0&&d.ctrlKey===!1?l.onValueChange(r):d.preventDefault()}),onKeyDown:De(t.onKeyDown,d=>{[" ","Enter"].includes(d.key)&&l.onValueChange(r)}),onFocus:De(t.onFocus,()=>{const d=l.activationMode!=="manual";!u&&!n&&d&&l.onValueChange(r)})})})});ea.displayName=Zt;var ta="TabsContent",aa=m.forwardRef((t,s)=>{const{__scopeTabs:a,value:r,forceMount:n,children:i,...l}=t,o=Ze(ta,a),h=sa(o.baseId,r),c=ra(o.baseId,r),u=r===o.value,d=m.useRef(u);return m.useEffect(()=>{const g=requestAnimationFrame(()=>d.current=!1);return()=>cancelAnimationFrame(g)},[]),e.jsx($a,{present:n||u,children:({present:g})=>e.jsx(Ee.div,{"data-state":u?"active":"inactive","data-orientation":o.orientation,role:"tabpanel","aria-labelledby":h,hidden:!g,id:c,tabIndex:0,...l,ref:s,style:{...t.style,animationDuration:d.current?"0s":void 0},children:g&&i})})});aa.displayName=ta;function sa(t,s){return`${t}-trigger-${s}`}function ra(t,s){return`${t}-content-${s}`}var il=Qt,na=Xt,ia=ea,oa=aa;const et=il,Me=m.forwardRef(({className:t,...s},a)=>e.jsx(na,{ref:a,className:Ve("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...s}));Me.displayName=na.displayName;const H=m.forwardRef(({className:t,...s},a)=>e.jsx(ia,{ref:a,className:Ve("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...s}));H.displayName=ia.displayName;const Y=m.forwardRef(({className:t,...s},a)=>e.jsx(oa,{ref:a,className:Ve("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...s}));Y.displayName=oa.displayName;const ol=({active:t,payload:s,label:a,metric:r})=>{if(t&&s&&s.length){const n=["clients","employees","shifts","hours","targetAchievement","missedTargets"].includes(r),i=s[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:a}),e.jsx("p",{className:"text-sm",children:n?i.toLocaleString():i.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},Ke=({data:t,metric:s,onBarClick:a})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Pt,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(he,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(ie,{type:"number",hide:!0}),e.jsx(re,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(V,{content:e.jsx(ol,{metric:s})}),e.jsx(Q,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:a,children:t.map((r,n)=>e.jsx(Ye,{fill:"hsl(var(--primary))",fillOpacity:.8+n*.05},`cell-${n}`))})]})})})})}),bt=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ll=({active:t,payload:s,metric:a})=>{if(t&&s&&s.length){const r=["revenue","costs","profit","overheads"].includes(a);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:s[0].name}),e.jsx("p",{className:"text-sm",children:r?Number(s[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(s[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(s[0].payload.percentage||0).toFixed(1)}%`})]})}return null},Se=({data:t,metric:s})=>{if(!t||t.length===0)return e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const a=[...t].sort((i,l)=>l.value-i.value),r=a.reduce((i,l)=>i+l.value,0),n=a.map(i=>({...i,percentage:r>0?i.value/r*100:0}));return e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Os,{children:[e.jsx(Ls,{data:n,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:n.map((i,l)=>e.jsx(Ye,{fill:bt[l%bt.length]},`cell-${l}`))}),e.jsx(V,{content:e.jsx(ll,{metric:s})}),e.jsx(Dt,{})]})})})})})},cl=({data:t,onEdit:s,onDelete:a})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Overheads Details"})}),e.jsx(B,{children:e.jsxs(Rt,{children:[e.jsx(Ft,{children:e.jsxs(Ae,{children:[e.jsx(W,{children:"Title"}),e.jsx(W,{children:"Month"}),e.jsx(W,{children:"Location"}),e.jsx(W,{children:"Site"}),e.jsx(W,{className:"text-right",children:"Amount"}),e.jsx(W,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Bt,{children:t.map(r=>e.jsxs(Ae,{children:[e.jsx(z,{className:"font-medium",children:r.name}),e.jsxs(z,{children:[r.month," ",r.year]}),e.jsx(z,{children:r.location||"-"}),e.jsx(z,{children:r.site||"-"}),e.jsx(z,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(z,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>s(r),children:e.jsx(Is,{className:"h-4 w-4"})}),e.jsx(se,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>a(r.id),children:e.jsx(Ds,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),dl=t=>{const s=[];for(let a=0;a<t;a++)s.push(a*360/t%360);return s.map(a=>`hsl(${a}, 70%, 60%)`)},hl=({active:t,payload:s})=>{if(t&&s&&s.length){const a=s[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:a.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",a.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",a.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",a.avgRevenue.toLocaleString()]})]}),a.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:a.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",a.hoveredClient.revenue.toLocaleString()]})]})]})}return null},ul=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const s=t.map(a=>{const r=dl(a.clients.length);return{tierName:a.name,totalRevenue:a.value,clientCount:a.clientCount,avgRevenue:a.avgRevenue,clients:a.clients,colors:r}});return e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Pt,{data:s,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(he,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(ie,{type:"number",hide:!0}),e.jsx(re,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(V,{content:e.jsx(hl,{})}),s.map((a,r)=>a.clients.map((n,i)=>e.jsx(Q,{dataKey:()=>n.revenue,stackId:r,fill:a.colors[i],radius:i===a.clients.length-1?[0,4,4,0]:[0,0,0,0],children:s.map((l,o)=>{const h=o===r;return e.jsx(Ye,{fill:h?a.colors[i]:"transparent",stroke:h?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:c=>{h&&(c.target.style.opacity="0.8")},onMouseLeave:c=>{h&&(c.target.style.opacity="1")}},`cell-${r}-${i}-${o}`)})},`${r}-${i}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:s.map((a,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:a.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:a.clients.map((n,i)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:a.colors[i]}}),e.jsx("span",{className:"truncate",title:`${n.name}: £${n.revenue.toLocaleString()}`,children:n.name})]},i))})]},r))})]})]})},ml=({active:t,payload:s})=>{if(t&&s&&s.length){const a=s[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:a.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",a.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",a.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",a.shiftCount]})]})]})}return null},fl=({data:t,medianHours:s,medianStaff:a})=>!t||t.length===0?e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Client Workload vs Staff Coverage"})}),e.jsx(B,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(sl,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(he,{strokeDasharray:"3 3"}),e.jsx(ie,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(ot,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(re,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(ot,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(V,{content:e.jsx(ml,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(lt,{x:s,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(lt,{y:a,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(We,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:s.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(a)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,n)=>r+n.shiftCount,0).toLocaleString()})]})]})]})]}),xl=({dateRange:t,locations:s=[],sites:a=[]})=>{const[r,n]=m.useState("calendar"),[i,l]=m.useState([]),[o,h]=m.useState([]),[c,u]=m.useState([]),[d,g]=m.useState([]),[p,k]=m.useState(!1),[y,w]=m.useState(33),[N,_]=m.useState(67),[M,K]=m.useState(!1);m.useEffect(()=>{(async()=>{k(!0);try{const f=new URLSearchParams({start:$(t.from,"yyyy-MM-dd"),end:$(t.to,"yyyy-MM-dd"),view_type:r});s&&s.length>0&&s.forEach(oe=>f.append("locations",oe)),a&&a.length>0&&a.forEach(oe=>f.append("sites",oe));const E={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},D=await fetch(`/api/dashboard/shifts-heatmap?${f.toString()}`,{headers:E,credentials:"include"});if(!D.ok){console.error(`Heatmap API returned ${D.status}`);return}const P=await D.json();P.view_type==="calendar"?l(P.data||[]):(h(P.data||[]),u(P.locations||[]),g(P.dates||[]))}catch(f){console.error("Error fetching heatmap data:",f)}finally{k(!1)}})()},[t,s,a,r]);const ee=()=>Math.max(...r==="calendar"?i.map(v=>v.shift_count):o.map(v=>v.shift_count),1),U=v=>{const f=ee(),E=v/f*100;return E===0?"#f8f9fa":E<y?"#d4edda":E<N?"#fff3cd":"#f8d7da"},I=(v,f)=>{const E=o.find(D=>D.location===v&&D.date===f);return E?E.shift_count:0};return e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"}),e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(L,{className:"font-semibold",children:"Intensity Thresholds (%)"}),e.jsx(se,{variant:"outline",size:"sm",onClick:()=>K(!M),children:M?"Done":"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Low (","<"," ",y,"%)"]}),M?e.jsx(ae,{type:"number",min:"0",max:"100",value:y,onChange:v=>w(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsxs("span",{className:"text-sm",children:["0-",y,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Medium (",y,"-",N,"%)"]}),M?e.jsx(ae,{type:"number",min:"0",max:"100",value:N,onChange:v=>_(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsxs("span",{className:"text-sm",children:[y,"-",N,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["High (",">="," ",N,"%)"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsxs("span",{className:"text-sm",children:[N,"-100%"]})]})]})]})]})]}),e.jsx(B,{children:e.jsxs(et,{value:r,onValueChange:v=>n(v),children:[e.jsxs(Me,{className:"mb-4",children:[e.jsx(H,{value:"calendar",children:"Calendar View"}),e.jsx(H,{value:"location_day",children:"By Location"})]}),e.jsx(Y,{value:"calendar",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):i.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:i.map((v,f)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:U(v.shift_count)},title:`${v.date} (${v.day_of_week}): ${v.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:$(new Date(v.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:v.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:v.shift_count})]},f))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(Y,{value:"location_day",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):c.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-scroll max-w-full",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"border-collapse",style:{minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),d.slice(0,31).map((v,f)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:$(new Date(v),"MMM d")},f))]})}),e.jsx("tbody",{children:c.map((v,f)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:v}),d.slice(0,31).map((E,D)=>{const P=I(v,E);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:U(P)},title:`${v} - ${E}: ${P} shifts`,children:P>0?P:""},D)})]},f))})]})}),d.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},gl=t=>{const{x:s,y:a,width:r,height:n,stroke:i,fill:l,payload:o}=t;if(!o||!o.median||n===0)return null;const h=n/o.median,c=a+n,u=_=>c-_*h,d=u(o.min),g=u(o.q1),p=u(o.median),k=u(o.q3),y=u(o.max),w=s+r/2,N=r/2;return e.jsxs("g",{children:[e.jsx("line",{x1:w,y1:y,x2:w,y2:d,stroke:i,strokeWidth:1}),e.jsx("line",{x1:w-N/2,y1:y,x2:w+N/2,y2:y,stroke:i,strokeWidth:1}),e.jsx("line",{x1:w-N/2,y1:d,x2:w+N/2,y2:d,stroke:i,strokeWidth:1}),e.jsx("rect",{x:s,y:k,width:r,height:Math.abs(g-k),stroke:i,fill:l,fillOpacity:.6}),e.jsx("line",{x1:s,y1:p,x2:s+r,y2:p,stroke:i,strokeWidth:2}),o.outliers&&o.outliers.map((_,M)=>e.jsx("circle",{cx:w,cy:u(_),r:2,fill:"#ef4444",opacity:.6},M))]})},pl=({active:t,payload:s,label:a})=>{if(t&&s&&s.length){const r=s[0].payload;return e.jsxs("div",{className:"bg-popover border text-popover-foreground p-3 rounded-lg shadow-md text-sm",children:[e.jsx("p",{className:"font-semibold mb-2",children:r.name}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Max:"}),e.jsxs("span",{className:"font-medium",children:[r.max.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q3 (75%):"}),e.jsxs("span",{className:"font-medium",children:[r.q3.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Median:"}),e.jsxs("span",{className:"font-medium text-primary",children:[r.median.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q1 (25%):"}),e.jsxs("span",{className:"font-medium",children:[r.q1.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Min:"}),e.jsxs("span",{className:"font-medium",children:[r.min.toFixed(1),"h"]})]}),r.outliers.length>0&&e.jsxs("div",{className:"flex justify-between gap-4 pt-1 border-t mt-1",children:[e.jsx("span",{className:"text-destructive",children:"Outliers:"}),e.jsx("span",{className:"font-medium",children:r.outliers.length})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 pt-1 border-t",children:["Sample size: ",r.count," shifts"]})]})]})}return null},vl=({dateRange:t,limit:s=15})=>{const[a,r]=m.useState("client"),[n,i]=m.useState([]),[l,o]=m.useState(!1);return m.useEffect(()=>{(async()=>{o(!0);try{const c=new URLSearchParams({start:$(t.from,"yyyy-MM-dd"),end:$(t.to,"yyyy-MM-dd"),dimension:a,limit:s.toString()}),u={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},d=await fetch(`${ce.HOURS_DISTRIBUTION}?${c.toString()}`,{headers:u});if(d.ok){const g=await d.json();i(g)}}catch(c){console.error("Error fetching distribution data:",c)}finally{o(!1)}})()},[t,a,s]),e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Hours Distribution"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Showing spread of shift durations. Box represents middle 50% of data."})]}),e.jsx(B,{children:e.jsxs(et,{value:a,onValueChange:h=>r(h),children:[e.jsxs(Me,{className:"mb-6",children:[e.jsx(H,{value:"client",children:"By Client"}),e.jsx(H,{value:"site",children:"By Site"})]}),e.jsxs("div",{className:"h-[400px] w-full",children:[l?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"Loading distribution data..."}):n.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No data available for selected period"}):e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(ze,{data:n,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(he,{strokeDasharray:"3 3",vertical:!1,opacity:.3}),e.jsx(ie,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:{fontSize:12}}),e.jsx(re,{label:{value:"Hours Worked",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(V,{content:e.jsx(pl,{}),cursor:{fill:"transparent"}}),e.jsx(Q,{dataKey:"max",fill:"transparent",barSize:1}),e.jsx(Q,{dataKey:"median",shape:gl,fill:"#3b82f6",stroke:"#1e40af",barSize:40})]})}),!l&&n.length>0&&e.jsx("div",{className:"text-center text-xs text-muted-foreground mt-2",children:"* Whiskers extend to 1.5x IQR. Dots represent outliers."})]})]})})]})},yl=t=>{const{cx:s,cy:a,payload:r}=t;if(!s||!a)return null;const n=20;return e.jsx("line",{x1:s,y1:a-n/2,x2:s,y2:a+n/2,stroke:"#000",strokeWidth:3})},jl=({active:t,payload:s,label:a})=>{if(t&&s&&s.length){const r=s.find(i=>i.dataKey==="actual"),n=r?r.payload:s[0].payload;return e.jsxs("div",{className:"bg-white p-3 border rounded shadow-lg text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:n.name}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[e.jsx("span",{className:"text-gray-500",children:"Actual:"}),e.jsx("span",{className:"font-mono font-medium",children:n.actual}),e.jsx("span",{className:"text-gray-500",children:"Target:"}),e.jsx("span",{className:"font-mono font-medium",children:n.target}),e.jsx("span",{className:"text-gray-500",children:"Achievement:"}),e.jsxs("span",{className:`font-mono font-bold ${n.achievement>=100?"text-green-600":n.achievement>=80?"text-yellow-600":"text-red-600"}`,children:[n.achievement,"%"]})]})]})}return null},bl=({dateRange:t,limit:s=15,dimension:a="site"})=>{const[r,n]=m.useState([]),[i,l]=m.useState(!1);return m.useEffect(()=>{(async()=>{if(!(!(t!=null&&t.from)||!(t!=null&&t.to))){l(!0);try{const h=$(t.from,"yyyy-MM-dd"),c=$(t.to,"yyyy-MM-dd"),u=localStorage.getItem("auth_token"),d=await fetch(`${ce.TARGET_ACHIEVEMENT_BULLET}?start=${h}&end=${c}&dimension=${a}&limit=${s}`,{headers:{Authorization:`Bearer ${u}`}});if(d.ok){const g=await d.json();n(g)}}catch(h){console.error("Error fetching bullet chart data:",h)}finally{l(!1)}}})()},[t,s,a]),i?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center",children:"Loading chart data..."}):r.length?e.jsxs("div",{className:"w-full",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Target Achievement by ",a==="client"?"Client":"Site"]}),e.jsx("div",{className:"h-[600px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(ze,{layout:"vertical",data:r,margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(he,{stroke:"#f5f5f5",horizontal:!0,vertical:!0}),e.jsx(ie,{type:"number"}),e.jsx(re,{type:"category",dataKey:"name",width:100,tick:{fontSize:12}}),e.jsx(V,{content:e.jsx(jl,{}),cursor:{fill:"transparent"}}),e.jsx(Q,{dataKey:"range_poor",stackId:"ranges",fill:"#fee2e2",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"range_good",stackId:"ranges",fill:"#fef3c7",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"range_excellent",stackId:"ranges",fill:"#dcfce7",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"actual",barSize:12,fill:"#1f2937"}),e.jsx(We,{dataKey:"marker",shape:e.jsx(yl,{}),legendType:"none"})]})})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-red-100 border border-red-200 block"}),e.jsx("span",{children:"Poor (<80%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-200 block"}),e.jsx("span",{children:"Good (80-95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-green-100 border border-green-200 block"}),e.jsx("span",{children:"Excellent (>95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-1 bg-gray-800 block"}),e.jsx("span",{children:"Actual"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1 h-3 bg-black block"}),e.jsx("span",{children:"Target"})]})]})]}):e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-gray-500",children:"No data available for this period"})},Nl={low:10,midLow:20,mid:30,high:40},pe=["#ef4444","#f97316","#eab308","#84cc16","#22c55e"],Nt=({data:t,title:s="Revenue Composition (Margin Color-Coded)"})=>{const[a,r]=m.useState(Nl),n=o=>o<a.low?pe[0]:o<a.midLow?pe[1]:o<a.mid?pe[2]:o<a.high?pe[3]:pe[4],i=o=>{const{root:h,depth:c,x:u,y:d,width:g,height:p,index:k,payload:y,colors:w,rank:N,name:_,margin:M}=o;return e.jsxs("g",{children:[e.jsx("rect",{x:u,y:d,width:g,height:p,style:{fill:n(M),stroke:"#fff",strokeWidth:2/(c+1e-10),strokeOpacity:1/(c+1e-10)}}),g>50&&p>30&&e.jsx("text",{x:u+g/2,y:d+p/2,textAnchor:"middle",fill:"#fff",fontSize:12,style:{pointerEvents:"none"},children:_})]})},l=({active:o,payload:h})=>{var c;if(o&&h&&h.length){const u=h[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:u.name}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Revenue:"}),e.jsxs("span",{className:"font-mono",children:["£",u.revenue.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cost:"}),e.jsxs("span",{className:"font-mono",children:["£",(c=u.cost)==null?void 0:c.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Profit:"}),e.jsxs("span",{className:`font-mono ${u.profit>=0?"text-green-600":"text-red-600"}`,children:["£",u.profit.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4 border-t pt-1 mt-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Margin:"}),e.jsxs("span",{className:`font-mono font-bold ${u.margin>=0?"text-green-600":"text-red-600"}`,children:[u.margin.toFixed(1),"%"]})]})]})]})}return null};return!t||t.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"}):e.jsxs(F,{children:[e.jsxs(X,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(Z,{className:"text-base font-medium",children:s}),e.jsxs(Ps,{children:[e.jsx(Rs,{asChild:!0,children:e.jsx(se,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(Ys,{className:"h-4 w-4"})})}),e.jsx(Fs,{className:"w-80",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium leading-none",children:"Margin Thresholds (%)"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Adjust color coding boundaries."})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"low",children:"Low (Red)"}),e.jsx(ae,{id:"low",type:"number",className:"col-span-2 h-8",value:a.low,onChange:o=>r({...a,low:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"midLow",children:"Mid-Low (Org)"}),e.jsx(ae,{id:"midLow",type:"number",className:"col-span-2 h-8",value:a.midLow,onChange:o=>r({...a,midLow:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"mid",children:"Mid (Ylw)"}),e.jsx(ae,{id:"mid",type:"number",className:"col-span-2 h-8",value:a.mid,onChange:o=>r({...a,mid:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"high",children:"High (Lime)"}),e.jsx(ae,{id:"high",type:"number",className:"col-span-2 h-8",value:a.high,onChange:o=>r({...a,high:Number(o.target.value)})})]})]})]})})]})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsx(Xe,{data:t,dataKey:"size",aspectRatio:4/3,stroke:"#fff",fill:"#8884d8",content:e.jsx(i,{}),children:e.jsx(V,{content:e.jsx(l,{})})})})}),e.jsxs("div",{className:"mt-4 flex flex-wrap justify-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsxs("span",{children:["< ",a.low,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-orange-500"}),e.jsxs("span",{children:[a.low,"-",a.midLow,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsxs("span",{children:[a.midLow,"-",a.mid,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-lime-500"}),e.jsxs("span",{children:[a.mid,"-",a.high,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsxs("span",{children:["> ",a.high,"%"]})]})]})]})]})},wl=({active:t,payload:s,label:a})=>t&&s&&s.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:a}),s.map((r,n)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:r.color}}),e.jsxs("span",{className:"text-muted-foreground",children:[r.name==="value"?"Cost":"Cumulative %",":"]}),e.jsx("span",{className:"font-mono",children:r.name==="value"?`£${r.value.toLocaleString()}`:`${r.value}%`})]},n))]}):null,Sl=({data:t})=>!t||t.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"}):e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{className:"text-base font-medium",children:"Overheads Pareto Analysis (80/20 Rule)"})}),e.jsx(B,{children:e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(ze,{data:t,margin:{top:20,right:20,bottom:20,left:20},children:[e.jsx(he,{stroke:"#f5f5f5",vertical:!1}),e.jsx(ie,{dataKey:"name",scale:"band",tick:{fontSize:12},interval:0,angle:-20,textAnchor:"end",height:60}),e.jsx(re,{yAxisId:"left",orientation:"left",tickFormatter:s=>`£${s}`,stroke:"#8884d8"}),e.jsx(re,{yAxisId:"right",orientation:"right",domain:[0,100],tickFormatter:s=>`${s}%`,stroke:"#ff7300"}),e.jsx(V,{content:e.jsx(wl,{})}),e.jsx(Dt,{}),e.jsx(Q,{yAxisId:"left",dataKey:"value",name:"Cost",barSize:40,fill:"#413ea0",radius:[4,4,0,0]}),e.jsx(_s,{yAxisId:"right",type:"monotone",dataKey:"cumulativePercentage",name:"Cumulative %",stroke:"#ff7300",strokeWidth:2,dot:{r:4}})]})})})})]}),Ue=["January","February","March","April","May","June","July","August","September","October","November","December"],wt=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Cl=({open:t,onOpenChange:s,initialData:a,onSave:r})=>{var I,v;const{data:n}=zs(),[i,l]=m.useState(!1),[o,h]=m.useState(new Date().getFullYear()),[c,u]=m.useState(Ue[new Date().getMonth()]),[d,g]=m.useState(""),[p,k]=m.useState(""),[y,w]=m.useState(""),[N,_]=m.useState(""),[M,K]=m.useState("");m.useEffect(()=>{t&&(a?(h(a.year),u(a.month),g(a.location||""),k(a.site||""),K(a.value.toString()),wt.includes(a.name)?(w(a.name),_("")):(w("Custom..."),_(a.name))):(h(new Date().getFullYear()),u(Ue[new Date().getMonth()]),g(""),k(""),w(""),_(""),K("")))},[t,a]);const ee=async()=>{if(!d||!y||!M){te.error("Please fill in all required fields");return}const f=y==="Custom..."?N:y;if(!f){te.error("Please specify the overhead name");return}l(!0);try{await r({id:a==null?void 0:a.id,year:o,month:c,location:d,site:p||null,name:f,value:parseFloat(M)}),s(!1)}catch(E){console.error("Failed to save overhead:",E)}finally{l(!1)}},U=((I=n==null?void 0:n.jobs)==null?void 0:I.filter(f=>f.location===d&&f.site).map(f=>f.site).filter((f,E,D)=>D.indexOf(f)===E))||[];return e.jsx(Bs,{open:t,onOpenChange:s,children:e.jsxs(Ks,{className:"sm:max-w-[500px]",children:[e.jsxs(Us,{children:[e.jsx(Hs,{children:a?"Edit Overhead":"Add Overhead"}),e.jsx(Vs,{children:a?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Year"}),e.jsxs(me,{value:o.toString(),onValueChange:f=>h(Number(f)),children:[e.jsx(fe,{children:e.jsx(xe,{})}),e.jsx(ge,{children:[2024,2025,2026,2027,2028].map(f=>e.jsx(le,{value:f.toString(),children:f},f))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Month"}),e.jsxs(me,{value:c,onValueChange:u,children:[e.jsx(fe,{children:e.jsx(xe,{})}),e.jsx(ge,{children:Ue.map(f=>e.jsx(le,{value:f,children:f},f))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Location"}),e.jsxs(me,{value:d,onValueChange:f=>{g(f),k("")},children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:"Select location..."})}),e.jsx(ge,{children:Array.from(new Set((v=n==null?void 0:n.jobs)==null?void 0:v.map(f=>f.location).filter(Boolean))).map(f=>e.jsx(le,{value:f,children:f},f))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Site (Optional)"}),e.jsxs(me,{value:p,onValueChange:k,disabled:!d||U.length===0,children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:U.length===0?"No sites available":"Select site..."})}),e.jsxs(ge,{children:[e.jsx(le,{value:"all_sites",children:"All Sites (if applicable)"}),U.map(f=>e.jsx(le,{value:f,children:f},f))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Category"}),e.jsxs(me,{value:y,onValueChange:w,children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:"Select category..."})}),e.jsx(ge,{children:wt.map(f=>e.jsx(le,{value:f,children:f},f))})]})]}),y==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Custom Name"}),e.jsx(ae,{placeholder:"Enter overhead name",value:N,onChange:f=>_(f.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Value (£)"}),e.jsx(ae,{type:"number",placeholder:"0.00",value:M,onChange:f=>K(f.target.value)})]})]}),e.jsxs(Ws,{children:[e.jsx(se,{variant:"outline",onClick:()=>s(!1),children:"Cancel"}),e.jsxs(se,{onClick:ee,disabled:i,children:[i&&e.jsx(Ea,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Zl=()=>{const{metricId:t}=_a(),s=Ma(),{dateRange:a,setDateRange:r}=Oa(),{role:n}=La(),[i,l]=m.useState(!1),[o,h]=m.useState(a),[c,u]=m.useState([]),[d,g]=m.useState([]),[p,k]=m.useState("trend"),[y,w]=m.useState([]),[N,_]=m.useState([]),[M,K]=m.useState([]),[ee,U]=m.useState({hours:0,staffCount:0}),[I,v]=m.useState([]),[f,E]=m.useState(!1),[D,P]=m.useState([]),[oe,la]=m.useState([]);m.useEffect(()=>{if(t!=="revenue"&&t!=="cost"||p!=="trend")return;(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd"),metric:t});c&&c.forEach(b=>x.append("locations",b)),d&&d.forEach(b=>x.append("sites",b));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/client-margin-treemap?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();la(b)}}catch(x){console.error("Error fetching treemap:",x)}})()},[t,p,a,c,d]);const[ca,da]=m.useState([]);m.useEffect(()=>{if(t!=="overheads"||p!=="trend")return;(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd")});c&&c.forEach(b=>x.append("locations",b)),d&&d.forEach(b=>x.append("sites",b));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/overheads-pareto?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();da(b)}}catch(x){console.error("Error fetching pareto:",x)}})()},[t,p,a,c,d]);const[Al,ha]=m.useState([]);m.useEffect(()=>{if(t!=="profit"||p!=="trend")return;(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd")});c&&c.forEach(b=>x.append("locations",b)),d&&d.forEach(b=>x.append("sites",b));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/profit-variance?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();ha(b)}}catch(x){console.error("Error fetching profit variance:",x)}})()},[t,p,a,c,d]);const[ua,je]=m.useState(!1),[ma,tt]=m.useState(null),[be,Oe]=m.useState(null),Ne=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),Le=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),at=t==="overheads",Ie=n==="admin",{operationalData:G,isLoading:fa}=qa(a,c,d),{financialData:q,isLoading:xa}=Ja(a,c,d),ga=Ne?xa:Le?fa:!1;m.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd")}),C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`${ce.TARGETS_PERFORMANCE}?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();P(b)}}catch(x){console.error("Error fetching targets performance:",x)}})()},[a,t]),m.useEffect(()=>{if(p==="trend"||!t)return;(async()=>{E(!0);try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd"),metric:t,limit:"20"});c&&c.length>0&&c.forEach(j=>x.append("locations",j)),d&&d.length>0&&d.forEach(j=>x.append("sites",j));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(p==="details"&&at){const j=await fetch(`${ce.FINANCIAL_METRICS_LIST}?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();v(b)}}else if(["location","site","client"].includes(p)){x.append("dimension",p);const j=await fetch(`${ce.BREAKDOWN}?${x.toString()}`,{headers:C});if(j.ok){const b=await j.json();w(b)}}}catch(x){console.error("Error fetching breakdown:",x)}finally{E(!1)}})()},[p,t,a,c,d]),m.useEffect(()=>{t==="clients"&&p==="revenueTier"&&Ie&&(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd")});c&&c.length>0&&c.forEach(b=>x.append("locations",b)),d&&d.length>0&&d.forEach(b=>x.append("sites",b));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/client-revenue-tiers?${x.toString()}`,{headers:C});if(j.ok){const R=(await j.json()).tiers.map(ue=>({name:ue.tier,value:ue.totalRevenue,clientCount:ue.clientCount,avgRevenue:ue.avgRevenue,clients:ue.clients||[]}));_(R)}}catch(x){console.error("Error fetching revenue tiers:",x)}})()},[t,p,Ie,a,c,d]),m.useEffect(()=>{p==="trend"&&(async()=>{try{const x=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd")});c&&c.length>0&&c.forEach(R=>x.append("locations",R)),d&&d.length>0&&d.forEach(R=>x.append("sites",R));const C={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/client-workload-scatter?${x.toString()}`,{headers:C});if(!j.ok){console.error(`❌ Workload scatter API failed (${j.status}): /api/dashboard/client-workload-scatter`);const R=await j.text();console.error("Response preview:",R.substring(0,200));return}const b=await j.json();K(b.data||[]),U(b.medians||{hours:0,staffCount:0})}catch(x){console.error("Error fetching workload data:",x)}})()},[p,a,c,d]);const pa=()=>{tt(null),je(!0)},va=S=>{tt(S),je(!0)},ya=async()=>{if(be)try{const S=await fetch(`/api/admin/financial-metrics/${be}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(S.ok)te.success("Overhead deleted"),p==="details"&&v(x=>x.filter(C=>C.id!==be));else{const x=await S.json();te.error(x.error||"Failed to delete")}}catch(S){console.error(S),te.error("Failed to delete")}finally{Oe(null)}},ja=async S=>{try{const x=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(S)});if(x.ok){te.success("Overhead saved"),je(!1);const C=new URLSearchParams({start:$(a.from,"yyyy-MM-dd"),end:$(a.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});c&&c.forEach(R=>C.append("locations",R)),d&&d.forEach(R=>C.append("sites",R));const j={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`${ce.FINANCIAL_METRICS_LIST}?${C.toString()}`,{headers:j});if(b.ok){const R=await b.json();v(R)}}else{const C=await x.json();te.error(C.error||"Failed to save")}}catch(x){console.error(x),te.error("Failed to save")}},ba=S=>{switch(S){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},Na=m.useMemo(()=>{if(!I||I.length===0)return[];const S=I.reduce((x,C)=>{const j=C.name||"Unknown";return x[j]||(x[j]=0),x[j]+=C.value,x},{});return Object.entries(S).map(([x,C])=>({name:x,value:C}))},[I]);return Ne?q==null||q.timeSeries:G==null||G.timeSeries,e.jsx(Ha,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(za,{dateRange:a,onDateRangeChange:r,calendarOpen:i,onCalendarOpenChange:l,tempDateRange:o,onTempDateRangeChange:h,selectedLocations:c,onLocationsChange:u,selectedSites:d,onSitesChange:g}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(ga||f)&&e.jsx(Xa,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(se,{variant:"ghost",size:"sm",onClick:()=>s(-1),className:"gap-2",children:[e.jsx(qs,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:ba(t)})]}),e.jsxs(et,{value:p,onValueChange:k,className:"space-y-4",children:[e.jsxs(Me,{children:[e.jsx(H,{value:"trend",children:"Trend"}),e.jsx(H,{value:"location",children:"By Location"}),e.jsx(H,{value:"site",children:"By Site"}),t!=="clients"&&t!=="targetAchievement"&&e.jsx(H,{value:"client",children:"By Clients"}),t==="clients"&&Ie&&e.jsx(H,{value:"revenueTier",children:"By Revenue Tier"}),at&&e.jsx(H,{value:"details",children:"All Details"})]}),e.jsx(Y,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(fl,{data:M,medianHours:ee.hours,medianStaff:ee.staffCount}),t==="shifts"&&e.jsx(xl,{dateRange:a,locations:c,sites:d}),Ne&&t!=="revenue"&&t!=="cost"&&t!=="overheads"&&e.jsx(Za,{data:(q==null?void 0:q.timeSeries)||[],aggregationLevel:(q==null?void 0:q.aggregationLevel)||"monthly",selectedMetric:t}),t==="revenue"&&e.jsx(Nt,{data:oe,title:"Revenue Composition (Margin Color-Coded)"}),t==="cost"&&e.jsx(Nt,{data:oe,title:"Cost Composition (Margin Color-Coded)"}),t==="overheads"&&e.jsx(Sl,{data:ca}),Le&&t!=="missedTargets"&&t!=="shifts"&&t!=="hours"&&t!=="targetAchievement"&&e.jsx(Ya,{data:(G==null?void 0:G.timeSeries)||[],aggregationLevel:(G==null?void 0:G.aggregationLevel)||"monthly",selectedMetric:t}),t==="hours"&&e.jsx(vl,{dateRange:a}),t==="targetAchievement"&&e.jsx(bl,{dateRange:a,dimension:"client"}),t==="missedTargets"&&e.jsx(Qa,{data:D}),!Ne&&!Le&&e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})})]})}),e.jsx(Y,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(Se,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(Se,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(Se,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ul,{data:N}),e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Tier Breakdown"})}),e.jsx(B,{children:e.jsxs(Rt,{children:[e.jsx(Ft,{children:e.jsxs(Ae,{children:[e.jsx(W,{children:"Tier"}),e.jsx(W,{className:"text-right",children:"Clients"}),e.jsx(W,{className:"text-right",children:"Total Revenue"}),e.jsx(W,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Bt,{children:N.map(S=>e.jsxs(Ae,{children:[e.jsx(z,{className:"font-medium",children:S.name}),e.jsx(z,{className:"text-right",children:S.clientCount}),e.jsxs(z,{className:"text-right",children:["£",S.value.toLocaleString()]}),e.jsxs(z,{className:"text-right",children:["£",S.avgRevenue.toLocaleString()]})]},S.name))})]})})]})]})}),e.jsx(Y,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(Se,{data:Na,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(se,{onClick:pa,className:"gap-2",children:[e.jsx(Gs,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(cl,{data:I,onEdit:va,onDelete:Oe}),e.jsx(Cl,{open:ua,onOpenChange:je,initialData:ma,onSave:ja}),e.jsx(Ia,{open:!!be,onOpenChange:S=>!S&&Oe(null),children:e.jsxs(Da,{children:[e.jsxs(Pa,{children:[e.jsx(Ra,{children:"Are you sure?"}),e.jsx(Fa,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Ba,{children:[e.jsx(Ka,{children:"Cancel"}),e.jsx(Ua,{onClick:ya,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Zl as default};
