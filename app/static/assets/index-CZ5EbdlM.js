import{r as b,j as t,e as S,B as k,I as O}from"./index-vv7Xxvxx.js";import{D as G,T as J}from"./DashboardLayout-BvNnIU1Q.js";import{T}from"./trash-2-CAq-4-us.js";import{D as H,a as F,b as I,c as L,d as Y,e as B}from"./dialog-C4jVc5rp.js";import{P as M}from"./plus-DzYcaoe3.js";import"./users-BuPRz4_V.js";function $(r,c){return r===null||r===0?"":c.isPercentage?`${r.toFixed(2)}%`:c.isCurrency?`Â£${r.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}`:r.toLocaleString("en-GB",{maximumFractionDigits:2})}function K({rowId:r,colId:c,value:s,row:i,isActive:d,onFocus:o,onUpdate:n,onNavigate:f}){const[h,y]=b.useState(!1),[g,_]=b.useState(""),w=b.useRef(null),v=b.useCallback(()=>{y(!0),_(s!==null?String(s):""),setTimeout(()=>{var a;return(a=w.current)==null?void 0:a.focus()},0)},[s]),j=b.useCallback(()=>{y(!1);const a=parseFloat(g);n(g===""?null:isNaN(a)?s:a)},[g,n,s]),A=a=>{h?a.key==="Enter"||a.key==="Tab"?(a.preventDefault(),j(),f(a.shiftKey?"up":"down")):a.key==="Escape"&&y(!1):a.key==="Enter"||a.key==="F2"?(a.preventDefault(),v()):a.key==="ArrowUp"?(a.preventDefault(),f("up")):a.key==="ArrowDown"?(a.preventDefault(),f("down")):a.key==="ArrowLeft"?(a.preventDefault(),f("left")):a.key==="ArrowRight"?(a.preventDefault(),f("right")):a.key==="Delete"||a.key==="Backspace"?(a.preventDefault(),n(null)):/^[0-9.\-]$/.test(a.key)&&(a.preventDefault(),_(a.key),y(!0),setTimeout(()=>{var e;return(e=w.current)==null?void 0:e.focus()},0))};return t.jsx("td",{className:S("border border-border px-2 py-1 text-right text-sm min-w-[110px] cursor-cell transition-colors",d&&"ring-2 ring-primary ring-inset bg-primary/5",!d&&"hover:bg-muted/50"),onClick:o,onDoubleClick:v,onKeyDown:A,tabIndex:0,onFocus:o,children:h?t.jsx("input",{ref:w,type:"text",value:g,onChange:a=>_(a.target.value),onBlur:j,className:"w-full bg-transparent text-right outline-none text-sm font-mono"}):t.jsx("span",{className:"font-mono text-sm",children:$(s,i)})})}function W({value:r,row:c}){return t.jsx("td",{className:S("border border-border px-2 py-1 text-right text-sm min-w-[110px]",c.isHeader?"bg-primary/10 font-semibold":"bg-muted/30"),children:t.jsx("span",{className:"font-mono text-sm",children:$(r,c)})})}function U({rows:r,columns:c,data:s,activeCell:i,setActiveCell:d,updateCell:o,deleteRow:n,deleteColumn:f,navigateCell:h,onRenameColumn:y}){const[g,_]=b.useState(null),[w,v]=b.useState(""),j=b.useRef(null),A=e=>{_(e.id),v(e.label),setTimeout(()=>{var l;return(l=j.current)==null?void 0:l.focus()},0)},a=()=>{g&&y&&y(g,w),_(null)};return t.jsx("div",{className:"overflow-x-auto border border-border rounded-lg bg-card max-w-full",children:t.jsxs("table",{className:"border-collapse w-full text-xs",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{className:"sticky left-0 z-20 bg-card border border-border px-2 py-2 text-left font-semibold text-muted-foreground uppercase tracking-wider w-[200px] min-w-[200px]",children:"Description"}),c.map(e=>t.jsx("th",{className:S("sticky top-0 z-10 border border-border px-1 py-1 text-center font-semibold uppercase tracking-wider min-w-[80px]",e.isYearEnd?"bg-primary/10 text-primary":"bg-muted/50 text-muted-foreground"),onDoubleClick:()=>!e.isProtected&&A(e),children:t.jsx("div",{className:"flex items-center justify-center gap-1 h-8 group relative px-2",children:g===e.id?t.jsx("input",{ref:j,value:w,onChange:l=>v(l.target.value),onBlur:a,onKeyDown:l=>l.key==="Enter"&&a(),className:"w-full bg-background border rounded px-1 text-center"}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"truncate",children:e.label}),!e.isProtected&&t.jsx(k,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 absolute -right-1 hover:text-destructive hover:bg-destructive/10",onClick:l=>{l.stopPropagation(),f(e.id)},children:t.jsx(T,{className:"h-3 w-3"})})]})})},e.id)),t.jsx("th",{className:"sticky top-0 z-10 bg-card border border-border w-8"})]})}),t.jsx("tbody",{children:r.map(e=>t.jsxs("tr",{className:S("group hover:bg-muted/20",e.isHeader&&"bg-primary/5"),children:[t.jsx("td",{className:S("sticky left-0 z-10 border border-border px-2 py-1 whitespace-nowrap bg-card text-xs truncate max-w-[200px]",e.isHeader&&"font-bold text-primary bg-primary/5",e.isAutoCalculated&&!e.isHeader&&"text-muted-foreground italic"),title:e.label,children:e.label}),c.map(l=>{var p;const u=(p=s[e.id])==null?void 0:p[l.id];return(u==null?void 0:u.isEditable)&&!e.isAutoCalculated&&!l.isYearEnd?t.jsx(K,{rowId:e.id,colId:l.id,value:(u==null?void 0:u.value)??null,row:e,isActive:(i==null?void 0:i.row)===e.id&&(i==null?void 0:i.col)===l.id,onFocus:()=>d({row:e.id,col:l.id}),onUpdate:C=>o(e.id,l.id,C),onNavigate:h},l.id):t.jsx(W,{value:(u==null?void 0:u.value)??null,row:e},l.id)}),t.jsx("td",{className:"border border-border bg-card w-8 text-center p-0",children:!e.isAutoCalculated&&t.jsx(k,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 hover:text-destructive",onClick:()=>n(e.id),children:t.jsx(T,{className:"h-3 w-3"})})})]},e.id))})]})})}const P=[{id:"jan",label:"January",isProtected:!0},{id:"feb",label:"February",isProtected:!0},{id:"mar",label:"March",isProtected:!0},{id:"apr",label:"April",isProtected:!0},{id:"may",label:"May",isProtected:!0},{id:"jun",label:"June",isProtected:!0},{id:"jul",label:"July",isProtected:!0},{id:"aug",label:"August",isProtected:!0},{id:"sep",label:"September",isProtected:!0},{id:"oct",label:"October",isProtected:!0},{id:"nov",label:"November",isProtected:!0},{id:"dec",label:"December",isProtected:!0},{id:"year_end",label:"Year End",isProtected:!0,isYearEnd:!0}],N=(r,c,s)=>c.reduce((i,d)=>{var n,f;const o=((f=(n=r[d])==null?void 0:n[s])==null?void 0:f.value)??0;return i+o},0),z=["cost_sales_se","cost_sales_paye","employee_ni","employee_pension"],V=["apprenticeship_levy","annual_leave","other_expenses","recruitment_cost","overheads_mgmt","bank_interest","cooperation_tax"],R=[{id:"total_sales",label:"Total Sales",isAutoCalculated:!1,isCurrency:!0},{id:"sales_split_pct",label:"% Sales Split for the Year",isAutoCalculated:!1,isPercentage:!0},{id:"cost_sales_se",label:"Cost of Sales SE",isAutoCalculated:!1,isCurrency:!0},{id:"cost_sales_paye",label:"Cost of Sales PAYE Gross",isAutoCalculated:!1,isCurrency:!0},{id:"employee_ni",label:"Employee NI",isAutoCalculated:!1,isCurrency:!0},{id:"employee_pension",label:"Employee Pension",isAutoCalculated:!1,isCurrency:!0},{id:"total_cost_sales",label:"Total Cost of Sales",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,c,s)=>N(r,z,s)},{id:"apprenticeship_levy",label:"Apprenticeship Levy",isAutoCalculated:!1,isCurrency:!0},{id:"annual_leave",label:"Annual Leave Accrual",isAutoCalculated:!1,isCurrency:!0},{id:"other_expenses",label:"Other Expenses",isAutoCalculated:!1,isCurrency:!0},{id:"recruitment_cost",label:"Recruitment and Pass Cost",isAutoCalculated:!1,isCurrency:!0},{id:"overheads_mgmt",label:"Overheads (Total Mgmt & Office Cost)",isAutoCalculated:!1,isCurrency:!0},{id:"bank_interest",label:"Bank Interest",isAutoCalculated:!1,isCurrency:!0},{id:"cooperation_tax",label:"Cooperation Tax",isAutoCalculated:!1,isCurrency:!0},{id:"total_overheads",label:"Total Overheads",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,c,s)=>N(r,V,s)},{id:"total_cost",label:"Total Cost",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,c,s)=>{const i=N(r,z,s),d=N(r,V,s);return i+d}},{id:"avg_hourly_charge",label:"Average Hourly Charge Rate",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_pay",label:"Gross Hourly Pay",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_margin",label:"Gross Hourly Margin",isAutoCalculated:!0,isCurrency:!0,formula:(r,c,s)=>{var o,n,f,h;const i=((n=(o=r.avg_hourly_charge)==null?void 0:o[s])==null?void 0:n.value)??0,d=((h=(f=r.gross_hourly_pay)==null?void 0:f[s])==null?void 0:h.value)??0;return i-d}},{id:"net_cost_per_hour",label:"Net Cost per Hour",isAutoCalculated:!1,isCurrency:!0},{id:"gross_pl_value",label:"Gross P&L Value",isAutoCalculated:!1,isCurrency:!0},{id:"net_pl",label:"Net P&L",isAutoCalculated:!1,isCurrency:!0},{id:"total_net_margin",label:"Total Net Margin",isAutoCalculated:!1,isPercentage:!0},{id:"worked_hours",label:"Worked Hours",isAutoCalculated:!1},{id:"hours_breakeven",label:"Hours for Breakeven",isAutoCalculated:!0,formula:(r,c,s)=>{var o,n,f,h;const i=((n=(o=r.total_cost)==null?void 0:o[s])==null?void 0:n.value)??0,d=((h=(f=r.gross_hourly_margin)==null?void 0:f[s])==null?void 0:h.value)??0;return d!==0?i/d:0}},{id:"value_breakeven",label:"Total Value for Breakeven",isAutoCalculated:!0,isCurrency:!0,formula:(r,c,s)=>{var o,n,f,h;const i=((n=(o=r.hours_breakeven)==null?void 0:o[s])==null?void 0:n.value)??0,d=((h=(f=r.avg_hourly_charge)==null?void 0:f[s])==null?void 0:h.value)??0;return i*d}},{id:"sales_budget_2026",label:"2026 Sales Budget 30% Uplift",isAutoCalculated:!0,isCurrency:!0,formula:(r,c,s)=>{var d,o;return(((o=(d=r.total_sales)==null?void 0:d[s])==null?void 0:o.value)??0)*1.3}},{id:"avg_hourly_charge_2026",label:"Average Hourly Charge Rate 2026",isAutoCalculated:!1,isCurrency:!0},{id:"sales_target_hours",label:"Sales Target in Hours",isAutoCalculated:!1},{id:"variance_2025",label:"Variance Against 2025",isAutoCalculated:!1,isCurrency:!0}];function q(r,c){const s={};for(const i of r){s[i.id]={};for(const d of c)s[i.id][d.id]={value:null,isEditable:!i.isAutoCalculated&&!d.isYearEnd}}return s}function E(r,c,s){const i=JSON.parse(JSON.stringify(r));for(const o of s.filter(n=>!n.isYearEnd))for(const n of c)n.formula&&(i[n.id][o.id]={...i[n.id][o.id],value:n.formula(i,n.id,o.id),isEditable:!1});const d=s.find(o=>o.isYearEnd);if(d)for(const o of c){const n=s.filter(f=>!f.isYearEnd).reduce((f,h)=>{var y,g;return f+(((g=(y=i[o.id])==null?void 0:y[h.id])==null?void 0:g.value)??0)},0);i[o.id][d.id]={value:n,isEditable:!1}}return i}function Q(){const[r,c]=b.useState(R),[s,i]=b.useState(P),[d,o]=b.useState(()=>E(q(R,P),R,P)),[n,f]=b.useState(null),h=b.useCallback((a,e,l)=>{o(u=>{const m={...u};return m[a]={...m[a]},m[a][e]={...m[a][e],value:l},E(m,r,s)})},[r,s]),y=b.useCallback(a=>{const e=`custom_${Date.now()}`,l={id:e,label:a,isAutoCalculated:!1,isCurrency:!0};c(u=>{const m=[...u,l];return o(p=>{const C={...p};C[e]={};for(const x of s)C[e][x.id]={value:null,isEditable:!x.isYearEnd};return E(C,m,s)}),m})},[s]),g=b.useCallback(a=>{c(e=>e.filter(l=>l.id!==a)),o(e=>{const l={...e};return delete l[a],l})},[]),_=b.useCallback(a=>{const e=`col_${Date.now()}`,l={id:e,label:a};i(u=>{const m=u.findIndex(C=>C.isYearEnd),p=[...u];return p.splice(m,0,l),o(C=>{const x={...C};for(const D of r)x[D.id]={...x[D.id]},x[D.id][e]={value:null,isEditable:!D.isAutoCalculated};return E(x,r,p)}),p})},[r]),w=b.useCallback(a=>{i(e=>{const l=e.filter(u=>u.id!==a);return o(u=>{const m={...u};for(const p of Object.keys(m)){const{[a]:C,...x}=m[p];m[p]=x}return E(m,r,l)}),l})},[r]),v=b.useCallback((a,e)=>{i(l=>l.map(u=>u.id===a?{...u,label:e}:u))},[]),j=b.useCallback(a=>{if(!n)return;const e=r.filter(x=>!x.isAutoCalculated),l=s.filter(x=>!x.isYearEnd),u=e.findIndex(x=>x.id===n.row),m=l.findIndex(x=>x.id===n.col);if(u===-1||m===-1)return;let p=u,C=m;switch(a){case"up":p=Math.max(0,u-1);break;case"down":p=Math.min(e.length-1,u+1);break;case"left":C=Math.max(0,m-1);break;case"right":C=Math.min(l.length-1,m+1);break}f({row:e[p].id,col:l[C].id})},[n,r,s]),A=b.useCallback(async a=>{if(a)try{const e={year:new Date().getFullYear(),data:d,rows:r,columns:s},l=localStorage.getItem("auth_token");if(!(await fetch("undefined/api/financial-summary/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(e)})).ok)throw new Error("Failed to save")}catch(e){throw console.error("Save failed",e),e}},[d,r,s]);return{rows:r,columns:s,data:d,activeCell:n,setActiveCell:f,updateCell:h,addRow:y,deleteRow:g,addColumn:_,deleteColumn:w,renameColumn:v,navigateCell:j,saveData:A}}function se(){const{rows:r,columns:c,data:s,activeCell:i,setActiveCell:d,updateCell:o,addRow:n,deleteRow:f,addColumn:h,deleteColumn:y,navigateCell:g}=Q(),[_,w]=b.useState(""),[v,j]=b.useState(""),[A,a]=b.useState(!1),[e,l]=b.useState(!1),u=()=>{_.trim()&&(n(_.trim()),w(""),a(!1))},m=()=>{v.trim()&&(h(v.trim()),j(""),l(!1))};return t.jsx(G,{noPadding:!0,fullWidth:!0,children:t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-border bg-card/50 shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:t.jsx(J,{className:"h-5 w-5 text-primary"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-foreground",children:"Financial Summary"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Annual budget and performance spreadsheet"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(H,{open:A,onOpenChange:a,children:[t.jsx(F,{asChild:!0,children:t.jsxs(k,{variant:"outline",size:"sm",children:[t.jsx(M,{className:"h-4 w-4 mr-1"})," Add Row"]})}),t.jsxs(I,{children:[t.jsx(L,{children:t.jsx(Y,{children:"Add New Row"})}),t.jsx(O,{placeholder:"Row label...",value:_,onChange:p=>w(p.target.value),onKeyDown:p=>p.key==="Enter"&&u()}),t.jsx(B,{children:t.jsx(k,{onClick:u,disabled:!_.trim(),children:"Add"})})]})]}),t.jsxs(H,{open:e,onOpenChange:l,children:[t.jsx(F,{asChild:!0,children:t.jsxs(k,{variant:"outline",size:"sm",children:[t.jsx(M,{className:"h-4 w-4 mr-1"})," Add Column"]})}),t.jsxs(I,{children:[t.jsx(L,{children:t.jsx(Y,{children:"Add New Column"})}),t.jsx(O,{placeholder:"Column label...",value:v,onChange:p=>j(p.target.value),onKeyDown:p=>p.key==="Enter"&&m()}),t.jsx(B,{children:t.jsx(k,{onClick:m,disabled:!v.trim(),children:"Add"})})]})]})]})]}),t.jsx("div",{className:"flex-1 overflow-auto p-4",children:t.jsx(U,{rows:r,columns:c,data:s,activeCell:i,setActiveCell:d,updateCell:o,deleteRow:f,deleteColumn:y,navigateCell:g})})]})})}export{se as default};
