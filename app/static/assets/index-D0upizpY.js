import{r as o,a8 as J,j as e,B as y,D as g,I as P,X as H}from"./index-TrEQoQxG.js";import{D as K,b as Q}from"./DashboardLayout-ba6jjFTQ.js";import{C as R,a as _,b as Y,d as W}from"./card-_Wg5TFuL.js";import{L as M}from"./label-lTSlj8NC.js";import{S as A,a as $,b as L,c as O,d as z}from"./select-C7JV3TDT.js";import{T as X,a as G,b as C,c as w,d as U,e as c}from"./table-kB69RI5t.js";import{u as I}from"./useQuery-CmYN-rb8.js";import{u as Z,e as q,P as ee}from"./useRecords--GOEXeMV.js";import{a as ae,C as te}from"./index-RV4qIDMr.js";import"./users-CZEPtaLg.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],ue=()=>{const[s,N]=o.useState(new Date().getFullYear()),[i,x]=o.useState(B[new Date().getMonth()]),[l,j]=o.useState(new Set),[d,b]=o.useState([]),p=J(),{data:m}=Z(),{data:f}=I({queryKey:["admin-targets",s],queryFn:async()=>{const a=await fetch(`/api/admin/targets?year=${s}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!a.ok)throw new Error("Failed to fetch targets");return a.json()}}),{data:h}=I({queryKey:["admin-financials",s],queryFn:async()=>{const a=await fetch(`/api/admin/financial-metrics?year=${s}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!a.ok)throw new Error("Failed to fetch metrics");return a.json()}}),T=q({mutationFn:async a=>{const t=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(a)});if(!t.ok)throw new Error("Failed to save target");return t.json()},onSuccess:()=>{p.invalidateQueries({queryKey:["admin-targets"]}),g.success("Target saved")},onError:a=>g.error(a.message)}),k=q({mutationFn:async a=>{const t=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(a)});if(!t.ok)throw new Error("Failed to save metric");return t.json()},onSuccess:()=>{p.invalidateQueries({queryKey:["admin-financials"]}),g.success("Metric saved")},onError:a=>g.error(a.message)}),v=o.useMemo(()=>{const a=new Set;return a.add("Overheads"),h==null||h.forEach(t=>a.add(t.name)),d.forEach(t=>a.add(t)),Array.from(a)},[h,d]),D=o.useMemo(()=>{if(!(m!=null&&m.jobs))return{};const a={};return m.jobs.forEach(t=>{t.location&&(a[t.location]||(a[t.location]=new Set),t.site&&a[t.location].add(t.site))}),a},[m]),V=a=>{const t=new Set(l);t.has(a)?t.delete(a):t.add(a),j(t)},E=(a,t)=>{var r;return((r=f==null?void 0:f.find(n=>n.month===i&&n.location===a&&n.site===t))==null?void 0:r.target)||0},F=(a,t,r)=>{var n;return((n=h==null?void 0:h.find(u=>u.month===i&&u.name===r&&u.location===a&&u.site===t))==null?void 0:n.value)||0};return e.jsxs(K,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(R,{className:"mb-6",children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Y,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{children:"Year:"}),e.jsxs(A,{value:s.toString(),onValueChange:a=>N(Number(a)),children:[e.jsx($,{className:"w-[100px]",children:e.jsx(L,{})}),e.jsx(O,{children:[2024,2025,2026,2027,2028].map(a=>e.jsx(z,{value:a.toString(),children:a},a))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{children:"Month:"}),e.jsxs(A,{value:i,onValueChange:x,children:[e.jsx($,{className:"w-[120px]",children:e.jsx(L,{})}),e.jsx(O,{children:B.map(a=>e.jsx(z,{value:a,children:a},a))})]})]})]})]})}),e.jsx(W,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(C,{children:[e.jsx(w,{className:"w-[300px]",children:"Location / Site"}),e.jsx(w,{className:"w-[150px]",children:"Shift Target"}),v.map(a=>e.jsx(w,{className:"w-[150px] group",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("span",{children:a})})},a)),e.jsx(w,{className:"w-[50px]",children:e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>{const a=prompt("Enter new metric name (e.g. Marketing):");a&&!v.includes(a)&&(b(t=>[...t,a]),g.success(`Added column: ${a}`))},children:e.jsx(ee,{className:"h-4 w-4"})})})]})}),e.jsx(U,{children:Object.entries(D).map(([a,t])=>e.jsxs(e.Fragment,{children:[e.jsxs(C,{className:"bg-muted/30",children:[e.jsxs(c,{className:"font-medium",children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>V(a),children:l.has(a)?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),a]}),e.jsx(c,{children:e.jsx(S,{value:E(a,null),onSave:r=>T.mutate({year:s,month:i,location:a,site:null,target:r})})}),v.map(r=>e.jsx(c,{children:e.jsx(S,{value:F(a,null,r),prefix:"£",onSave:n=>k.mutate({year:s,month:i,location:a,site:null,name:r,value:n})})},r)),e.jsx(c,{})]},a),l.has(a)&&Array.from(t).map(r=>e.jsxs(C,{children:[e.jsx(c,{className:"pl-10 text-sm text-muted-foreground",children:r}),e.jsx(c,{children:e.jsx(S,{value:E(a,r),onSave:n=>T.mutate({year:s,month:i,location:a,site:r,target:n})})}),v.map(n=>e.jsx(c,{children:e.jsx(S,{value:F(a,r,n),prefix:"£",onSave:u=>k.mutate({year:s,month:i,location:a,site:r,name:n,value:u})})},n)),e.jsx(c,{})]},`${a}-${r}`))]}))})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on any value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Location targets are distributed to sites if site targets are not set (default 1000)."}),e.jsx("p",{children:"• Overheads/Financials can be set per Location or per Site."})]})]})},S=({value:s,onSave:N,prefix:i=""})=>{const[x,l]=o.useState(!1),[j,d]=o.useState(s);o.useEffect(()=>{x||d(s)},[s,x]);const b=()=>{d(s),l(!0)},p=()=>{j!==s&&N(j),l(!1)},m=()=>{l(!1),d(s)};return x?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(P,{type:"number",value:j,onChange:f=>d(Number(f.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:p,children:e.jsx(te,{className:"h-4 w-4"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:m,children:e.jsx(H,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:b,children:s?`${i}${s.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{ue as default};
