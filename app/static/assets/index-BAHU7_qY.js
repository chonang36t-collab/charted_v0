import{r as c,a2 as _,j as e,B as y,I as F,a3 as J,a4 as K,a5 as Q,a6 as Y,a7 as U,a8 as W,a9 as X,aa as G,X as Z,y as S}from"./index-B06xTncy.js";import{D as ee,C as ae}from"./DashboardLayout-DErby7_N.js";import{C as se,a as te,b as ne,d as re}from"./card-DU0EVlUW.js";import{L as D}from"./label-CQdQ2BhF.js";import{S as M,a as L,b as O,c as $,d as z}from"./select-BWVHLgxf.js";import{T as ie,a as le,b as k,c as E,d as oe,e as p}from"./table-D5pP-wTy.js";import{u as V}from"./useQuery-Bmk9BP1l.js";import{u as ce,e as q}from"./useRecords-C9eHiarg.js";import{D as de,a as he,b as me,c as ue,d as xe,f as je}from"./dialog-CxRP2Gow.js";import{a as ge,C as pe}from"./index-Crquc7O-.js";import{P as fe}from"./pen-BK09B8Vd.js";import{T as ve}from"./trash-2-BlVEssfK.js";import"./users-CIDiFv45.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],H=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Le=()=>{const[n,f]=c.useState(new Date().getFullYear()),[i,g]=c.useState(B[new Date().getMonth()]),[m,v]=c.useState(new Set),u=_(),{data:x}=ce(),{data:o}=V({queryKey:["admin-targets",n],queryFn:async()=>{const a=await fetch(`/api/admin/targets?year=${n}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!a.ok)throw new Error("Failed to fetch targets");return a.json()}}),{data:d}=V({queryKey:["admin-financials",n],queryFn:async()=>{const a=await fetch(`/api/admin/financial-metrics?year=${n}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!a.ok)throw new Error("Failed to fetch metrics");return a.json()}}),j=q({mutationFn:async a=>{const t=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(a)});if(!t.ok)throw new Error("Failed to save target");return t.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-targets"]}),S.success("Target saved")},onError:a=>S.error(a.message)}),w=q({mutationFn:async a=>{const t=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(a)});if(!t.ok)throw new Error("Failed to save metric");return t.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-financials"]}),S.success("Metric saved")},onError:a=>S.error(a.message)}),N=c.useMemo(()=>{if(!(x!=null&&x.jobs))return{};const a={};return x.jobs.forEach(t=>{t.location&&(a[t.location]||(a[t.location]=new Set),t.site&&a[t.location].add(t.site))}),a},[x]),b=a=>{const t=new Set(m);t.has(a)?t.delete(a):t.add(a),v(t)},C=(a,t)=>{var h;if(t){const s=(h=o==null?void 0:o.find(l=>l.month===i&&l.location===a&&l.site===t))==null?void 0:h.target;return s??1e3}const T=N[a]?Array.from(N[a]):[];let r=0;return T.forEach(s=>{var I;const l=(I=o==null?void 0:o.find(A=>A.month===i&&A.location===a&&A.site===s))==null?void 0:I.target;r+=l??1e3}),r};return e.jsxs(ee,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(se,{className:"mb-6",children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ne,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{children:"Year:"}),e.jsxs(M,{value:n.toString(),onValueChange:a=>f(Number(a)),children:[e.jsx(L,{className:"w-[100px]",children:e.jsx(O,{})}),e.jsx($,{children:[2024,2025,2026,2027,2028].map(a=>e.jsx(z,{value:a.toString(),children:a},a))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{children:"Month:"}),e.jsxs(M,{value:i,onValueChange:g,children:[e.jsx(L,{className:"w-[120px]",children:e.jsx(O,{})}),e.jsx($,{children:B.map(a=>e.jsx(z,{value:a,children:a},a))})]})]})]})]})}),e.jsx(re,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(k,{children:[e.jsx(E,{className:"w-[300px]",children:"Location / Site"}),e.jsx(E,{className:"w-[150px]",children:"Shift Target"}),e.jsx(E,{className:"w-[150px]",children:"Total Overheads"}),e.jsx(E,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(oe,{children:Object.entries(N).map(([a,t])=>{const T=(d||[]).filter(r=>r.location===a&&r.site===null&&r.month===i&&r.year===n).reduce((r,h)=>r+h.value,0);return e.jsxs(e.Fragment,{children:[e.jsxs(k,{className:"bg-muted/30",children:[e.jsxs(p,{className:"font-medium",children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>b(a),children:m.has(a)?e.jsx(ge,{className:"h-4 w-4"}):e.jsx(ae,{className:"h-4 w-4"})}),a]}),e.jsx(p,{children:t.size===0?e.jsx(P,{value:C(a,null)||1e3,onSave:r=>j.mutate({year:n,month:i,location:a,site:null,target:r})}):e.jsx("span",{className:"text-muted-foreground font-semibold px-2",children:C(a,null).toLocaleString()})}),e.jsx(p,{children:e.jsxs("span",{className:"font-mono",children:["£",T.toLocaleString()]})}),e.jsx(p,{children:e.jsx(R,{location:a,site:null,year:n,month:i,metrics:d||[],onSave:(r,h)=>w.mutate({year:n,month:i,location:a,site:null,name:r,value:h})})})]},a),m.has(a)&&Array.from(t).map(r=>{const h=(d||[]).filter(s=>s.location===a&&s.site===r&&s.month===i&&s.year===n).reduce((s,l)=>s+l.value,0);return e.jsxs(k,{children:[e.jsx(p,{className:"pl-10 text-sm text-muted-foreground",children:r}),e.jsx(p,{children:e.jsx(P,{value:C(a,r),onSave:s=>j.mutate({year:n,month:i,location:a,site:r,target:s})})}),e.jsx(p,{children:e.jsxs("span",{className:"font-mono",children:["£",h.toLocaleString()]})}),e.jsx(p,{children:e.jsx(R,{location:a,site:r,year:n,month:i,metrics:d||[],onSave:(s,l)=>w.mutate({year:n,month:i,location:a,site:r,name:s,value:l})})})]},`${a}-${r}`)})]})})})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on Target value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Locations without sites have a default target of 1000."}),e.jsx("p",{children:'• Use "Edit Financials" to add multiple overheads per location/site.'})]})]})},R=({location:n,site:f,year:i,month:g,metrics:m,onSave:v})=>{const[u,x]=c.useState(!1),[o,d]=c.useState(""),[j,w]=c.useState(""),[N,b]=c.useState(null),C=m.filter(s=>s.year===i&&s.month===g&&s.location===n&&s.site===f),[a,t]=c.useState(""),T=()=>{const s=a==="Custom..."?o:a;!s||!j||(v(s,parseFloat(j)),d(""),t(""),w(""))},r=async()=>{if(N)try{const s=await fetch(`/api/admin/financial-metrics/${N}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(s.ok)S.success("Deleted successfully"),window.location.reload();else{const l=await s.json();S.error(l.error||"Failed to delete")}}catch(s){console.error(s),S.error("Failed to delete")}finally{b(null)}},h=s=>{w(s.value.toString()),H.includes(s.name)?(t(s.name),d("")):(t("Custom..."),d(s.name))};return e.jsxs(de,{open:u,onOpenChange:x,children:[e.jsx(he,{asChild:!0,children:e.jsx(y,{variant:"outline",size:"sm",children:"Edit Financials"})}),e.jsxs(me,{className:"sm:max-w-[500px]",children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Manage Financials"}),e.jsxs(je,{children:[n," ",f?` - ${f}`:""," (",g," ",i,")"]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-2 max-h-[200px] overflow-y-auto space-y-2",children:[C.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No metrics added yet."}),C.map(s=>e.jsxs("div",{className:"flex items-center justify-between bg-secondary/20 p-2 rounded",children:[e.jsx("span",{className:"text-sm font-medium",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",children:["£",s.value.toLocaleString()]}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>h(s),children:e.jsx(fe,{className:"h-3 w-3 text-blue-500"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>b(s.id),children:e.jsx(ve,{className:"h-3 w-3 text-red-500"})})]})]},s.id))]}),e.jsxs("div",{className:"grid gap-4 border-t pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(D,{children:"Category"}),e.jsxs(M,{value:a,onValueChange:t,children:[e.jsx(L,{children:e.jsx(O,{placeholder:"Select..."})}),e.jsx($,{children:H.map(s=>e.jsx(z,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(D,{htmlFor:"val",children:"Value (£)"}),e.jsx(F,{id:"val",type:"number",placeholder:"0",value:j,onChange:s=>w(s.target.value)})]})]}),a==="Custom..."&&e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(D,{htmlFor:"custom-name",children:"Custom Name"}),e.jsx(F,{id:"custom-name",placeholder:"Enter overhead name...",value:o,onChange:s=>d(s.target.value)})]}),e.jsx(y,{onClick:T,disabled:!a||a==="Custom..."&&!o||!j,children:"Add Overhead"})]})]})]}),e.jsx(J,{open:!!N,onOpenChange:s=>!s&&b(null),children:e.jsxs(K,{children:[e.jsxs(Q,{children:[e.jsx(Y,{children:"Are you sure?"}),e.jsx(U,{children:"This will permanently delete this overhead record."})]}),e.jsxs(W,{children:[e.jsx(X,{children:"Cancel"}),e.jsx(G,{onClick:r,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})},P=({value:n,onSave:f,prefix:i=""})=>{const[g,m]=c.useState(!1),[v,u]=c.useState(n);c.useEffect(()=>{g||u(n)},[n,g]);const x=()=>{u(n),m(!0)},o=()=>{v!==n&&f(v),m(!1)},d=()=>{m(!1),u(n)};return g?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{type:"number",value:v,onChange:j=>u(Number(j.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:o,children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:d,children:e.jsx(Z,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:x,children:n?`${i}${n.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{Le as default};
