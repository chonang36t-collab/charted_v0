import{r as h,a2 as _,j as e,B as S,I as M,X as J,y as b}from"./index-D1klQVMP.js";import{D as K,C as Q}from"./DashboardLayout-CTXFZdja.js";import{C as Y,a as U,b as W,d as X}from"./card-BP-weWrw.js";import{L as E}from"./label-yMpFyRUm.js";import{S as A,a as L,b as O,c as $,d as z}from"./select-5mFX41LU.js";import{T as G,a as Z,b as F,c as k,d as ee,e as v}from"./table-BPnpFJXt.js";import{u as V}from"./useQuery-CpJKggsR.js";import{u as se,e as q}from"./useRecords-BY4xFMFE.js";import{D as ae,a as te,b as ne,c as re,d as ie,f as oe}from"./dialog-Bm_yUuwy.js";import{a as le,C as ce}from"./index-BgY1qCIR.js";import{P as de}from"./pen-6GWiErnC.js";import{T as he}from"./trash-2-CZhCayvR.js";import"./users-pPTyOrIf.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],R=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],be=()=>{const[t,N]=h.useState(new Date().getFullYear()),[r,g]=h.useState(B[new Date().getMonth()]),[m,y]=h.useState(new Set),u=_(),{data:x}=se(),{data:o}=V({queryKey:["admin-targets",t],queryFn:async()=>{const s=await fetch(`/api/admin/targets?year=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch targets");return s.json()}}),{data:l}=V({queryKey:["admin-financials",t],queryFn:async()=>{const s=await fetch(`/api/admin/financial-metrics?year=${t}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch metrics");return s.json()}}),j=q({mutationFn:async s=>{const n=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!n.ok)throw new Error("Failed to save target");return n.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-targets"]}),b.success("Target saved")},onError:s=>b.error(s.message)}),w=q({mutationFn:async s=>{const n=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!n.ok)throw new Error("Failed to save metric");return n.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-financials"]}),b.success("Metric saved")},onError:s=>b.error(s.message)}),C=h.useMemo(()=>{if(!(x!=null&&x.jobs))return{};const s={};return x.jobs.forEach(n=>{n.location&&(s[n.location]||(s[n.location]=new Set),n.site&&s[n.location].add(n.site))}),s},[x]),p=s=>{const n=new Set(m);n.has(s)?n.delete(s):n.add(s),y(n)},f=(s,n)=>{var c;if(n){const i=(c=o==null?void 0:o.find(d=>d.month===r&&d.location===s&&d.site===n))==null?void 0:c.target;return i??1e3}const T=C[s]?Array.from(C[s]):[];let a=0;return T.forEach(i=>{var I;const d=(I=o==null?void 0:o.find(D=>D.month===r&&D.location===s&&D.site===i))==null?void 0:I.target;a+=d??1e3}),a};return e.jsxs(K,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(Y,{className:"mb-6",children:[e.jsx(U,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(W,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{children:"Year:"}),e.jsxs(A,{value:t.toString(),onValueChange:s=>N(Number(s)),children:[e.jsx(L,{className:"w-[100px]",children:e.jsx(O,{})}),e.jsx($,{children:[2024,2025,2026,2027,2028].map(s=>e.jsx(z,{value:s.toString(),children:s},s))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{children:"Month:"}),e.jsxs(A,{value:r,onValueChange:g,children:[e.jsx(L,{className:"w-[120px]",children:e.jsx(O,{})}),e.jsx($,{children:B.map(s=>e.jsx(z,{value:s,children:s},s))})]})]})]})]})}),e.jsx(X,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(G,{children:[e.jsx(Z,{children:e.jsxs(F,{children:[e.jsx(k,{className:"w-[300px]",children:"Location / Site"}),e.jsx(k,{className:"w-[150px]",children:"Shift Target"}),e.jsx(k,{className:"w-[150px]",children:"Total Overheads"}),e.jsx(k,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(ee,{children:Object.entries(C).map(([s,n])=>{const T=(l||[]).filter(a=>a.location===s&&a.site===null&&a.month===r&&a.year===t).reduce((a,c)=>a+c.value,0);return e.jsxs(e.Fragment,{children:[e.jsxs(F,{className:"bg-muted/30",children:[e.jsxs(v,{className:"font-medium",children:[e.jsx(S,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>p(s),children:m.has(s)?e.jsx(le,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),s]}),e.jsx(v,{children:n.size===0?e.jsx(P,{value:f(s,null)||1e3,onSave:a=>j.mutate({year:t,month:r,location:s,site:null,target:a})}):e.jsx("span",{className:"text-muted-foreground font-semibold px-2",children:f(s,null).toLocaleString()})}),e.jsx(v,{children:e.jsxs("span",{className:"font-mono",children:["£",T.toLocaleString()]})}),e.jsx(v,{children:e.jsx(H,{location:s,site:null,year:t,month:r,metrics:l||[],onSave:(a,c)=>w.mutate({year:t,month:r,location:s,site:null,name:a,value:c})})})]},s),m.has(s)&&Array.from(n).map(a=>{const c=(l||[]).filter(i=>i.location===s&&i.site===a&&i.month===r&&i.year===t).reduce((i,d)=>i+d.value,0);return e.jsxs(F,{children:[e.jsx(v,{className:"pl-10 text-sm text-muted-foreground",children:a}),e.jsx(v,{children:e.jsx(P,{value:f(s,a),onSave:i=>j.mutate({year:t,month:r,location:s,site:a,target:i})})}),e.jsx(v,{children:e.jsxs("span",{className:"font-mono",children:["£",c.toLocaleString()]})}),e.jsx(v,{children:e.jsx(H,{location:s,site:a,year:t,month:r,metrics:l||[],onSave:(i,d)=>w.mutate({year:t,month:r,location:s,site:a,name:i,value:d})})})]},`${s}-${a}`)})]})})})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on Target value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Locations without sites have a default target of 1000."}),e.jsx("p",{children:'• Use "Edit Financials" to add multiple overheads per location/site.'})]})]})},H=({location:t,site:N,year:r,month:g,metrics:m,onSave:y})=>{const[u,x]=h.useState(!1),[o,l]=h.useState(""),[j,w]=h.useState(""),C=m.filter(a=>a.year===r&&a.month===g&&a.location===t&&a.site===N),[p,f]=h.useState(""),s=()=>{const a=p==="Custom..."?o:p;!a||!j||(y(a,parseFloat(j)),l(""),f(""),w(""))},n=async a=>{if(confirm("Delete this metric?"))try{(await fetch(`/api/admin/financial-metrics/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}})).ok&&(b.success("Deleted successfully"),window.location.reload())}catch(c){console.error(c),b.error("Failed to delete")}},T=a=>{w(a.value.toString()),R.includes(a.name)?(f(a.name),l("")):(f("Custom..."),l(a.name))};return e.jsxs(ae,{open:u,onOpenChange:x,children:[e.jsx(te,{asChild:!0,children:e.jsx(S,{variant:"outline",size:"sm",children:"Edit Financials"})}),e.jsxs(ne,{className:"sm:max-w-[500px]",children:[e.jsxs(re,{children:[e.jsx(ie,{children:"Manage Financials"}),e.jsxs(oe,{children:[t," ",N?` - ${N}`:""," (",g," ",r,")"]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-2 max-h-[200px] overflow-y-auto space-y-2",children:[C.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No metrics added yet."}),C.map(a=>e.jsxs("div",{className:"flex items-center justify-between bg-secondary/20 p-2 rounded",children:[e.jsx("span",{className:"text-sm font-medium",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",children:["£",a.value.toLocaleString()]}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>T(a),children:e.jsx(de,{className:"h-3 w-3 text-blue-500"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>n(a.id),children:e.jsx(he,{className:"h-3 w-3 text-red-500"})})]})]},a.id))]}),e.jsxs("div",{className:"grid gap-4 border-t pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(E,{children:"Category"}),e.jsxs(A,{value:p,onValueChange:f,children:[e.jsx(L,{children:e.jsx(O,{placeholder:"Select..."})}),e.jsx($,{children:R.map(a=>e.jsx(z,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(E,{htmlFor:"val",children:"Value (£)"}),e.jsx(M,{id:"val",type:"number",placeholder:"0",value:j,onChange:a=>w(a.target.value)})]})]}),p==="Custom..."&&e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(E,{htmlFor:"custom-name",children:"Custom Name"}),e.jsx(M,{id:"custom-name",placeholder:"Enter overhead name...",value:o,onChange:a=>l(a.target.value)})]}),e.jsx(S,{onClick:s,disabled:!p||p==="Custom..."&&!o||!j,children:"Add Overhead"})]})]})]})]})},P=({value:t,onSave:N,prefix:r=""})=>{const[g,m]=h.useState(!1),[y,u]=h.useState(t);h.useEffect(()=>{g||u(t)},[t,g]);const x=()=>{u(t),m(!0)},o=()=>{y!==t&&N(y),m(!1)},l=()=>{m(!1),u(t)};return g?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{type:"number",value:y,onChange:j=>u(Number(j.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:o,children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:l,children:e.jsx(J,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:x,children:t?`${r}${t.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{be as default};
