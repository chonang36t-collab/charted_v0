import{r as l,u as E,a as I,b as O,R as D,j as e,A as F}from"./index-B7OWM2ug.js";import{B as u}from"./button-DlC8NlnR.js";import{I as p}from"./input-B4gmsl5y.js";import{L as f}from"./label-DZko9UTV.js";import{C as P,a as R,b as V,c as U,d as q}from"./card-Cy5T66gH.js";function H(){const[c,n]=l.useState(!1),[o,m]=l.useState("login"),[y,C]=l.useState(""),[j,b]=l.useState(""),[r,v]=l.useState(""),w=E(),{toast:a}=I(),{refreshUser:h,role:N,isLoading:S}=O();D.useEffect(()=>{!S&&N&&w("/dashboard")},[N,S,w]);const k=async t=>{t.preventDefault(),n(!0);const s=new FormData(t.currentTarget),i=s.get("username"),T=s.get("password");C(i);try{const x=await fetch(F.LOGIN,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({username:i,password:T})}),d=await x.json();if(x.ok)if(d.status==="2fa_setup_required"){const A=await(await fetch(`${g}/api/2fa/setup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i})})).json();b(A.qr_code),m("2fa_setup")}else d.status==="2fa_login_required"?m("2fa_verify"):(localStorage.setItem("auth_token",d.token),await h(),a({title:"Login successful"}));else a({title:"Login failed",description:d.error||"Invalid credentials",variant:"destructive"})}catch{a({title:"Error",description:"Could not connect to server",variant:"destructive"})}finally{n(!1)}},L=async t=>{t.preventDefault(),n(!0);try{const s=await fetch(`${g}/api/2fa/verify-setup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:y,token:r})}),i=await s.json();s.ok?(localStorage.setItem("auth_token",i.token),await h(),a({title:"2FA Setup complete"})):a({title:"Verification failed",description:i.error,variant:"destructive"})}catch{a({title:"Error",description:"Verification failed",variant:"destructive"})}finally{n(!1)}},_=async t=>{t.preventDefault(),n(!0);try{const s=await fetch(`${g}/api/2fa/login-verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:y,token:r})}),i=await s.json();s.ok?(localStorage.setItem("auth_token",i.token),await h(),a({title:"Login successful"})):a({title:"Verification failed",description:i.error,variant:"destructive"})}catch{a({title:"Error",description:"Verification failed",variant:"destructive"})}finally{n(!1)}},g="";return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background relative p-4",children:[e.jsx("div",{className:"absolute top-6 left-6 z-50",children:e.jsx("a",{href:"/",className:"block hover:opacity-80 transition-opacity",children:e.jsx("img",{src:"/logo.png",alt:"Company Logo",className:"h-12 w-auto object-contain"})})}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs(P,{className:"w-full max-w-md",children:[e.jsxs(R,{children:[e.jsx(V,{className:"text-2xl",children:o==="login"?"Analytics Dashboard":"Two-Factor Authentication"}),e.jsx(U,{children:o==="login"?"Sign in to access your analytics":o==="2fa_setup"?"Scan the QR code with your Authenticator app":"Enter the 6-digit code from your app"})]}),e.jsxs(q,{children:[o==="login"&&e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"login-username",children:"Username"}),e.jsx(p,{id:"login-username",name:"username",type:"text",placeholder:"your_username",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"login-password",children:"Password"}),e.jsx(p,{id:"login-password",name:"password",type:"password",required:!0})]}),e.jsx(u,{type:"submit",className:"w-full",disabled:c,children:c?"Logging in...":"Login"})]}),o==="2fa_setup"&&e.jsxs("div",{className:"space-y-6 flex flex-col items-center",children:[j&&e.jsx("div",{className:"bg-white p-4 rounded-lg shadow-sm border",children:e.jsx("img",{src:j,alt:"2FA QR Code",className:"w-48 h-48"})}),e.jsxs("div",{className:"w-full space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"otp-setup",children:"Enter 6-digit code to confirm"}),e.jsx(p,{id:"otp-setup",value:r,onChange:t=>v(t.target.value),placeholder:"000000",maxLength:6,className:"text-center text-2xl tracking-[0.5em] font-mono"})]}),e.jsx(u,{onClick:L,className:"w-full",disabled:c||r.length!==6,children:"Verify and Enable 2FA"})]})]}),o==="2fa_verify"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"otp-login",children:"Authenticator Code"}),e.jsx(p,{id:"otp-login",value:r,onChange:t=>v(t.target.value),placeholder:"000000",maxLength:6,className:"text-center text-2xl tracking-[0.5em] font-mono"})]}),e.jsx(u,{onClick:_,className:"w-full",disabled:c||r.length!==6,children:"Verify Code"}),e.jsx(u,{variant:"ghost",onClick:()=>m("login"),className:"w-full text-xs",children:"Back to login"})]})]})]})})]})}export{H as default};
