import{c as pa,ab as va,R as k,ac as ya,r as f,h as ja,U as ba,p as Na,j as e,v as wa,P as Ee,q as De,w as Sa,e as He,B as ee,I as Ae,A as ne,L as Aa,y as X,ad as Ca,u as Ta,d as _a,b as $a,a3 as Ea,a4 as ka,a5 as Oa,a6 as Ma,a7 as Ia,a8 as La,a9 as Da,aa as Pa}from"./index-Btrs1-xX.js";import{D as Ra}from"./DashboardLayout-BXyyWRMm.js";import{C as R,d as B,a as te,b as ae}from"./card-CeBvtqgb.js";import{c as Nt,R as Ba,I as Fa}from"./index-Biy5H_VG.js";import{D as Ka}from"./DashboardHeader-B5PcFCMk.js";import{S as Ve,Z as Ua,C as wt,u as Wa,O as Ha,T as Va}from"./TargetPerformanceChart-xUr7d2qo.js";import{u as za,L as Ga,R as qa}from"./LoadingOverlay-SJ3MXcqV.js";import{_ as St,e as Ya,k as At,i as ze,a as Ct,b as Qa,c as Ja,d as Xa,f as Tt,g as Za,h as _t,s as es,j as ts,l as as,m as ss,n as Ge,o as $t,p as Et,q as kt,r as rs,t as ns,u as is,v as os,w as ls,x as cs,y as Ot,z as ds,D as hs,E as us,F as ms,G as fs,H as xs,I as gs,J as Ne,K as ps,M as vs,N as Pe,O as Re,P as at,Q as st,S as rt,U as ys,V as js,W as bs,Z as Ns,$ as ws,a0 as nt,a1 as Mt,T as z,a2 as Ss,X as oe,Y as le,a3 as As,R as se,C as pe,B as Z,a4 as qe,L as Cs,a5 as it,a6 as ot}from"./generateCategoricalChart-DWNLsrUT.js";import{B as It}from"./BarChart-JN7cdheh.js";import{P as Ts,a as _s,b as $s}from"./PieChart-C_jT-qu2.js";import{T as Lt,a as Dt,b as Ce,c as H,d as Pt,e as V}from"./table-BLH7XXGH.js";import{P as Es}from"./pen-C-J10NQo.js";import{T as ks}from"./trash-2-DhZelcoJ.js";import{L as U}from"./label-CPtYrsVN.js";import{f as E}from"./popover-DdxQeDd_.js";import{D as Os,b as Ms,c as Is,d as Ls,f as Ds,e as Ps}from"./dialog-Dkbjj7mo.js";import{S as he,a as ue,b as me,c as fe,d as re}from"./select-8nDprP0_.js";import{u as Rs}from"./useRecords-aNFynTcY.js";import{P as Bs}from"./plus-Bk7Rb-fc.js";import"./users-D3MOBDMw.js";import"./locationUtils-3l-uZm3Y.js";import"./checkbox-BxQ8p5Jk.js";import"./index-CEPwhrTK.js";import"./AreaChart-C0oAeDp_.js";import"./useQuery-DrJ2d6sL.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=pa("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);function Ks(t,a){for(var s=-1,r=t==null?0:t.length;++s<r&&a(t[s],s,t)!==!1;);return t}var Us=Ks,Ws=St,Hs=Ya,Vs=Object.prototype,zs=Vs.hasOwnProperty;function Gs(t,a,s){var r=t[a];(!(zs.call(t,a)&&Hs(r,s))||s===void 0&&!(a in t))&&Ws(t,a,s)}var Rt=Gs,qs=Rt,Ys=St;function Qs(t,a,s,r){var n=!s;s||(s={});for(var i=-1,o=a.length;++i<o;){var l=a[i],h=r?r(s[l],t[l],l,s,t):void 0;h===void 0&&(h=t[l]),n?Ys(s,l,h):qs(s,l,h)}return s}var ve=Qs,Js=ve,Xs=At;function Zs(t,a){return t&&Js(a,Xs(a),t)}var er=Zs;function tr(t){var a=[];if(t!=null)for(var s in Object(t))a.push(s);return a}var ar=tr,sr=ze,rr=Ct,nr=ar,ir=Object.prototype,or=ir.hasOwnProperty;function lr(t){if(!sr(t))return nr(t);var a=rr(t),s=[];for(var r in t)r=="constructor"&&(a||!or.call(t,r))||s.push(r);return s}var cr=lr,dr=Qa,hr=cr,ur=Ja;function mr(t){return ur(t)?dr(t,!0):hr(t)}var Ye=mr,fr=ve,xr=Ye;function gr(t,a){return t&&fr(a,xr(a),t)}var pr=gr,Te={exports:{}};Te.exports;(function(t,a){var s=Xa,r=a&&!a.nodeType&&a,n=r&&!0&&t&&!t.nodeType&&t,i=n&&n.exports===r,o=i?s.Buffer:void 0,l=o?o.allocUnsafe:void 0;function h(d,u){if(u)return d.slice();var c=d.length,x=l?l(c):new d.constructor(c);return d.copy(x),x}t.exports=h})(Te,Te.exports);var vr=Te.exports;function yr(t,a){var s=-1,r=t.length;for(a||(a=Array(r));++s<r;)a[s]=t[s];return a}var jr=yr,br=ve,Nr=Tt;function wr(t,a){return br(t,Nr(t),a)}var Sr=wr,Ar=Za,Cr=_t,Tr=Tt,_r=es,$r=Object.getOwnPropertySymbols,Er=$r?function(t){for(var a=[];t;)Ar(a,Tr(t)),t=Cr(t);return a}:_r,Bt=Er,kr=ve,Or=Bt;function Mr(t,a){return kr(t,Or(t),a)}var Ir=Mr,Lr=ts,Dr=Bt,Pr=Ye;function Rr(t){return Lr(t,Pr,Dr)}var Ft=Rr,Br=Object.prototype,Fr=Br.hasOwnProperty;function Kr(t){var a=t.length,s=new t.constructor(a);return a&&typeof t[0]=="string"&&Fr.call(t,"index")&&(s.index=t.index,s.input=t.input),s}var Ur=Kr,lt=as;function Wr(t){var a=new t.constructor(t.byteLength);return new lt(a).set(new lt(t)),a}var Qe=Wr,Hr=Qe;function Vr(t,a){var s=a?Hr(t.buffer):t.buffer;return new t.constructor(s,t.byteOffset,t.byteLength)}var zr=Vr,Gr=/\w*$/;function qr(t){var a=new t.constructor(t.source,Gr.exec(t));return a.lastIndex=t.lastIndex,a}var Yr=qr,ct=ss,dt=ct?ct.prototype:void 0,ht=dt?dt.valueOf:void 0;function Qr(t){return ht?Object(ht.call(t)):{}}var Jr=Qr,Xr=Qe;function Zr(t,a){var s=a?Xr(t.buffer):t.buffer;return new t.constructor(s,t.byteOffset,t.length)}var en=Zr,tn=Qe,an=zr,sn=Yr,rn=Jr,nn=en,on="[object Boolean]",ln="[object Date]",cn="[object Map]",dn="[object Number]",hn="[object RegExp]",un="[object Set]",mn="[object String]",fn="[object Symbol]",xn="[object ArrayBuffer]",gn="[object DataView]",pn="[object Float32Array]",vn="[object Float64Array]",yn="[object Int8Array]",jn="[object Int16Array]",bn="[object Int32Array]",Nn="[object Uint8Array]",wn="[object Uint8ClampedArray]",Sn="[object Uint16Array]",An="[object Uint32Array]";function Cn(t,a,s){var r=t.constructor;switch(a){case xn:return tn(t);case on:case ln:return new r(+t);case gn:return an(t,s);case pn:case vn:case yn:case jn:case bn:case Nn:case wn:case Sn:case An:return nn(t,s);case cn:return new r;case dn:case mn:return new r(t);case hn:return sn(t);case un:return new r;case fn:return rn(t)}}var Tn=Cn,_n=ze,ut=Object.create,$n=function(){function t(){}return function(a){if(!_n(a))return{};if(ut)return ut(a);t.prototype=a;var s=new t;return t.prototype=void 0,s}}(),En=$n,kn=En,On=_t,Mn=Ct;function In(t){return typeof t.constructor=="function"&&!Mn(t)?kn(On(t)):{}}var Ln=In,Dn=Ge,Pn=$t,Rn="[object Map]";function Bn(t){return Pn(t)&&Dn(t)==Rn}var Fn=Bn,Kn=Fn,Un=kt,mt=Et,ft=mt&&mt.isMap,Wn=ft?Un(ft):Kn,Hn=Wn,Vn=Ge,zn=$t,Gn="[object Set]";function qn(t){return zn(t)&&Vn(t)==Gn}var Yn=qn,Qn=Yn,Jn=kt,xt=Et,gt=xt&&xt.isSet,Xn=gt?Jn(gt):Qn,Zn=Xn,ei=rs,ti=Us,ai=Rt,si=er,ri=pr,ni=vr,ii=jr,oi=Sr,li=Ir,ci=is,di=Ft,hi=Ge,ui=Ur,mi=Tn,fi=Ln,xi=os,gi=ns,pi=Hn,vi=ze,yi=Zn,ji=At,bi=Ye,Ni=1,wi=2,Si=4,Kt="[object Arguments]",Ai="[object Array]",Ci="[object Boolean]",Ti="[object Date]",_i="[object Error]",Ut="[object Function]",$i="[object GeneratorFunction]",Ei="[object Map]",ki="[object Number]",Wt="[object Object]",Oi="[object RegExp]",Mi="[object Set]",Ii="[object String]",Li="[object Symbol]",Di="[object WeakMap]",Pi="[object ArrayBuffer]",Ri="[object DataView]",Bi="[object Float32Array]",Fi="[object Float64Array]",Ki="[object Int8Array]",Ui="[object Int16Array]",Wi="[object Int32Array]",Hi="[object Uint8Array]",Vi="[object Uint8ClampedArray]",zi="[object Uint16Array]",Gi="[object Uint32Array]",w={};w[Kt]=w[Ai]=w[Pi]=w[Ri]=w[Ci]=w[Ti]=w[Bi]=w[Fi]=w[Ki]=w[Ui]=w[Wi]=w[Ei]=w[ki]=w[Wt]=w[Oi]=w[Mi]=w[Ii]=w[Li]=w[Hi]=w[Vi]=w[zi]=w[Gi]=!0;w[_i]=w[Ut]=w[Di]=!1;function Se(t,a,s,r,n,i){var o,l=a&Ni,h=a&wi,d=a&Si;if(s&&(o=n?s(t,r,n,i):s(t)),o!==void 0)return o;if(!vi(t))return t;var u=xi(t);if(u){if(o=ui(t),!l)return ii(t,o)}else{var c=hi(t),x=c==Ut||c==$i;if(gi(t))return ni(t,l);if(c==Wt||c==Kt||x&&!n){if(o=h||x?{}:fi(t),!l)return h?li(t,ri(o,t)):oi(t,si(o,t))}else{if(!w[c])return n?t:{};o=mi(t,c,l)}}i||(i=new ei);var p=i.get(t);if(p)return p;i.set(t,o),yi(t)?t.forEach(function(N){o.add(Se(N,a,s,N,t,i))}):pi(t)&&t.forEach(function(N,j){o.set(j,Se(N,a,s,j,t,i))});var C=d?h?di:ci:h?bi:ji,y=u?void 0:C(t);return ti(y||t,function(N,j){y&&(j=N,N=t[j]),ai(o,j,Se(N,a,s,j,t,i))}),o}var qi=Se,Yi=ls,Qi=cs;function Ji(t,a){return a.length<2?t:Yi(t,Qi(a,0,-1))}var Xi=Ji,Zi=Ot,eo=ds,to=Xi,ao=hs;function so(t,a){return a=Zi(a,t),t=to(t,a),t==null||delete t[ao(eo(a))]}var ro=so,no=us;function io(t){return no(t)?void 0:t}var oo=io,lo=ms;function co(t){var a=t==null?0:t.length;return a?lo(t,1):[]}var ho=co,uo=ho,mo=fs,fo=xs;function xo(t){return fo(mo(t,void 0,uo),t+"")}var go=xo,po=gs,vo=qi,yo=ro,jo=Ot,bo=ve,No=oo,wo=go,So=Ft,Ao=1,Co=2,To=4,_o=wo(function(t,a){var s={};if(t==null)return s;var r=!1;a=po(a,function(i){return i=jo(i,t),r||(r=i.length>1),i}),bo(t,So(t),s),r&&(s=vo(s,Ao|Co|To,No));for(var n=a.length;n--;)yo(s,a[n]);return s}),$o=_o;const Eo=va($o);var ko=["#1890FF","#66B5FF","#41D9C7","#2FC25B","#6EDB8F","#9AE65C","#FACC14","#E6965C","#57AD71","#223273","#738AE6","#7564CC","#8543E0","#A877ED","#5C8EE6","#13C2C2","#70E0E0","#5CA3E6","#3436C7","#8082FF","#DD81E6","#F04864","#FA7D92","#D598D9"],Oo=["width","height","className","style","children","type"];function ie(t){"@babel/helpers - typeof";return ie=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},ie(t)}function _e(){return _e=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var s=arguments[a];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},_e.apply(this,arguments)}function Mo(t,a){if(t==null)return{};var s=Io(t,a),r,n;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],!(a.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(s[r]=t[r])}return s}function Io(t,a){if(t==null)return{};var s={};for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){if(a.indexOf(r)>=0)continue;s[r]=t[r]}return s}function Lo(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}function pt(t,a){for(var s=0;s<a.length;s++){var r=a[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,Vt(r.key),r)}}function Do(t,a,s){return a&&pt(t.prototype,a),s&&pt(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}function Po(t,a,s){return a=$e(a),Ro(t,Ht()?Reflect.construct(a,s||[],$e(t).constructor):a.apply(t,s))}function Ro(t,a){if(a&&(ie(a)==="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Bo(t)}function Bo(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Ht(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Ht=function(){return!!t})()}function $e(t){return $e=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(s){return s.__proto__||Object.getPrototypeOf(s)},$e(t)}function Fo(t,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(a&&a.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),a&&We(t,a)}function We(t,a){return We=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},We(t,a)}function vt(t,a){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);a&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),s.push.apply(s,r)}return s}function S(t){for(var a=1;a<arguments.length;a++){var s=arguments[a]!=null?arguments[a]:{};a%2?vt(Object(s),!0).forEach(function(r){Q(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):vt(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}function Q(t,a,s){return a=Vt(a),a in t?Object.defineProperty(t,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[a]=s,t}function Vt(t){var a=Ko(t,"string");return ie(a)=="symbol"?a:a+""}function Ko(t,a){if(ie(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,a||"default");if(ie(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(t)}var ge="value",Be=function t(a){var s=a.depth,r=a.node,n=a.index,i=a.valueKey,o=r.children,l=s+1,h=o&&o.length?o.map(function(u,c){return t({depth:l,node:u,index:c,valueKey:i})}):null,d;return o&&o.length?d=h.reduce(function(u,c){return u+c[ge]},0):d=Mt(r[i])||r[i]<=0?0:r[i],S(S({},r),{},Q(Q(Q({children:h},ge,d),"depth",s),"index",n))},Uo=function(a){return{x:a.x,y:a.y,width:a.width,height:a.height}},Wo=function(a,s){var r=s<0?0:s;return a.map(function(n){var i=n[ge]*r;return S(S({},n),{},{area:Mt(i)||i<=0?0:i})})},Ho=function(a,s,r){var n=s*s,i=a.area*a.area,o=a.reduce(function(d,u){return{min:Math.min(d.min,u.area),max:Math.max(d.max,u.area)}},{min:1/0,max:0}),l=o.min,h=o.max;return i?Math.max(n*h*r/i,i/(n*l*r)):1/0},Vo=function(a,s,r,n){var i=s?Math.round(a.area/s):0;(n||i>r.height)&&(i=r.height);for(var o=r.x,l,h=0,d=a.length;h<d;h++)l=a[h],l.x=o,l.y=r.y,l.height=i,l.width=Math.min(i?Math.round(l.area/i):0,r.x+r.width-o),o+=l.width;return l.width+=r.x+r.width-o,S(S({},r),{},{y:r.y+i,height:r.height-i})},zo=function(a,s,r,n){var i=s?Math.round(a.area/s):0;(n||i>r.width)&&(i=r.width);for(var o=r.y,l,h=0,d=a.length;h<d;h++)l=a[h],l.x=r.x,l.y=o,l.width=i,l.height=Math.min(i?Math.round(l.area/i):0,r.y+r.height-o),o+=l.height;return l&&(l.height+=r.y+r.height-o),S(S({},r),{},{x:r.x+i,width:r.width-i})},yt=function(a,s,r,n){return s===r.width?Vo(a,s,r,n):zo(a,s,r,n)},Fe=function t(a,s){var r=a.children;if(r&&r.length){var n=Uo(a),i=[],o=1/0,l,h,d=Math.min(n.width,n.height),u=Wo(r,n.width*n.height/a[ge]),c=u.slice();for(i.area=0;c.length>0;)i.push(l=c[0]),i.area+=l.area,h=Ho(i,d,s),h<=o?(c.shift(),o=h):(i.area-=i.pop().area,n=yt(i,d,n,!1),d=Math.min(n.width,n.height),i.length=i.area=0,o=1/0);return i.length&&(n=yt(i,d,n,!0),i.length=i.area=0),S(S({},a),{},{children:u.map(function(x){return t(x,s)})})}return a},Go={isTooltipActive:!1,isAnimationFinished:!1,activeNode:null,formatRoot:null,currentRoot:null,nestIndex:[]},Je=function(t){function a(){var s;Lo(this,a);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return s=Po(this,a,[].concat(n)),Q(s,"state",S({},Go)),Q(s,"handleAnimationEnd",function(){var o=s.props.onAnimationEnd;s.setState({isAnimationFinished:!0}),Ne(o)&&o()}),Q(s,"handleAnimationStart",function(){var o=s.props.onAnimationStart;s.setState({isAnimationFinished:!1}),Ne(o)&&o()}),s}return Fo(a,t),Do(a,[{key:"handleMouseEnter",value:function(r,n){n.persist();var i=this.props,o=i.onMouseEnter,l=i.children,h=Pe(l,z);h?this.setState({isTooltipActive:!0,activeNode:r},function(){o&&o(r,n)}):o&&o(r,n)}},{key:"handleMouseLeave",value:function(r,n){n.persist();var i=this.props,o=i.onMouseLeave,l=i.children,h=Pe(l,z);h?this.setState({isTooltipActive:!1,activeNode:null},function(){o&&o(r,n)}):o&&o(r,n)}},{key:"handleClick",value:function(r){var n=this.props,i=n.onClick,o=n.type;if(o==="nest"&&r.children){var l=this.props,h=l.width,d=l.height,u=l.dataKey,c=l.aspectRatio,x=Be({depth:0,node:S(S({},r),{},{x:0,y:0,width:h,height:d}),index:0,valueKey:u}),p=Fe(x,c),C=this.state.nestIndex;C.push(r),this.setState({formatRoot:p,currentRoot:x,nestIndex:C})}i&&i(r)}},{key:"handleNestIndex",value:function(r,n){var i=this.state.nestIndex,o=this.props,l=o.width,h=o.height,d=o.dataKey,u=o.aspectRatio,c=Be({depth:0,node:S(S({},r),{},{x:0,y:0,width:l,height:h}),index:0,valueKey:d}),x=Fe(c,u);i=i.slice(0,n+1),this.setState({formatRoot:x,currentRoot:r,nestIndex:i})}},{key:"renderItem",value:function(r,n,i){var o=this,l=this.props,h=l.isAnimationActive,d=l.animationBegin,u=l.animationDuration,c=l.animationEasing,x=l.isUpdateAnimationActive,p=l.type,C=l.animationId,y=l.colorPanel,N=this.state.isAnimationFinished,j=n.width,O=n.height,M=n.x,F=n.y,J=n.depth,K=parseInt("".concat((Math.random()*2-1)*j),10),I={};return(i||p==="nest")&&(I={onMouseEnter:this.handleMouseEnter.bind(this,n),onMouseLeave:this.handleMouseLeave.bind(this,n),onClick:this.handleClick.bind(this,n)}),h?k.createElement(at,{begin:d,duration:u,isActive:h,easing:c,key:"treemap-".concat(C),from:{x:M,y:F,width:j,height:O},to:{x:M,y:F,width:j,height:O},onAnimationStart:this.handleAnimationStart,onAnimationEnd:this.handleAnimationEnd},function(v){var m=v.x,$=v.y,L=v.width,D=v.height;return k.createElement(at,{from:"translate(".concat(K,"px, ").concat(K,"px)"),to:"translate(0, 0)",attributeName:"transform",begin:d,easing:c,isActive:h,duration:u},k.createElement(Re,I,function(){return J>2&&!N?null:o.constructor.renderContentItem(r,S(S({},n),{},{isAnimationActive:h,isUpdateAnimationActive:!x,width:L,height:D,x:m,y:$}),p,y)}()))}):k.createElement(Re,I,this.constructor.renderContentItem(r,S(S({},n),{},{isAnimationActive:!1,isUpdateAnimationActive:!1,width:j,height:O,x:M,y:F}),p,y))}},{key:"renderNode",value:function(r,n){var i=this,o=this.props,l=o.content,h=o.type,d=S(S(S({},st(this.props,!1)),n),{},{root:r}),u=!n.children||!n.children.length,c=this.state.currentRoot,x=(c.children||[]).filter(function(p){return p.depth===n.depth&&p.name===n.name});return!x.length&&r.depth&&h==="nest"?null:k.createElement(Re,{key:"recharts-treemap-node-".concat(d.x,"-").concat(d.y,"-").concat(d.name),className:"recharts-treemap-depth-".concat(n.depth)},this.renderItem(l,d,u),n.children&&n.children.length?n.children.map(function(p){return i.renderNode(n,p)}):null)}},{key:"renderAllNodes",value:function(){var r=this.state.formatRoot;return r?this.renderNode(r,r):null}},{key:"renderTooltip",value:function(){var r=this.props,n=r.children,i=r.nameKey,o=Pe(n,z);if(!o)return null;var l=this.props,h=l.width,d=l.height,u=this.state,c=u.isTooltipActive,x=u.activeNode,p={x:0,y:0,width:h,height:d},C=x?{x:x.x+x.width/2,y:x.y+x.height/2}:null,y=c&&x?[{payload:x,name:rt(x,i,""),value:rt(x,ge)}]:[];return k.cloneElement(o,{viewBox:p,active:c,coordinate:C,label:"",payload:y})}},{key:"renderNestIndex",value:function(){var r=this,n=this.props,i=n.nameKey,o=n.nestIndexContent,l=this.state.nestIndex;return k.createElement("div",{className:"recharts-treemap-nest-index-wrapper",style:{marginTop:"8px",textAlign:"center"}},l.map(function(h,d){var u=ys(h,i,"root"),c=null;return k.isValidElement(o)&&(c=k.cloneElement(o,h,d)),Ne(o)?c=o(h,d):c=u,k.createElement("div",{onClick:r.handleNestIndex.bind(r,h,d),key:"nest-index-".concat(js()),className:"recharts-treemap-nest-index-box",style:{cursor:"pointer",display:"inline-block",padding:"0 7px",background:"#000",color:"#fff",marginRight:"3px"}},c)}))}},{key:"render",value:function(){if(!bs(this))return null;var r=this.props,n=r.width,i=r.height,o=r.className,l=r.style,h=r.children,d=r.type,u=Mo(r,Oo),c=st(u,!1);return k.createElement("div",{className:ya("recharts-wrapper",o),style:S(S({},l),{},{position:"relative",cursor:"default",width:n,height:i}),role:"region"},k.createElement(Ns,_e({},c,{width:n,height:d==="nest"?i-30:i}),this.renderAllNodes(),ws(h)),this.renderTooltip(),d==="nest"&&this.renderNestIndex())}}],[{key:"getDerivedStateFromProps",value:function(r,n){if(r.data!==n.prevData||r.type!==n.prevType||r.width!==n.prevWidth||r.height!==n.prevHeight||r.dataKey!==n.prevDataKey||r.aspectRatio!==n.prevAspectRatio){var i=Be({depth:0,node:{children:r.data,x:0,y:0,width:r.width,height:r.height},index:0,valueKey:r.dataKey}),o=Fe(i,r.aspectRatio);return S(S({},n),{},{formatRoot:o,currentRoot:i,nestIndex:[i],prevAspectRatio:r.aspectRatio,prevData:r.data,prevWidth:r.width,prevHeight:r.height,prevDataKey:r.dataKey,prevType:r.type})}return null}},{key:"renderContentItem",value:function(r,n,i,o){if(k.isValidElement(r))return k.cloneElement(r,n);if(Ne(r))return r(n);var l=n.x,h=n.y,d=n.width,u=n.height,c=n.index,x=null;d>10&&u>10&&n.children&&i==="nest"&&(x=k.createElement(Ts,{points:[{x:l+2,y:h+u/2},{x:l+6,y:h+u/2+3},{x:l+2,y:h+u/2+6}]}));var p=null,C=ps(n.name);d>20&&u>20&&C.width<d&&C.height<u&&(p=k.createElement("text",{x:l+8,y:h+u/2+7,fontSize:14},n.name));var y=o||ko;return k.createElement("g",null,k.createElement(vs,_e({fill:n.depth<2?y[c%y.length]:"rgba(255,255,255,0)",stroke:"#fff"},Eo(n,"children"),{role:"img"})),x,p)}}])}(f.PureComponent);Q(Je,"displayName","Treemap");Q(Je,"defaultProps",{aspectRatio:.5*(1+Math.sqrt(5)),dataKey:"value",type:"flat",isAnimationActive:!nt.isSsr,isUpdateAnimationActive:!nt.isSsr,animationBegin:0,animationDuration:1500,animationEasing:"linear"});var qo=Ss({chartName:"ScatterChart",GraphicalChild:Ve,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:oe},{axisType:"yAxis",AxisComp:le},{axisType:"zAxis",AxisComp:Ua}],formatAxisMap:As}),ke="Tabs",[Yo,Wl]=ja(ke,[Nt]),zt=Nt(),[Qo,Xe]=Yo(ke),Gt=f.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,onValueChange:n,defaultValue:i,orientation:o="horizontal",dir:l,activationMode:h="automatic",...d}=t,u=ba(l),[c,x]=Na({prop:r,onChange:n,defaultProp:i??"",caller:ke});return e.jsx(Qo,{scope:s,baseId:wa(),value:c,onValueChange:x,orientation:o,dir:u,activationMode:h,children:e.jsx(Ee.div,{dir:u,"data-orientation":o,...d,ref:a})})});Gt.displayName=ke;var qt="TabsList",Yt=f.forwardRef((t,a)=>{const{__scopeTabs:s,loop:r=!0,...n}=t,i=Xe(qt,s),o=zt(s);return e.jsx(Ba,{asChild:!0,...o,orientation:i.orientation,dir:i.dir,loop:r,children:e.jsx(Ee.div,{role:"tablist","aria-orientation":i.orientation,...n,ref:a})})});Yt.displayName=qt;var Qt="TabsTrigger",Jt=f.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,disabled:n=!1,...i}=t,o=Xe(Qt,s),l=zt(s),h=ea(o.baseId,r),d=ta(o.baseId,r),u=r===o.value;return e.jsx(Fa,{asChild:!0,...l,focusable:!n,active:u,children:e.jsx(Ee.button,{type:"button",role:"tab","aria-selected":u,"aria-controls":d,"data-state":u?"active":"inactive","data-disabled":n?"":void 0,disabled:n,id:h,...i,ref:a,onMouseDown:De(t.onMouseDown,c=>{!n&&c.button===0&&c.ctrlKey===!1?o.onValueChange(r):c.preventDefault()}),onKeyDown:De(t.onKeyDown,c=>{[" ","Enter"].includes(c.key)&&o.onValueChange(r)}),onFocus:De(t.onFocus,()=>{const c=o.activationMode!=="manual";!u&&!n&&c&&o.onValueChange(r)})})})});Jt.displayName=Qt;var Xt="TabsContent",Zt=f.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,forceMount:n,children:i,...o}=t,l=Xe(Xt,s),h=ea(l.baseId,r),d=ta(l.baseId,r),u=r===l.value,c=f.useRef(u);return f.useEffect(()=>{const x=requestAnimationFrame(()=>c.current=!1);return()=>cancelAnimationFrame(x)},[]),e.jsx(Sa,{present:n||u,children:({present:x})=>e.jsx(Ee.div,{"data-state":u?"active":"inactive","data-orientation":l.orientation,role:"tabpanel","aria-labelledby":h,hidden:!x,id:d,tabIndex:0,...o,ref:a,style:{...t.style,animationDuration:c.current?"0s":void 0},children:x&&i})})});Zt.displayName=Xt;function ea(t,a){return`${t}-trigger-${a}`}function ta(t,a){return`${t}-content-${a}`}var Jo=Gt,aa=Yt,sa=Jt,ra=Zt;const Ze=Jo,Oe=f.forwardRef(({className:t,...a},s)=>e.jsx(aa,{ref:s,className:He("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));Oe.displayName=aa.displayName;const W=f.forwardRef(({className:t,...a},s)=>e.jsx(sa,{ref:s,className:He("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));W.displayName=sa.displayName;const Y=f.forwardRef(({className:t,...a},s)=>e.jsx(ra,{ref:s,className:He("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));Y.displayName=ra.displayName;const Xo=({active:t,payload:a,label:s,metric:r})=>{if(t&&a&&a.length){const n=["clients","employees","shifts","hours","targetAchievement","missedTargets"].includes(r),i=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:n?i.toLocaleString():i.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},Ke=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(R,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(It,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(pe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(oe,{type:"number",hide:!0}),e.jsx(le,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(z,{content:e.jsx(Xo,{metric:a})}),e.jsx(Z,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((r,n)=>e.jsx(qe,{fill:"hsl(var(--primary))",fillOpacity:.8+n*.05},`cell-${n}`))})]})})})})}),jt=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],Zo=({active:t,payload:a,metric:s})=>{if(t&&a&&a.length){const r=["revenue","costs","profit","overheads"].includes(s);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:r?Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(a[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]})}return null},we=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(R,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((i,o)=>o.value-i.value),r=s.reduce((i,o)=>i+o.value,0),n=s.map(i=>({...i,percentage:r>0?i.value/r*100:0}));return e.jsx(R,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(_s,{children:[e.jsx($s,{data:n,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:n.map((i,o)=>e.jsx(qe,{fill:jt[o%jt.length]},`cell-${o}`))}),e.jsx(z,{content:e.jsx(Zo,{metric:a})}),e.jsx(Cs,{})]})})})})})},el=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(R,{children:[e.jsx(te,{children:e.jsx(ae,{children:"Overheads Details"})}),e.jsx(B,{children:e.jsxs(Lt,{children:[e.jsx(Dt,{children:e.jsxs(Ce,{children:[e.jsx(H,{children:"Title"}),e.jsx(H,{children:"Month"}),e.jsx(H,{children:"Location"}),e.jsx(H,{children:"Site"}),e.jsx(H,{className:"text-right",children:"Amount"}),e.jsx(H,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Pt,{children:t.map(r=>e.jsxs(Ce,{children:[e.jsx(V,{className:"font-medium",children:r.name}),e.jsxs(V,{children:[r.month," ",r.year]}),e.jsx(V,{children:r.location||"-"}),e.jsx(V,{children:r.site||"-"}),e.jsx(V,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(V,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(r),children:e.jsx(Es,{className:"h-4 w-4"})}),e.jsx(ee,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx(ks,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),tl=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},al=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},sl=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const r=tl(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:r}});return e.jsxs(R,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(It,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(pe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(oe,{type:"number",hide:!0}),e.jsx(le,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(z,{content:e.jsx(al,{})}),a.map((s,r)=>s.clients.map((n,i)=>e.jsx(Z,{dataKey:()=>n.revenue,stackId:r,fill:s.colors[i],radius:i===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((o,l)=>{const h=l===r;return e.jsx(qe,{fill:h?s.colors[i]:"transparent",stroke:h?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:d=>{h&&(d.target.style.opacity="0.8")},onMouseLeave:d=>{h&&(d.target.style.opacity="1")}},`cell-${r}-${i}-${l}`)})},`${r}-${i}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((n,i)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[i]}}),e.jsx("span",{className:"truncate",title:`${n.name}: £${n.revenue.toLocaleString()}`,children:n.name})]},i))})]},r))})]})]})},rl=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},nl=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(R,{children:[e.jsx(te,{children:e.jsx(ae,{children:"Client Workload vs Staff Coverage"})}),e.jsx(B,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(R,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(qo,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(pe,{strokeDasharray:"3 3"}),e.jsx(oe,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(it,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(le,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(it,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(z,{content:e.jsx(rl,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(ot,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(ot,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(Ve,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,n)=>r+n.shiftCount,0).toLocaleString()})]})]})]})]}),il=({dateRange:t,locations:a=[],sites:s=[]})=>{const[r,n]=f.useState("calendar"),[i,o]=f.useState([]),[l,h]=f.useState([]),[d,u]=f.useState([]),[c,x]=f.useState([]),[p,C]=f.useState(!1),[y,N]=f.useState(33),[j,O]=f.useState(67),[M,F]=f.useState(!1);f.useEffect(()=>{(async()=>{C(!0);try{const m=new URLSearchParams({start:E(t.from,"yyyy-MM-dd"),end:E(t.to,"yyyy-MM-dd"),view_type:r});a&&a.length>0&&a.forEach(ce=>m.append("locations",ce)),s&&s.length>0&&s.forEach(ce=>m.append("sites",ce));const $={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},L=await fetch(`/api/dashboard/shifts-heatmap?${m.toString()}`,{headers:$,credentials:"include"});if(!L.ok){console.error(`Heatmap API returned ${L.status}`);return}const D=await L.json();D.view_type==="calendar"?o(D.data||[]):(h(D.data||[]),u(D.locations||[]),x(D.dates||[]))}catch(m){console.error("Error fetching heatmap data:",m)}finally{C(!1)}})()},[t,a,s,r]);const J=()=>Math.max(...r==="calendar"?i.map(v=>v.shift_count):l.map(v=>v.shift_count),1),K=v=>{const m=J(),$=v/m*100;return $===0?"#f8f9fa":$<y?"#d4edda":$<j?"#fff3cd":"#f8d7da"},I=(v,m)=>{const $=l.find(L=>L.location===v&&L.date===m);return $?$.shift_count:0};return e.jsxs(R,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"}),e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(U,{className:"font-semibold",children:"Intensity Thresholds (%)"}),e.jsx(ee,{variant:"outline",size:"sm",onClick:()=>F(!M),children:M?"Done":"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs(U,{className:"text-xs",children:["Low (","<"," ",y,"%)"]}),M?e.jsx(Ae,{type:"number",min:"0",max:"100",value:y,onChange:v=>N(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsxs("span",{className:"text-sm",children:["0-",y,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(U,{className:"text-xs",children:["Medium (",y,"-",j,"%)"]}),M?e.jsx(Ae,{type:"number",min:"0",max:"100",value:j,onChange:v=>O(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsxs("span",{className:"text-sm",children:[y,"-",j,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(U,{className:"text-xs",children:["High (",">="," ",j,"%)"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsxs("span",{className:"text-sm",children:[j,"-100%"]})]})]})]})]})]}),e.jsx(B,{children:e.jsxs(Ze,{value:r,onValueChange:v=>n(v),children:[e.jsxs(Oe,{className:"mb-4",children:[e.jsx(W,{value:"calendar",children:"Calendar View"}),e.jsx(W,{value:"location_day",children:"By Location"})]}),e.jsx(Y,{value:"calendar",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):i.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:i.map((v,m)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:K(v.shift_count)},title:`${v.date} (${v.day_of_week}): ${v.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:E(new Date(v.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:v.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:v.shift_count})]},m))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(Y,{value:"location_day",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):d.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-scroll max-w-full",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"border-collapse",style:{minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),c.slice(0,31).map((v,m)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:E(new Date(v),"MMM d")},m))]})}),e.jsx("tbody",{children:d.map((v,m)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:v}),c.slice(0,31).map(($,L)=>{const D=I(v,$);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:K(D)},title:`${v} - ${$}: ${D} shifts`,children:D>0?D:""},L)})]},m))})]})}),c.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},ol=t=>{const{x:a,y:s,width:r,height:n,stroke:i,fill:o,payload:l}=t;if(!l||!l.median||n===0)return null;const h=n/l.median,d=s+n,u=O=>d-O*h,c=u(l.min),x=u(l.q1),p=u(l.median),C=u(l.q3),y=u(l.max),N=a+r/2,j=r/2;return e.jsxs("g",{children:[e.jsx("line",{x1:N,y1:y,x2:N,y2:c,stroke:i,strokeWidth:1}),e.jsx("line",{x1:N-j/2,y1:y,x2:N+j/2,y2:y,stroke:i,strokeWidth:1}),e.jsx("line",{x1:N-j/2,y1:c,x2:N+j/2,y2:c,stroke:i,strokeWidth:1}),e.jsx("rect",{x:a,y:C,width:r,height:Math.abs(x-C),stroke:i,fill:o,fillOpacity:.6}),e.jsx("line",{x1:a,y1:p,x2:a+r,y2:p,stroke:i,strokeWidth:2}),l.outliers&&l.outliers.map((O,M)=>e.jsx("circle",{cx:N,cy:u(O),r:2,fill:"#ef4444",opacity:.6},M))]})},ll=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a[0].payload;return e.jsxs("div",{className:"bg-popover border text-popover-foreground p-3 rounded-lg shadow-md text-sm",children:[e.jsx("p",{className:"font-semibold mb-2",children:r.name}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Max:"}),e.jsxs("span",{className:"font-medium",children:[r.max.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q3 (75%):"}),e.jsxs("span",{className:"font-medium",children:[r.q3.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Median:"}),e.jsxs("span",{className:"font-medium text-primary",children:[r.median.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q1 (25%):"}),e.jsxs("span",{className:"font-medium",children:[r.q1.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Min:"}),e.jsxs("span",{className:"font-medium",children:[r.min.toFixed(1),"h"]})]}),r.outliers.length>0&&e.jsxs("div",{className:"flex justify-between gap-4 pt-1 border-t mt-1",children:[e.jsx("span",{className:"text-destructive",children:"Outliers:"}),e.jsx("span",{className:"font-medium",children:r.outliers.length})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 pt-1 border-t",children:["Sample size: ",r.count," shifts"]})]})]})}return null},cl=({dateRange:t,limit:a=15})=>{const[s,r]=f.useState("client"),[n,i]=f.useState([]),[o,l]=f.useState(!1);return f.useEffect(()=>{(async()=>{l(!0);try{const d=new URLSearchParams({start:E(t.from,"yyyy-MM-dd"),end:E(t.to,"yyyy-MM-dd"),dimension:s,limit:a.toString()}),u={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},c=await fetch(`${ne.HOURS_DISTRIBUTION}?${d.toString()}`,{headers:u});if(c.ok){const x=await c.json();i(x)}}catch(d){console.error("Error fetching distribution data:",d)}finally{l(!1)}})()},[t,s,a]),e.jsxs(R,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Hours Distribution"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Showing spread of shift durations. Box represents middle 50% of data."})]}),e.jsx(B,{children:e.jsxs(Ze,{value:s,onValueChange:h=>r(h),children:[e.jsxs(Oe,{className:"mb-6",children:[e.jsx(W,{value:"client",children:"By Client"}),e.jsx(W,{value:"site",children:"By Site"})]}),e.jsxs("div",{className:"h-[400px] w-full",children:[o?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"Loading distribution data..."}):n.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No data available for selected period"}):e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(wt,{data:n,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(pe,{strokeDasharray:"3 3",vertical:!1,opacity:.3}),e.jsx(oe,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:{fontSize:12}}),e.jsx(le,{label:{value:"Hours Worked",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(z,{content:e.jsx(ll,{}),cursor:{fill:"transparent"}}),e.jsx(Z,{dataKey:"max",fill:"transparent",barSize:1}),e.jsx(Z,{dataKey:"median",shape:ol,fill:"#3b82f6",stroke:"#1e40af",barSize:40})]})}),!o&&n.length>0&&e.jsx("div",{className:"text-center text-xs text-muted-foreground mt-2",children:"* Whiskers extend to 1.5x IQR. Dots represent outliers."})]})]})})]})},dl=t=>{const{cx:a,cy:s,payload:r}=t;if(!a||!s)return null;const n=20;return e.jsx("line",{x1:a,y1:s-n/2,x2:a,y2:s+n/2,stroke:"#000",strokeWidth:3})},hl=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a.find(i=>i.dataKey==="actual"),n=r?r.payload:a[0].payload;return e.jsxs("div",{className:"bg-white p-3 border rounded shadow-lg text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:n.name}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[e.jsx("span",{className:"text-gray-500",children:"Actual:"}),e.jsx("span",{className:"font-mono font-medium",children:n.actual}),e.jsx("span",{className:"text-gray-500",children:"Target:"}),e.jsx("span",{className:"font-mono font-medium",children:n.target}),e.jsx("span",{className:"text-gray-500",children:"Achievement:"}),e.jsxs("span",{className:`font-mono font-bold ${n.achievement>=100?"text-green-600":n.achievement>=80?"text-yellow-600":"text-red-600"}`,children:[n.achievement,"%"]})]})]})}return null},ul=({dateRange:t,limit:a=15,dimension:s="site"})=>{const[r,n]=f.useState([]),[i,o]=f.useState(!1);return f.useEffect(()=>{(async()=>{if(!(!(t!=null&&t.from)||!(t!=null&&t.to))){o(!0);try{const h=E(t.from,"yyyy-MM-dd"),d=E(t.to,"yyyy-MM-dd"),u=localStorage.getItem("auth_token"),c=await fetch(`${ne.TARGET_ACHIEVEMENT_BULLET}?start=${h}&end=${d}&dimension=${s}&limit=${a}`,{headers:{Authorization:`Bearer ${u}`}});if(c.ok){const x=await c.json();n(x)}}catch(h){console.error("Error fetching bullet chart data:",h)}finally{o(!1)}}})()},[t,a,s]),i?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center",children:"Loading chart data..."}):r.length?e.jsxs("div",{className:"w-full",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Target Achievement by ",s==="client"?"Client":"Site"]}),e.jsx("div",{className:"h-[600px] w-full",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsxs(wt,{layout:"vertical",data:r,margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(pe,{stroke:"#f5f5f5",horizontal:!0,vertical:!0}),e.jsx(oe,{type:"number"}),e.jsx(le,{type:"category",dataKey:"name",width:100,tick:{fontSize:12}}),e.jsx(z,{content:e.jsx(hl,{}),cursor:{fill:"transparent"}}),e.jsx(Z,{dataKey:"range_poor",stackId:"ranges",fill:"#fee2e2",barSize:30,isAnimationActive:!1}),e.jsx(Z,{dataKey:"range_good",stackId:"ranges",fill:"#fef3c7",barSize:30,isAnimationActive:!1}),e.jsx(Z,{dataKey:"range_excellent",stackId:"ranges",fill:"#dcfce7",barSize:30,isAnimationActive:!1}),e.jsx(Z,{dataKey:"actual",barSize:12,fill:"#1f2937"}),e.jsx(Ve,{dataKey:"marker",shape:e.jsx(dl,{}),legendType:"none"})]})})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-red-100 border border-red-200 block"}),e.jsx("span",{children:"Poor (<80%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-200 block"}),e.jsx("span",{children:"Good (80-95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-green-100 border border-green-200 block"}),e.jsx("span",{children:"Excellent (>95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-1 bg-gray-800 block"}),e.jsx("span",{children:"Actual"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1 h-3 bg-black block"}),e.jsx("span",{children:"Target"})]})]})]}):e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-gray-500",children:"No data available for this period"})},xe=["#ef4444","#f97316","#eab308","#84cc16","#22c55e"],ml=t=>t<10?xe[0]:t<20?xe[1]:t<30?xe[2]:t<40?xe[3]:xe[4],fl=t=>{const{root:a,depth:s,x:r,y:n,width:i,height:o,index:l,payload:h,colors:d,rank:u,name:c,margin:x}=t;return e.jsxs("g",{children:[e.jsx("rect",{x:r,y:n,width:i,height:o,style:{fill:ml(x),stroke:"#fff",strokeWidth:2/(s+1e-10),strokeOpacity:1/(s+1e-10)}}),i>50&&o>30&&e.jsx("text",{x:r+i/2,y:n+o/2,textAnchor:"middle",fill:"#fff",fontSize:12,fontWeight:"bold",style:{pointerEvents:"none"},children:c})]})},xl=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:s.name}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Revenue:"}),e.jsxs("span",{className:"font-mono",children:["£",s.revenue.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Profit:"}),e.jsxs("span",{className:`font-mono ${s.profit>=0?"text-green-600":"text-red-600"}`,children:["£",s.profit.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4 border-t pt-1 mt-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Margin:"}),e.jsxs("span",{className:`font-mono font-bold ${s.margin>=0?"text-green-600":"text-red-600"}`,children:[s.margin.toFixed(1),"%"]})]})]})]})}return null},gl=({data:t})=>!t||t.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"}):e.jsx(R,{children:e.jsxs(B,{className:"pt-6",children:[e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(se,{width:"100%",height:"100%",children:e.jsx(Je,{data:t,dataKey:"size",aspectRatio:4/3,stroke:"#fff",fill:"#8884d8",content:e.jsx(fl,{}),children:e.jsx(z,{content:e.jsx(xl,{})})})})}),e.jsxs("div",{className:"mt-4 flex flex-wrap justify-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsx("span",{children:"< 10% Margin"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-orange-500"}),e.jsx("span",{children:"10-20%"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsx("span",{children:"20-30%"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-lime-500"}),e.jsx("span",{children:"30-40%"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("span",{children:"> 40%"})]})]})]})}),Ue=["January","February","March","April","May","June","July","August","September","October","November","December"],bt=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],pl=({open:t,onOpenChange:a,initialData:s,onSave:r})=>{var I,v;const{data:n}=Rs(),[i,o]=f.useState(!1),[l,h]=f.useState(new Date().getFullYear()),[d,u]=f.useState(Ue[new Date().getMonth()]),[c,x]=f.useState(""),[p,C]=f.useState(""),[y,N]=f.useState(""),[j,O]=f.useState(""),[M,F]=f.useState("");f.useEffect(()=>{t&&(s?(h(s.year),u(s.month),x(s.location||""),C(s.site||""),F(s.value.toString()),bt.includes(s.name)?(N(s.name),O("")):(N("Custom..."),O(s.name))):(h(new Date().getFullYear()),u(Ue[new Date().getMonth()]),x(""),C(""),N(""),O(""),F("")))},[t,s]);const J=async()=>{if(!c||!y||!M){X.error("Please fill in all required fields");return}const m=y==="Custom..."?j:y;if(!m){X.error("Please specify the overhead name");return}o(!0);try{await r({id:s==null?void 0:s.id,year:l,month:d,location:c,site:p||null,name:m,value:parseFloat(M)}),a(!1)}catch($){console.error("Failed to save overhead:",$)}finally{o(!1)}},K=((I=n==null?void 0:n.jobs)==null?void 0:I.filter(m=>m.location===c&&m.site).map(m=>m.site).filter((m,$,L)=>L.indexOf(m)===$))||[];return e.jsx(Os,{open:t,onOpenChange:a,children:e.jsxs(Ms,{className:"sm:max-w-[500px]",children:[e.jsxs(Is,{children:[e.jsx(Ls,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(Ds,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Year"}),e.jsxs(he,{value:l.toString(),onValueChange:m=>h(Number(m)),children:[e.jsx(ue,{children:e.jsx(me,{})}),e.jsx(fe,{children:[2024,2025,2026,2027,2028].map(m=>e.jsx(re,{value:m.toString(),children:m},m))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Month"}),e.jsxs(he,{value:d,onValueChange:u,children:[e.jsx(ue,{children:e.jsx(me,{})}),e.jsx(fe,{children:Ue.map(m=>e.jsx(re,{value:m,children:m},m))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Location"}),e.jsxs(he,{value:c,onValueChange:m=>{x(m),C("")},children:[e.jsx(ue,{children:e.jsx(me,{placeholder:"Select location..."})}),e.jsx(fe,{children:Array.from(new Set((v=n==null?void 0:n.jobs)==null?void 0:v.map(m=>m.location).filter(Boolean))).map(m=>e.jsx(re,{value:m,children:m},m))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Site (Optional)"}),e.jsxs(he,{value:p,onValueChange:C,disabled:!c||K.length===0,children:[e.jsx(ue,{children:e.jsx(me,{placeholder:K.length===0?"No sites available":"Select site..."})}),e.jsxs(fe,{children:[e.jsx(re,{value:"all_sites",children:"All Sites (if applicable)"}),K.map(m=>e.jsx(re,{value:m,children:m},m))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Category"}),e.jsxs(he,{value:y,onValueChange:N,children:[e.jsx(ue,{children:e.jsx(me,{placeholder:"Select category..."})}),e.jsx(fe,{children:bt.map(m=>e.jsx(re,{value:m,children:m},m))})]})]}),y==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Custom Name"}),e.jsx(Ae,{placeholder:"Enter overhead name",value:j,onChange:m=>O(m.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(U,{children:"Value (£)"}),e.jsx(Ae,{type:"number",placeholder:"0.00",value:M,onChange:m=>F(m.target.value)})]})]}),e.jsxs(Ps,{children:[e.jsx(ee,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(ee,{onClick:J,disabled:i,children:[i&&e.jsx(Aa,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Hl=()=>{const{metricId:t}=Ca(),a=Ta(),{dateRange:s,setDateRange:r}=_a(),{role:n}=$a(),[i,o]=f.useState(!1),[l,h]=f.useState(s),[d,u]=f.useState([]),[c,x]=f.useState([]),[p,C]=f.useState("trend"),[y,N]=f.useState([]),[j,O]=f.useState([]),[M,F]=f.useState([]),[J,K]=f.useState({hours:0,staffCount:0}),[I,v]=f.useState([]),[m,$]=f.useState(!1),[L,D]=f.useState([]),[ce,na]=f.useState([]);f.useEffect(()=>{if(t!=="revenue"||p!=="trend")return;(async()=>{try{const g=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd")});d&&d.forEach(_=>g.append("locations",_)),c&&c.forEach(_=>g.append("sites",_));const T={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`/api/dashboard/client-margin-treemap?${g.toString()}`,{headers:T});if(b.ok){const _=await b.json();na(_)}}catch(g){console.error("Error fetching treemap:",g)}})()},[t,p,s,d,c]);const[ia,ye]=f.useState(!1),[oa,et]=f.useState(null),[je,Me]=f.useState(null),be=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),Ie=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),tt=t==="overheads",Le=n==="admin",{operationalData:G,isLoading:la}=Wa(s,d,c),{financialData:q,isLoading:ca}=za(s,d,c),da=be?ca:Ie?la:!1;f.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const g=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd")}),T={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`${ne.TARGETS_PERFORMANCE}?${g.toString()}`,{headers:T});if(b.ok){const _=await b.json();D(_)}}catch(g){console.error("Error fetching targets performance:",g)}})()},[s,t]),f.useEffect(()=>{if(p==="trend"||!t)return;(async()=>{$(!0);try{const g=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});d&&d.length>0&&d.forEach(b=>g.append("locations",b)),c&&c.length>0&&c.forEach(b=>g.append("sites",b));const T={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(p==="details"&&tt){const b=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:T});if(b.ok){const _=await b.json();v(_)}}else if(["location","site","client"].includes(p)){g.append("dimension",p);const b=await fetch(`${ne.BREAKDOWN}?${g.toString()}`,{headers:T});if(b.ok){const _=await b.json();N(_)}}}catch(g){console.error("Error fetching breakdown:",g)}finally{$(!1)}})()},[p,t,s,d,c]),f.useEffect(()=>{t==="clients"&&p==="revenueTier"&&Le&&(async()=>{try{const g=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd")});d&&d.length>0&&d.forEach(_=>g.append("locations",_)),c&&c.length>0&&c.forEach(_=>g.append("sites",_));const T={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`/api/dashboard/client-revenue-tiers?${g.toString()}`,{headers:T});if(b.ok){const P=(await b.json()).tiers.map(de=>({name:de.tier,value:de.totalRevenue,clientCount:de.clientCount,avgRevenue:de.avgRevenue,clients:de.clients||[]}));O(P)}}catch(g){console.error("Error fetching revenue tiers:",g)}})()},[t,p,Le,s,d,c]),f.useEffect(()=>{p==="trend"&&(async()=>{try{const g=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd")});d&&d.length>0&&d.forEach(P=>g.append("locations",P)),c&&c.length>0&&c.forEach(P=>g.append("sites",P));const T={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`/api/dashboard/client-workload-scatter?${g.toString()}`,{headers:T});if(!b.ok){console.error(`❌ Workload scatter API failed (${b.status}): /api/dashboard/client-workload-scatter`);const P=await b.text();console.error("Response preview:",P.substring(0,200));return}const _=await b.json();F(_.data||[]),K(_.medians||{hours:0,staffCount:0})}catch(g){console.error("Error fetching workload data:",g)}})()},[p,s,d,c]);const ha=()=>{et(null),ye(!0)},ua=A=>{et(A),ye(!0)},ma=async()=>{if(je)try{const A=await fetch(`/api/admin/financial-metrics/${je}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(A.ok)X.success("Overhead deleted"),p==="details"&&v(g=>g.filter(T=>T.id!==je));else{const g=await A.json();X.error(g.error||"Failed to delete")}}catch(A){console.error(A),X.error("Failed to delete")}finally{Me(null)}},fa=async A=>{try{const g=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(A)});if(g.ok){X.success("Overhead saved"),ye(!1);const T=new URLSearchParams({start:E(s.from,"yyyy-MM-dd"),end:E(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});d&&d.forEach(P=>T.append("locations",P)),c&&c.forEach(P=>T.append("sites",P));const b={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},_=await fetch(`${ne.FINANCIAL_METRICS_LIST}?${T.toString()}`,{headers:b});if(_.ok){const P=await _.json();v(P)}}else{const T=await g.json();X.error(T.error||"Failed to save")}}catch(g){console.error(g),X.error("Failed to save")}},xa=A=>{switch(A){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},ga=f.useMemo(()=>{if(!I||I.length===0)return[];const A=I.reduce((g,T)=>{const b=T.name||"Unknown";return g[b]||(g[b]=0),g[b]+=T.value,g},{});return Object.entries(A).map(([g,T])=>({name:g,value:T}))},[I]);return be?q==null||q.timeSeries:G==null||G.timeSeries,e.jsx(Ra,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Ka,{dateRange:s,onDateRangeChange:r,calendarOpen:i,onCalendarOpenChange:o,tempDateRange:l,onTempDateRangeChange:h,selectedLocations:d,onLocationsChange:u,selectedSites:c,onSitesChange:x}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(da||m)&&e.jsx(Ga,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ee,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(Fs,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:xa(t)})]}),e.jsxs(Ze,{value:p,onValueChange:C,className:"space-y-4",children:[e.jsxs(Oe,{children:[e.jsx(W,{value:"trend",children:"Trend"}),e.jsx(W,{value:"location",children:"By Location"}),e.jsx(W,{value:"site",children:"By Site"}),t!=="clients"&&t!=="targetAchievement"&&e.jsx(W,{value:"client",children:"By Clients"}),t==="clients"&&Le&&e.jsx(W,{value:"revenueTier",children:"By Revenue Tier"}),tt&&e.jsx(W,{value:"details",children:"All Details"})]}),e.jsx(Y,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(nl,{data:M,medianHours:J.hours,medianStaff:J.staffCount}),t==="shifts"&&e.jsx(il,{dateRange:s,locations:d,sites:c}),be&&t!=="revenue"&&e.jsx(qa,{data:(q==null?void 0:q.timeSeries)||[],aggregationLevel:(q==null?void 0:q.aggregationLevel)||"monthly",selectedMetric:t}),t==="revenue"&&e.jsx(gl,{data:ce}),Ie&&t!=="missedTargets"&&t!=="shifts"&&t!=="hours"&&t!=="targetAchievement"&&e.jsx(Ha,{data:(G==null?void 0:G.timeSeries)||[],aggregationLevel:(G==null?void 0:G.aggregationLevel)||"monthly",selectedMetric:t}),t==="hours"&&e.jsx(cl,{dateRange:s}),t==="targetAchievement"&&e.jsx(ul,{dateRange:s,dimension:"client"}),t==="missedTargets"&&e.jsx(Va,{data:L}),!be&&!Ie&&e.jsx(R,{children:e.jsx(B,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})})]})}),e.jsx(Y,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(we,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(we,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:y,metric:t||"revenue"}),e.jsx(we,{data:y,metric:t||"revenue"})]})}),e.jsx(Y,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(sl,{data:j}),e.jsxs(R,{children:[e.jsx(te,{children:e.jsx(ae,{children:"Tier Breakdown"})}),e.jsx(B,{children:e.jsxs(Lt,{children:[e.jsx(Dt,{children:e.jsxs(Ce,{children:[e.jsx(H,{children:"Tier"}),e.jsx(H,{className:"text-right",children:"Clients"}),e.jsx(H,{className:"text-right",children:"Total Revenue"}),e.jsx(H,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Pt,{children:j.map(A=>e.jsxs(Ce,{children:[e.jsx(V,{className:"font-medium",children:A.name}),e.jsx(V,{className:"text-right",children:A.clientCount}),e.jsxs(V,{className:"text-right",children:["£",A.value.toLocaleString()]}),e.jsxs(V,{className:"text-right",children:["£",A.avgRevenue.toLocaleString()]})]},A.name))})]})})]})]})}),e.jsx(Y,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(we,{data:ga,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(ee,{onClick:ha,className:"gap-2",children:[e.jsx(Bs,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(el,{data:I,onEdit:ua,onDelete:Me}),e.jsx(pl,{open:ia,onOpenChange:ye,initialData:oa,onSave:fa}),e.jsx(Ea,{open:!!je,onOpenChange:A=>!A&&Me(null),children:e.jsxs(ka,{children:[e.jsxs(Oa,{children:[e.jsx(Ma,{children:"Are you sure?"}),e.jsx(Ia,{children:"This will permanently delete this overhead record."})]}),e.jsxs(La,{children:[e.jsx(Da,{children:"Cancel"}),e.jsx(Pa,{onClick:ma,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Hl as default};
