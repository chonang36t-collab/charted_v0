import{c as hs,h as ms,r as i,U as us,p as xs,j as e,v as fs,P as he,q as ye,w as gs,e as Ce,B as K,I as ce,L as js,y as U,ab as ps,u as vs,d as ys,b as Ns,a3 as bs,a4 as Cs,a5 as Ss,a6 as ws,a7 as Ts,a8 as ks,a9 as As,aa as Ms,A as le}from"./index-B5MuF-qr.js";import{D as Ls}from"./DashboardLayout-DuK_vmQw.js";import{C as P,d as I,a as J,b as X}from"./card-BLMa-B4o.js";import{c as $e,R as Ds,I as Rs}from"./index-DOKzCGFB.js";import{D as Es}from"./DashboardHeader-Bov7-K7o.js";import{S as Pe,Z as $s,u as Ps,O as Is,T as _s}from"./TargetPerformanceChart-laBMFIAe.js";import{u as Os,L as Bs,R as Fs}from"./LoadingOverlay-UybJL07E.js";import{g as zs,X as me,Y as ue,f as Hs,R as xe,C as Se,T as fe,B as Ie,a as we,L as Vs,b as Le,c as De}from"./generateCategoricalChart-BEfurWd0.js";import{B as _e}from"./BarChart-DoZ0EEO1.js";import{P as Ws,a as Us}from"./PieChart-lFSQ_DVI.js";import{T as Oe,a as Be,b as de,c as E,d as Fe,e as $}from"./table-NmpVn6ke.js";import{P as Gs}from"./pen-DP9EUISO.js";import{T as Ks}from"./trash-2-DSQNfzSX.js";import{L}from"./label-Clmu_KuL.js";import{f as w}from"./popover-DzqOyyH6.js";import{D as qs,b as Ys,c as Js,d as Xs,f as Zs,e as Qs}from"./dialog-CtTuO5hF.js";import{S as ee,a as se,b as te,c as ae,d as Y}from"./select-B8pUzcLJ.js";import{u as et}from"./useRecords-tiOrBTVh.js";import{P as st}from"./plus-C7ILk1bL.js";import"./users-BvhGoy_k.js";import"./locationUtils-CsPlEKRd.js";import"./checkbox-BeGd0gPx.js";import"./index-4ljK9HZu.js";import"./AreaChart-DOso7RU0.js";import"./useQuery-BjvV8N9r.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=hs("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var at=zs({chartName:"ScatterChart",GraphicalChild:Pe,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:me},{axisType:"yAxis",AxisComp:ue},{axisType:"zAxis",AxisComp:$s}],formatAxisMap:Hs}),ge="Tabs",[rt,Ht]=ms(ge,[$e]),ze=$e(),[nt,Te]=rt(ge),He=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,onValueChange:c,defaultValue:d,orientation:u="horizontal",dir:j,activationMode:y="automatic",...m}=t,p=us(j),[l,S]=xs({prop:n,onChange:c,defaultProp:d??"",caller:ge});return e.jsx(nt,{scope:s,baseId:fs(),value:l,onValueChange:S,orientation:u,dir:p,activationMode:y,children:e.jsx(he.div,{dir:p,"data-orientation":u,...m,ref:a})})});He.displayName=ge;var Ve="TabsList",We=i.forwardRef((t,a)=>{const{__scopeTabs:s,loop:n=!0,...c}=t,d=Te(Ve,s),u=ze(s);return e.jsx(Ds,{asChild:!0,...u,orientation:d.orientation,dir:d.dir,loop:n,children:e.jsx(he.div,{role:"tablist","aria-orientation":d.orientation,...c,ref:a})})});We.displayName=Ve;var Ue="TabsTrigger",Ge=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,disabled:c=!1,...d}=t,u=Te(Ue,s),j=ze(s),y=Ye(u.baseId,n),m=Je(u.baseId,n),p=n===u.value;return e.jsx(Rs,{asChild:!0,...j,focusable:!c,active:p,children:e.jsx(he.button,{type:"button",role:"tab","aria-selected":p,"aria-controls":m,"data-state":p?"active":"inactive","data-disabled":c?"":void 0,disabled:c,id:y,...d,ref:a,onMouseDown:ye(t.onMouseDown,l=>{!c&&l.button===0&&l.ctrlKey===!1?u.onValueChange(n):l.preventDefault()}),onKeyDown:ye(t.onKeyDown,l=>{[" ","Enter"].includes(l.key)&&u.onValueChange(n)}),onFocus:ye(t.onFocus,()=>{const l=u.activationMode!=="manual";!p&&!c&&l&&u.onValueChange(n)})})})});Ge.displayName=Ue;var Ke="TabsContent",qe=i.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,forceMount:c,children:d,...u}=t,j=Te(Ke,s),y=Ye(j.baseId,n),m=Je(j.baseId,n),p=n===j.value,l=i.useRef(p);return i.useEffect(()=>{const S=requestAnimationFrame(()=>l.current=!1);return()=>cancelAnimationFrame(S)},[]),e.jsx(gs,{present:c||p,children:({present:S})=>e.jsx(he.div,{"data-state":p?"active":"inactive","data-orientation":j.orientation,role:"tabpanel","aria-labelledby":y,hidden:!S,id:m,tabIndex:0,...u,ref:a,style:{...t.style,animationDuration:l.current?"0s":void 0},children:S&&d})})});qe.displayName=Ke;function Ye(t,a){return`${t}-trigger-${a}`}function Je(t,a){return`${t}-content-${a}`}var it=He,Xe=We,Ze=Ge,Qe=qe;const es=it,ke=i.forwardRef(({className:t,...a},s)=>e.jsx(Xe,{ref:s,className:Ce("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));ke.displayName=Xe.displayName;const F=i.forwardRef(({className:t,...a},s)=>e.jsx(Ze,{ref:s,className:Ce("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));F.displayName=Ze.displayName;const z=i.forwardRef(({className:t,...a},s)=>e.jsx(Qe,{ref:s,className:Ce("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));z.displayName=Qe.displayName;const lt=({active:t,payload:a,label:s,metric:n})=>{if(t&&a&&a.length){const c=["clients","employees","shifts","hours"].includes(n),d=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:c?d.toLocaleString():d.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},Ne=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(P,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(xe,{width:"100%",height:"100%",children:e.jsxs(_e,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(Se,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(me,{type:"number",hide:!0}),e.jsx(ue,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(fe,{content:e.jsx(lt,{metric:a})}),e.jsx(Ie,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((n,c)=>e.jsx(we,{fill:"hsl(var(--primary))",fillOpacity:.8+c*.05},`cell-${c}`))})]})})})})}),Re=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ot=({active:t,payload:a,metric:s})=>{if(t&&a&&a.length){const n=["revenue","costs","profit","overheads"].includes(s);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:n?Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(a[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]})}return null},oe=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(P,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((d,u)=>u.value-d.value),n=s.reduce((d,u)=>d+u.value,0),c=s.map(d=>({...d,percentage:n>0?d.value/n*100:0}));return e.jsx(P,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(xe,{width:"100%",height:"100%",children:e.jsxs(Ws,{children:[e.jsx(Us,{data:c,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:c.map((d,u)=>e.jsx(we,{fill:Re[u%Re.length]},`cell-${u}`))}),e.jsx(fe,{content:e.jsx(ot,{metric:a})}),e.jsx(Vs,{})]})})})})})},ct=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(P,{children:[e.jsx(J,{children:e.jsx(X,{children:"Overheads Details"})}),e.jsx(I,{children:e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsxs(de,{children:[e.jsx(E,{children:"Title"}),e.jsx(E,{children:"Month"}),e.jsx(E,{children:"Location"}),e.jsx(E,{children:"Site"}),e.jsx(E,{className:"text-right",children:"Amount"}),e.jsx(E,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Fe,{children:t.map(n=>e.jsxs(de,{children:[e.jsx($,{className:"font-medium",children:n.name}),e.jsxs($,{children:[n.month," ",n.year]}),e.jsx($,{children:n.location||"-"}),e.jsx($,{children:n.site||"-"}),e.jsx($,{className:"text-right",children:n.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx($,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(n),children:e.jsx(Gs,{className:"h-4 w-4"})}),e.jsx(K,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(n.id),children:e.jsx(Ks,{className:"h-4 w-4"})})]})})]},n.id))})]})})]}),dt=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},ht=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},mt=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const n=dt(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:n}});return e.jsxs(P,{children:[e.jsxs(J,{children:[e.jsx(X,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(I,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(xe,{width:"100%",height:"100%",children:e.jsxs(_e,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(Se,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(me,{type:"number",hide:!0}),e.jsx(ue,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(fe,{content:e.jsx(ht,{})}),a.map((s,n)=>s.clients.map((c,d)=>e.jsx(Ie,{dataKey:()=>c.revenue,stackId:n,fill:s.colors[d],radius:d===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((u,j)=>{const y=j===n;return e.jsx(we,{fill:y?s.colors[d]:"transparent",stroke:y?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:m=>{y&&(m.target.style.opacity="0.8")},onMouseLeave:m=>{y&&(m.target.style.opacity="1")}},`cell-${n}-${d}-${j}`)})},`${n}-${d}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,n)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((c,d)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[d]}}),e.jsx("span",{className:"truncate",title:`${c.name}: £${c.revenue.toLocaleString()}`,children:c.name})]},d))})]},n))})]})]})},ut=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},xt=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(P,{children:[e.jsx(J,{children:e.jsx(X,{children:"Client Workload vs Staff Coverage"})}),e.jsx(I,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(P,{children:[e.jsxs(J,{children:[e.jsx(X,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(I,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(xe,{width:"100%",height:"100%",children:e.jsxs(at,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(Se,{strokeDasharray:"3 3"}),e.jsx(me,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:n=>n.toLocaleString(),children:e.jsx(Le,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(ue,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(Le,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(fe,{content:e.jsx(ut,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(De,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(De,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(Pe,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((n,c)=>n+c.shiftCount,0).toLocaleString()})]})]})]})]}),ft=({dateRange:t,locations:a=[],sites:s=[]})=>{const[n,c]=i.useState("calendar"),[d,u]=i.useState([]),[j,y]=i.useState([]),[m,p]=i.useState([]),[l,S]=i.useState([]),[b,_]=i.useState(!1),[v,H]=i.useState(33),[k,V]=i.useState(67),[D,G]=i.useState(!1);i.useEffect(()=>{(async()=>{_(!0);try{const r=new URLSearchParams({start:w(t.from,"yyyy-MM-dd"),end:w(t.to,"yyyy-MM-dd"),view_type:n});a&&a.length>0&&a.forEach(Z=>r.append("locations",Z)),s&&s.length>0&&s.forEach(Z=>r.append("sites",Z));const N={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},A=await fetch(`/api/dashboard/shifts-heatmap?${r.toString()}`,{headers:N,credentials:"include"});if(!A.ok){console.error(`Heatmap API returned ${A.status}`);return}const M=await A.json();M.view_type==="calendar"?u(M.data||[]):(y(M.data||[]),p(M.locations||[]),S(M.dates||[]))}catch(r){console.error("Error fetching heatmap data:",r)}finally{_(!1)}})()},[t,a,s,n]);const q=()=>Math.max(...n==="calendar"?d.map(h=>h.shift_count):j.map(h=>h.shift_count),1),W=h=>{const r=q(),N=h/r*100;return N===0?"#f8f9fa":N<v?"#d4edda":N<k?"#fff3cd":"#f8d7da"},R=(h,r)=>{const N=j.find(A=>A.location===h&&A.date===r);return N?N.shift_count:0};return e.jsxs(P,{children:[e.jsxs(J,{children:[e.jsx(X,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"}),e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(L,{className:"font-semibold",children:"Intensity Thresholds (%)"}),e.jsx(K,{variant:"outline",size:"sm",onClick:()=>G(!D),children:D?"Done":"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Low (","<"," ",v,"%)"]}),D?e.jsx(ce,{type:"number",min:"0",max:"100",value:v,onChange:h=>H(Number(h.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsxs("span",{className:"text-sm",children:["0-",v,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Medium (",v,"-",k,"%)"]}),D?e.jsx(ce,{type:"number",min:"0",max:"100",value:k,onChange:h=>V(Number(h.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsxs("span",{className:"text-sm",children:[v,"-",k,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["High (",">="," ",k,"%)"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsxs("span",{className:"text-sm",children:[k,"-100%"]})]})]})]})]})]}),e.jsx(I,{children:e.jsxs(es,{value:n,onValueChange:h=>c(h),children:[e.jsxs(ke,{className:"mb-4",children:[e.jsx(F,{value:"calendar",children:"Calendar View"}),e.jsx(F,{value:"location_day",children:"By Location"})]}),e.jsx(z,{value:"calendar",children:b?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):d.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:d.map((h,r)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:W(h.shift_count)},title:`${h.date} (${h.day_of_week}): ${h.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:w(new Date(h.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:h.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:h.shift_count})]},r))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(z,{value:"location_day",children:b?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):m.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-scroll max-w-full",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"border-collapse",style:{minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),l.slice(0,31).map((h,r)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:w(new Date(h),"MMM d")},r))]})}),e.jsx("tbody",{children:m.map((h,r)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:h}),l.slice(0,31).map((N,A)=>{const M=R(h,N);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:W(M)},title:`${h} - ${N}: ${M} shifts`,children:M>0?M:""},A)})]},r))})]})}),l.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},be=["January","February","March","April","May","June","July","August","September","October","November","December"],Ee=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],gt=({open:t,onOpenChange:a,initialData:s,onSave:n})=>{var R,h;const{data:c}=et(),[d,u]=i.useState(!1),[j,y]=i.useState(new Date().getFullYear()),[m,p]=i.useState(be[new Date().getMonth()]),[l,S]=i.useState(""),[b,_]=i.useState(""),[v,H]=i.useState(""),[k,V]=i.useState(""),[D,G]=i.useState("");i.useEffect(()=>{t&&(s?(y(s.year),p(s.month),S(s.location||""),_(s.site||""),G(s.value.toString()),Ee.includes(s.name)?(H(s.name),V("")):(H("Custom..."),V(s.name))):(y(new Date().getFullYear()),p(be[new Date().getMonth()]),S(""),_(""),H(""),V(""),G("")))},[t,s]);const q=async()=>{if(!l||!v||!D){U.error("Please fill in all required fields");return}const r=v==="Custom..."?k:v;if(!r){U.error("Please specify the overhead name");return}u(!0);try{await n({id:s==null?void 0:s.id,year:j,month:m,location:l,site:b||null,name:r,value:parseFloat(D)}),a(!1)}catch(N){console.error("Failed to save overhead:",N)}finally{u(!1)}},W=((R=c==null?void 0:c.jobs)==null?void 0:R.filter(r=>r.location===l&&r.site).map(r=>r.site).filter((r,N,A)=>A.indexOf(r)===N))||[];return e.jsx(qs,{open:t,onOpenChange:a,children:e.jsxs(Ys,{className:"sm:max-w-[500px]",children:[e.jsxs(Js,{children:[e.jsx(Xs,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(Zs,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Year"}),e.jsxs(ee,{value:j.toString(),onValueChange:r=>y(Number(r)),children:[e.jsx(se,{children:e.jsx(te,{})}),e.jsx(ae,{children:[2024,2025,2026,2027,2028].map(r=>e.jsx(Y,{value:r.toString(),children:r},r))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Month"}),e.jsxs(ee,{value:m,onValueChange:p,children:[e.jsx(se,{children:e.jsx(te,{})}),e.jsx(ae,{children:be.map(r=>e.jsx(Y,{value:r,children:r},r))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Location"}),e.jsxs(ee,{value:l,onValueChange:r=>{S(r),_("")},children:[e.jsx(se,{children:e.jsx(te,{placeholder:"Select location..."})}),e.jsx(ae,{children:Array.from(new Set((h=c==null?void 0:c.jobs)==null?void 0:h.map(r=>r.location).filter(Boolean))).map(r=>e.jsx(Y,{value:r,children:r},r))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Site (Optional)"}),e.jsxs(ee,{value:b,onValueChange:_,disabled:!l||W.length===0,children:[e.jsx(se,{children:e.jsx(te,{placeholder:W.length===0?"No sites available":"Select site..."})}),e.jsxs(ae,{children:[e.jsx(Y,{value:"all_sites",children:"All Sites (if applicable)"}),W.map(r=>e.jsx(Y,{value:r,children:r},r))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Category"}),e.jsxs(ee,{value:v,onValueChange:H,children:[e.jsx(se,{children:e.jsx(te,{placeholder:"Select category..."})}),e.jsx(ae,{children:Ee.map(r=>e.jsx(Y,{value:r,children:r},r))})]})]}),v==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Custom Name"}),e.jsx(ce,{placeholder:"Enter overhead name",value:k,onChange:r=>V(r.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Value (£)"}),e.jsx(ce,{type:"number",placeholder:"0.00",value:D,onChange:r=>G(r.target.value)})]})]}),e.jsxs(Qs,{children:[e.jsx(K,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(K,{onClick:q,disabled:d,children:[d&&e.jsx(js,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Vt=()=>{const{metricId:t}=ps(),a=vs(),{dateRange:s,setDateRange:n}=ys(),{role:c}=Ns(),[d,u]=i.useState(!1),[j,y]=i.useState(s),[m,p]=i.useState([]),[l,S]=i.useState([]),[b,_]=i.useState("trend"),[v,H]=i.useState([]),[k,V]=i.useState([]),[D,G]=i.useState([]),[q,W]=i.useState({hours:0,staffCount:0}),[R,h]=i.useState([]),[r,N]=i.useState(!1),[A,M]=i.useState([]),[Z,re]=i.useState(!1),[ss,Ae]=i.useState(null),[ne,je]=i.useState(null),ie=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),pe=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),Me=t==="overheads",ve=c==="admin",{operationalData:O,isLoading:ts}=Ps(s,m,l),{financialData:B,isLoading:as}=Os(s,m,l),rs=ie?as:pe?ts:!1;i.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const o=new URLSearchParams({start:w(s.from,"yyyy-MM-dd"),end:w(s.to,"yyyy-MM-dd")}),g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`${le.TARGETS_PERFORMANCE}?${o.toString()}`,{headers:g});if(x.ok){const C=await x.json();M(C)}}catch(o){console.error("Error fetching targets performance:",o)}})()},[s,t]),i.useEffect(()=>{if(b==="trend"||!t)return;(async()=>{N(!0);try{const o=new URLSearchParams({start:w(s.from,"yyyy-MM-dd"),end:w(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});m&&m.length>0&&m.forEach(x=>o.append("locations",x)),l&&l.length>0&&l.forEach(x=>o.append("sites",x));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(b==="details"&&Me){const x=await fetch(`${le.FINANCIAL_METRICS_LIST}?${o.toString()}`,{headers:g});if(x.ok){const C=await x.json();h(C)}}else if(["location","site","client"].includes(b)){o.append("dimension",b);const x=await fetch(`${le.BREAKDOWN}?${o.toString()}`,{headers:g});if(x.ok){const C=await x.json();H(C)}}}catch(o){console.error("Error fetching breakdown:",o)}finally{N(!1)}})()},[b,t,s,m,l]),i.useEffect(()=>{t==="clients"&&b==="revenueTier"&&ve&&(async()=>{try{const o=new URLSearchParams({start:w(s.from,"yyyy-MM-dd"),end:w(s.to,"yyyy-MM-dd")});m&&m.length>0&&m.forEach(C=>o.append("locations",C)),l&&l.length>0&&l.forEach(C=>o.append("sites",C));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`/api/dashboard/client-revenue-tiers?${o.toString()}`,{headers:g});if(x.ok){const T=(await x.json()).tiers.map(Q=>({name:Q.tier,value:Q.totalRevenue,clientCount:Q.clientCount,avgRevenue:Q.avgRevenue,clients:Q.clients||[]}));V(T)}}catch(o){console.error("Error fetching revenue tiers:",o)}})()},[t,b,ve,s,m,l]),i.useEffect(()=>{b==="trend"&&(async()=>{try{const o=new URLSearchParams({start:w(s.from,"yyyy-MM-dd"),end:w(s.to,"yyyy-MM-dd")});m&&m.length>0&&m.forEach(T=>o.append("locations",T)),l&&l.length>0&&l.forEach(T=>o.append("sites",T));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`/api/dashboard/client-workload-scatter?${o.toString()}`,{headers:g});if(!x.ok){console.error(`❌ Workload scatter API failed (${x.status}): /api/dashboard/client-workload-scatter`);const T=await x.text();console.error("Response preview:",T.substring(0,200));return}const C=await x.json();G(C.data||[]),W(C.medians||{hours:0,staffCount:0})}catch(o){console.error("Error fetching workload data:",o)}})()},[b,s,m,l]);const ns=()=>{Ae(null),re(!0)},is=f=>{Ae(f),re(!0)},ls=async()=>{if(ne)try{const f=await fetch(`/api/admin/financial-metrics/${ne}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(f.ok)U.success("Overhead deleted"),b==="details"&&h(o=>o.filter(g=>g.id!==ne));else{const o=await f.json();U.error(o.error||"Failed to delete")}}catch(f){console.error(f),U.error("Failed to delete")}finally{je(null)}},os=async f=>{try{const o=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(f)});if(o.ok){U.success("Overhead saved"),re(!1);const g=new URLSearchParams({start:w(s.from,"yyyy-MM-dd"),end:w(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});m&&m.forEach(T=>g.append("locations",T)),l&&l.forEach(T=>g.append("sites",T));const x={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},C=await fetch(`${le.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:x});if(C.ok){const T=await C.json();h(T)}}else{const g=await o.json();U.error(g.error||"Failed to save")}}catch(o){console.error(o),U.error("Failed to save")}},cs=f=>{switch(f){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},ds=i.useMemo(()=>{if(!R||R.length===0)return[];const f=R.reduce((o,g)=>{const x=g.name||"Unknown";return o[x]||(o[x]=0),o[x]+=g.value,o},{});return Object.entries(f).map(([o,g])=>({name:o,value:g}))},[R]);return ie?B==null||B.timeSeries:O==null||O.timeSeries,e.jsx(Ls,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Es,{dateRange:s,onDateRangeChange:n,calendarOpen:d,onCalendarOpenChange:u,tempDateRange:j,onTempDateRangeChange:y,selectedLocations:m,onLocationsChange:p,selectedSites:l,onSitesChange:S}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(rs||r)&&e.jsx(Bs,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(K,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(tt,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:cs(t)})]}),e.jsxs(es,{value:b,onValueChange:_,className:"space-y-4",children:[e.jsxs(ke,{children:[e.jsx(F,{value:"trend",children:"Trend"}),e.jsx(F,{value:"location",children:"By Location"}),e.jsx(F,{value:"site",children:"By Site"}),t!=="clients"&&e.jsx(F,{value:"client",children:"By Clients"}),t==="clients"&&ve&&e.jsx(F,{value:"revenueTier",children:"By Revenue Tier"}),Me&&e.jsx(F,{value:"details",children:"All Details"})]}),e.jsx(z,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(xt,{data:D,medianHours:q.hours,medianStaff:q.staffCount}),t==="shifts"&&e.jsx(ft,{dateRange:s,locations:m,sites:l}),ie&&e.jsx(Fs,{data:(B==null?void 0:B.timeSeries)||[],aggregationLevel:(B==null?void 0:B.aggregationLevel)||"monthly",selectedMetric:t}),pe&&t!=="missedTargets"&&t!=="shifts"&&e.jsx(Is,{data:(O==null?void 0:O.timeSeries)||[],aggregationLevel:(O==null?void 0:O.aggregationLevel)||"monthly",selectedMetric:t}),t==="missedTargets"&&e.jsx(_s,{data:A}),!ie&&!pe&&e.jsx(P,{children:e.jsx(I,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})})]})}),e.jsx(z,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ne,{data:v,metric:t||"revenue"}),e.jsx(oe,{data:v,metric:t||"revenue"})]})}),e.jsx(z,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ne,{data:v,metric:t||"revenue"}),e.jsx(oe,{data:v,metric:t||"revenue"})]})}),e.jsx(z,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ne,{data:v,metric:t||"revenue"}),e.jsx(oe,{data:v,metric:t||"revenue"})]})}),e.jsx(z,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(mt,{data:k}),e.jsxs(P,{children:[e.jsx(J,{children:e.jsx(X,{children:"Tier Breakdown"})}),e.jsx(I,{children:e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsxs(de,{children:[e.jsx(E,{children:"Tier"}),e.jsx(E,{className:"text-right",children:"Clients"}),e.jsx(E,{className:"text-right",children:"Total Revenue"}),e.jsx(E,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Fe,{children:k.map(f=>e.jsxs(de,{children:[e.jsx($,{className:"font-medium",children:f.name}),e.jsx($,{className:"text-right",children:f.clientCount}),e.jsxs($,{className:"text-right",children:["£",f.value.toLocaleString()]}),e.jsxs($,{className:"text-right",children:["£",f.avgRevenue.toLocaleString()]})]},f.name))})]})})]})]})}),e.jsx(z,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(oe,{data:ds,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(K,{onClick:ns,className:"gap-2",children:[e.jsx(st,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(ct,{data:R,onEdit:is,onDelete:je}),e.jsx(gt,{open:Z,onOpenChange:re,initialData:ss,onSave:os}),e.jsx(bs,{open:!!ne,onOpenChange:f=>!f&&je(null),children:e.jsxs(Cs,{children:[e.jsxs(Ss,{children:[e.jsx(ws,{children:"Are you sure?"}),e.jsx(Ts,{children:"This will permanently delete this overhead record."})]}),e.jsxs(ks,{children:[e.jsx(As,{children:"Cancel"}),e.jsx(Ms,{onClick:ls,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Vt as default};
