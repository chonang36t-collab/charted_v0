import{c as H,r as l,a as te,j as e,I as _,B as y,X as z,f as q,g as V,A as le}from"./index-DqRlWhRN.js";import{D as ae,a as re,F as ie}from"./DashboardLayout-zE_Ymdb9.js";import{C as d,a as o,b as x,d as m}from"./card-D5vd-LVJ.js";import{L as A}from"./label-D_WPptcu.js";import{P as ce}from"./progress-DCgnq1U8.js";import{B as $}from"./badge-BS_Ozsh5.js";import"./users-BOBInr6z.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=H("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=H("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function ge(){const[u,w]=l.useState(null),[h,F]=l.useState(!1),[R,f]=l.useState(0),[I,oe]=l.useState({}),[j,p]=l.useState("idle"),[K,S]=l.useState(""),[r,b]=l.useState(null),C=l.useRef(null),{toast:k}=te(),[c,E]=l.useState([]),[n,U]=l.useState([]),[g,B]=l.useState(""),[N,M]=l.useState("");l.useEffect(()=>{const s=localStorage.getItem("upload_excluded_locations"),t=localStorage.getItem("upload_excluded_clients");s&&E(JSON.parse(s)),t&&U(JSON.parse(t))},[]),l.useEffect(()=>{localStorage.setItem("upload_excluded_locations",JSON.stringify(c))},[c]),l.useEffect(()=>{localStorage.setItem("upload_excluded_clients",JSON.stringify(n))},[n]);const O=()=>{g.trim()&&!c.includes(g.trim())&&(E([...c,g.trim()]),B(""))},W=s=>{E(c.filter(t=>t!==s))},T=()=>{N.trim()&&!n.includes(N.trim())&&(U([...n,N.trim()]),M(""))},G=s=>{U(n.filter(t=>t!==s))},X=s=>{var a;const t=(a=s.target.files)==null?void 0:a[0];t&&(t.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||t.type==="application/vnd.ms-excel"||t.name.endsWith(".csv")?(w(t),p("idle"),S("")):(k({title:"Invalid file type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file",variant:"destructive"}),w(null)))},Y=async()=>{if(!u)return;F(!0),f(0),p("idle"),S(""),b(null);const s=new FormData;s.append("file",u),s.append("excluded_locations",JSON.stringify(c)),s.append("excluded_clients",JSON.stringify(n));try{const t=localStorage.getItem("auth_token"),a=await fetch(le.UPLOAD,{method:"POST",body:s,headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!a.ok)throw new Error(`Upload failed: ${a.statusText}`);if(!a.body)throw new Error("No response body");const v=a.body.getReader(),Z=new TextDecoder;let D="",P=!1;for(;;){const{done:ee,value:se}=await v.read();if(ee)break;D+=Z.decode(se,{stream:!0});const J=D.split(`
`);D=J.pop()||"";for(const L of J)if(L.trim())try{const i=JSON.parse(L);if(i.status==="progress")i.progress&&f(i.progress);else if(i.status==="complete")p("success"),b(i.data),f(100),k({title:"Upload successful",description:"Your file has been uploaded and processed successfully"}),P=!0;else if(i.status==="error")throw new Error(i.message)}catch(i){if(console.error("Error parsing stream:",i),L.trim().startsWith("<"))throw new Error("Server error occurred during processing")}}if(!P&&j!=="success")throw new Error("Upload interrupted. The server may have run out of memory or timed out.")}catch(t){p("error"),S(t.message||"An unexpected error occurred"),k({title:"Upload failed",description:t.message||"An unexpected error occurred",variant:"destructive"})}finally{F(!1)}},Q=s=>{if(s===0)return"0 Bytes";const t=1024,a=["Bytes","KB","MB","GB"],v=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,v)).toFixed(2))+" "+a[v]};return e.jsx(ae,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Upload Data"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload your Excel or CSV files to import data into the system"})]}),e.jsxs(d,{children:[e.jsxs(o,{children:[e.jsx(x,{children:"Upload Exclusions"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Records matching these locations or clients will be automatically filtered during upload"})]}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Excluded Locations"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(_,{placeholder:"Enter location name...",value:g,onChange:s=>B(s.target.value),onKeyDown:s=>s.key==="Enter"&&O()}),e.jsx(y,{onClick:O,variant:"secondary",children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:c.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No excluded locations"}):c.map(s=>e.jsxs($,{variant:"secondary",className:"gap-1",children:[s,e.jsx(z,{className:"h-3 w-3 cursor-pointer",onClick:()=>W(s)})]},s))})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Excluded Clients"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(_,{placeholder:"Enter client name...",value:N,onChange:s=>M(s.target.value),onKeyDown:s=>s.key==="Enter"&&T()}),e.jsx(y,{onClick:T,variant:"secondary",children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:n.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No excluded clients"}):n.map(s=>e.jsxs($,{variant:"secondary",className:"gap-1",children:[s,e.jsx(z,{className:"h-3 w-3 cursor-pointer",onClick:()=>G(s)})]},s))})]})]})]}),e.jsxs(d,{children:[e.jsx(o,{children:e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5"}),"File Upload"]})}),e.jsxs(m,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"file-upload",children:"Select File"}),e.jsx(_,{id:"file-upload",type:"file",ref:C,onChange:X,accept:".xlsx,.xls,.csv",disabled:h}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Supported formats: Excel (.xlsx, .xls) and CSV files"})]}),u&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border rounded-lg",children:[e.jsx(ie,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:u.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Q(u.size)})]})]}),h&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Uploading..."}),e.jsxs("span",{children:[R,"%"]})]}),e.jsx(ce,{value:R})]}),j==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(q,{className:"border-green-200 bg-green-50",children:[e.jsx(de,{className:"h-4 w-4 text-green-600"}),e.jsx(V,{className:"text-green-800",children:"File uploaded successfully!"})]}),r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(d,{children:[e.jsx(o,{className:"pb-2",children:e.jsx(x,{className:"text-sm font-medium",children:"Rows Inserted"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:r.inserted.toLocaleString()})})]}),e.jsxs(d,{children:[e.jsx(o,{className:"pb-2",children:e.jsx(x,{className:"text-sm font-medium",children:"Duplicate Rows"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:r.skipped_details.filter(s=>s.reason==="Duplicate").length.toLocaleString()})})]}),e.jsxs(d,{children:[e.jsx(o,{className:"pb-2",children:e.jsx(x,{className:"text-sm font-medium",children:"Skipped Rows"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:r.skipped_details.filter(s=>s.reason!=="Duplicate").length.toLocaleString()})})]}),e.jsxs(d,{children:[e.jsx(o,{className:"pb-2",children:e.jsx(x,{className:"text-sm font-medium",children:"Revenue Match"})}),e.jsxs(m,{children:[e.jsx("div",{className:`text-2xl font-bold ${r.verification.match?"text-green-600":"text-red-600"}`,children:r.verification.match?"MATCHED":"MISMATCH"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Excel: £",r.verification.excel_revenue.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["DB: £",r.verification.db_revenue.toLocaleString()]})]})]})]}),r.skipped_details.length>0&&e.jsxs(d,{children:[e.jsx(o,{children:e.jsx(x,{className:"text-base",children:"Skipped Rows Details"})}),e.jsx(m,{children:e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-md",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-muted sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 font-medium",children:"Row"}),e.jsx("th",{className:"p-2 font-medium",children:"Reason"}),e.jsx("th",{className:"p-2 font-medium",children:"Details"})]})}),e.jsx("tbody",{children:r.skipped_details.map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/50",children:[e.jsx("td",{className:"p-2",children:s.row}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${s.reason==="Duplicate"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.reason})}),e.jsx("td",{className:"p-2 text-muted-foreground",children:s.details})]},t))})]})})})]})]}),e.jsx(y,{onClick:()=>{p("idle"),f(0),w(null),b(null),C.current&&(C.current.value="")},variant:"outline",className:"w-full",children:"Upload New File"})]}),j==="error"&&e.jsxs(q,{className:"border-red-200 bg-red-50",children:[e.jsx(ne,{className:"h-4 w-4 text-red-600"}),e.jsx(V,{className:"text-red-800",children:K})]}),j!=="success"&&e.jsx(y,{onClick:Y,disabled:h,className:"w-full",children:h?"Uploading...":"Upload File"})]})]})]}),Object.keys(I).length>0&&e.jsxs(d,{children:[e.jsx(o,{children:e.jsx(x,{children:"Required Columns"})}),e.jsx(m,{children:e.jsx("div",{className:"space-y-4",children:Object.entries(I).map(([s,t])=>e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:s}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.map(a=>e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-sm",children:a},a))})]},s))})})]})]})})}export{ge as default};
