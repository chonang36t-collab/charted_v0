import{c as te,r as h,j as e,e as N,B as E,T as J,k as U,l as q,m as Q,I as L}from"./index-BHxRkZ95.js";import{D as re,T as ae}from"./DashboardLayout-C8B9cU1y.js";import{T as I}from"./trash-2-BRo36h9x.js";import{D as F,a as z,b as Y,c as B,d as $,e as V}from"./dialog-BglLAt-j.js";import{P as K}from"./plus-DJPrersg.js";import"./users-CTnIwX3p.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=te("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);function le(r){let l="",s=r;for(;s>=0;)l=String.fromCharCode(65+s%26)+l,s=Math.floor(s/26)-1;return l}const oe={database:{bg:"border-l-blue-500",border:"border-l-2",label:"Database"},manual:{bg:"border-l-transparent",border:"",label:"Manual"},formula:{bg:"border-l-orange-500",border:"border-l-2",label:"Formula"},calculated:{bg:"border-l-emerald-500",border:"border-l-2",label:"Calculated"}};function X(r,l){return r===null||r===0?"":l.isPercentage?`${r.toFixed(2)}%`:l.isCurrency?`Â£${r.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}`:r.toLocaleString("en-GB",{maximumFractionDigits:2})}function Z({source:r}){if(!r||r==="manual")return null;const l={database:"border-t-blue-500 border-r-blue-500",formula:"border-t-orange-500 border-r-orange-500",calculated:"border-t-emerald-500 border-r-emerald-500"};return e.jsx(J,{delayDuration:200,children:e.jsxs(U,{children:[e.jsx(q,{asChild:!0,children:e.jsx("div",{className:N("absolute top-0 right-0 w-0 h-0 border-t-[6px] border-r-[6px] border-b-0 border-l-0 border-solid border-b-transparent border-l-transparent",l[r])})}),e.jsxs(Q,{side:"top",className:"text-xs",children:["Source: ",oe[r].label]})]})})}function ne({rowId:r,colId:l,value:s,source:o,row:c,isActive:n,isHighlighted:i,onFocus:x,onUpdate:y,onNavigate:C}){const[v,_]=h.useState(!1),[w,j]=h.useState(""),k=h.useRef(null),A=h.useCallback(()=>{_(!0),j(s!==null?String(s):""),setTimeout(()=>{var a;return(a=k.current)==null?void 0:a.focus()},0)},[s]),b=h.useCallback(()=>{_(!1);const a=parseFloat(w);y(w===""?null:isNaN(a)?s:a)},[w,y,s]),d=a=>{v?a.key==="Enter"||a.key==="Tab"?(a.preventDefault(),b(),C(a.shiftKey?"up":"down")):a.key==="Escape"&&_(!1):a.key==="Enter"||a.key==="F2"?(a.preventDefault(),A()):a.key==="ArrowUp"?(a.preventDefault(),C("up")):a.key==="ArrowDown"?(a.preventDefault(),C("down")):a.key==="ArrowLeft"?(a.preventDefault(),C("left")):a.key==="ArrowRight"?(a.preventDefault(),C("right")):a.key==="Delete"||a.key==="Backspace"?(a.preventDefault(),y(null)):/^[0-9.\-]$/.test(a.key)&&(a.preventDefault(),j(a.key),_(!0),setTimeout(()=>{var m;return(m=k.current)==null?void 0:m.focus()},0))};return e.jsxs("td",{className:N("relative border-r border-b border-border/40 px-2 py-[5px] text-right text-[13px] min-w-[120px] cursor-cell select-none transition-all duration-75",n&&"outline outline-2 outline-primary z-10 bg-primary/5",i&&"ring-2 ring-orange-400/70 bg-orange-50/30 dark:bg-orange-950/20",!n&&!i&&"hover:bg-muted/30"),onClick:x,onDoubleClick:A,onKeyDown:d,tabIndex:0,onFocus:x,children:[e.jsx(Z,{source:o}),v?e.jsx("input",{ref:k,type:"text",value:w,onChange:a=>j(a.target.value),onBlur:b,className:"w-full bg-background text-right outline-none text-[13px] font-mono border border-primary/30 rounded px-1 -mx-1"}):e.jsx("span",{className:"font-mono text-[13px] text-foreground/90",children:X(s,c)})]})}function ie({value:r,row:l,source:s,isHighlighted:o}){return e.jsxs("td",{className:N("relative border-r border-b border-border/40 px-2 py-[5px] text-right text-[13px] min-w-[120px] select-none",l.isHeader?"bg-primary/[0.06] font-semibold":"bg-muted/20",o&&"ring-2 ring-orange-400/70 bg-orange-50/30 dark:bg-orange-950/20"),children:[e.jsx(Z,{source:s}),e.jsx("span",{className:N("font-mono text-[13px]",l.isHeader?"text-foreground font-semibold":"text-muted-foreground"),children:X(r,l)})]})}function de({rows:r,columns:l,data:s,activeCell:o,setActiveCell:c,updateCell:n,deleteRow:i,deleteColumn:x,navigateCell:y,onRenameColumn:C,onEditFormula:v}){const[_,w]=h.useState(null),[j,k]=h.useState(""),[A,b]=h.useState(null),d=h.useRef(null),a=t=>{w(t.id),k(t.label),setTimeout(()=>{var p;return(p=d.current)==null?void 0:p.focus()},0)},m=()=>{_&&C&&C(_,j),w(null)},f=h.useMemo(()=>{if(!A)return new Set;const t=r.find(S=>S.id===A);if(!(t!=null&&t.formula))return new Set;const p=["cost_sales_se","cost_sales_paye","employee_ni","employee_pension"],u=["apprenticeship_levy","annual_leave","other_expenses","recruitment_cost","overheads_mgmt","bank_interest","cooperation_tax"],P={total_cost_sales:p,total_overheads:u,total_cost:[...p,...u],gross_hourly_margin:["avg_hourly_charge","gross_hourly_pay"],hours_breakeven:["total_cost","gross_hourly_margin"],value_breakeven:["hours_breakeven","avg_hourly_charge"],sales_budget_2026:["total_sales"]}[A]||[],R=new Set;for(const S of P)for(const O of l)R.add(`${S}:${O.id}`);return R},[A,r,l]);return e.jsx("div",{className:"border border-border rounded-md bg-card overflow-hidden shadow-sm",children:e.jsx("div",{className:"overflow-auto max-h-[calc(100vh-200px)]",children:e.jsxs("table",{className:"border-collapse w-full",children:[e.jsxs("thead",{className:"sticky top-0 z-30",children:[e.jsxs("tr",{className:"bg-muted/60",children:[e.jsx("th",{className:"sticky left-0 z-40 bg-muted/80 border-r border-b border-border/50 w-10 min-w-[40px]"}),e.jsx("th",{className:"sticky left-10 z-40 bg-muted/80 border-r border-b border-border/50 w-[200px] min-w-[200px]"}),l.map((t,p)=>e.jsx("th",{className:"border-r border-b border-border/50 px-1 py-1 text-center text-[11px] font-medium text-muted-foreground bg-muted/60 min-w-[120px]",children:le(p)},p)),e.jsx("th",{className:"bg-muted/60 border-b border-border/50 w-8"})]}),e.jsxs("tr",{className:"bg-muted/40",children:[e.jsx("th",{className:"sticky left-0 z-40 bg-muted/60 border-r border-b border-border/50 w-10 min-w-[40px] text-[10px] text-muted-foreground font-medium",children:"#"}),e.jsx("th",{className:"sticky left-10 z-40 bg-muted/60 border-r border-b border-border/50 px-3 py-2 text-left text-[11px] font-semibold text-muted-foreground uppercase tracking-wider w-[200px] min-w-[200px]",children:"Description"}),l.map(t=>e.jsx("th",{className:N("border-r border-b border-border/50 px-1 py-2 text-center text-[11px] font-semibold uppercase tracking-wide min-w-[120px]",t.isYearEnd?"bg-primary/10 text-primary":"bg-muted/40 text-muted-foreground"),onDoubleClick:()=>!t.isProtected&&a(t),children:e.jsx("div",{className:"flex items-center justify-center gap-1 group relative",children:_===t.id?e.jsx("input",{ref:d,value:j,onChange:p=>k(p.target.value),onBlur:m,onKeyDown:p=>p.key==="Enter"&&m(),className:"w-full bg-background border border-border rounded px-1 text-center text-[11px]"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"truncate",children:t.label}),!t.isProtected&&e.jsx(E,{variant:"ghost",size:"icon",className:"h-4 w-4 opacity-0 group-hover:opacity-100 absolute -right-1 hover:text-destructive",onClick:p=>{p.stopPropagation(),x(t.id)},children:e.jsx(I,{className:"h-3 w-3"})})]})})},t.id)),e.jsx("th",{className:"bg-muted/40 border-b border-border/50 w-8"})]})]}),e.jsx("tbody",{children:r.map((t,p)=>e.jsxs("tr",{className:N("group",t.isHeader&&"bg-primary/[0.04]"),onMouseEnter:()=>t.isAutoCalculated&&t.formula&&b(t.id),onMouseLeave:()=>b(null),children:[e.jsx("td",{className:"sticky left-0 z-10 bg-muted/60 border-r border-b border-border/50 text-center text-[11px] text-muted-foreground font-medium w-10 min-w-[40px] select-none",children:p+1}),e.jsx("td",{className:N("sticky left-10 z-10 border-r border-b border-border/50 px-3 py-[5px] whitespace-nowrap text-[13px] truncate max-w-[200px] w-[200px] min-w-[200px] bg-card",t.isHeader&&"font-bold text-primary bg-primary/[0.04]",t.isAutoCalculated&&!t.isHeader&&"text-muted-foreground italic"),title:t.label,children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"truncate",children:t.label}),t.isAutoCalculated&&t.formula&&e.jsx(J,{delayDuration:200,children:e.jsxs(U,{children:[e.jsx(q,{asChild:!0,children:e.jsx("button",{className:"opacity-0 group-hover:opacity-70 hover:!opacity-100 transition-opacity",onClick:()=>v==null?void 0:v(t.id),children:e.jsx(se,{className:"h-3.5 w-3.5 text-orange-500"})})}),e.jsx(Q,{side:"right",className:"text-xs",children:"Edit formula"})]})})]})}),l.map(u=>{var O;const g=(O=s[t.id])==null?void 0:O[u.id],P=(g==null?void 0:g.isEditable)&&!t.isAutoCalculated&&!u.isYearEnd,R=`${t.id}:${u.id}`,S=f.has(R);return P?e.jsx(ne,{rowId:t.id,colId:u.id,value:(g==null?void 0:g.value)??null,source:g==null?void 0:g.source,row:t,isActive:(o==null?void 0:o.row)===t.id&&(o==null?void 0:o.col)===u.id,isHighlighted:S,onFocus:()=>c({row:t.id,col:u.id}),onUpdate:ee=>n(t.id,u.id,ee),onNavigate:y},u.id):e.jsx(ie,{value:(g==null?void 0:g.value)??null,row:t,source:g==null?void 0:g.source,isHighlighted:S},u.id)}),e.jsx("td",{className:"border-b border-border/40 bg-card w-8 text-center p-0",children:!t.isAutoCalculated&&e.jsx(E,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 hover:text-destructive hover:bg-destructive/10",onClick:()=>i(t.id),children:e.jsx(I,{className:"h-3 w-3"})})})]},t.id))})]})})})}const M=[{id:"jan",label:"January",isProtected:!0},{id:"feb",label:"February",isProtected:!0},{id:"mar",label:"March",isProtected:!0},{id:"apr",label:"April",isProtected:!0},{id:"may",label:"May",isProtected:!0},{id:"jun",label:"June",isProtected:!0},{id:"jul",label:"July",isProtected:!0},{id:"aug",label:"August",isProtected:!0},{id:"sep",label:"September",isProtected:!0},{id:"oct",label:"October",isProtected:!0},{id:"nov",label:"November",isProtected:!0},{id:"dec",label:"December",isProtected:!0},{id:"year_end",label:"Year End",isProtected:!0,isYearEnd:!0}],T=(r,l,s)=>l.reduce((o,c)=>{var i,x;const n=((x=(i=r[c])==null?void 0:i[s])==null?void 0:x.value)??0;return o+n},0),W=["cost_sales_se","cost_sales_paye","employee_ni","employee_pension"],G=["apprenticeship_levy","annual_leave","other_expenses","recruitment_cost","overheads_mgmt","bank_interest","cooperation_tax"],H=[{id:"total_sales",label:"Total Sales",isAutoCalculated:!1,isCurrency:!0},{id:"sales_split_pct",label:"% Sales Split for the Year",isAutoCalculated:!1,isPercentage:!0},{id:"cost_sales_se",label:"Cost of Sales SE",isAutoCalculated:!1,isCurrency:!0},{id:"cost_sales_paye",label:"Cost of Sales PAYE Gross",isAutoCalculated:!1,isCurrency:!0},{id:"employee_ni",label:"Employee NI",isAutoCalculated:!1,isCurrency:!0},{id:"employee_pension",label:"Employee Pension",isAutoCalculated:!1,isCurrency:!0},{id:"total_cost_sales",label:"Total Cost of Sales",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,l,s)=>T(r,W,s)},{id:"apprenticeship_levy",label:"Apprenticeship Levy",isAutoCalculated:!1,isCurrency:!0},{id:"annual_leave",label:"Annual Leave Accrual",isAutoCalculated:!1,isCurrency:!0},{id:"other_expenses",label:"Other Expenses",isAutoCalculated:!1,isCurrency:!0},{id:"recruitment_cost",label:"Recruitment and Pass Cost",isAutoCalculated:!1,isCurrency:!0},{id:"overheads_mgmt",label:"Overheads (Total Mgmt & Office Cost)",isAutoCalculated:!1,isCurrency:!0},{id:"bank_interest",label:"Bank Interest",isAutoCalculated:!1,isCurrency:!0},{id:"cooperation_tax",label:"Cooperation Tax",isAutoCalculated:!1,isCurrency:!0},{id:"total_overheads",label:"Total Overheads",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,l,s)=>T(r,G,s)},{id:"total_cost",label:"Total Cost",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(r,l,s)=>{const o=T(r,W,s),c=T(r,G,s);return o+c}},{id:"avg_hourly_charge",label:"Average Hourly Charge Rate",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_pay",label:"Gross Hourly Pay",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_margin",label:"Gross Hourly Margin",isAutoCalculated:!0,isCurrency:!0,formula:(r,l,s)=>{var n,i,x,y;const o=((i=(n=r.avg_hourly_charge)==null?void 0:n[s])==null?void 0:i.value)??0,c=((y=(x=r.gross_hourly_pay)==null?void 0:x[s])==null?void 0:y.value)??0;return o-c}},{id:"net_cost_per_hour",label:"Net Cost per Hour",isAutoCalculated:!1,isCurrency:!0},{id:"gross_pl_value",label:"Gross P&L Value",isAutoCalculated:!1,isCurrency:!0},{id:"net_pl",label:"Net P&L",isAutoCalculated:!1,isCurrency:!0},{id:"total_net_margin",label:"Total Net Margin",isAutoCalculated:!1,isPercentage:!0},{id:"worked_hours",label:"Worked Hours",isAutoCalculated:!1},{id:"hours_breakeven",label:"Hours for Breakeven",isAutoCalculated:!0,formula:(r,l,s)=>{var n,i,x,y;const o=((i=(n=r.total_cost)==null?void 0:n[s])==null?void 0:i.value)??0,c=((y=(x=r.gross_hourly_margin)==null?void 0:x[s])==null?void 0:y.value)??0;return c!==0?o/c:0}},{id:"value_breakeven",label:"Total Value for Breakeven",isAutoCalculated:!0,isCurrency:!0,formula:(r,l,s)=>{var n,i,x,y;const o=((i=(n=r.hours_breakeven)==null?void 0:n[s])==null?void 0:i.value)??0,c=((y=(x=r.avg_hourly_charge)==null?void 0:x[s])==null?void 0:y.value)??0;return o*c}},{id:"sales_budget_2026",label:"2026 Sales Budget 30% Uplift",isAutoCalculated:!0,isCurrency:!0,formula:(r,l,s)=>{var c,n;return(((n=(c=r.total_sales)==null?void 0:c[s])==null?void 0:n.value)??0)*1.3}},{id:"avg_hourly_charge_2026",label:"Average Hourly Charge Rate 2026",isAutoCalculated:!1,isCurrency:!0},{id:"sales_target_hours",label:"Sales Target in Hours",isAutoCalculated:!1},{id:"variance_2025",label:"Variance Against 2025",isAutoCalculated:!1,isCurrency:!0}];function ue(r,l){const s={};for(const o of r){s[o.id]={};for(const c of l)s[o.id][c.id]={value:null,isEditable:!o.isAutoCalculated&&!c.isYearEnd}}return s}function D(r,l,s){const o=JSON.parse(JSON.stringify(r));for(const n of s.filter(i=>!i.isYearEnd))for(const i of l)i.formula&&(o[i.id][n.id]={...o[i.id][n.id],value:i.formula(o,i.id,n.id),isEditable:!1});const c=s.find(n=>n.isYearEnd);if(c)for(const n of l){const i=s.filter(x=>!x.isYearEnd).reduce((x,y)=>{var C,v;return x+(((v=(C=o[n.id])==null?void 0:C[y.id])==null?void 0:v.value)??0)},0);o[n.id][c.id]={value:i,isEditable:!1}}return o}function ce(){const[r,l]=h.useState(H),[s,o]=h.useState(M),[c,n]=h.useState(()=>D(ue(H,M),H,M)),[i,x]=h.useState(null),y=h.useCallback((b,d,a)=>{n(m=>{const f={...m};return f[b]={...f[b]},f[b][d]={...f[b][d],value:a},D(f,r,s)})},[r,s]),C=h.useCallback(b=>{const d=`custom_${Date.now()}`,a={id:d,label:b,isAutoCalculated:!1,isCurrency:!0};l(m=>{const f=[...m,a];return n(t=>{const p={...t};p[d]={};for(const u of s)p[d][u.id]={value:null,isEditable:!u.isYearEnd};return D(p,f,s)}),f})},[s]),v=h.useCallback(b=>{l(d=>d.filter(a=>a.id!==b)),n(d=>{const a={...d};return delete a[b],a})},[]),_=h.useCallback(b=>{const d=`col_${Date.now()}`,a={id:d,label:b};o(m=>{const f=m.findIndex(p=>p.isYearEnd),t=[...m];return t.splice(f,0,a),n(p=>{const u={...p};for(const g of r)u[g.id]={...u[g.id]},u[g.id][d]={value:null,isEditable:!g.isAutoCalculated};return D(u,r,t)}),t})},[r]),w=h.useCallback(b=>{o(d=>{const a=d.filter(m=>m.id!==b);return n(m=>{const f={...m};for(const t of Object.keys(f)){const{[b]:p,...u}=f[t];f[t]=u}return D(f,r,a)}),a})},[r]),j=h.useCallback((b,d)=>{o(a=>a.map(m=>m.id===b?{...m,label:d}:m))},[]),k=h.useCallback(b=>{if(!i)return;const d=r.filter(u=>!u.isAutoCalculated),a=s.filter(u=>!u.isYearEnd),m=d.findIndex(u=>u.id===i.row),f=a.findIndex(u=>u.id===i.col);if(m===-1||f===-1)return;let t=m,p=f;switch(b){case"up":t=Math.max(0,m-1);break;case"down":t=Math.min(d.length-1,m+1);break;case"left":p=Math.max(0,f-1);break;case"right":p=Math.min(a.length-1,f+1);break}x({row:d[t].id,col:a[p].id})},[i,r,s]),A=h.useCallback(async b=>{if(b)try{const d={year:new Date().getFullYear(),data:c,rows:r,columns:s},a=localStorage.getItem("auth_token");if(!(await fetch("undefined/api/financial-summary/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(d)})).ok)throw new Error("Failed to save")}catch(d){throw console.error("Save failed",d),d}},[c,r,s]);return{rows:r,columns:s,data:c,activeCell:i,setActiveCell:x,updateCell:y,addRow:C,deleteRow:v,addColumn:_,deleteColumn:w,renameColumn:j,navigateCell:k,saveData:A}}function ge(){const{rows:r,columns:l,data:s,activeCell:o,setActiveCell:c,updateCell:n,addRow:i,deleteRow:x,addColumn:y,deleteColumn:C,navigateCell:v}=ce(),[_,w]=h.useState(""),[j,k]=h.useState(""),[A,b]=h.useState(!1),[d,a]=h.useState(!1),m=()=>{_.trim()&&(i(_.trim()),w(""),b(!1))},f=()=>{j.trim()&&(y(j.trim()),k(""),a(!1))};return e.jsx(re,{noPadding:!0,fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-border bg-card/50 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(ae,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-foreground",children:"Financial Summary"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Annual budget and performance spreadsheet"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{open:A,onOpenChange:b,children:[e.jsx(z,{asChild:!0,children:e.jsxs(E,{variant:"outline",size:"sm",children:[e.jsx(K,{className:"h-4 w-4 mr-1"})," Add Row"]})}),e.jsxs(Y,{children:[e.jsx(B,{children:e.jsx($,{children:"Add New Row"})}),e.jsx(L,{placeholder:"Row label...",value:_,onChange:t=>w(t.target.value),onKeyDown:t=>t.key==="Enter"&&m()}),e.jsx(V,{children:e.jsx(E,{onClick:m,disabled:!_.trim(),children:"Add"})})]})]}),e.jsxs(F,{open:d,onOpenChange:a,children:[e.jsx(z,{asChild:!0,children:e.jsxs(E,{variant:"outline",size:"sm",children:[e.jsx(K,{className:"h-4 w-4 mr-1"})," Add Column"]})}),e.jsxs(Y,{children:[e.jsx(B,{children:e.jsx($,{children:"Add New Column"})}),e.jsx(L,{placeholder:"Column label...",value:j,onChange:t=>k(t.target.value),onKeyDown:t=>t.key==="Enter"&&f()}),e.jsx(V,{children:e.jsx(E,{onClick:f,disabled:!j.trim(),children:"Add"})})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:e.jsx(de,{rows:r,columns:l,data:s,activeCell:o,setActiveCell:c,updateCell:n,deleteRow:x,deleteColumn:C,navigateCell:v})})]})})}export{ge as default};
