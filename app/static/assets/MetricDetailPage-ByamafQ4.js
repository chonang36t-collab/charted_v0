import{c as Pe,h as Ie,r as c,U as Be,p as Me,j as e,v as $e,P as I,q as w,w as Ee,e as H,ar as Oe,u as we,d as _e,B as He,A as J}from"./index-DNQinrEY.js";import{D as Ge}from"./DashboardLayout-C97PVsLE.js";import{C as R,d as A,a as ee,b as se}from"./card-Dtsa0zn_.js";import{c as te,R as Ve,I as ze}from"./index-p65Cm7tZ.js";import{D as Ke}from"./DashboardHeader-Dbp6s0mf.js";import{u as Ue,O as qe}from"./OperationalTrendChart-C7Jc7xWS.js";import{u as We,L as Xe,R as Ye}from"./LoadingOverlay-ILLA888f.js";import{R as ae,C as Je,X as Qe,Y as Ze,T as re,B as es,a as ie,L as ss}from"./generateCategoricalChart-DpUoEaFk.js";import{B as ts}from"./BarChart-MK_Xx5Tc.js";import{P as as,a as rs}from"./PieChart-Xnx-ZkgW.js";import{T as ne,a as oe,b as F,c as N,d as ce,e as b,f as is}from"./table-B0I8tJle.js";import{f as Q}from"./popover-iV-3pSF1.js";import"./users-BIT8MfKi.js";import"./locationUtils-CPrlR3dp.js";import"./index-BeNVWpEg.js";import"./Line-IBiIBkFc.js";import"./AreaChart-B6p5y9-9.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=Pe("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var B="Tabs",[os,ks]=Ie(B,[te]),le=te(),[cs,G]=os(B),de=c.forwardRef((s,t)=>{const{__scopeTabs:a,value:n,onValueChange:i,defaultValue:g,orientation:d="horizontal",dir:f,activationMode:h="automatic",...y}=s,o=Be(f),[m,x]=Me({prop:n,onChange:i,defaultProp:g??"",caller:B});return e.jsx(cs,{scope:a,baseId:$e(),value:m,onValueChange:x,orientation:d,dir:o,activationMode:h,children:e.jsx(I.div,{dir:o,"data-orientation":d,...y,ref:t})})});de.displayName=B;var ue="TabsList",me=c.forwardRef((s,t)=>{const{__scopeTabs:a,loop:n=!0,...i}=s,g=G(ue,a),d=le(a);return e.jsx(Ve,{asChild:!0,...d,orientation:g.orientation,dir:g.dir,loop:n,children:e.jsx(I.div,{role:"tablist","aria-orientation":g.orientation,...i,ref:t})})});me.displayName=ue;var he="TabsTrigger",xe=c.forwardRef((s,t)=>{const{__scopeTabs:a,value:n,disabled:i=!1,...g}=s,d=G(he,a),f=le(a),h=ve(d.baseId,n),y=je(d.baseId,n),o=n===d.value;return e.jsx(ze,{asChild:!0,...f,focusable:!i,active:o,children:e.jsx(I.button,{type:"button",role:"tab","aria-selected":o,"aria-controls":y,"data-state":o?"active":"inactive","data-disabled":i?"":void 0,disabled:i,id:h,...g,ref:t,onMouseDown:w(s.onMouseDown,m=>{!i&&m.button===0&&m.ctrlKey===!1?d.onValueChange(n):m.preventDefault()}),onKeyDown:w(s.onKeyDown,m=>{[" ","Enter"].includes(m.key)&&d.onValueChange(n)}),onFocus:w(s.onFocus,()=>{const m=d.activationMode!=="manual";!o&&!i&&m&&d.onValueChange(n)})})})});xe.displayName=he;var ge="TabsContent",fe=c.forwardRef((s,t)=>{const{__scopeTabs:a,value:n,forceMount:i,children:g,...d}=s,f=G(ge,a),h=ve(f.baseId,n),y=je(f.baseId,n),o=n===f.value,m=c.useRef(o);return c.useEffect(()=>{const x=requestAnimationFrame(()=>m.current=!1);return()=>cancelAnimationFrame(x)},[]),e.jsx(Ee,{present:i||o,children:({present:x})=>e.jsx(I.div,{"data-state":o?"active":"inactive","data-orientation":f.orientation,role:"tabpanel","aria-labelledby":h,hidden:!x,id:y,tabIndex:0,...d,ref:t,style:{...s.style,animationDuration:m.current?"0s":void 0},children:x&&g})})});fe.displayName=ge;function ve(s,t){return`${s}-trigger-${t}`}function je(s,t){return`${s}-content-${t}`}var ls=de,pe=me,be=xe,ye=fe;const ds=ls,Ne=c.forwardRef(({className:s,...t},a)=>e.jsx(pe,{ref:a,className:H("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...t}));Ne.displayName=pe.displayName;const S=c.forwardRef(({className:s,...t},a)=>e.jsx(be,{ref:a,className:H("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",s),...t}));S.displayName=be.displayName;const L=c.forwardRef(({className:s,...t},a)=>e.jsx(ye,{ref:a,className:H("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...t}));L.displayName=ye.displayName;const us=({active:s,payload:t,label:a})=>s&&t&&t.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:a}),e.jsx("p",{className:"text-sm",children:t[0].value.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]}):null,_=({data:s,metric:t,onBarClick:a})=>!s||s.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(R,{children:e.jsx(A,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ae,{width:"100%",height:"100%",children:e.jsxs(ts,{data:s,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(Je,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(Qe,{type:"number",hide:!0}),e.jsx(Ze,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(re,{content:e.jsx(us,{})}),e.jsx(es,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:a,children:s.map((n,i)=>e.jsx(ie,{fill:"hsl(var(--primary))",fillOpacity:.8+i*.05},`cell-${i}`))})]})})})})}),Z=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ms=({active:s,payload:t})=>s&&t&&t.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:t[0].name}),e.jsx("p",{className:"text-sm",children:Number(t[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${((t[0].payload.percent||0)*100).toFixed(1)}%`})]}):null,P=({data:s,metric:t})=>{if(!s||s.length===0)return e.jsx(R,{children:e.jsx(A,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const a=[...s].sort((n,i)=>i.value-n.value);return e.jsx(R,{children:e.jsx(A,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ae,{width:"100%",height:"100%",children:e.jsxs(as,{children:[e.jsx(rs,{data:a,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:a.map((n,i)=>e.jsx(ie,{fill:Z[i%Z.length]},`cell-${i}`))}),e.jsx(re,{content:e.jsx(ms,{})}),e.jsx(ss,{})]})})})})})},hs=({data:s})=>!s||s.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(R,{children:[e.jsx(ee,{children:e.jsx(se,{children:"Overheads Details"})}),e.jsx(A,{children:e.jsxs(ne,{children:[e.jsx(oe,{children:e.jsxs(F,{children:[e.jsx(N,{children:"Title"}),e.jsx(N,{children:"Month"}),e.jsx(N,{children:"Location"}),e.jsx(N,{children:"Site"}),e.jsx(N,{className:"text-right",children:"Amount"})]})}),e.jsx(ce,{children:s.map(t=>e.jsxs(F,{children:[e.jsx(b,{className:"font-medium",children:t.name}),e.jsxs(b,{children:[t.month," ",t.year]}),e.jsx(b,{children:t.location||"-"}),e.jsx(b,{children:t.site||"-"}),e.jsx(b,{className:"text-right",children:t.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]},t.id))})]})})]}),Ps=()=>{const{metricId:s}=Oe(),t=we(),{dateRange:a,setDateRange:n}=_e(),[i,g]=c.useState(!1),[d,f]=c.useState(a),[h,y]=c.useState([]),[o,m]=c.useState([]),[x,Te]=c.useState("trend"),[T,Ce]=c.useState([]),[D,Se]=c.useState([]),[Le,V]=c.useState(!1),k=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(s||""),M=["shifts","hours","clients","targetAchievement","missedTargets"].includes(s||""),$=s==="overheads",{operationalData:j,isLoading:Re}=Ue(a,h,o),{financialData:p,isLoading:Ae}=We(a,h,o),De=k?Ae:M?Re:!1;c.useEffect(()=>{if(x==="trend"||!s)return;(async()=>{V(!0);try{const l=new URLSearchParams({start:Q(a.from,"yyyy-MM-dd"),end:Q(a.to,"yyyy-MM-dd"),metric:s,limit:"20"});h&&h.length>0&&h.forEach(u=>l.append("locations",u)),o&&o.length>0&&o.forEach(u=>l.append("sites",u));const v={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(x==="details"&&$){const u=await fetch(`${J.FINANCIAL_METRICS_LIST}?${l.toString()}`,{headers:v});if(u.ok){const C=await u.json();Se(C)}}else if(["location","site","client"].includes(x)){l.append("dimension",x);const u=await fetch(`${J.BREAKDOWN}?${l.toString()}`,{headers:v});if(u.ok){const C=await u.json();Ce(C)}}}catch(l){console.error("Error fetching breakdown:",l)}finally{V(!1)}})()},[x,s,a,h,o]);const z=r=>{switch(r){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},Fe=(r,l)=>{var v,u,C,K,U,q,W,X,Y;if(!r)return"-";switch(l){case"revenue":return`£${((v=r.revenue)==null?void 0:v.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"cost":return`£${((u=r.cost)==null?void 0:u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"profit":const O=r.profit??r.revenue-r.cost-(r.overheads||0);return`£${(O==null?void 0:O.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"shifts":return((C=r.totalShifts)==null?void 0:C.toLocaleString())??0;case"hours":return((K=r.paidHours)==null?void 0:K.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"clients":return((U=r.clientCount)==null?void 0:U.toLocaleString())??0;case"employees":return((q=r.paidHours)==null?void 0:q.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"targetAchievement":return`${((W=r.achievementPercentage)==null?void 0:W.toFixed(1))??0}%`;case"missedTargets":return`${((X=r.achievementPercentage)==null?void 0:X.toFixed(1))??0}%`;case"clientRate":return`£${(r.revenue/r.paidHours||0).toFixed(2)}`;case"staffRate":return`£${(r.cost/r.paidHours||0).toFixed(2)}`;case"overheads":return`£${((Y=r.overheads)==null?void 0:Y.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;default:return"-"}},ke=c.useMemo(()=>{if(!D||D.length===0)return[];const r=D.reduce((l,v)=>{const u=v.name||"Unknown";return l[u]||(l[u]=0),l[u]+=v.value,l},{});return Object.entries(r).map(([l,v])=>({name:l,value:v}))},[D]),E=k?p==null?void 0:p.timeSeries:j==null?void 0:j.timeSeries;return e.jsx(Ge,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Ke,{dateRange:a,onDateRangeChange:n,calendarOpen:i,onCalendarOpenChange:g,tempDateRange:d,onTempDateRangeChange:f,selectedLocations:h,onLocationsChange:y,selectedSites:o,onSitesChange:m}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(De||Le)&&e.jsx(Xe,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(He,{variant:"ghost",size:"sm",onClick:()=>t(-1),className:"gap-2",children:[e.jsx(ns,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:z(s)})]}),e.jsxs(ds,{value:x,onValueChange:Te,className:"space-y-4",children:[e.jsxs(Ne,{children:[e.jsx(S,{value:"trend",children:"Trend"}),e.jsx(S,{value:"location",children:"By Location"}),e.jsx(S,{value:"site",children:"By Site"}),!$&&e.jsx(S,{value:"client",children:"By Client"}),$&&e.jsx(S,{value:"details",children:"All Details"})]}),e.jsx(L,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[k&&e.jsx(Ye,{data:(p==null?void 0:p.timeSeries)||[],aggregationLevel:(p==null?void 0:p.aggregationLevel)||"monthly",selectedMetric:s}),M&&e.jsx(qe,{data:(j==null?void 0:j.timeSeries)||[],aggregationLevel:(j==null?void 0:j.aggregationLevel)||"monthly",selectedMetric:s}),!k&&!M&&e.jsx(R,{children:e.jsx(A,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})}),e.jsxs(R,{children:[e.jsx(ee,{children:e.jsx(se,{children:"Historical Data"})}),e.jsx(A,{children:e.jsxs(ne,{children:[e.jsxs(is,{children:["Detailed historical data for ",z(s)]}),e.jsx(oe,{children:e.jsxs(F,{children:[e.jsx(N,{children:"Period"}),e.jsx(N,{className:"text-right",children:"Value"})]})}),e.jsx(ce,{children:E&&E.length>0?[...E].reverse().map((r,l)=>e.jsxs(F,{children:[e.jsx(b,{className:"font-medium",children:r.display}),e.jsx(b,{className:"text-right font-medium",children:Fe(r,s)})]},l)):e.jsx(F,{children:e.jsx(b,{colSpan:2,className:"text-center",children:"No data available"})})})]})})]})]})}),e.jsx(L,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(_,{data:T,metric:s||"revenue"}),e.jsx(P,{data:T,metric:s||"revenue"})]})}),e.jsx(L,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(_,{data:T,metric:s||"revenue"}),e.jsx(P,{data:T,metric:s||"revenue"})]})}),e.jsx(L,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(_,{data:T,metric:s||"revenue"}),e.jsx(P,{data:T,metric:s||"revenue"})]})}),e.jsx(L,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(P,{data:ke,metric:"overheads"})}),e.jsx(hs,{data:D})]})})]})]})]})})};export{Ps as default};
