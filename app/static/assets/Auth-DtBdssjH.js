import{r as l,u as E,a as I,b as O,R as D,j as e,A as F}from"./index-PNwetgCy.js";import{B as p}from"./button-BMYDbvaE.js";import{I as u}from"./input-Def0k1Ag.js";import{L as f}from"./label-DHwJuiG2.js";import{C as R,a as P,b as U,c as V,d as q}from"./card-DTPibqdI.js";function H(){const[c,o]=l.useState(!1),[n,m]=l.useState("login"),[x,b]=l.useState(""),[y,k]=l.useState(""),[r,j]=l.useState(""),v=E(),{toast:a}=I(),{refreshUser:h,role:w,isLoading:N}=O();D.useEffect(()=>{!N&&w&&v("/dashboard")},[w,N,v]);const L=async t=>{t.preventDefault(),o(!0);const s=new FormData(t.currentTarget),i=s.get("username"),A=s.get("password");b(i);try{const g=await fetch(F.LOGIN,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({username:i,password:A})}),d=await g.json();if(g.ok)if(d.status==="2fa_setup_required"){const C=await(await fetch("http://localhost:5000/api/2fa/setup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i})})).json();console.log("DEBUG: 2FA Setup Response",C),k(C.qr_code),m("2fa_setup")}else d.status==="2fa_login_required"?m("2fa_verify"):(localStorage.setItem("auth_token",d.token),await h(),a({title:"Login successful"}));else a({title:"Login failed",description:d.error||"Invalid credentials",variant:"destructive"})}catch{a({title:"Error",description:"Could not connect to server",variant:"destructive"})}finally{o(!1)}},_=async t=>{t.preventDefault(),o(!0);try{const s=await fetch(`${S}/api/2fa/verify-setup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:x,token:r})}),i=await s.json();s.ok?(localStorage.setItem("auth_token",i.token),await h(),a({title:"2FA Setup complete"})):a({title:"Verification failed",description:i.error,variant:"destructive"})}catch{a({title:"Error",description:"Verification failed",variant:"destructive"})}finally{o(!1)}},T=async t=>{t.preventDefault(),o(!0);try{const s=await fetch(`${S}/api/2fa/login-verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:x,token:r})}),i=await s.json();s.ok?(localStorage.setItem("auth_token",i.token),await h(),a({title:"Login successful"})):a({title:"Verification failed",description:i.error,variant:"destructive"})}catch{a({title:"Error",description:"Verification failed",variant:"destructive"})}finally{o(!1)}},S="";return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background relative p-4",children:[e.jsx("div",{className:"absolute top-6 left-6 z-50",children:e.jsx("a",{href:"/",className:"block hover:opacity-80 transition-opacity",children:e.jsx("img",{src:"/logo.png",alt:"Company Logo",className:"h-12 w-auto object-contain"})})}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs(R,{className:"w-full max-w-md",children:[e.jsxs(P,{children:[e.jsx(U,{className:"text-2xl",children:n==="login"?"Analytics Dashboard":"Two-Factor Authentication"}),e.jsx(V,{children:n==="login"?"Sign in to access your analytics":n==="2fa_setup"?"Scan the QR code with your Authenticator app":"Enter the 6-digit code from your app"})]}),e.jsxs(q,{children:[n==="login"&&e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"login-username",children:"Username"}),e.jsx(u,{id:"login-username",name:"username",type:"text",placeholder:"your_username",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"login-password",children:"Password"}),e.jsx(u,{id:"login-password",name:"password",type:"password",required:!0})]}),e.jsx(p,{type:"submit",className:"w-full",disabled:c,children:c?"Logging in...":"Login"})]}),n==="2fa_setup"&&e.jsxs("div",{className:"space-y-6 flex flex-col items-center",children:[y&&e.jsx("div",{className:"bg-white p-4 rounded-lg shadow-sm border",children:e.jsx("img",{src:y,alt:"2FA QR Code",className:"w-48 h-48"})}),e.jsxs("div",{className:"w-full space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"otp-setup",children:"Enter 6-digit code to confirm"}),e.jsx(u,{id:"otp-setup",value:r,onChange:t=>j(t.target.value),placeholder:"000000",maxLength:6,className:"text-center text-2xl tracking-[0.5em] font-mono"})]}),e.jsx(p,{onClick:_,className:"w-full",disabled:c||r.length!==6,children:"Verify and Enable 2FA"})]})]}),n==="2fa_verify"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"otp-login",children:"Authenticator Code"}),e.jsx(u,{id:"otp-login",value:r,onChange:t=>j(t.target.value),placeholder:"000000",maxLength:6,className:"text-center text-2xl tracking-[0.5em] font-mono"})]}),e.jsx(p,{onClick:T,className:"w-full",disabled:c||r.length!==6,children:"Verify Code"}),e.jsx(p,{variant:"ghost",onClick:()=>m("login"),className:"w-full text-xs",children:"Back to login"})]})]})]})})]})}export{H as default};
