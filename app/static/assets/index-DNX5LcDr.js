import{c as ee,ab as z,r as p,j as e,B as D,e as O,T as oe,I as B,k as ie,l as ne,m as ce,ac as de}from"./index-CaaUPn5_.js";import{D as ue,T as me}from"./DashboardLayout-DWajdZ1B.js";import{L as fe}from"./label-uC6KrRQ7.js";import{D as G,b as K,c as R,d as J,a as W,e as U}from"./dialog-C_rOH54n.js";import{R as he,B as be,A as xe,C as pe,X as ge,Y as ye,T as Ce,a as ve}from"./generateCategoricalChart-BV6KAT7E.js";import{L as _e}from"./LineChart-oVNwEABx.js";import{L as je,B as ke}from"./BarChart-BEnrfAE9.js";import{A as we}from"./AreaChart-BgfmCFlO.js";import{T as Ne}from"./users-CWgz3kza.js";import{T as X}from"./trash-2-4g8CXvAa.js";import{e as Ae,f as T,P as Se,a as Ee,C as De,b as Pe,d as Le,s as Te}from"./popover-u0Jmy2Q5.js";import{P as q}from"./plus-CAEBSL9b.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=ee("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=ee("ChartNoAxesColumn",[["line",{x1:"18",x2:"18",y1:"20",y2:"10",key:"1xfpm4"}],["line",{x1:"12",x2:"12",y1:"20",y2:"4",key:"be30l9"}],["line",{x1:"6",x2:"6",y1:"20",y2:"14",key:"1r4le6"}]]);function Fe(s,l){const o=z(s.start),t=z(s.end);let C=+o>+t;const y=C?+o:+t,h=C?t:o;h.setHours(0,0,0,0),h.setDate(1);let b=1;const v=[];for(;+h<=y;)v.push(z(h)),h.setMonth(h.getMonth()+b);return C?v.reverse():v}function Oe(s){const l=z(s),o=l.getFullYear();return l.setFullYear(o+1,0,0),l.setHours(23,59,59,999),l}const L="#6366f1";function F(s){return s==null?"—":new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(s)}function Y(s){return s==null?"—":`${s.toFixed(2)}%`}const Ye=({active:s,payload:l,label:o,row:t})=>{var y;if(!s||!(l!=null&&l.length))return null;const C=(y=l[0])==null?void 0:y.value;return e.jsxs("div",{className:"bg-popover text-popover-foreground border border-border rounded-lg px-3 py-2 shadow-lg text-xs",children:[e.jsx("p",{className:"font-semibold text-muted-foreground mb-1",children:o}),e.jsx("p",{className:"font-bold text-base",children:t.isPercentage?Y(C):F(C)})]})};function $e({open:s,onOpenChange:l,row:o,columns:t,data:C}){const[y,h]=p.useState("line"),b=p.useMemo(()=>t.filter(d=>!d.isYearEnd).map(d=>{var a,A;return{name:d.label,value:((A=(a=C[o.id])==null?void 0:a[d.id])==null?void 0:A.value)??null}}).filter(d=>d.value!==null),[t,C,o.id]),v=b.map(d=>d.value),w=v.length?v.reduce((d,a)=>d+a,0)/v.length:0,n=d=>o.isPercentage?`${d.toFixed(1)}%`:new Intl.NumberFormat("en-GB",{notation:"compact",currency:"GBP"}).format(d),m={data:b,margin:{top:10,right:20,left:10,bottom:5}},_=e.jsxs(e.Fragment,{children:[e.jsx(pe,{strokeDasharray:"3 3",className:"stroke-border/50"}),e.jsx(ge,{dataKey:"name",tick:{fontSize:11},className:"text-muted-foreground",tickLine:!1,axisLine:!1}),e.jsx(ye,{tickFormatter:n,tick:{fontSize:11},className:"text-muted-foreground",tickLine:!1,axisLine:!1,width:65}),e.jsx(Ce,{content:e.jsx(Ye,{row:o})}),e.jsx(ve,{y:w,stroke:"#94a3b8",strokeDasharray:"4 4",label:{value:"Avg",fontSize:10,fill:"#94a3b8"}})]}),N=[{type:"line",label:"Line",icon:e.jsx(Ne,{className:"h-3.5 w-3.5"})},{type:"bar",label:"Bar",icon:e.jsx(te,{className:"h-3.5 w-3.5"})},{type:"area",label:"Area",icon:e.jsx(Me,{className:"h-3.5 w-3.5"})}];return e.jsx(G,{open:s,onOpenChange:l,children:e.jsxs(K,{className:"max-w-3xl w-full",children:[e.jsx(R,{children:e.jsxs(J,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Chart —"}),o.label]})}),e.jsxs("div",{className:"flex items-center gap-2 pb-1",children:[N.map(({type:d,label:a,icon:A})=>e.jsxs(D,{variant:y===d?"default":"outline",size:"sm",className:O("gap-1.5",y===d&&"shadow"),onClick:()=>h(d),children:[A,a]},d)),e.jsxs("span",{className:"ml-auto text-xs text-muted-foreground",children:["Avg: ",o.isPercentage?Y(w):F(w)]})]}),e.jsx("div",{className:"h-72 w-full",children:b.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground text-sm",children:"No data available for this row."}):e.jsx(he,{width:"100%",height:"100%",children:y==="line"?e.jsxs(_e,{...m,children:[_,e.jsx(je,{type:"monotone",dataKey:"value",stroke:L,strokeWidth:2,dot:{r:3,fill:L},activeDot:{r:5}})]}):y==="bar"?e.jsxs(ke,{...m,children:[_,e.jsx(be,{dataKey:"value",fill:L,radius:[4,4,0,0],opacity:.85})]}):e.jsxs(we,{...m,children:[_,e.jsx("defs",{children:e.jsxs("linearGradient",{id:"areaGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:L,stopOpacity:.25}),e.jsx("stop",{offset:"95%",stopColor:L,stopOpacity:.03})]})}),e.jsx(xe,{type:"monotone",dataKey:"value",stroke:L,strokeWidth:2,fill:"url(#areaGrad)",dot:{r:3,fill:L},activeDot:{r:5}})]})})}),b.length>0&&e.jsx("div",{className:"grid grid-cols-4 gap-3 pt-1 border-t border-border",children:[{label:"Total (period)",value:o.isPercentage?void 0:F(v.reduce((d,a)=>d+a,0))},{label:"Average",value:o.isPercentage?Y(w):F(w)},{label:"Highest",value:o.isPercentage?Y(Math.max(...v)):F(Math.max(...v))},{label:"Lowest",value:o.isPercentage?Y(Math.min(...v)):F(Math.min(...v))}].filter(d=>d.value).map(d=>e.jsxs("div",{className:"bg-muted/50 rounded-lg p-2.5 text-center",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wide",children:d.label}),e.jsx("p",{className:"text-sm font-semibold mt-0.5",children:d.value})]},d.label))})]})})}function He(s,l){return s===null||s===0?"":l.isPercentage?`${s.toFixed(2)}%`:l.isCurrency?`£${s.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}`:s.toLocaleString("en-GB",{maximumFractionDigits:2})}function ze({rowId:s,colId:l,value:o,row:t,isActive:C,source:y,onFocus:h,onUpdate:b,onNavigate:v,updateRowFormula:w}){const[n,m]=p.useState(!1),[_,N]=p.useState(""),d=p.useRef(null),[a,A]=p.useState(!1),[i,r]=p.useState(t.formulaString||"");p.useEffect(()=>{r(t.formulaString||"")},[t.formulaString]);const g=p.useCallback(c=>{m(!0),N(c!==void 0?c:o!==null?String(o):""),setTimeout(()=>{var u;return(u=d.current)==null?void 0:u.focus()},0)},[o]),f=p.useCallback(()=>{m(!1);const c=_.replace(/[£$€,\s]/g,"").trim(),u=parseFloat(c);b(c===""?null:isNaN(u)?o:u)},[_,b,o]),x=p.useCallback(()=>{A(!1),w&&i!==t.formulaString&&w(s,i)},[i,t.formulaString,s,w]),j=p.useCallback(c=>{c.key==="Enter"?f():c.key==="Escape"&&m(!1)},[f]);return p.useEffect(()=>{if(C&&!n&&!a){const c=u=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(u.key)?(u.preventDefault(),v({ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"}[u.key])):!u.ctrlKey&&!u.altKey&&!u.metaKey&&u.key.length===1?g(u.key):u.key==="Enter"?(u.preventDefault(),g()):(u.key==="Backspace"||u.key==="Delete")&&b(null)};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)}},[C,n,a,v,g,b]),n?e.jsx("input",{ref:d,type:"text",className:"w-full h-full px-2 py-1 outline-none bg-background text-center font-lato",value:_,onChange:c=>N(c.target.value),onBlur:f,onKeyDown:j}):e.jsxs(ie,{delayDuration:800,children:[e.jsx(ne,{asChild:!0,children:e.jsxs("div",{className:O("w-full h-full px-2 py-1 cursor-cell flex items-center justify-center font-lato relative group",t.isHeader&&"font-bold",!t.isHeader&&y==="calculated"&&"bg-blue-50/60 dark:bg-blue-950/20",!t.isHeader&&y==="manual"&&"bg-amber-50/70 dark:bg-amber-950/20",!t.isHeader&&y==="database"&&"bg-green-50/60 dark:bg-green-950/20"),tabIndex:-1,onClick:h,onDoubleClick:c=>{c.preventDefault(),g()},children:[He(o,t),y==="manual"&&t.isAutoCalculated&&e.jsx("div",{className:"absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-bl-full",title:"Manual Override"})]})}),(y||t.formulaString||t.isAutoCalculated)&&e.jsx(ce,{className:"p-3 min-w-[200px] pointer-events-auto",side:"bottom",children:e.jsxs("div",{className:"text-xs space-y-2",children:[(y||t.isAutoCalculated)&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"font-semibold text-muted-foreground",children:"Source:"}),e.jsx("span",{className:O("capitalize font-medium",(y==="calculated"||t.isAutoCalculated)&&"text-blue-600 dark:text-blue-400",y==="manual"&&"text-amber-600 dark:text-amber-400",y==="database"&&"text-green-600 dark:text-green-400"),children:y??(t.isAutoCalculated?"calculated":void 0)})]}),t.formulaString&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"font-semibold text-muted-foreground",children:"Formula:"}),a?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{value:i,onChange:c=>r(c.target.value),className:"h-6 text-xs",onKeyDown:c=>{c.key==="Enter"&&x(),c.key==="Escape"&&A(!1)}}),e.jsx(D,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:x,children:e.jsx("span",{className:"text-green-500",children:"✓"})})]}):e.jsxs("div",{className:"bg-muted px-2 py-1 rounded font-mono cursor-pointer hover:bg-muted/80 flex justify-between items-center group/formula",onClick:c=>{c.preventDefault(),A(!0),r(t.formulaString||"")},children:[t.formulaString,e.jsx("span",{className:"opacity-0 group-hover/formula:opacity-100 text-[10px] text-muted-foreground ml-2",children:"Edit"})]})]})]})})]})}function Be(s){let l="",o=s;for(;o>=0;)l=String.fromCharCode(o%26+65)+l,o=Math.floor(o/26)-1;return l}function Ie({rows:s,columns:l,data:o,activeCell:t,setActiveCell:C,updateCell:y,deleteRow:h,deleteColumn:b,navigateCell:v,updateRowFormula:w,renameColumn:n}){const[m,_]=p.useState(null),[N,d]=p.useState(null);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-1 overflow-auto relative border border-border rounded-md bg-background",children:[e.jsx(oe,{children:e.jsxs("table",{className:"w-full border-collapse table-fixed text-sm",children:[e.jsxs("thead",{className:"sticky top-0 z-20 bg-muted/90 backdrop-blur-sm shadow-sm",children:[e.jsxs("tr",{children:[e.jsx("th",{className:"w-12 border-b border-border bg-muted p-1 text-center text-xs text-muted-foreground font-normal select-none relative group",children:e.jsx("div",{className:"absolute inset-0 bg-muted/50"})}),e.jsx("th",{className:"w-64 border-b border-r border-border bg-muted p-2 text-left font-medium text-muted-foreground"}),l.map((a,A)=>e.jsx("th",{className:"border-b border-r border-border bg-muted p-1 text-center text-xs font-normal text-muted-foreground select-none relative min-w-[120px]",children:Be(A)},`excel-${A}`))]}),e.jsxs("tr",{children:[e.jsx("th",{className:"w-12 border-b border-border bg-background p-2"}),e.jsx("th",{className:"w-64 border-b border-r border-border bg-background p-2 text-left font-semibold text-foreground",children:"Metric / Account"}),l.map(a=>e.jsx("th",{className:O("relative border-b border-r border-border bg-background p-2 text-right font-semibold min-w-[120px]",a.isYearEnd?"text-primary/80 bg-primary/5":"text-foreground"),children:e.jsxs("div",{className:"flex items-center justify-end gap-2 group",children:[e.jsx("span",{className:"cursor-pointer hover:text-primary transition-colors py-1",onDoubleClick:()=>!a.isProtected&&_({id:a.id,type:"col",value:a.label}),children:a.label}),!a.isProtected&&e.jsx(D,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity absolute top-1 right-1",onClick:()=>b(a.id),children:e.jsx(X,{className:"h-3 w-3 text-destructive"})})]})},a.id))]})]}),e.jsx("tbody",{children:s.map((a,A)=>e.jsxs("tr",{className:"group/row hover:bg-muted/30 transition-colors",children:[e.jsx("td",{className:"border-r border-b border-border bg-muted/30 p-2 text-center text-xs text-muted-foreground font-mono select-none sticky left-0 z-10 w-12",children:A+1}),e.jsx("td",{className:"border-r border-b border-border p-2 font-medium bg-background relative w-64",children:e.jsxs("div",{className:"flex items-center justify-between group",children:[a.isHeader?e.jsx("span",{className:"font-bold text-primary",children:a.label}):e.jsx("span",{className:"cursor-pointer hover:text-primary transition-colors w-full",onDoubleClick:()=>!a.isAutoCalculated&&_({id:a.id,type:"row",value:a.label}),children:a.label}),e.jsxs("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2",children:[e.jsx(D,{variant:"ghost",size:"icon",className:"h-6 w-6",title:`Chart: ${a.label}`,onClick:()=>d(a),children:e.jsx(te,{className:"h-3 w-3 text-primary"})}),!a.isAutoCalculated&&e.jsx(D,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>h(a.id),children:e.jsx(X,{className:"h-3 w-3 text-destructive"})})]})]})}),l.map(i=>{var x;const r=(x=o[a.id])==null?void 0:x[i.id],g=(r==null?void 0:r.value)??null,f=(t==null?void 0:t.row)===a.id&&(t==null?void 0:t.col)===i.id;return e.jsx("td",{className:O("border-r border-b border-border p-0 relative min-w-[120px]",f?"ring-2 ring-primary z-10":"",a.isHeader?"bg-muted/20 font-semibold":"",i.isYearEnd?"bg-primary/5 font-semibold":""),onClick:()=>C({row:a.id,col:i.id}),children:e.jsx(ze,{rowId:a.id,colId:i.id,value:g,row:a,isActive:f,onFocus:()=>C({row:a.id,col:i.id}),onUpdate:j=>y(a.id,i.id,j),onNavigate:v,updateRowFormula:w})},`${a.id}-${i.id}`)})]},a.id))})]})}),m&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",onClick:()=>_(null),children:e.jsxs("div",{className:"bg-card p-4 rounded-lg shadow-lg border w-96",onClick:a=>a.stopPropagation(),children:[e.jsxs(fe,{children:["Edit ",m.type==="row"?"Row":"Column"," Label"]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(B,{autoFocus:!0,value:m.value,onChange:a=>_({...m,value:a.target.value}),onKeyDown:a=>{a.key==="Enter"&&(m.type==="col"&&n&&n(m.id,m.value),_(null))}}),e.jsx(D,{onClick:()=>_(null),children:"Done"})]})]})})]}),N&&e.jsx($e,{open:!!N,onOpenChange:a=>!a&&d(null),row:N,columns:l,data:o})]})}const H=s=>{if(!(s!=null&&s.from)||!(s!=null&&s.to))return new Date().getFullYear(),[{id:"jan",label:"January",isProtected:!0},{id:"feb",label:"February",isProtected:!0},{id:"mar",label:"March",isProtected:!0},{id:"apr",label:"April",isProtected:!0},{id:"may",label:"May",isProtected:!0},{id:"jun",label:"June",isProtected:!0},{id:"jul",label:"July",isProtected:!0},{id:"aug",label:"August",isProtected:!0},{id:"sep",label:"September",isProtected:!0},{id:"oct",label:"October",isProtected:!0},{id:"nov",label:"November",isProtected:!0},{id:"dec",label:"December",isProtected:!0},{id:"year_end",label:"Year End",isProtected:!0,isYearEnd:!0}];const o=Fe({start:de(s.from),end:Ae(s.to)}).map(t=>({id:T(t,"MMM-yyyy").toLowerCase(),label:T(t,"MMM yyyy"),isProtected:!0}));return o.push({id:"year_end",label:"Period Total",isProtected:!0,isYearEnd:!0}),o},Q=(s,l,o)=>{var t,C;try{const y=Object.keys(l).sort((v,w)=>w.length-v.length);let h=s;for(const v of y){const w=new RegExp(`\\b${v}\\b`,"g");if(w.test(h)){const n=((C=(t=l[v])==null?void 0:t[o])==null?void 0:C.value)??0;h=h.replace(w,`(${n})`)}}if(!/^[0-9+\-*/().\s]*$/.test(h))return null;const b=new Function(`return ${h}`)();return typeof b=="number"&&!isNaN(b)&&isFinite(b)?b:null}catch{return null}},I=[{id:"total_sales",label:"Total Sales",isAutoCalculated:!1,isCurrency:!0},{id:"sales_split_pct",label:"% Sales Split for the Year",isAutoCalculated:!1,isPercentage:!0},{id:"cost_sales_se",label:"Cost of Sales SE",isAutoCalculated:!1,isCurrency:!0},{id:"cost_sales_paye",label:"Cost of Sales PAYE Gross",isAutoCalculated:!1,isCurrency:!0},{id:"employee_ni",label:"Employee NI",isAutoCalculated:!1,isCurrency:!0},{id:"employee_pension",label:"Employee Pension",isAutoCalculated:!1,isCurrency:!0},{id:"total_cost_sales",label:"Total Cost of Sales",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formulaString:"cost_sales_se + cost_sales_paye + employee_ni + employee_pension"},{id:"apprenticeship_levy",label:"Apprenticeship Levy",isAutoCalculated:!1,isCurrency:!0},{id:"annual_leave",label:"Annual Leave Accrual",isAutoCalculated:!1,isCurrency:!0},{id:"other_expenses",label:"Other Expenses",isAutoCalculated:!1,isCurrency:!0},{id:"recruitment_cost",label:"Recruitment & Pass Cost",isAutoCalculated:!1,isCurrency:!0},{id:"overheads_mgmt",label:"Mgmt & Office Cost",isAutoCalculated:!1,isCurrency:!0},{id:"bank_interest",label:"Bank Interest",isAutoCalculated:!1,isCurrency:!0},{id:"cooperation_tax",label:"Cooperation Tax",isAutoCalculated:!1,isCurrency:!0},{id:"total_overheads",label:"Total Overheads",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formulaString:"apprenticeship_levy + annual_leave + other_expenses + recruitment_cost + overheads_mgmt + bank_interest + cooperation_tax"},{id:"total_cost",label:"Total Cost",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formulaString:"total_cost_sales + total_overheads"},{id:"worked_hours",label:"Total Worked Hours",isAutoCalculated:!1,isCurrency:!1},{id:"avg_hourly_charge",label:"Avg Hourly Charge",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_sales / worked_hours"},{id:"gross_hourly_pay",label:"Gross Hourly Pay",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_cost_sales / worked_hours"},{id:"gross_hourly_margin",label:"Gross Hourly Margin",isAutoCalculated:!0,isCurrency:!0,formulaString:"avg_hourly_charge - gross_hourly_pay"},{id:"net_cost_per_hour",label:"Net Cost per Hour",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_cost / worked_hours"},{id:"gross_pl_value",label:"Gross P&L Value",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_sales - cost_sales_se"},{id:"net_pl",label:"Net P&L",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_sales - total_cost"},{id:"total_net_margin",label:"Total Net Margin",isAutoCalculated:!0,isCurrency:!0,formulaString:"net_pl / worked_hours"},{id:"hours_breakeven",label:"Hours for Breakeven",isAutoCalculated:!0,formulaString:"(other_expenses + overheads_mgmt) / gross_hourly_margin"},{id:"value_breakeven",label:"Total Value for Breakeven",isAutoCalculated:!0,isCurrency:!0,formulaString:"hours_breakeven * net_cost_per_hour"},{id:"avg_hourly_charge_2026",label:"Avg Hourly Charge Rate Future",isAutoCalculated:!0,isCurrency:!0,formulaString:"avg_hourly_charge * 1.06"},{id:"sales_budget_2026",label:"Projected Sales Budget 30% Uplift",isAutoCalculated:!0,isCurrency:!0,formulaString:"total_sales * 1.3"},{id:"sales_target_hours",label:"Sales Target in Hours",isAutoCalculated:!0,formulaString:"sales_budget_2026 / avg_hourly_charge_2026"},{id:"variance_2025",label:"Variance",isAutoCalculated:!0,formulaString:"sales_target_hours - worked_hours"}];function Z(s,l){const o={};for(const t of s){o[t.id]={};for(const C of l)o[t.id][C.id]={value:null,isEditable:!t.isAutoCalculated&&!C.isYearEnd,source:"manual"}}return o}function E(s,l,o){var v,w;const t=JSON.parse(JSON.stringify(s));for(const n of o.filter(m=>!m.isYearEnd))for(const m of l)m.formulaString?t[m.id][n.id]={...t[m.id][n.id],value:Q(m.formulaString,t,n.id),isEditable:!1,source:"calculated"}:m.formula&&(t[m.id][n.id]={...t[m.id][n.id],value:m.formula(t,m.id,n.id),isEditable:!1,source:"calculated"});const C=l.find(n=>n.id==="total_sales"),y=l.find(n=>n.id==="sales_split_pct"),h=o.find(n=>n.isYearEnd);if(C&&y&&h){let n=0;const m=o.filter(_=>!_.isYearEnd);n=m.reduce((_,N)=>{var d,a;return _+(((a=(d=t.total_sales)==null?void 0:d[N.id])==null?void 0:a.value)??0)},0);for(const _ of m){const N=((w=(v=t.total_sales)==null?void 0:v[_.id])==null?void 0:w.value)??0,d=n!==0?N/n*100:0;t.sales_split_pct[_.id]={value:d,isEditable:!1,source:"calculated"}}t.sales_split_pct[h.id]={value:n!==0?100:0,isEditable:!1,source:"calculated"}}const b=o.find(n=>n.isYearEnd);if(b)for(const n of l){if(n.id==="sales_split_pct")continue;const m=o.filter(_=>!_.isYearEnd).reduce((_,N)=>{var d,a;return _+(((a=(d=t[n.id])==null?void 0:d[N.id])==null?void 0:a.value)??0)},0);n.formulaString||n.isAutoCalculated?n.formulaString?t[n.id][b.id]={value:Q(n.formulaString,t,b.id),isEditable:!1,source:"calculated"}:n.formula?t[n.id][b.id]={value:n.formula(t,n.id,b.id),isEditable:!1,source:"calculated"}:t[n.id][b.id]={value:m,isEditable:!1,source:"calculated"}:t[n.id][b.id]={value:m,isEditable:!1,source:"calculated"}}return t}function Ge(s){const[l,o]=p.useState(I),[t,C]=p.useState(()=>H(s)),[y,h]=p.useState(()=>E(Z(I,H(s)),I,H(s))),[b,v]=p.useState(null);p.useEffect(()=>{const i=H(s);C(i);let r=Z(l,i);s!=null&&s.from&&(s!=null&&s.to)?(async()=>{try{const f=T(s.from,"yyyy-MM-dd"),x=T(s.to,"yyyy-MM-dd"),j=localStorage.getItem("auth_token"),c=await fetch(`/api/financial-summary/metrics?start=${f}&end=${x}`,{headers:{Authorization:`Bearer ${j}`},credentials:"include"});if(c.status===401){console.error("Unauthorized: Redirecting to login"),window.location.href="/auth";return}if(c.ok){const u=c.headers.get("content-type");if(u&&u.indexOf("application/json")!==-1){const k=await c.json(),ae={January:"jan",February:"feb",March:"mar",April:"apr",May:"may",June:"jun",July:"jul",August:"aug",September:"sep",October:"oct",November:"nov",December:"dec"};for(const[$,M]of Object.entries(k)){const[P,re]=$.split("-"),V=ae[re];if(!V)continue;const S=`${V}-${P}`;i.find(le=>le.id===S)&&(r.total_sales&&r.total_sales[S]&&(r.total_sales[S].value=M.total_sales,r.total_sales[S].source="backend"),r.cost_sales_se&&r.cost_sales_se[S]&&(r.cost_sales_se[S].value=M.cost_sales_se,r.cost_sales_se[S].source="backend"),r.cost_sales_paye&&r.cost_sales_paye[S]&&(r.cost_sales_paye[S].value=M.cost_sales_paye,r.cost_sales_paye[S].source="backend"),r.worked_hours&&r.worked_hours[S]&&(r.worked_hours[S].value=M.total_hours,r.worked_hours[S].source="backend"))}try{const $=await fetch("/api/financial-summary/overrides",{headers:{Authorization:`Bearer ${j}`},credentials:"include"});if($.ok){const M=await $.json();for(const P of M)r[P.row_id]&&r[P.row_id][P.col_id]!==void 0&&(r[P.row_id][P.col_id]={...r[P.row_id][P.col_id],value:P.value,source:"manual"})}}catch{}h(E(r,l,i))}else console.error("Received non-JSON response from API"),h(E(r,l,i))}else console.error("API Error",c.status,c.statusText),h(E(r,l,i))}catch(f){console.error("Failed to fetch metrics",f),h(E(r,l,i))}})():h(E(r,l,i))},[s]);const w=p.useCallback((i,r,g)=>{h(x=>{const j={...x};return j[i]={...j[i]},j[i][r]={...j[i][r],value:g,source:"manual"},E(j,l,t)});const f=localStorage.getItem("auth_token");fetch("/api/financial-summary/overrides",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},credentials:"include",body:JSON.stringify({row_id:i,col_id:r,value:g})}).catch(x=>console.warn("Failed to save override:",x))},[l,t]),n=p.useCallback((i,r)=>{o(g=>{const f=g.map(x=>x.id===i?{...x,formulaString:r}:x);return h(x=>E(x,f,t)),f})},[t]),m=p.useCallback(i=>{const r=`custom_${Date.now()}`,g={id:r,label:i,isAutoCalculated:!1,isCurrency:!0};o(f=>{const x=[...f,g];return h(j=>{const c={...j};c[r]={};for(const u of t)c[r][u.id]={value:null,isEditable:!u.isYearEnd,source:"manual"};return E(c,x,t)}),x})},[t]),_=p.useCallback(i=>{o(r=>r.filter(g=>g.id!==i)),h(r=>{const g={...r};return delete g[i],g})},[]),N=p.useCallback(i=>{const r=`col_${Date.now()}`,g={id:r,label:i};C(f=>{const x=f.findIndex(c=>c.isYearEnd),j=[...f];return j.splice(x,0,g),h(c=>{const u={...c};for(const k of l)u[k.id]={...u[k.id]},u[k.id][r]={value:null,isEditable:!k.isAutoCalculated,source:"manual"};return E(u,l,j)}),j})},[l]),d=p.useCallback(i=>{C(r=>{const g=r.filter(f=>f.id!==i);return h(f=>{const x={...f};for(const j of Object.keys(x)){const{[i]:c,...u}=x[j];x[j]=u}return E(x,l,g)}),g})},[l]),a=p.useCallback((i,r)=>{C(g=>g.map(f=>f.id===i?{...f,label:r}:f))},[]),A=p.useCallback(i=>{if(!b)return;const r=l.filter(u=>!u.isAutoCalculated),g=t.filter(u=>!u.isYearEnd),f=r.findIndex(u=>u.id===b.row),x=g.findIndex(u=>u.id===b.col);if(f===-1||x===-1)return;let j=f,c=x;switch(i){case"up":j=Math.max(0,f-1);break;case"down":j=Math.min(r.length-1,f+1);break;case"left":c=Math.max(0,x-1);break;case"right":c=Math.min(g.length-1,x+1);break}v({row:r[j].id,col:g[c].id})},[b,l,t]);return{rows:l,columns:t,data:y,updateCell:w,updateRowFormula:n,addRow:m,deleteRow:_,addColumn:N,deleteColumn:d,renameColumn:a,activeCell:b,setActiveCell:v,navigateCell:A}}const se="financial_summary_date_range";function Ke(){try{const s=localStorage.getItem(se);if(s){const l=JSON.parse(s);return{from:new Date(l.from),to:new Date(l.to)}}}catch{}return{from:Te(new Date),to:Oe(new Date)}}function at(){const[s,l]=p.useState(Ke),o=k=>{l(k),k!=null&&k.from&&(k!=null&&k.to)&&localStorage.setItem(se,JSON.stringify({from:k.from.toISOString(),to:k.to.toISOString()}))},{rows:t,columns:C,data:y,activeCell:h,setActiveCell:b,updateCell:v,addRow:w,deleteRow:n,addColumn:m,deleteColumn:_,navigateCell:N,updateRowFormula:d}=Ge(s),[a,A]=p.useState(""),[i,r]=p.useState(""),[g,f]=p.useState(!1),[x,j]=p.useState(!1),c=()=>{a.trim()&&(w(a.trim()),A(""),f(!1))},u=()=>{i.trim()&&(m(i.trim()),r(""),j(!1))};return e.jsx(ue,{noPadding:!0,fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-border bg-card/50 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(me,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-foreground",children:"Financial Summary."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Annual budget and performance spreadsheet"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Se,{children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(D,{id:"date",variant:"outline",className:O("w-[260px] justify-start text-left font-normal",!s&&"text-muted-foreground"),children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),s!=null&&s.from?s.to?e.jsxs(e.Fragment,{children:[T(s.from,"LLL dd, y")," -"," ",T(s.to,"LLL dd, y")]}):T(s.from,"LLL dd, y"):e.jsx("span",{children:"Pick a date"})]})}),e.jsx(Pe,{className:"w-auto p-0",align:"end",children:e.jsx(Le,{initialFocus:!0,mode:"range",defaultMonth:s==null?void 0:s.from,selected:s,onSelect:o,numberOfMonths:2,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsxs(G,{open:g,onOpenChange:f,children:[e.jsx(W,{asChild:!0,children:e.jsxs(D,{variant:"outline",size:"sm",children:[e.jsx(q,{className:"h-4 w-4 mr-1"})," Add Row"]})}),e.jsxs(K,{children:[e.jsx(R,{children:e.jsx(J,{children:"Add New Row"})}),e.jsx(B,{placeholder:"Row label...",value:a,onChange:k=>A(k.target.value),onKeyDown:k=>k.key==="Enter"&&c()}),e.jsx(U,{children:e.jsx(D,{onClick:c,disabled:!a.trim(),children:"Add"})})]})]}),e.jsxs(G,{open:x,onOpenChange:j,children:[e.jsx(W,{asChild:!0,children:e.jsxs(D,{variant:"outline",size:"sm",children:[e.jsx(q,{className:"h-4 w-4 mr-1"})," Add Column"]})}),e.jsxs(K,{children:[e.jsx(R,{children:e.jsx(J,{children:"Add New Column"})}),e.jsx(B,{placeholder:"Column label...",value:i,onChange:k=>r(k.target.value),onKeyDown:k=>k.key==="Enter"&&u()}),e.jsx(U,{children:e.jsx(D,{onClick:u,disabled:!i.trim(),children:"Add"})})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:e.jsx(Ie,{rows:t,columns:C,data:y,activeCell:h,setActiveCell:b,updateCell:v,deleteRow:n,deleteColumn:_,navigateCell:N,updateRowFormula:d})})]})})}export{at as default};
