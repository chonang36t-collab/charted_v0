import{c as $,b as ee,r as n,j as e,P as V,i as w,o as se,a as re}from"./index-B2rzTr7p.js";import{D as te,C as ae,F as le}from"./DashboardLayout-BfiZPXHo.js";import{C as f,a as h,b as g,d as v}from"./UserContext-CiO66Kvx.js";import{B as _}from"./button-CWN-pghO.js";import{I as ie}from"./input-BoTYXI6h.js";import{L as oe}from"./label-BhEodsOl.js";import{A as ne}from"./api-Da72sVOF.js";import"./users-DDAS6rlP.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=$("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=$("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);var I="Progress",U=100,[ue,Re]=ee(I),[xe,me]=ue(I),B=n.forwardRef((s,r)=>{const{__scopeProgress:l,value:i=null,max:o,getValueLabel:j=pe,...N}=s;(o||o===0)&&!L(o)&&console.error(fe(`${o}`,"Progress"));const m=L(o)?o:U;i!==null&&!T(i,m)&&console.error(he(`${i}`,"Progress"));const d=T(i,m)?i:null,p=y(d)?j(d,m):void 0;return e.jsx(xe,{scope:l,value:d,max:m,children:e.jsx(V.div,{"aria-valuemax":m,"aria-valuemin":0,"aria-valuenow":y(d)?d:void 0,"aria-valuetext":p,role:"progressbar","data-state":q(d,m),"data-value":d??void 0,"data-max":m,...N,ref:r})})});B.displayName=I;var O="ProgressIndicator",z=n.forwardRef((s,r)=>{const{__scopeProgress:l,...i}=s,o=me(O,l);return e.jsx(V.div,{"data-state":q(o.value,o.max),"data-value":o.value??void 0,"data-max":o.max,...i,ref:r})});z.displayName=O;function pe(s,r){return`${Math.round(s/r*100)}%`}function q(s,r){return s==null?"indeterminate":s===r?"complete":"loading"}function y(s){return typeof s=="number"}function L(s){return y(s)&&!isNaN(s)&&s>0}function T(s,r){return y(s)&&!isNaN(s)&&s<=r&&s>=0}function fe(s,r){return`Invalid prop \`max\` of value \`${s}\` supplied to \`${r}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${U}\`.`}function he(s,r){return`Invalid prop \`value\` of value \`${s}\` supplied to \`${r}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${U} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var G=B,ge=z;const H=n.forwardRef(({className:s,value:r,...l},i)=>e.jsx(G,{ref:i,className:w("relative h-4 w-full overflow-hidden rounded-full bg-secondary",s),...l,children:e.jsx(ge,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(r||0)}%)`}})}));H.displayName=G.displayName;const ve=se("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),D=n.forwardRef(({className:s,variant:r,...l},i)=>e.jsx("div",{ref:i,role:"alert",className:w(ve({variant:r}),s),...l}));D.displayName="Alert";const je=n.forwardRef(({className:s,...r},l)=>e.jsx("h5",{ref:l,className:w("mb-1 font-medium leading-none tracking-tight",s),...r}));je.displayName="AlertTitle";const E=n.forwardRef(({className:s,...r},l)=>e.jsx("div",{ref:l,className:w("text-sm [&_p]:leading-relaxed",s),...r}));E.displayName="AlertDescription";function Ae(){const[s,r]=n.useState(null),[l,i]=n.useState(!1),[o,j]=n.useState(0),[N,m]=n.useState({}),[d,p]=n.useState("idle"),[W,S]=n.useState(""),[u,C]=n.useState(null),P=n.useRef(null),{toast:k}=re(),X=t=>{var c;const a=(c=t.target.files)==null?void 0:c[0];a&&(a.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||a.type==="application/vnd.ms-excel"||a.name.endsWith(".csv")?(r(a),p("idle"),S("")):(k({title:"Invalid file type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file",variant:"destructive"}),r(null)))},J=async()=>{if(!s)return;i(!0),j(0),p("idle"),S(""),C(null);const t=new FormData;t.append("file",s);try{const a=localStorage.getItem("auth_token"),c=await fetch(ne.UPLOAD,{method:"POST",body:t,headers:{Authorization:`Bearer ${a}`},credentials:"include"});if(!c.ok)throw new Error(`Upload failed: ${c.statusText}`);if(!c.body)throw new Error("No response body");const b=c.body.getReader(),Y=new TextDecoder;let R="",M=!1;for(;;){const{done:Q,value:Z}=await b.read();if(Q)break;R+=Y.decode(Z,{stream:!0});const F=R.split(`
`);R=F.pop()||"";for(const A of F)if(A.trim())try{const x=JSON.parse(A);if(x.status==="progress")x.progress&&j(x.progress);else if(x.status==="complete")p("success"),C(x.data),j(100),k({title:"Upload successful",description:"Your file has been uploaded and processed successfully"}),M=!0;else if(x.status==="error")throw new Error(x.message)}catch(x){if(console.error("Error parsing stream:",x),A.trim().startsWith("<"))throw new Error("Server error occurred during processing")}}if(!M&&d!=="success")throw new Error("Upload interrupted. The server may have run out of memory or timed out.")}catch(a){p("error"),S(a.message||"An unexpected error occurred"),k({title:"Upload failed",description:a.message||"An unexpected error occurred",variant:"destructive"})}finally{i(!1)}},K=t=>{if(t===0)return"0 Bytes";const a=1024,c=["Bytes","KB","MB","GB"],b=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,b)).toFixed(2))+" "+c[b]};return e.jsx(te,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Upload Data"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload your Excel or CSV files to import data into the system"})]}),e.jsxs(f,{children:[e.jsx(h,{children:e.jsxs(g,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5"}),"File Upload"]})}),e.jsxs(v,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(oe,{htmlFor:"file-upload",children:"Select File"}),e.jsx(ie,{id:"file-upload",type:"file",ref:P,onChange:X,accept:".xlsx,.xls,.csv",disabled:l}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Supported formats: Excel (.xlsx, .xls) and CSV files"})]}),s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border rounded-lg",children:[e.jsx(le,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:K(s.size)})]})]}),l&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Uploading..."}),e.jsxs("span",{children:[o,"%"]})]}),e.jsx(H,{value:o})]}),d==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(D,{className:"border-green-200 bg-green-50",children:[e.jsx(ce,{className:"h-4 w-4 text-green-600"}),e.jsx(E,{className:"text-green-800",children:"File uploaded successfully!"})]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(f,{children:[e.jsx(h,{className:"pb-2",children:e.jsx(g,{className:"text-sm font-medium",children:"Rows Inserted"})}),e.jsx(v,{children:e.jsx("div",{className:"text-2xl font-bold",children:u.inserted.toLocaleString()})})]}),e.jsxs(f,{children:[e.jsx(h,{className:"pb-2",children:e.jsx(g,{className:"text-sm font-medium",children:"Duplicate Rows"})}),e.jsx(v,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:u.skipped_details.filter(t=>t.reason==="Duplicate").length.toLocaleString()})})]}),e.jsxs(f,{children:[e.jsx(h,{className:"pb-2",children:e.jsx(g,{className:"text-sm font-medium",children:"Skipped Rows"})}),e.jsx(v,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:u.skipped_details.filter(t=>t.reason!=="Duplicate").length.toLocaleString()})})]}),e.jsxs(f,{children:[e.jsx(h,{className:"pb-2",children:e.jsx(g,{className:"text-sm font-medium",children:"Revenue Match"})}),e.jsxs(v,{children:[e.jsx("div",{className:`text-2xl font-bold ${u.verification.match?"text-green-600":"text-red-600"}`,children:u.verification.match?"MATCHED":"MISMATCH"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Excel: £",u.verification.excel_revenue.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["DB: £",u.verification.db_revenue.toLocaleString()]})]})]})]}),u.skipped_details.length>0&&e.jsxs(f,{children:[e.jsx(h,{children:e.jsx(g,{className:"text-base",children:"Skipped Rows Details"})}),e.jsx(v,{children:e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-md",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-muted sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 font-medium",children:"Row"}),e.jsx("th",{className:"p-2 font-medium",children:"Reason"}),e.jsx("th",{className:"p-2 font-medium",children:"Details"})]})}),e.jsx("tbody",{children:u.skipped_details.map((t,a)=>e.jsxs("tr",{className:"border-t hover:bg-muted/50",children:[e.jsx("td",{className:"p-2",children:t.row}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.reason==="Duplicate"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:t.reason})}),e.jsx("td",{className:"p-2 text-muted-foreground",children:t.details})]},a))})]})})})]})]}),e.jsx(_,{onClick:()=>{p("idle"),j(0),r(null),C(null),P.current&&(P.current.value="")},variant:"outline",className:"w-full",children:"Upload New File"})]}),d==="error"&&e.jsxs(D,{className:"border-red-200 bg-red-50",children:[e.jsx(de,{className:"h-4 w-4 text-red-600"}),e.jsx(E,{className:"text-red-800",children:W})]}),d!=="success"&&e.jsx(_,{onClick:J,disabled:l,className:"w-full",children:l?"Uploading...":"Upload File"})]})]})]}),Object.keys(N).length>0&&e.jsxs(f,{children:[e.jsx(h,{children:e.jsx(g,{children:"Required Columns"})}),e.jsx(v,{children:e.jsx("div",{className:"space-y-4",children:Object.entries(N).map(([t,a])=>e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:t}),e.jsx("div",{className:"flex flex-wrap gap-2",children:a.map(c=>e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-sm",children:c},c))})]},t))})})]})]})})}export{Ae as default};
