import{c as us,h as fs,r as o,U as gs,p as js,j as e,v as ps,P as je,q as Ce,w as vs,e as Te,B as q,I as fe,A as ae,L as ys,y as U,ab as Ns,u as bs,d as Ss,b as Cs,a3 as ws,a4 as ks,a5 as Ts,a6 as As,a7 as Ms,a8 as Ls,a9 as Ds,aa as Es}from"./index-CWx4Phza.js";import{D as $s}from"./DashboardLayout-CQMrasys.js";import{C as R,d as I,a as Y,b as Q}from"./card-DN6RKQB-.js";import{c as Be,R as Rs,I as Is}from"./index-8kTfmNXR.js";import{D as Ps}from"./DashboardHeader-CDy6hhUW.js";import{S as Ae,Z as _s,C as Fe,u as Bs,O as Fs,T as Os}from"./TargetPerformanceChart-BBf8RKt3.js";import{u as zs,L as Hs,R as Ws}from"./LoadingOverlay-DgMHHDtf.js";import{g as Vs,X as J,Y as Z,f as Ks,R as X,C as re,T as ee,B as z,a as pe,L as Us,b as Re,c as Ie}from"./generateCategoricalChart-PEp1MmcZ.js";import{B as Me}from"./BarChart-Dmtfwptg.js";import{P as Gs,a as qs}from"./PieChart-B1_3Ycia.js";import{T as Oe,a as ze,b as ge,c as F,d as He,e as O}from"./table-CqL3WfSy.js";import{P as Ys}from"./pen-CfuhctfW.js";import{T as Qs}from"./trash-2-Bd-Qzrle.js";import{L as P}from"./label-CmjtHcmn.js";import{f as C}from"./popover-BcbVNZpZ.js";import{D as Js,b as Zs,c as Xs,d as et,f as st,e as tt}from"./dialog-Hr0zkCZN.js";import{S as le,a as oe,b as ce,c as de,d as te}from"./select-BswM-d_L.js";import{u as at}from"./useRecords-CzLhPg34.js";import{P as rt}from"./plus-yCmT_A6K.js";import"./users-Bc6FXYQF.js";import"./locationUtils-DtlK18dG.js";import"./checkbox-DV_k8JHB.js";import"./index-CBa4wsDC.js";import"./AreaChart-Us4-0rw6.js";import"./useQuery-DryMmDs_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=us("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var it=Vs({chartName:"ScatterChart",GraphicalChild:Ae,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:J},{axisType:"yAxis",AxisComp:Z},{axisType:"zAxis",AxisComp:_s}],formatAxisMap:Ks}),ve="Tabs",[lt,Xt]=fs(ve,[Be]),We=Be(),[ot,Le]=lt(ve),Ve=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,onValueChange:n,defaultValue:i,orientation:m="horizontal",dir:x,activationMode:g="automatic",...d}=t,u=gs(x),[c,S]=js({prop:r,onChange:n,defaultProp:i??"",caller:ve});return e.jsx(ot,{scope:s,baseId:ps(),value:c,onValueChange:S,orientation:m,dir:u,activationMode:g,children:e.jsx(je.div,{dir:u,"data-orientation":m,...d,ref:a})})});Ve.displayName=ve;var Ke="TabsList",Ue=o.forwardRef((t,a)=>{const{__scopeTabs:s,loop:r=!0,...n}=t,i=Le(Ke,s),m=We(s);return e.jsx(Rs,{asChild:!0,...m,orientation:i.orientation,dir:i.dir,loop:r,children:e.jsx(je.div,{role:"tablist","aria-orientation":i.orientation,...n,ref:a})})});Ue.displayName=Ke;var Ge="TabsTrigger",qe=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,disabled:n=!1,...i}=t,m=Le(Ge,s),x=We(s),g=Je(m.baseId,r),d=Ze(m.baseId,r),u=r===m.value;return e.jsx(Is,{asChild:!0,...x,focusable:!n,active:u,children:e.jsx(je.button,{type:"button",role:"tab","aria-selected":u,"aria-controls":d,"data-state":u?"active":"inactive","data-disabled":n?"":void 0,disabled:n,id:g,...i,ref:a,onMouseDown:Ce(t.onMouseDown,c=>{!n&&c.button===0&&c.ctrlKey===!1?m.onValueChange(r):c.preventDefault()}),onKeyDown:Ce(t.onKeyDown,c=>{[" ","Enter"].includes(c.key)&&m.onValueChange(r)}),onFocus:Ce(t.onFocus,()=>{const c=m.activationMode!=="manual";!u&&!n&&c&&m.onValueChange(r)})})})});qe.displayName=Ge;var Ye="TabsContent",Qe=o.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,forceMount:n,children:i,...m}=t,x=Le(Ye,s),g=Je(x.baseId,r),d=Ze(x.baseId,r),u=r===x.value,c=o.useRef(u);return o.useEffect(()=>{const S=requestAnimationFrame(()=>c.current=!1);return()=>cancelAnimationFrame(S)},[]),e.jsx(vs,{present:n||u,children:({present:S})=>e.jsx(je.div,{"data-state":u?"active":"inactive","data-orientation":x.orientation,role:"tabpanel","aria-labelledby":g,hidden:!S,id:d,tabIndex:0,...m,ref:a,style:{...t.style,animationDuration:c.current?"0s":void 0},children:S&&i})})});Qe.displayName=Ye;function Je(t,a){return`${t}-trigger-${a}`}function Ze(t,a){return`${t}-content-${a}`}var ct=Ve,Xe=Ue,es=qe,ss=Qe;const De=ct,ye=o.forwardRef(({className:t,...a},s)=>e.jsx(Xe,{ref:s,className:Te("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));ye.displayName=Xe.displayName;const _=o.forwardRef(({className:t,...a},s)=>e.jsx(es,{ref:s,className:Te("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));_.displayName=es.displayName;const V=o.forwardRef(({className:t,...a},s)=>e.jsx(ss,{ref:s,className:Te("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));V.displayName=ss.displayName;const dt=({active:t,payload:a,label:s,metric:r})=>{if(t&&a&&a.length){const n=["clients","employees","shifts","hours","targetAchievement","missedTargets"].includes(r),i=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:n?i.toLocaleString():i.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},we=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(R,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Me,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(re,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(J,{type:"number",hide:!0}),e.jsx(Z,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(ee,{content:e.jsx(dt,{metric:a})}),e.jsx(z,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((r,n)=>e.jsx(pe,{fill:"hsl(var(--primary))",fillOpacity:.8+n*.05},`cell-${n}`))})]})})})})}),Pe=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ht=({active:t,payload:a,metric:s})=>{if(t&&a&&a.length){const r=["revenue","costs","profit","overheads"].includes(s);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:r?Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(a[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]})}return null},ue=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(R,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((i,m)=>m.value-i.value),r=s.reduce((i,m)=>i+m.value,0),n=s.map(i=>({...i,percentage:r>0?i.value/r*100:0}));return e.jsx(R,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Gs,{children:[e.jsx(qs,{data:n,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:n.map((i,m)=>e.jsx(pe,{fill:Pe[m%Pe.length]},`cell-${m}`))}),e.jsx(ee,{content:e.jsx(ht,{metric:a})}),e.jsx(Us,{})]})})})})})},mt=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(R,{children:[e.jsx(Y,{children:e.jsx(Q,{children:"Overheads Details"})}),e.jsx(I,{children:e.jsxs(Oe,{children:[e.jsx(ze,{children:e.jsxs(ge,{children:[e.jsx(F,{children:"Title"}),e.jsx(F,{children:"Month"}),e.jsx(F,{children:"Location"}),e.jsx(F,{children:"Site"}),e.jsx(F,{className:"text-right",children:"Amount"}),e.jsx(F,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(He,{children:t.map(r=>e.jsxs(ge,{children:[e.jsx(O,{className:"font-medium",children:r.name}),e.jsxs(O,{children:[r.month," ",r.year]}),e.jsx(O,{children:r.location||"-"}),e.jsx(O,{children:r.site||"-"}),e.jsx(O,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(O,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(r),children:e.jsx(Ys,{className:"h-4 w-4"})}),e.jsx(q,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx(Qs,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),xt=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},ut=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},ft=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const r=xt(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:r}});return e.jsxs(R,{children:[e.jsxs(Y,{children:[e.jsx(Q,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(I,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Me,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(re,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(J,{type:"number",hide:!0}),e.jsx(Z,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(ee,{content:e.jsx(ut,{})}),a.map((s,r)=>s.clients.map((n,i)=>e.jsx(z,{dataKey:()=>n.revenue,stackId:r,fill:s.colors[i],radius:i===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((m,x)=>{const g=x===r;return e.jsx(pe,{fill:g?s.colors[i]:"transparent",stroke:g?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:d=>{g&&(d.target.style.opacity="0.8")},onMouseLeave:d=>{g&&(d.target.style.opacity="1")}},`cell-${r}-${i}-${x}`)})},`${r}-${i}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((n,i)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[i]}}),e.jsx("span",{className:"truncate",title:`${n.name}: £${n.revenue.toLocaleString()}`,children:n.name})]},i))})]},r))})]})]})},gt=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},jt=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(R,{children:[e.jsx(Y,{children:e.jsx(Q,{children:"Client Workload vs Staff Coverage"})}),e.jsx(I,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(R,{children:[e.jsxs(Y,{children:[e.jsx(Q,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(I,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(it,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(re,{strokeDasharray:"3 3"}),e.jsx(J,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(Re,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(Z,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(Re,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(ee,{content:e.jsx(gt,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(Ie,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(Ie,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(Ae,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,n)=>r+n.shiftCount,0).toLocaleString()})]})]})]})]}),pt=({dateRange:t,locations:a=[],sites:s=[]})=>{const[r,n]=o.useState("calendar"),[i,m]=o.useState([]),[x,g]=o.useState([]),[d,u]=o.useState([]),[c,S]=o.useState([]),[N,M]=o.useState(!1),[v,T]=o.useState(33),[k,L]=o.useState(67),[D,G]=o.useState(!1);o.useEffect(()=>{(async()=>{M(!0);try{const l=new URLSearchParams({start:C(t.from,"yyyy-MM-dd"),end:C(t.to,"yyyy-MM-dd"),view_type:r});a&&a.length>0&&a.forEach(ne=>l.append("locations",ne)),s&&s.length>0&&s.forEach(ne=>l.append("sites",ne));const w={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},E=await fetch(`/api/dashboard/shifts-heatmap?${l.toString()}`,{headers:w,credentials:"include"});if(!E.ok){console.error(`Heatmap API returned ${E.status}`);return}const $=await E.json();$.view_type==="calendar"?m($.data||[]):(g($.data||[]),u($.locations||[]),S($.dates||[]))}catch(l){console.error("Error fetching heatmap data:",l)}finally{M(!1)}})()},[t,a,s,r]);const se=()=>Math.max(...r==="calendar"?i.map(f=>f.shift_count):x.map(f=>f.shift_count),1),K=f=>{const l=se(),w=f/l*100;return w===0?"#f8f9fa":w<v?"#d4edda":w<k?"#fff3cd":"#f8d7da"},B=(f,l)=>{const w=x.find(E=>E.location===f&&E.date===l);return w?w.shift_count:0};return e.jsxs(R,{children:[e.jsxs(Y,{children:[e.jsx(Q,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"}),e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(P,{className:"font-semibold",children:"Intensity Thresholds (%)"}),e.jsx(q,{variant:"outline",size:"sm",onClick:()=>G(!D),children:D?"Done":"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs(P,{className:"text-xs",children:["Low (","<"," ",v,"%)"]}),D?e.jsx(fe,{type:"number",min:"0",max:"100",value:v,onChange:f=>T(Number(f.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsxs("span",{className:"text-sm",children:["0-",v,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(P,{className:"text-xs",children:["Medium (",v,"-",k,"%)"]}),D?e.jsx(fe,{type:"number",min:"0",max:"100",value:k,onChange:f=>L(Number(f.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsxs("span",{className:"text-sm",children:[v,"-",k,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(P,{className:"text-xs",children:["High (",">="," ",k,"%)"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsxs("span",{className:"text-sm",children:[k,"-100%"]})]})]})]})]})]}),e.jsx(I,{children:e.jsxs(De,{value:r,onValueChange:f=>n(f),children:[e.jsxs(ye,{className:"mb-4",children:[e.jsx(_,{value:"calendar",children:"Calendar View"}),e.jsx(_,{value:"location_day",children:"By Location"})]}),e.jsx(V,{value:"calendar",children:N?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):i.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:i.map((f,l)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:K(f.shift_count)},title:`${f.date} (${f.day_of_week}): ${f.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:C(new Date(f.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:f.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:f.shift_count})]},l))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(V,{value:"location_day",children:N?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):d.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-scroll max-w-full",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"border-collapse",style:{minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),c.slice(0,31).map((f,l)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:C(new Date(f),"MMM d")},l))]})}),e.jsx("tbody",{children:d.map((f,l)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:f}),c.slice(0,31).map((w,E)=>{const $=B(f,w);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:K($)},title:`${f} - ${w}: ${$} shifts`,children:$>0?$:""},E)})]},l))})]})}),c.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},vt=t=>{const{x:a,y:s,width:r,height:n,stroke:i,fill:m,payload:x}=t;if(!x||!x.median||n===0)return null;const g=n/x.median,d=s+n,u=L=>d-L*g,c=u(x.min),S=u(x.q1),N=u(x.median),M=u(x.q3),v=u(x.max),T=a+r/2,k=r/2;return e.jsxs("g",{children:[e.jsx("line",{x1:T,y1:v,x2:T,y2:c,stroke:i,strokeWidth:1}),e.jsx("line",{x1:T-k/2,y1:v,x2:T+k/2,y2:v,stroke:i,strokeWidth:1}),e.jsx("line",{x1:T-k/2,y1:c,x2:T+k/2,y2:c,stroke:i,strokeWidth:1}),e.jsx("rect",{x:a,y:M,width:r,height:Math.abs(S-M),stroke:i,fill:m,fillOpacity:.6}),e.jsx("line",{x1:a,y1:N,x2:a+r,y2:N,stroke:i,strokeWidth:2}),x.outliers&&x.outliers.map((L,D)=>e.jsx("circle",{cx:T,cy:u(L),r:2,fill:"#ef4444",opacity:.6},D))]})},yt=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a[0].payload;return e.jsxs("div",{className:"bg-popover border text-popover-foreground p-3 rounded-lg shadow-md text-sm",children:[e.jsx("p",{className:"font-semibold mb-2",children:r.name}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Max:"}),e.jsxs("span",{className:"font-medium",children:[r.max.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q3 (75%):"}),e.jsxs("span",{className:"font-medium",children:[r.q3.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Median:"}),e.jsxs("span",{className:"font-medium text-primary",children:[r.median.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q1 (25%):"}),e.jsxs("span",{className:"font-medium",children:[r.q1.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Min:"}),e.jsxs("span",{className:"font-medium",children:[r.min.toFixed(1),"h"]})]}),r.outliers.length>0&&e.jsxs("div",{className:"flex justify-between gap-4 pt-1 border-t mt-1",children:[e.jsx("span",{className:"text-destructive",children:"Outliers:"}),e.jsx("span",{className:"font-medium",children:r.outliers.length})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 pt-1 border-t",children:["Sample size: ",r.count," shifts"]})]})]})}return null},Nt=({dateRange:t,limit:a=15})=>{const[s,r]=o.useState("client"),[n,i]=o.useState([]),[m,x]=o.useState(!1);return o.useEffect(()=>{(async()=>{x(!0);try{const d=new URLSearchParams({start:C(t.from,"yyyy-MM-dd"),end:C(t.to,"yyyy-MM-dd"),dimension:s,limit:a.toString()}),u={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},c=await fetch(`${ae.HOURS_DISTRIBUTION}?${d.toString()}`,{headers:u});if(c.ok){const S=await c.json();i(S)}}catch(d){console.error("Error fetching distribution data:",d)}finally{x(!1)}})()},[t,s,a]),e.jsxs(R,{children:[e.jsxs(Y,{children:[e.jsx(Q,{children:"Hours Distribution"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Showing spread of shift durations. Box represents middle 50% of data."})]}),e.jsx(I,{children:e.jsxs(De,{value:s,onValueChange:g=>r(g),children:[e.jsxs(ye,{className:"mb-6",children:[e.jsx(_,{value:"client",children:"By Client"}),e.jsx(_,{value:"site",children:"By Site"})]}),e.jsxs("div",{className:"h-[400px] w-full",children:[m?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"Loading distribution data..."}):n.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No data available for selected period"}):e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Fe,{data:n,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(re,{strokeDasharray:"3 3",vertical:!1,opacity:.3}),e.jsx(J,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:{fontSize:12}}),e.jsx(Z,{label:{value:"Hours Worked",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(ee,{content:e.jsx(yt,{}),cursor:{fill:"transparent"}}),e.jsx(z,{dataKey:"max",fill:"transparent",barSize:1}),e.jsx(z,{dataKey:"median",shape:vt,fill:"#3b82f6",stroke:"#1e40af",barSize:40})]})}),!m&&n.length>0&&e.jsx("div",{className:"text-center text-xs text-muted-foreground mt-2",children:"* Whiskers extend to 1.5x IQR. Dots represent outliers."})]})]})})]})},bt=t=>{const{cx:a,cy:s,payload:r}=t;if(!a||!s)return null;const n=20;return e.jsx("line",{x1:a,y1:s-n/2,x2:a,y2:s+n/2,stroke:"#000",strokeWidth:3})},St=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a.find(i=>i.dataKey==="actual"),n=r?r.payload:a[0].payload;return e.jsxs("div",{className:"bg-white p-3 border rounded shadow-lg text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:n.name}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[e.jsx("span",{className:"text-gray-500",children:"Actual:"}),e.jsx("span",{className:"font-mono font-medium",children:n.actual}),e.jsx("span",{className:"text-gray-500",children:"Target:"}),e.jsx("span",{className:"font-mono font-medium",children:n.target}),e.jsx("span",{className:"text-gray-500",children:"Achievement:"}),e.jsxs("span",{className:`font-mono font-bold ${n.achievement>=100?"text-green-600":n.achievement>=80?"text-yellow-600":"text-red-600"}`,children:[n.achievement,"%"]})]})]})}return null},Ct=({dateRange:t,limit:a=15,dimension:s="site"})=>{const[r,n]=o.useState([]),[i,m]=o.useState(!1);return o.useEffect(()=>{(async()=>{if(!(!(t!=null&&t.from)||!(t!=null&&t.to))){m(!0);try{const g=C(t.from,"yyyy-MM-dd"),d=C(t.to,"yyyy-MM-dd"),u=localStorage.getItem("auth_token"),c=await fetch(`${ae.TARGET_ACHIEVEMENT_BULLET}?start=${g}&end=${d}&dimension=${s}&limit=${a}`,{headers:{Authorization:`Bearer ${u}`}});if(c.ok){const S=await c.json();n(S)}}catch(g){console.error("Error fetching bullet chart data:",g)}finally{m(!1)}}})()},[t,a,s]),i?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center",children:"Loading chart data..."}):r.length?e.jsxs("div",{className:"w-full",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Target Achievement by ",s==="client"?"Client":"Site"]}),e.jsx("div",{className:"h-[600px] w-full",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Fe,{layout:"vertical",data:r,margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(re,{stroke:"#f5f5f5",horizontal:!0,vertical:!0}),e.jsx(J,{type:"number"}),e.jsx(Z,{type:"category",dataKey:"name",width:100,tick:{fontSize:12}}),e.jsx(ee,{content:e.jsx(St,{}),cursor:{fill:"transparent"}}),e.jsx(z,{dataKey:"range_poor",stackId:"ranges",fill:"#fee2e2",barSize:30,isAnimationActive:!1}),e.jsx(z,{dataKey:"range_good",stackId:"ranges",fill:"#fef3c7",barSize:30,isAnimationActive:!1}),e.jsx(z,{dataKey:"range_excellent",stackId:"ranges",fill:"#dcfce7",barSize:30,isAnimationActive:!1}),e.jsx(z,{dataKey:"actual",barSize:12,fill:"#1f2937"}),e.jsx(Ae,{dataKey:"marker",shape:e.jsx(bt,{}),legendType:"none"})]})})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-red-100 border border-red-200 block"}),e.jsx("span",{children:"Poor (<80%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-200 block"}),e.jsx("span",{children:"Good (80-95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-green-100 border border-green-200 block"}),e.jsx("span",{children:"Excellent (>95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-1 bg-gray-800 block"}),e.jsx("span",{children:"Actual"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1 h-3 bg-black block"}),e.jsx("span",{children:"Target"})]})]})]}):e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-gray-500",children:"No data available for this period"})},wt=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a[0].payload,n=r.value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:r.name}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Value:"}),e.jsxs("span",{className:`font-mono font-medium ${n>=0?"text-green-600":"text-red-600"}`,children:[n>0?"+":"","£",Math.abs(n).toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:0})]})]})]})}return null},kt=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"});let a=0;const s=t.map((r,n)=>{const i=r.value;let m,x,g;r.type==="start"||r.type==="total"?(m=0,x=i,g="#6b7280",a=i):(m=a,x=a+i,g=i>=0?"#22c55e":"#ef4444",a+=i);let d=0,u=0;return r.type==="start"||r.type==="total"?(d=0,u=i):i>=0?(d=m,u=i):(d=x,u=Math.abs(i)),{...r,base:d,magnitude:u,fill:g}});return e.jsx(R,{children:e.jsx(I,{className:"pt-6",children:e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(X,{width:"100%",height:"100%",children:e.jsxs(Me,{data:s,margin:{top:20,right:30,left:20,bottom:5},children:[e.jsx(re,{strokeDasharray:"3 3",vertical:!1}),e.jsx(J,{dataKey:"name",axisLine:!1,tickLine:!1,fontSize:12}),e.jsx(Z,{axisLine:!1,tickLine:!1,fontSize:12,tickFormatter:r=>`£${r.toLocaleString(void 0,{notation:"compact"})}`}),e.jsx(ee,{content:e.jsx(wt,{}),cursor:{fill:"transparent"}}),e.jsx(z,{dataKey:"base",stackId:"a",fill:"transparent"}),e.jsx(z,{dataKey:"magnitude",stackId:"a",radius:[2,2,2,2],children:s.map((r,n)=>e.jsx(pe,{fill:r.fill},`cell-${n}`))})]})})})})})},ke=["January","February","March","April","May","June","July","August","September","October","November","December"],_e=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Tt=({open:t,onOpenChange:a,initialData:s,onSave:r})=>{var B,f;const{data:n}=at(),[i,m]=o.useState(!1),[x,g]=o.useState(new Date().getFullYear()),[d,u]=o.useState(ke[new Date().getMonth()]),[c,S]=o.useState(""),[N,M]=o.useState(""),[v,T]=o.useState(""),[k,L]=o.useState(""),[D,G]=o.useState("");o.useEffect(()=>{t&&(s?(g(s.year),u(s.month),S(s.location||""),M(s.site||""),G(s.value.toString()),_e.includes(s.name)?(T(s.name),L("")):(T("Custom..."),L(s.name))):(g(new Date().getFullYear()),u(ke[new Date().getMonth()]),S(""),M(""),T(""),L(""),G("")))},[t,s]);const se=async()=>{if(!c||!v||!D){U.error("Please fill in all required fields");return}const l=v==="Custom..."?k:v;if(!l){U.error("Please specify the overhead name");return}m(!0);try{await r({id:s==null?void 0:s.id,year:x,month:d,location:c,site:N||null,name:l,value:parseFloat(D)}),a(!1)}catch(w){console.error("Failed to save overhead:",w)}finally{m(!1)}},K=((B=n==null?void 0:n.jobs)==null?void 0:B.filter(l=>l.location===c&&l.site).map(l=>l.site).filter((l,w,E)=>E.indexOf(l)===w))||[];return e.jsx(Js,{open:t,onOpenChange:a,children:e.jsxs(Zs,{className:"sm:max-w-[500px]",children:[e.jsxs(Xs,{children:[e.jsx(et,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(st,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Year"}),e.jsxs(le,{value:x.toString(),onValueChange:l=>g(Number(l)),children:[e.jsx(oe,{children:e.jsx(ce,{})}),e.jsx(de,{children:[2024,2025,2026,2027,2028].map(l=>e.jsx(te,{value:l.toString(),children:l},l))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Month"}),e.jsxs(le,{value:d,onValueChange:u,children:[e.jsx(oe,{children:e.jsx(ce,{})}),e.jsx(de,{children:ke.map(l=>e.jsx(te,{value:l,children:l},l))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Location"}),e.jsxs(le,{value:c,onValueChange:l=>{S(l),M("")},children:[e.jsx(oe,{children:e.jsx(ce,{placeholder:"Select location..."})}),e.jsx(de,{children:Array.from(new Set((f=n==null?void 0:n.jobs)==null?void 0:f.map(l=>l.location).filter(Boolean))).map(l=>e.jsx(te,{value:l,children:l},l))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Site (Optional)"}),e.jsxs(le,{value:N,onValueChange:M,disabled:!c||K.length===0,children:[e.jsx(oe,{children:e.jsx(ce,{placeholder:K.length===0?"No sites available":"Select site..."})}),e.jsxs(de,{children:[e.jsx(te,{value:"all_sites",children:"All Sites (if applicable)"}),K.map(l=>e.jsx(te,{value:l,children:l},l))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Category"}),e.jsxs(le,{value:v,onValueChange:T,children:[e.jsx(oe,{children:e.jsx(ce,{placeholder:"Select category..."})}),e.jsx(de,{children:_e.map(l=>e.jsx(te,{value:l,children:l},l))})]})]}),v==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Custom Name"}),e.jsx(fe,{placeholder:"Enter overhead name",value:k,onChange:l=>L(l.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(P,{children:"Value (£)"}),e.jsx(fe,{type:"number",placeholder:"0.00",value:D,onChange:l=>G(l.target.value)})]})]}),e.jsxs(tt,{children:[e.jsx(q,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(q,{onClick:se,disabled:i,children:[i&&e.jsx(ys,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},ea=()=>{const{metricId:t}=Ns(),a=bs(),{dateRange:s,setDateRange:r}=Ss(),{role:n}=Cs(),[i,m]=o.useState(!1),[x,g]=o.useState(s),[d,u]=o.useState([]),[c,S]=o.useState([]),[N,M]=o.useState("trend"),[v,T]=o.useState([]),[k,L]=o.useState([]),[D,G]=o.useState([]),[se,K]=o.useState({hours:0,staffCount:0}),[B,f]=o.useState([]),[l,w]=o.useState(!1),[E,$]=o.useState([]),[ne,ts]=o.useState([]);o.useEffect(()=>{if(t!=="revenue"||N!=="trend")return;(async()=>{try{const h=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd")});d&&d.forEach(b=>h.append("locations",b)),c&&c.forEach(b=>h.append("sites",b));const y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/revenue-waterfall?${h.toString()}`,{headers:y});if(j.ok){const b=await j.json();ts(b)}}catch(h){console.error("Error fetching revenue waterfall:",h)}})()},[t,N,s,d,c]);const[as,he]=o.useState(!1),[rs,Ee]=o.useState(null),[me,Ne]=o.useState(null),xe=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),be=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),$e=t==="overheads",Se=n==="admin",{operationalData:H,isLoading:ns}=Bs(s,d,c),{financialData:W,isLoading:is}=zs(s,d,c),ls=xe?is:be?ns:!1;o.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const h=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd")}),y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`${ae.TARGETS_PERFORMANCE}?${h.toString()}`,{headers:y});if(j.ok){const b=await j.json();$(b)}}catch(h){console.error("Error fetching targets performance:",h)}})()},[s,t]),o.useEffect(()=>{if(N==="trend"||!t)return;(async()=>{w(!0);try{const h=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});d&&d.length>0&&d.forEach(j=>h.append("locations",j)),c&&c.length>0&&c.forEach(j=>h.append("sites",j));const y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(N==="details"&&$e){const j=await fetch(`${ae.FINANCIAL_METRICS_LIST}?${h.toString()}`,{headers:y});if(j.ok){const b=await j.json();f(b)}}else if(["location","site","client"].includes(N)){h.append("dimension",N);const j=await fetch(`${ae.BREAKDOWN}?${h.toString()}`,{headers:y});if(j.ok){const b=await j.json();T(b)}}}catch(h){console.error("Error fetching breakdown:",h)}finally{w(!1)}})()},[N,t,s,d,c]),o.useEffect(()=>{t==="clients"&&N==="revenueTier"&&Se&&(async()=>{try{const h=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd")});d&&d.length>0&&d.forEach(b=>h.append("locations",b)),c&&c.length>0&&c.forEach(b=>h.append("sites",b));const y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/client-revenue-tiers?${h.toString()}`,{headers:y});if(j.ok){const A=(await j.json()).tiers.map(ie=>({name:ie.tier,value:ie.totalRevenue,clientCount:ie.clientCount,avgRevenue:ie.avgRevenue,clients:ie.clients||[]}));L(A)}}catch(h){console.error("Error fetching revenue tiers:",h)}})()},[t,N,Se,s,d,c]),o.useEffect(()=>{N==="trend"&&(async()=>{try{const h=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd")});d&&d.length>0&&d.forEach(A=>h.append("locations",A)),c&&c.length>0&&c.forEach(A=>h.append("sites",A));const y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},j=await fetch(`/api/dashboard/client-workload-scatter?${h.toString()}`,{headers:y});if(!j.ok){console.error(`❌ Workload scatter API failed (${j.status}): /api/dashboard/client-workload-scatter`);const A=await j.text();console.error("Response preview:",A.substring(0,200));return}const b=await j.json();G(b.data||[]),K(b.medians||{hours:0,staffCount:0})}catch(h){console.error("Error fetching workload data:",h)}})()},[N,s,d,c]);const os=()=>{Ee(null),he(!0)},cs=p=>{Ee(p),he(!0)},ds=async()=>{if(me)try{const p=await fetch(`/api/admin/financial-metrics/${me}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(p.ok)U.success("Overhead deleted"),N==="details"&&f(h=>h.filter(y=>y.id!==me));else{const h=await p.json();U.error(h.error||"Failed to delete")}}catch(p){console.error(p),U.error("Failed to delete")}finally{Ne(null)}},hs=async p=>{try{const h=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(p)});if(h.ok){U.success("Overhead saved"),he(!1);const y=new URLSearchParams({start:C(s.from,"yyyy-MM-dd"),end:C(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});d&&d.forEach(A=>y.append("locations",A)),c&&c.forEach(A=>y.append("sites",A));const j={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},b=await fetch(`${ae.FINANCIAL_METRICS_LIST}?${y.toString()}`,{headers:j});if(b.ok){const A=await b.json();f(A)}}else{const y=await h.json();U.error(y.error||"Failed to save")}}catch(h){console.error(h),U.error("Failed to save")}},ms=p=>{switch(p){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},xs=o.useMemo(()=>{if(!B||B.length===0)return[];const p=B.reduce((h,y)=>{const j=y.name||"Unknown";return h[j]||(h[j]=0),h[j]+=y.value,h},{});return Object.entries(p).map(([h,y])=>({name:h,value:y}))},[B]);return xe?W==null||W.timeSeries:H==null||H.timeSeries,e.jsx($s,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Ps,{dateRange:s,onDateRangeChange:r,calendarOpen:i,onCalendarOpenChange:m,tempDateRange:x,onTempDateRangeChange:g,selectedLocations:d,onLocationsChange:u,selectedSites:c,onSitesChange:S}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(ls||l)&&e.jsx(Hs,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(q,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(nt,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:ms(t)})]}),e.jsxs(De,{value:N,onValueChange:M,className:"space-y-4",children:[e.jsxs(ye,{children:[e.jsx(_,{value:"trend",children:"Trend"}),e.jsx(_,{value:"location",children:"By Location"}),e.jsx(_,{value:"site",children:"By Site"}),t!=="clients"&&t!=="targetAchievement"&&e.jsx(_,{value:"client",children:"By Clients"}),t==="clients"&&Se&&e.jsx(_,{value:"revenueTier",children:"By Revenue Tier"}),$e&&e.jsx(_,{value:"details",children:"All Details"})]}),e.jsx(V,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(jt,{data:D,medianHours:se.hours,medianStaff:se.staffCount}),t==="shifts"&&e.jsx(pt,{dateRange:s,locations:d,sites:c}),xe&&t!=="revenue"&&e.jsx(Ws,{data:(W==null?void 0:W.timeSeries)||[],aggregationLevel:(W==null?void 0:W.aggregationLevel)||"monthly",selectedMetric:t}),t==="revenue"&&e.jsx(kt,{data:ne}),be&&t!=="missedTargets"&&t!=="shifts"&&t!=="hours"&&t!=="targetAchievement"&&e.jsx(Fs,{data:(H==null?void 0:H.timeSeries)||[],aggregationLevel:(H==null?void 0:H.aggregationLevel)||"monthly",selectedMetric:t}),t==="hours"&&e.jsx(Nt,{dateRange:s}),t==="targetAchievement"&&e.jsx(Ct,{dateRange:s,dimension:"client"}),t==="missedTargets"&&e.jsx(Os,{data:E}),!xe&&!be&&e.jsx(R,{children:e.jsx(I,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})})]})}),e.jsx(V,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(we,{data:v,metric:t||"revenue"}),e.jsx(ue,{data:v,metric:t||"revenue"})]})}),e.jsx(V,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(we,{data:v,metric:t||"revenue"}),e.jsx(ue,{data:v,metric:t||"revenue"})]})}),e.jsx(V,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(we,{data:v,metric:t||"revenue"}),e.jsx(ue,{data:v,metric:t||"revenue"})]})}),e.jsx(V,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ft,{data:k}),e.jsxs(R,{children:[e.jsx(Y,{children:e.jsx(Q,{children:"Tier Breakdown"})}),e.jsx(I,{children:e.jsxs(Oe,{children:[e.jsx(ze,{children:e.jsxs(ge,{children:[e.jsx(F,{children:"Tier"}),e.jsx(F,{className:"text-right",children:"Clients"}),e.jsx(F,{className:"text-right",children:"Total Revenue"}),e.jsx(F,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(He,{children:k.map(p=>e.jsxs(ge,{children:[e.jsx(O,{className:"font-medium",children:p.name}),e.jsx(O,{className:"text-right",children:p.clientCount}),e.jsxs(O,{className:"text-right",children:["£",p.value.toLocaleString()]}),e.jsxs(O,{className:"text-right",children:["£",p.avgRevenue.toLocaleString()]})]},p.name))})]})})]})]})}),e.jsx(V,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(ue,{data:xs,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(q,{onClick:os,className:"gap-2",children:[e.jsx(rt,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(mt,{data:B,onEdit:cs,onDelete:Ne}),e.jsx(Tt,{open:as,onOpenChange:he,initialData:rs,onSave:hs}),e.jsx(ws,{open:!!me,onOpenChange:p=>!p&&Ne(null),children:e.jsxs(ks,{children:[e.jsxs(Ts,{children:[e.jsx(As,{children:"Are you sure?"}),e.jsx(Ms,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Ls,{children:[e.jsx(Ds,{children:"Cancel"}),e.jsx(Es,{onClick:ds,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{ea as default};
