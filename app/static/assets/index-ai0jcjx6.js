import{e as me,z as ne,A as E,r as c,j as e,L as F,B as V,I as m,E as g}from"./index-DC3FHo3-.js";import{D as ge}from"./DashboardLayout-CIjQrMcE.js";import{u as xe,a as le,P as je}from"./useMutation-LntPM6AG.js";import{T as Y,a as J,b as x,c as j,d as U,e as d}from"./table-BfpewTiD.js";import{S as b,a as C,b as A,c as M,d as p}from"./select-Bdbi9z8Y.js";import{T as pe,a as ve,b as W,c as X}from"./tabs-hL171aFI.js";import{C as Z,a as ee,b as se,c as ae,d as te}from"./card-D2pw_rWt.js";import"./users-DoxNMKdS.js";import"./index-puNHyyh2.js";import"./index-BL-YJAX1.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=me("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),fe=(n,h)=>xe({queryKey:["parameters",n,h],queryFn:async()=>{const t=new URLSearchParams;n&&t.append("month",n.toString()),h&&t.append("year",h.toString());const[f,v]=await Promise.all([fetch(`${E.PARAMETERS}/targets?${t.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}),fetch(`${E.PARAMETERS}/overheads?${t.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}})]);if(!f.ok||!v.ok)throw new Error("Failed to fetch parameters");return{targets:await f.json(),overheads:await v.json()}}}),Se=()=>{const n=ne();return le({mutationFn:async h=>{const t=await fetch(`${E.PARAMETERS}/targets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(h)});if(!t.ok)throw new Error("Failed to save targets");return t.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})},we=()=>{const n=ne();return le({mutationFn:async h=>{const t=await fetch(`${E.PARAMETERS}/overheads`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(h)});if(!t.ok)throw new Error("Failed to save overheads");return t.json()},onSuccess:()=>{n.invalidateQueries({queryKey:["parameters"]})}})};function Re(){var K;const[n,h]=c.useState(new Date().getMonth()+1),[t,f]=c.useState(new Date().getFullYear()),[v,ie]=c.useState({locations:[]}),[S,$]=c.useState(new Map),[w,L]=c.useState(new Map),[y,z]=c.useState(""),[B,D]=c.useState(""),[O,_]=c.useState(""),[i,q]=c.useState(""),[P,k]=c.useState(""),[N,H]=c.useState(""),{data:l,isLoading:oe,refetch:ye}=fe(n,t),T=Se(),R=we(),G=()=>{var r;if(!(l!=null&&l.targets))return 0;const s=((r=l.targets.find(o=>!o.location))==null?void 0:r.target)||0,a=l.targets.filter(o=>o.location).reduce((o,u)=>o+u.target,0);return Math.max(0,s-a)};c.useEffect(()=>{fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}).then(s=>s.json()).then(s=>ie(s)).catch(s=>console.error("Failed to fetch filters",s))},[]);const ce=async()=>{if(!i||!N)return;const s=parseInt(N)||0;if(i!=="null"){const a=G();if(s>a){g.error(`Value exceeds remaining Global target (${a})`);return}}try{await T.mutateAsync([{month:n,year:t,location:i==="null"?null:i,site:P==="null"?null:P,target:s}]),g.success("Target added successfully"),q(""),k(""),H("")}catch{g.error("Failed to add target")}},de=(s,a,r)=>{const o=`${s}::${a}`;$(new Map(S.set(o,parseInt(r)||0)))},Q=(s,a,r)=>{const o=w.get(s)||{},u=new Map(w);u.set(s,{...o,[a]:a==="amount"?parseFloat(r)||0:r}),L(u)},he=async()=>{if(S.size===0)return;const s=[];S.forEach((a,r)=>{const[o,u]=r.split("::");s.push({month:n,year:t,location:o==="null"?null:o,site:u==="null"?null:u,target:a})});try{await T.mutateAsync(s),g.success("Targets saved successfully"),$(new Map)}catch{g.error("Failed to save targets")}},ue=async()=>{const s=[];if(Array.from(w.entries()).forEach(([a,r])=>{s.push({month:n,year:t,category:a,amount:r.amount,description:r.description})}),y&&O&&s.push({month:n,year:t,category:y,description:B,amount:parseFloat(O)||0}),s.length!==0)try{await R.mutateAsync(s),g.success("Overheads saved successfully"),L(new Map),z(""),D(""),_("")}catch{g.error("Failed to save overheads")}},I=new Map;return l==null||l.targets.forEach(s=>{var r;const a=s.location||"Global";I.has(a)||I.set(a,[]),(r=I.get(a))==null||r.push(s)}),e.jsx(ge,{children:e.jsxs("div",{className:"flex flex-col gap-6 p-6 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Business Parameters"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(b,{value:n.toString(),onValueChange:s=>h(parseInt(s)),children:[e.jsx(C,{className:"w-[120px]",children:e.jsx(A,{placeholder:"Month"})}),e.jsx(M,{children:Array.from({length:12},(s,a)=>e.jsx(p,{value:(a+1).toString(),children:new Date(0,a).toLocaleString("default",{month:"long"})},a+1))})]}),e.jsxs(b,{value:t.toString(),onValueChange:s=>f(parseInt(s)),children:[e.jsx(C,{className:"w-[100px]",children:e.jsx(A,{placeholder:"Year"})}),e.jsx(M,{children:[2024,2025,2026,2027].map(s=>e.jsx(p,{value:s.toString(),children:s},s))})]})]})]}),oe?e.jsx("div",{className:"flex justify-center items-center h-64 border rounded-lg bg-muted/10",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(pe,{defaultValue:"targets",children:[e.jsxs(ve,{children:[e.jsx(W,{value:"targets",children:"Shift Targets"}),e.jsx(W,{value:"overheads",children:"Monthly Overheads"})]}),e.jsx(X,{value:"targets",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(se,{children:"Monthly Shift Targets"}),e.jsx(ae,{children:"Set monthly shift goals per location or site."})]}),e.jsxs(V,{onClick:he,disabled:S.size===0||T.isPending,children:[T.isPending?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),"Save Changes"]})]})}),e.jsx(te,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(Y,{children:[e.jsx(J,{children:e.jsxs(x,{children:[e.jsx(j,{className:"w-[300px]",children:"Location"}),e.jsx(j,{className:"w-[300px]",children:"Site"}),e.jsx(j,{children:"Target Shifts"})]})}),e.jsxs(U,{children:[l==null?void 0:l.targets.map(s=>e.jsxs(x,{children:[e.jsx(d,{children:s.location||"Global"}),e.jsx(d,{children:s.site||"All Sites"}),e.jsx(d,{children:e.jsx(m,{type:"number",defaultValue:s.target,onChange:a=>de(s.location||"null",s.site||"null",a.target.value),className:"w-32"})})]},s.id)),e.jsxs(x,{className:"bg-muted/30",children:[e.jsx(d,{children:e.jsxs(b,{value:i,onValueChange:s=>{q(s),k("null")},children:[e.jsx(C,{className:"w-full",children:e.jsx(A,{placeholder:"Select Location"})}),e.jsxs(M,{children:[e.jsx(p,{value:"null",children:"Global"}),v.locations.map(s=>e.jsx(p,{value:s.name,children:s.name},s.name))]})]})}),e.jsx(d,{children:e.jsxs(b,{value:P,onValueChange:k,disabled:!i||i==="null",children:[e.jsx(C,{className:"w-full",children:e.jsx(A,{placeholder:"Select Site (Optional)"})}),e.jsxs(M,{children:[e.jsx(p,{value:"null",children:"All Sites"}),(K=v.locations.find(s=>s.name===i))==null?void 0:K.sites.map(s=>e.jsx(p,{value:s,children:s},s))]})]})}),e.jsx(d,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(m,{type:"number",placeholder:"0",value:N,onChange:s=>H(s.target.value),className:"w-32"}),e.jsx(V,{size:"sm",variant:"ghost",onClick:ce,disabled:!N||!i&&i!=="null",children:e.jsx(je,{className:"h-4 w-4"})})]}),i!=="null"&&i!==""&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Remaining: ",G()]})]})})]})]})]})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:'Use the bottom row to add targets for new locations/sites. Changes for existing targets must be saved using the "Save Changes" button.'})]})})]})}),e.jsx(X,{value:"overheads",children:e.jsxs(Z,{children:[e.jsxs(ee,{children:[e.jsx(se,{children:"Monthly Overheads"}),e.jsx(ae,{children:"Track fixed costs for the month (e.g., Rent, Software, Insurance)."})]}),e.jsx(te,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"border rounded-md",children:e.jsxs(Y,{children:[e.jsx(J,{children:e.jsxs(x,{children:[e.jsx(j,{className:"w-[200px]",children:"Category"}),e.jsx(j,{className:"w-[400px]",children:"Description"}),e.jsx(j,{children:"Amount (Â£)"})]})}),e.jsxs(U,{children:[l==null?void 0:l.overheads.map(s=>e.jsxs(x,{children:[e.jsx(d,{className:"font-medium",children:s.category}),e.jsx(d,{children:e.jsx(m,{defaultValue:s.description||"",placeholder:"Add details...",onChange:a=>Q(s.category,"description",a.target.value),className:"h-8"})}),e.jsx(d,{children:e.jsx(m,{type:"number",defaultValue:s.amount,onChange:a=>Q(s.category,"amount",a.target.value),className:"w-32 h-8"})})]},s.id)),e.jsxs(x,{className:"bg-muted/30",children:[e.jsx(d,{children:e.jsx(m,{placeholder:"e.g. Rent",value:y,onChange:s=>z(s.target.value),className:"h-8"})}),e.jsx(d,{children:e.jsx(m,{placeholder:"Monthly office rent",value:B,onChange:s=>D(s.target.value),className:"h-8"})}),e.jsx(d,{children:e.jsx(m,{type:"number",placeholder:"0.00",value:O,onChange:s=>_(s.target.value),className:"w-32 h-8"})})]})]})]})}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsxs(V,{onClick:ue,disabled:w.size===0&&!y||R.isPending,children:[R.isPending?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),"Save Changes"]})})]})})]})})]})]})})}export{Re as default};
