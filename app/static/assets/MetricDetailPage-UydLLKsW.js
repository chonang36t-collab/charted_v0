import{c as xs,h as gs,r as l,U as fs,p as vs,j as e,v as js,P as ie,q as xe,w as ps,e as ye,B as G,I as Me,L as ys,y as w,ab as bs,u as Ns,d as Ss,b as Cs,a3 as Ts,a4 as As,a5 as Rs,a6 as Ls,a7 as ks,a8 as Ds,a9 as ws,aa as Ms,A as te}from"./index-BbAuIYhy.js";import{D as Es}from"./DashboardLayout-BsdWI_i3.js";import{C as M,d as E,a as re,b as ne}from"./card-Duxs6LOw.js";import{c as $e,R as Fs,I as $s,P as Ps}from"./index-BU2LGFAk.js";import{D as Is}from"./DashboardHeader-CgARAriH.js";import{u as Os,O as Bs,T as _s}from"./TargetPerformanceChart-CBrpmOyo.js";import{u as Vs,L as zs,R as Hs}from"./LoadingOverlay-CPO-EBl5.js";import{R as be,C as Pe,X as Ie,Y as Oe,T as Ne,B as Be,a as Se,L as Gs}from"./generateCategoricalChart-BqJVNZ-l.js";import{B as _e}from"./BarChart-D__Y2No_.js";import{P as Us,a as Ks}from"./PieChart-Bpbni1YD.js";import{T as ve,a as je,b as I,c as C,d as pe,e as b,f as Ws}from"./table-D_hVta4_.js";import{P as Ys}from"./pen-CKojbfjW.js";import{T as qs}from"./trash-2-BtlCH0lm.js";import{D as Js,b as Xs,c as Qs,d as Zs,f as et,e as st}from"./dialog-BHVtbSJ0.js";import{L as F}from"./label-DltLh34p.js";import{S as Y,a as q,b as J,c as X,d as H}from"./select-BjHsz0G4.js";import{u as tt}from"./useRecords-DYZN6j1v.js";import{f as A}from"./popover-DT5xubrl.js";import"./users-LA0Z6igC.js";import"./locationUtils-DxSykN0N.js";import"./index-B9Cc51S6.js";import"./AreaChart-BCdz5Oj_.js";import"./useQuery-BNXbNfeY.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=xs("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var oe="Tabs",[rt,Ot]=gs(oe,[$e]),Ve=$e(),[nt,Ce]=rt(oe),ze=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,onValueChange:d,defaultValue:h,orientation:m="horizontal",dir:j,activationMode:p="automatic",...u}=t,v=fs(j),[c,N]=vs({prop:n,onChange:d,defaultProp:h??"",caller:oe});return e.jsx(nt,{scope:s,baseId:js(),value:c,onValueChange:N,orientation:m,dir:v,activationMode:p,children:e.jsx(ie.div,{dir:v,"data-orientation":m,...u,ref:a})})});ze.displayName=oe;var He="TabsList",Ge=l.forwardRef((t,a)=>{const{__scopeTabs:s,loop:n=!0,...d}=t,h=Ce(He,s),m=Ve(s);return e.jsx(Fs,{asChild:!0,...m,orientation:h.orientation,dir:h.dir,loop:n,children:e.jsx(ie.div,{role:"tablist","aria-orientation":h.orientation,...d,ref:a})})});Ge.displayName=He;var Ue="TabsTrigger",Ke=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,disabled:d=!1,...h}=t,m=Ce(Ue,s),j=Ve(s),p=qe(m.baseId,n),u=Je(m.baseId,n),v=n===m.value;return e.jsx($s,{asChild:!0,...j,focusable:!d,active:v,children:e.jsx(ie.button,{type:"button",role:"tab","aria-selected":v,"aria-controls":u,"data-state":v?"active":"inactive","data-disabled":d?"":void 0,disabled:d,id:p,...h,ref:a,onMouseDown:xe(t.onMouseDown,c=>{!d&&c.button===0&&c.ctrlKey===!1?m.onValueChange(n):c.preventDefault()}),onKeyDown:xe(t.onKeyDown,c=>{[" ","Enter"].includes(c.key)&&m.onValueChange(n)}),onFocus:xe(t.onFocus,()=>{const c=m.activationMode!=="manual";!v&&!d&&c&&m.onValueChange(n)})})})});Ke.displayName=Ue;var We="TabsContent",Ye=l.forwardRef((t,a)=>{const{__scopeTabs:s,value:n,forceMount:d,children:h,...m}=t,j=Ce(We,s),p=qe(j.baseId,n),u=Je(j.baseId,n),v=n===j.value,c=l.useRef(v);return l.useEffect(()=>{const N=requestAnimationFrame(()=>c.current=!1);return()=>cancelAnimationFrame(N)},[]),e.jsx(ps,{present:d||v,children:({present:N})=>e.jsx(ie.div,{"data-state":v?"active":"inactive","data-orientation":j.orientation,role:"tabpanel","aria-labelledby":p,hidden:!N,id:u,tabIndex:0,...m,ref:a,style:{...t.style,animationDuration:c.current?"0s":void 0},children:N&&h})})});Ye.displayName=We;function qe(t,a){return`${t}-trigger-${a}`}function Je(t,a){return`${t}-content-${a}`}var it=ze,Xe=Ge,Qe=Ke,Ze=Ye;const ot=it,es=l.forwardRef(({className:t,...a},s)=>e.jsx(Xe,{ref:s,className:ye("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));es.displayName=Xe.displayName;const $=l.forwardRef(({className:t,...a},s)=>e.jsx(Qe,{ref:s,className:ye("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));$.displayName=Qe.displayName;const P=l.forwardRef(({className:t,...a},s)=>e.jsx(Ze,{ref:s,className:ye("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));P.displayName=Ze.displayName;const lt=({active:t,payload:a,label:s,metric:n})=>{if(t&&a&&a.length){const d=["clients","employees","shifts","hours"].includes(n),h=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:d?h.toLocaleString():h.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},ge=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(M,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(_e,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(Pe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(Ie,{type:"number",hide:!0}),e.jsx(Oe,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(Ne,{content:e.jsx(lt,{metric:a})}),e.jsx(Be,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((n,d)=>e.jsx(Se,{fill:"hsl(var(--primary))",fillOpacity:.8+d*.05},`cell-${d}`))})]})})})})}),Ee=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ct=({active:t,payload:a})=>t&&a&&a.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]}):null,ae=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(M,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((h,m)=>m.value-h.value),n=s.reduce((h,m)=>h+m.value,0),d=s.map(h=>({...h,percentage:n>0?h.value/n*100:0}));return e.jsx(M,{children:e.jsx(E,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(Us,{children:[e.jsx(Ks,{data:d,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:d.map((h,m)=>e.jsx(Se,{fill:Ee[m%Ee.length]},`cell-${m}`))}),e.jsx(Ne,{content:e.jsx(ct,{})}),e.jsx(Gs,{})]})})})})})},dt=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(M,{children:[e.jsx(re,{children:e.jsx(ne,{children:"Overheads Details"})}),e.jsx(E,{children:e.jsxs(ve,{children:[e.jsx(je,{children:e.jsxs(I,{children:[e.jsx(C,{children:"Title"}),e.jsx(C,{children:"Month"}),e.jsx(C,{children:"Location"}),e.jsx(C,{children:"Site"}),e.jsx(C,{className:"text-right",children:"Amount"}),e.jsx(C,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(pe,{children:t.map(n=>e.jsxs(I,{children:[e.jsx(b,{className:"font-medium",children:n.name}),e.jsxs(b,{children:[n.month," ",n.year]}),e.jsx(b,{children:n.location||"-"}),e.jsx(b,{children:n.site||"-"}),e.jsx(b,{className:"text-right",children:n.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(n),children:e.jsx(Ys,{className:"h-4 w-4"})}),e.jsx(G,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(n.id),children:e.jsx(qs,{className:"h-4 w-4"})})]})})]},n.id))})]})})]}),ht=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},ut=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},mt=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const n=ht(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:n}});return e.jsxs(M,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(E,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(be,{width:"100%",height:"100%",children:e.jsxs(_e,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(Pe,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(Ie,{type:"number",hide:!0}),e.jsx(Oe,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(Ne,{content:e.jsx(ut,{})}),a.map((s,n)=>s.clients.map((d,h)=>e.jsx(Be,{dataKey:()=>d.revenue,stackId:n,fill:s.colors[h],radius:h===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((m,j)=>{const p=j===n;return e.jsx(Se,{fill:p?s.colors[h]:"transparent",stroke:p?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:u=>{p&&(u.target.style.opacity="0.8")},onMouseLeave:u=>{p&&(u.target.style.opacity="1")}},`cell-${n}-${h}-${j}`)})},`${n}-${h}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,n)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((d,h)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[h]}}),e.jsx("span",{className:"truncate",title:`${d.name}: £${d.revenue.toLocaleString()}`,children:d.name})]},h))})]},n))})]})]})},fe=["January","February","March","April","May","June","July","August","September","October","November","December"],Fe=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],xt=({open:t,onOpenChange:a,initialData:s,onSave:n})=>{var k,V;const{data:d}=tt(),[h,m]=l.useState(!1),[j,p]=l.useState(new Date().getFullYear()),[u,v]=l.useState(fe[new Date().getMonth()]),[c,N]=l.useState(""),[y,O]=l.useState(""),[S,B]=l.useState(""),[U,_]=l.useState(""),[Q,K]=l.useState("");l.useEffect(()=>{t&&(s?(p(s.year),v(s.month),N(s.location||""),O(s.site||""),K(s.value.toString()),Fe.includes(s.name)?(B(s.name),_("")):(B("Custom..."),_(s.name))):(p(new Date().getFullYear()),v(fe[new Date().getMonth()]),N(""),O(""),B(""),_(""),K("")))},[t,s]);const Te=async()=>{if(!c||!S||!Q){w.error("Please fill in all required fields");return}const o=S==="Custom..."?U:S;if(!o){w.error("Please specify the overhead name");return}m(!0);try{await n({id:s==null?void 0:s.id,year:j,month:u,location:c,site:y||null,name:o,value:parseFloat(Q)}),a(!1)}catch(z){console.error("Failed to save overhead:",z)}finally{m(!1)}},W=((k=d==null?void 0:d.jobs)==null?void 0:k.filter(o=>o.location===c&&o.site).map(o=>o.site).filter((o,z,le)=>le.indexOf(o)===z))||[];return e.jsx(Js,{open:t,onOpenChange:a,children:e.jsxs(Xs,{className:"sm:max-w-[500px]",children:[e.jsxs(Qs,{children:[e.jsx(Zs,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(et,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Year"}),e.jsxs(Y,{value:j.toString(),onValueChange:o=>p(Number(o)),children:[e.jsx(q,{children:e.jsx(J,{})}),e.jsx(X,{children:[2024,2025,2026,2027,2028].map(o=>e.jsx(H,{value:o.toString(),children:o},o))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Month"}),e.jsxs(Y,{value:u,onValueChange:v,children:[e.jsx(q,{children:e.jsx(J,{})}),e.jsx(X,{children:fe.map(o=>e.jsx(H,{value:o,children:o},o))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Location"}),e.jsxs(Y,{value:c,onValueChange:o=>{N(o),O("")},children:[e.jsx(q,{children:e.jsx(J,{placeholder:"Select location..."})}),e.jsx(X,{children:Array.from(new Set((V=d==null?void 0:d.jobs)==null?void 0:V.map(o=>o.location).filter(Boolean))).map(o=>e.jsx(H,{value:o,children:o},o))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Site (Optional)"}),e.jsxs(Y,{value:y,onValueChange:O,disabled:!c||W.length===0,children:[e.jsx(q,{children:e.jsx(J,{placeholder:W.length===0?"No sites available":"Select site..."})}),e.jsxs(X,{children:[e.jsx(H,{value:"all_sites",children:"All Sites (if applicable)"}),W.map(o=>e.jsx(H,{value:o,children:o},o))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Category"}),e.jsxs(Y,{value:S,onValueChange:B,children:[e.jsx(q,{children:e.jsx(J,{placeholder:"Select category..."})}),e.jsx(X,{children:Fe.map(o=>e.jsx(H,{value:o,children:o},o))})]})]}),S==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Custom Name"}),e.jsx(Me,{placeholder:"Enter overhead name",value:U,onChange:o=>_(o.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(F,{children:"Value (£)"}),e.jsx(Me,{type:"number",placeholder:"0.00",value:Q,onChange:o=>K(o.target.value)})]})]}),e.jsxs(st,{children:[e.jsx(G,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(G,{onClick:Te,disabled:h,children:[h&&e.jsx(ys,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Bt=()=>{const{metricId:t}=bs(),a=Ns(),{dateRange:s,setDateRange:n}=Ss(),{role:d}=Cs(),[h,m]=l.useState(!1),[j,p]=l.useState(s),[u,v]=l.useState([]),[c,N]=l.useState([]),[y,O]=l.useState("trend"),[S,B]=l.useState([]),[U,_]=l.useState([]),[Q,K]=l.useState([]),[Te,W]=l.useState({hours:0,staffCount:0}),[k,V]=l.useState([]),[o,z]=l.useState(!1),[le,ss]=l.useState([]),[ts,Z]=l.useState(!1),[as,Ae]=l.useState(null),[ee,ce]=l.useState(null),se=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),de=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),he=t==="overheads",rs=d==="admin",{operationalData:R,isLoading:ns}=Os(s,u,c),{financialData:L,isLoading:is}=Vs(s,u,c),os=se?is:de?ns:!1;l.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")}),g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`${te.TARGETS_PERFORMANCE}?${i.toString()}`,{headers:g});if(x.ok){const f=await x.json();ss(f)}}catch(i){console.error("Error fetching targets performance:",i)}})()},[s,t]),l.useEffect(()=>{if(y==="trend"||!t)return;(async()=>{z(!0);try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});u&&u.length>0&&u.forEach(x=>i.append("locations",x)),c&&c.length>0&&c.forEach(x=>i.append("sites",x));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(y==="details"&&he){const x=await fetch(`${te.FINANCIAL_METRICS_LIST}?${i.toString()}`,{headers:g});if(x.ok){const f=await x.json();V(f)}}else if(["location","site","client"].includes(y)){i.append("dimension",y);const x=await fetch(`${te.BREAKDOWN}?${i.toString()}`,{headers:g});if(x.ok){const f=await x.json();B(f)}}}catch(i){console.error("Error fetching breakdown:",i)}finally{z(!1)}})()},[y,t,s,u,c]),l.useEffect(()=>{t==="clients"&&y==="revenueTier"&&(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(f=>i.append("locations",f)),c&&c.length>0&&c.forEach(f=>i.append("sites",f));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`/api/dashboard/client-revenue-tiers?${i.toString()}`,{headers:g});if(x.ok){const T=(await x.json()).tiers.map(D=>({name:D.tier,value:D.totalRevenue,clientCount:D.clientCount,avgRevenue:D.avgRevenue,clients:D.clients||[]}));_(T)}}catch(i){console.error("Error fetching revenue tiers:",i)}})()},[t,y,s,u,c]),l.useEffect(()=>{y==="trend"&&(async()=>{try{const i=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd")});u&&u.length>0&&u.forEach(f=>i.append("locations",f)),c&&c.length>0&&c.forEach(f=>i.append("sites",f));const g={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},x=await fetch(`/api/dashboard/client-workload-scatter?${i.toString()}`,{headers:g});if(x.ok){const f=await x.json();K(f.data||[]),W(f.medians||{hours:0,staffCount:0})}}catch(i){console.error("Error fetching workload data:",i)}})()},[y,s,u,c]);const ls=()=>{Ae(null),Z(!0)},cs=r=>{Ae(r),Z(!0)},ds=async()=>{if(ee)try{const r=await fetch(`/api/admin/financial-metrics/${ee}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(r.ok)w.success("Overhead deleted"),y==="details"&&V(i=>i.filter(g=>g.id!==ee));else{const i=await r.json();w.error(i.error||"Failed to delete")}}catch(r){console.error(r),w.error("Failed to delete")}finally{ce(null)}},hs=async r=>{try{const i=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(r)});if(i.ok){w.success("Overhead saved"),Z(!1);const g=new URLSearchParams({start:A(s.from,"yyyy-MM-dd"),end:A(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});u&&u.forEach(T=>g.append("locations",T)),c&&c.forEach(T=>g.append("sites",T));const x={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},f=await fetch(`${te.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:x});if(f.ok){const T=await f.json();V(T)}}else{const g=await i.json();w.error(g.error||"Failed to save")}}catch(i){console.error(i),w.error("Failed to save")}},Re=r=>{switch(r){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},us=(r,i)=>{var g,x,f,T,D,Le,ke,De,we;if(!r)return"-";switch(i){case"revenue":return`£${((g=r.revenue)==null?void 0:g.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"cost":return`£${((x=r.cost)==null?void 0:x.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"profit":const me=r.profit??r.revenue-r.cost-(r.overheads||0);return`£${(me==null?void 0:me.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;case"shifts":return((f=r.totalShifts)==null?void 0:f.toLocaleString())??0;case"hours":return((T=r.paidHours)==null?void 0:T.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"clients":return((D=r.clientCount)==null?void 0:D.toLocaleString())??0;case"employees":return((Le=r.paidHours)==null?void 0:Le.toLocaleString(void 0,{maximumFractionDigits:1}))??0;case"targetAchievement":return`${((ke=r.achievementPercentage)==null?void 0:ke.toFixed(1))??0}%`;case"missedTargets":return`${((De=r.achievementPercentage)==null?void 0:De.toFixed(1))??0}%`;case"clientRate":return`£${(r.revenue/r.paidHours||0).toFixed(2)}`;case"staffRate":return`£${(r.cost/r.paidHours||0).toFixed(2)}`;case"overheads":return`£${((we=r.overheads)==null?void 0:we.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0}`;default:return"-"}},ms=l.useMemo(()=>{if(!k||k.length===0)return[];const r=k.reduce((i,g)=>{const x=g.name||"Unknown";return i[x]||(i[x]=0),i[x]+=g.value,i},{});return Object.entries(r).map(([i,g])=>({name:i,value:g}))},[k]),ue=se?L==null?void 0:L.timeSeries:R==null?void 0:R.timeSeries;return e.jsx(Es,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Is,{dateRange:s,onDateRangeChange:n,calendarOpen:h,onCalendarOpenChange:m,tempDateRange:j,onTempDateRangeChange:p,selectedLocations:u,onLocationsChange:v,selectedSites:c,onSitesChange:N}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(os||o)&&e.jsx(zs,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(G,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(at,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:Re(t)})]}),e.jsxs(ot,{value:y,onValueChange:O,className:"space-y-4",children:[e.jsxs(es,{children:[e.jsx($,{value:"trend",children:"Trend"}),e.jsx($,{value:"location",children:"By Location"}),e.jsx($,{value:"site",children:"By Site"}),t==="clients"&&rs?e.jsx($,{value:"revenueTier",children:"By Revenue Tier"}):!he&&e.jsx($,{value:"client",children:"By Client"}),he&&e.jsx($,{value:"details",children:"All Details"})]}),e.jsx(P,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[se&&e.jsx(Hs,{data:(L==null?void 0:L.timeSeries)||[],aggregationLevel:(L==null?void 0:L.aggregationLevel)||"monthly",selectedMetric:t}),de&&t!=="missedTargets"&&e.jsx(Bs,{data:(R==null?void 0:R.timeSeries)||[],aggregationLevel:(R==null?void 0:R.aggregationLevel)||"monthly",selectedMetric:t}),t==="missedTargets"&&e.jsx(_s,{data:le}),!se&&!de&&e.jsx(M,{children:e.jsx(E,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})}),e.jsxs(M,{children:[e.jsx(re,{children:e.jsx(ne,{children:"Historical Data"})}),e.jsx(E,{children:e.jsxs(ve,{children:[e.jsxs(Ws,{children:["Detailed historical data for ",Re(t)]}),e.jsx(je,{children:e.jsxs(I,{children:[e.jsx(C,{children:"Period"}),e.jsx(C,{className:"text-right",children:"Value"})]})}),e.jsx(pe,{children:ue&&ue.length>0?[...ue].reverse().map((r,i)=>e.jsxs(I,{children:[e.jsx(b,{className:"font-medium",children:r.display}),e.jsx(b,{className:"text-right font-medium",children:us(r,t)})]},i)):e.jsx(I,{children:e.jsx(b,{colSpan:2,className:"text-center",children:"No data available"})})})]})})]})]})}),e.jsx(P,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ae,{data:S,metric:t||"revenue"})]})}),e.jsx(P,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ae,{data:S,metric:t||"revenue"})]})}),e.jsx(P,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(mt,{data:U}),e.jsxs(M,{children:[e.jsx(re,{children:e.jsx(ne,{children:"Tier Breakdown"})}),e.jsx(E,{children:e.jsxs(ve,{children:[e.jsx(je,{children:e.jsxs(I,{children:[e.jsx(C,{children:"Tier"}),e.jsx(C,{className:"text-right",children:"Clients"}),e.jsx(C,{className:"text-right",children:"Total Revenue"}),e.jsx(C,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(pe,{children:U.map(r=>e.jsxs(I,{children:[e.jsx(b,{className:"font-medium",children:r.name}),e.jsx(b,{className:"text-right",children:r.clientCount}),e.jsxs(b,{className:"text-right",children:["£",r.value.toLocaleString()]}),e.jsxs(b,{className:"text-right",children:["£",r.avgRevenue.toLocaleString()]})]},r.name))})]})})]})]})}),e.jsx(P,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(ge,{data:S,metric:t||"revenue"}),e.jsx(ae,{data:S,metric:t||"revenue"})]})}),e.jsx(P,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(ae,{data:ms,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(G,{onClick:ls,className:"gap-2",children:[e.jsx(Ps,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(dt,{data:k,onEdit:cs,onDelete:ce}),e.jsx(xt,{open:ts,onOpenChange:Z,initialData:as,onSave:hs}),e.jsx(Ts,{open:!!ee,onOpenChange:r=>!r&&ce(null),children:e.jsxs(As,{children:[e.jsxs(Rs,{children:[e.jsx(Ls,{children:"Are you sure?"}),e.jsx(ks,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Ds,{children:[e.jsx(ws,{children:"Cancel"}),e.jsx(Ms,{onClick:ds,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Bt as default};
