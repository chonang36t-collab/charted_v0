import{r as c,a5 as R,j as e,B as w,I as D,X as K,D as b}from"./index-Ypcdoao5.js";import{D as Q,b as _}from"./DashboardLayout-CS4jATbD.js";import{C as P,a as Y,b as U,d as W}from"./card-DO1S-a6D.js";import{L as T}from"./label-BmsUkCeN.js";import{S as A,a as O,b as $,c as z,d as I}from"./select-DcQfBGh-.js";import{T as X,a as G,b as M,c as C,d as Z,e as p}from"./table-PVhO5FNt.js";import{u as V}from"./useQuery-CYhAwQKL.js";import{u as ee,e as q}from"./useRecords-CvmDMjmn.js";import{D as se,a as ae,b as te,c as ne,d as re,f as ie}from"./dialog-ByXbN32W.js";import{a as oe,C as le}from"./index-kqLllKMY.js";import"./users-DQvBOw7c.js";const B=["January","February","March","April","May","June","July","August","September","October","November","December"],Ne=()=>{const[a,f]=c.useState(new Date().getFullYear()),[r,j]=c.useState(B[new Date().getMonth()]),[d,v]=c.useState(new Set),h=R(),{data:m}=ee(),{data:l}=V({queryKey:["admin-targets",a],queryFn:async()=>{const s=await fetch(`/api/admin/targets?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch targets");return s.json()}}),{data:u}=V({queryKey:["admin-financials",a],queryFn:async()=>{const s=await fetch(`/api/admin/financial-metrics?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch metrics");return s.json()}}),x=q({mutationFn:async s=>{const t=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save target");return t.json()},onSuccess:()=>{h.invalidateQueries({queryKey:["admin-targets"]}),b.success("Target saved")},onError:s=>b.error(s.message)}),S=q({mutationFn:async s=>{const t=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save metric");return t.json()},onSuccess:()=>{h.invalidateQueries({queryKey:["admin-financials"]}),b.success("Metric saved")},onError:s=>b.error(s.message)}),y=c.useMemo(()=>{if(!(m!=null&&m.jobs))return{};const s={};return m.jobs.forEach(t=>{t.location&&(s[t.location]||(s[t.location]=new Set),t.site&&s[t.location].add(t.site))}),s},[m]),F=s=>{const t=new Set(d);t.has(s)?t.delete(s):t.add(s),v(t)},i=(s,t)=>{var g;if(t)return((g=l==null?void 0:l.find(o=>o.month===r&&o.location===s&&o.site===t))==null?void 0:g.target)||0;const k=y[s]?Array.from(y[s]):[];let n=0;return k.forEach(o=>{var L;const N=(L=l==null?void 0:l.find(E=>E.month===r&&E.location===s&&E.site===o))==null?void 0:L.target;n+=N??1e3}),n};return e.jsxs(Q,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(P,{className:"mb-6",children:[e.jsx(Y,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{children:"Year:"}),e.jsxs(A,{value:a.toString(),onValueChange:s=>f(Number(s)),children:[e.jsx(O,{className:"w-[100px]",children:e.jsx($,{})}),e.jsx(z,{children:[2024,2025,2026,2027,2028].map(s=>e.jsx(I,{value:s.toString(),children:s},s))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{children:"Month:"}),e.jsxs(A,{value:r,onValueChange:j,children:[e.jsx(O,{className:"w-[120px]",children:e.jsx($,{})}),e.jsx(z,{children:B.map(s=>e.jsx(I,{value:s,children:s},s))})]})]})]})]})}),e.jsx(W,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(M,{children:[e.jsx(C,{className:"w-[300px]",children:"Location / Site"}),e.jsx(C,{className:"w-[150px]",children:"Shift Target"}),e.jsx(C,{className:"w-[150px]",children:"Total Overheads"}),e.jsx(C,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Z,{children:Object.entries(y).map(([s,t])=>{const k=(u||[]).filter(n=>n.location===s&&n.site===null&&n.month===r&&n.year===a).reduce((n,g)=>n+g.value,0);return e.jsxs(e.Fragment,{children:[e.jsxs(M,{className:"bg-muted/30",children:[e.jsxs(p,{className:"font-medium",children:[e.jsx(w,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>F(s),children:d.has(s)?e.jsx(oe,{className:"h-4 w-4"}):e.jsx(_,{className:"h-4 w-4"})}),s]}),e.jsx(p,{children:t.size===0?e.jsx(J,{value:i(s,null)||1e3,onSave:n=>x.mutate({year:a,month:r,location:s,site:null,target:n})}):e.jsxs("span",{className:"text-muted-foreground font-semibold px-2",children:[i(s,null).toLocaleString()," (Sum)"]})}),e.jsx(p,{children:e.jsxs("span",{className:"font-mono",children:["£",k.toLocaleString()]})}),e.jsx(p,{children:e.jsx(H,{location:s,site:null,year:a,month:r,metrics:u||[],onSave:(n,g)=>S.mutate({year:a,month:r,location:s,site:null,name:n,value:g})})})]},s),d.has(s)&&Array.from(t).map(n=>{const g=(u||[]).filter(o=>o.location===s&&o.site===n&&o.month===r&&o.year===a).reduce((o,N)=>o+N.value,0);return e.jsxs(M,{children:[e.jsx(p,{className:"pl-10 text-sm text-muted-foreground",children:n}),e.jsx(p,{children:e.jsx(J,{value:i(s,n),onSave:o=>x.mutate({year:a,month:r,location:s,site:n,target:o})})}),e.jsx(p,{children:e.jsxs("span",{className:"font-mono",children:["£",g.toLocaleString()]})}),e.jsx(p,{children:e.jsx(H,{location:s,site:n,year:a,month:r,metrics:u||[],onSave:(o,N)=>S.mutate({year:a,month:r,location:s,site:n,name:o,value:N})})})]},`${s}-${n}`)})]})})})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on Target value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Locations without sites have a default target of 1000."}),e.jsx("p",{children:'• Use "Edit Financials" to add multiple overheads per location/site.'})]})]})},H=({location:a,site:f,year:r,month:j,metrics:d,onSave:v})=>{const[h,m]=c.useState(!1),[l,u]=c.useState(""),[x,S]=c.useState(""),y=d.filter(i=>i.year===r&&i.month===j&&i.location===a&&i.site===f),F=()=>{!l||!x||(v(l,parseFloat(x)),u(""),S(""))};return e.jsxs(se,{open:h,onOpenChange:m,children:[e.jsx(ae,{asChild:!0,children:e.jsx(w,{variant:"outline",size:"sm",children:"Edit Financials"})}),e.jsxs(te,{className:"sm:max-w-[500px]",children:[e.jsxs(ne,{children:[e.jsx(re,{children:"Manage Financials"}),e.jsxs(ie,{children:[a," ",f?` - ${f}`:""," (",j," ",r,")"]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"border rounded-md p-2 max-h-[200px] overflow-y-auto space-y-2",children:[y.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No metrics added yet."}),y.map(i=>e.jsxs("div",{className:"flex items-center justify-between bg-secondary/20 p-2 rounded",children:[e.jsx("span",{className:"text-sm font-medium",children:i.name}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-sm",children:["£",i.value.toLocaleString()]})})]},i.id))]}),e.jsxs("div",{className:"flex items-end gap-2 border-t pt-4",children:[e.jsxs("div",{className:"grid gap-1.5 flex-1",children:[e.jsx(T,{htmlFor:"name",children:"Name"}),e.jsx(D,{id:"name",placeholder:"e.g. Rent",value:l,onChange:i=>u(i.target.value)})]}),e.jsxs("div",{className:"grid gap-1.5 w-[100px]",children:[e.jsx(T,{htmlFor:"val",children:"Value (£)"}),e.jsx(D,{id:"val",type:"number",placeholder:"0",value:x,onChange:i=>S(i.target.value)})]}),e.jsx(w,{onClick:F,disabled:!l||!x,children:"Add"})]})]})]})]})},J=({value:a,onSave:f,prefix:r=""})=>{const[j,d]=c.useState(!1),[v,h]=c.useState(a);c.useEffect(()=>{j||h(a)},[a,j]);const m=()=>{h(a),d(!0)},l=()=>{v!==a&&f(v),d(!1)},u=()=>{d(!1),h(a)};return j?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{type:"number",value:v,onChange:x=>h(Number(x.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:l,children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:u,children:e.jsx(K,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:m,children:a?`${r}${a.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{Ne as default};
