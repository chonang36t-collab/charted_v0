import{ab as L,r as f,j as e,e as O,B as k,ac as Z,I as G}from"./index-COiR3tvD.js";import{D as ee,T as te}from"./DashboardLayout-Bf4cHqr7.js";import{T as J}from"./trash-2-CnHTyUl2.js";import{e as re,C as se,b as ae}from"./calendar-B9TV1w5U.js";import{f as N,s as le,P as oe,a as ne,b as ie}from"./popover-DCCS4NMb.js";import{D as F,a as Y,b as H,c as I,d as B,e as z}from"./dialog-yuJIxXRT.js";import{P as K}from"./plus-BX57HoJt.js";import"./users-05VuBXH0.js";function ue(t,l){const s=L(t.start),a=L(t.end);let u=+s>+a;const d=u?+s:+a,n=u?a:s;n.setHours(0,0,0,0),n.setDate(1);let c=1;const p=[];for(;+n<=d;)p.push(L(n)),n.setMonth(n.getMonth()+c);return u?p.reverse():p}function de(t){const l=L(t),s=l.getFullYear();return l.setFullYear(s+1,0,0),l.setHours(23,59,59,999),l}function Q(t,l){return t===null||t===0?"":l.isPercentage?`${t.toFixed(2)}%`:l.isCurrency?`Â£${t.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}`:t.toLocaleString("en-GB",{maximumFractionDigits:2})}function ce({rowId:t,colId:l,value:s,row:a,isActive:u,onFocus:d,onUpdate:n,onNavigate:c}){const[p,g]=f.useState(!1),[C,j]=f.useState(""),_=f.useRef(null),A=f.useCallback(()=>{g(!0),j(s!==null?String(s):""),setTimeout(()=>{var i;return(i=_.current)==null?void 0:i.focus()},0)},[s]),D=f.useCallback(()=>{g(!1);const i=parseFloat(C);n(C===""?null:isNaN(i)?s:i)},[C,n,s]),w=i=>{p?i.key==="Enter"||i.key==="Tab"?(i.preventDefault(),D(),c(i.shiftKey?"up":"down")):i.key==="Escape"&&g(!1):i.key==="Enter"||i.key==="F2"?(i.preventDefault(),A()):i.key==="ArrowUp"?(i.preventDefault(),c("up")):i.key==="ArrowDown"?(i.preventDefault(),c("down")):i.key==="ArrowLeft"?(i.preventDefault(),c("left")):i.key==="ArrowRight"?(i.preventDefault(),c("right")):i.key==="Delete"||i.key==="Backspace"?(i.preventDefault(),n(null)):/^[0-9.\-]$/.test(i.key)&&(i.preventDefault(),j(i.key),g(!0),setTimeout(()=>{var r;return(r=_.current)==null?void 0:r.focus()},0))};return e.jsx("td",{className:O("border border-border px-2 py-1 text-right text-sm min-w-[110px] cursor-cell transition-colors",u&&"ring-2 ring-primary ring-inset bg-primary/5",!u&&"hover:bg-muted/50"),onClick:d,onDoubleClick:A,onKeyDown:w,tabIndex:0,onFocus:d,children:p?e.jsx("input",{ref:_,type:"text",value:C,onChange:i=>j(i.target.value),onBlur:D,className:"w-full bg-transparent text-right outline-none text-sm font-mono"}):e.jsx("span",{className:"font-mono text-sm",children:Q(s,a)})})}function me({value:t,row:l}){return e.jsx("td",{className:O("border border-border px-2 py-1 text-right text-sm min-w-[110px]",l.isHeader?"bg-primary/10 font-semibold":"bg-muted/30"),children:e.jsx("span",{className:"font-mono text-sm",children:Q(t,l)})})}function fe({rows:t,columns:l,data:s,activeCell:a,setActiveCell:u,updateCell:d,deleteRow:n,deleteColumn:c,navigateCell:p,onRenameColumn:g}){const[C,j]=f.useState(null),[_,A]=f.useState(""),D=f.useRef(null),w=r=>{j(r.id),A(r.label),setTimeout(()=>{var o;return(o=D.current)==null?void 0:o.focus()},0)},i=()=>{C&&g&&g(C,_),j(null)};return e.jsx("div",{className:"overflow-x-auto border border-border rounded-lg bg-card max-w-full",children:e.jsxs("table",{className:"border-collapse w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 z-20 bg-card border border-border px-2 py-2 text-left font-semibold text-muted-foreground uppercase tracking-wider w-[200px] min-w-[200px]",children:"Description"}),l.map(r=>e.jsx("th",{className:O("sticky top-0 z-10 border border-border px-1 py-1 text-center font-semibold uppercase tracking-wider min-w-[80px]",r.isYearEnd?"bg-primary/10 text-primary":"bg-muted/50 text-muted-foreground"),onDoubleClick:()=>!r.isProtected&&w(r),children:e.jsx("div",{className:"flex items-center justify-center gap-1 h-8 group relative px-2",children:C===r.id?e.jsx("input",{ref:D,value:_,onChange:o=>A(o.target.value),onBlur:i,onKeyDown:o=>o.key==="Enter"&&i(),className:"w-full bg-background border rounded px-1 text-center"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"truncate",children:r.label}),!r.isProtected&&e.jsx(k,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 absolute -right-1 hover:text-destructive hover:bg-destructive/10",onClick:o=>{o.stopPropagation(),c(r.id)},children:e.jsx(J,{className:"h-3 w-3"})})]})})},r.id)),e.jsx("th",{className:"sticky top-0 z-10 bg-card border border-border w-8"})]})}),e.jsx("tbody",{children:t.map(r=>e.jsxs("tr",{className:O("group hover:bg-muted/20",r.isHeader&&"bg-primary/5"),children:[e.jsx("td",{className:O("sticky left-0 z-10 border border-border px-2 py-1 whitespace-nowrap bg-card text-xs truncate max-w-[200px]",r.isHeader&&"font-bold text-primary bg-primary/5",r.isAutoCalculated&&!r.isHeader&&"text-muted-foreground italic"),title:r.label,children:r.label}),l.map(o=>{var h;const m=(h=s[r.id])==null?void 0:h[o.id];return(m==null?void 0:m.isEditable)&&!r.isAutoCalculated&&!o.isYearEnd?e.jsx(ce,{rowId:r.id,colId:o.id,value:(m==null?void 0:m.value)??null,row:r,isActive:(a==null?void 0:a.row)===r.id&&(a==null?void 0:a.col)===o.id,onFocus:()=>u({row:r.id,col:o.id}),onUpdate:y=>d(r.id,o.id,y),onNavigate:p},o.id):e.jsx(me,{value:(m==null?void 0:m.value)??null,row:r},o.id)}),e.jsx("td",{className:"border border-border bg-card w-8 text-center p-0",children:!r.isAutoCalculated&&e.jsx(k,{variant:"ghost",size:"icon",className:"h-5 w-5 opacity-0 group-hover:opacity-100 hover:text-destructive",onClick:()=>n(r.id),children:e.jsx(J,{className:"h-3 w-3"})})})]},r.id))})]})})}const M=t=>{if(!(t!=null&&t.from)||!(t!=null&&t.to))return new Date().getFullYear(),[{id:"jan",label:"January",isProtected:!0},{id:"feb",label:"February",isProtected:!0},{id:"mar",label:"March",isProtected:!0},{id:"apr",label:"April",isProtected:!0},{id:"may",label:"May",isProtected:!0},{id:"jun",label:"June",isProtected:!0},{id:"jul",label:"July",isProtected:!0},{id:"aug",label:"August",isProtected:!0},{id:"sep",label:"September",isProtected:!0},{id:"oct",label:"October",isProtected:!0},{id:"nov",label:"November",isProtected:!0},{id:"dec",label:"December",isProtected:!0},{id:"year_end",label:"Year End",isProtected:!0,isYearEnd:!0}];const s=ue({start:Z(t.from),end:re(t.to)}).map(a=>({id:N(a,"MMM").toLowerCase(),label:N(a,"MMM yyyy"),isProtected:!0}));return s.push({id:"year_end",label:"Period Total",isProtected:!0,isYearEnd:!0}),s},T=(t,l,s)=>l.reduce((a,u)=>{var n,c;const d=((c=(n=t[u])==null?void 0:n[s])==null?void 0:c.value)??0;return a+d},0),W=["cost_sales_se","cost_sales_paye","employee_ni","employee_pension"],U=["apprenticeship_levy","annual_leave","other_expenses","recruitment_cost","overheads_mgmt","bank_interest","cooperation_tax"],$=[{id:"total_sales",label:"Total Sales",isAutoCalculated:!1,isCurrency:!0},{id:"sales_split_pct",label:"% Sales Split for the Year",isAutoCalculated:!1,isPercentage:!0},{id:"cost_sales_se",label:"Cost of Sales SE",isAutoCalculated:!1,isCurrency:!0},{id:"cost_sales_paye",label:"Cost of Sales PAYE Gross",isAutoCalculated:!1,isCurrency:!0},{id:"employee_ni",label:"Employee NI",isAutoCalculated:!1,isCurrency:!0},{id:"employee_pension",label:"Employee Pension",isAutoCalculated:!1,isCurrency:!0},{id:"total_cost_sales",label:"Total Cost of Sales",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(t,l,s)=>T(t,W,s)},{id:"apprenticeship_levy",label:"Apprenticeship Levy",isAutoCalculated:!1,isCurrency:!0},{id:"annual_leave",label:"Annual Leave Accrual",isAutoCalculated:!1,isCurrency:!0},{id:"other_expenses",label:"Other Expenses",isAutoCalculated:!1,isCurrency:!0},{id:"recruitment_cost",label:"Recruitment and Pass Cost",isAutoCalculated:!1,isCurrency:!0},{id:"overheads_mgmt",label:"Overheads (Total Mgmt & Office Cost)",isAutoCalculated:!1,isCurrency:!0},{id:"bank_interest",label:"Bank Interest",isAutoCalculated:!1,isCurrency:!0},{id:"cooperation_tax",label:"Cooperation Tax",isAutoCalculated:!1,isCurrency:!0},{id:"total_overheads",label:"Total Overheads",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(t,l,s)=>T(t,U,s)},{id:"total_cost",label:"Total Cost",isAutoCalculated:!0,isCurrency:!0,isHeader:!0,formula:(t,l,s)=>{const a=T(t,W,s),u=T(t,U,s);return a+u}},{id:"avg_hourly_charge",label:"Average Hourly Charge Rate",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_pay",label:"Gross Hourly Pay",isAutoCalculated:!1,isCurrency:!0},{id:"gross_hourly_margin",label:"Gross Hourly Margin",isAutoCalculated:!0,isCurrency:!0,formula:(t,l,s)=>{var d,n,c,p;const a=((n=(d=t.avg_hourly_charge)==null?void 0:d[s])==null?void 0:n.value)??0,u=((p=(c=t.gross_hourly_pay)==null?void 0:c[s])==null?void 0:p.value)??0;return a-u}},{id:"net_cost_per_hour",label:"Net Cost per Hour",isAutoCalculated:!1,isCurrency:!0},{id:"gross_pl_value",label:"Gross P&L Value",isAutoCalculated:!1,isCurrency:!0},{id:"net_pl",label:"Net P&L",isAutoCalculated:!1,isCurrency:!0},{id:"total_net_margin",label:"Total Net Margin",isAutoCalculated:!1,isPercentage:!0},{id:"worked_hours",label:"Worked Hours",isAutoCalculated:!1},{id:"hours_breakeven",label:"Hours for Breakeven",isAutoCalculated:!0,formula:(t,l,s)=>{var d,n,c,p;const a=((n=(d=t.total_cost)==null?void 0:d[s])==null?void 0:n.value)??0,u=((p=(c=t.gross_hourly_margin)==null?void 0:c[s])==null?void 0:p.value)??0;return u!==0?a/u:0}},{id:"value_breakeven",label:"Total Value for Breakeven",isAutoCalculated:!0,isCurrency:!0,formula:(t,l,s)=>{var d,n,c,p;const a=((n=(d=t.hours_breakeven)==null?void 0:d[s])==null?void 0:n.value)??0,u=((p=(c=t.avg_hourly_charge)==null?void 0:c[s])==null?void 0:p.value)??0;return a*u}},{id:"sales_budget_2026",label:"Projeted Sales Budget 30% Uplift",isAutoCalculated:!0,isCurrency:!0,formula:(t,l,s)=>{var u,d;return(((d=(u=t.total_sales)==null?void 0:u[s])==null?void 0:d.value)??0)*1.3}},{id:"avg_hourly_charge_2026",label:"Average Hourly Charge Rate Future",isAutoCalculated:!1,isCurrency:!0},{id:"sales_target_hours",label:"Sales Target in Hours",isAutoCalculated:!1},{id:"variance_2025",label:"Variance",isAutoCalculated:!1,isCurrency:!0}];function q(t,l){const s={};for(const a of t){s[a.id]={};for(const u of l)s[a.id][u.id]={value:null,isEditable:!a.isAutoCalculated&&!u.isYearEnd}}return s}function P(t,l,s){const a=JSON.parse(JSON.stringify(t));for(const d of s.filter(n=>!n.isYearEnd))for(const n of l)n.formula&&(a[n.id][d.id]={...a[n.id][d.id],value:n.formula(a,n.id,d.id),isEditable:!1});const u=s.find(d=>d.isYearEnd);if(u)for(const d of l){const n=s.filter(c=>!c.isYearEnd).reduce((c,p)=>{var g,C;return c+(((C=(g=a[d.id])==null?void 0:g[p.id])==null?void 0:C.value)??0)},0);a[d.id][u.id]={value:n,isEditable:!1}}return a}function he(t){const[l,s]=f.useState($),[a,u]=f.useState(()=>M(t)),[d,n]=f.useState(()=>P(q($,M(t)),$,M(t))),[c,p]=f.useState(null);f.useEffect(()=>{const r=M(t);u(r),n(P(q(l,r),l,r))},[t,l]);const g=f.useCallback((r,o,m)=>{n(b=>{const h={...b};return h[r]={...h[r]},h[r][o]={...h[r][o],value:m},P(h,l,a)})},[l,a]),C=f.useCallback(r=>{const o=`custom_${Date.now()}`,m={id:o,label:r,isAutoCalculated:!1,isCurrency:!0};s(b=>{const h=[...b,m];return n(y=>{const v={...y};v[o]={};for(const x of a)v[o][x.id]={value:null,isEditable:!x.isYearEnd};return P(v,h,a)}),h})},[a]),j=f.useCallback(r=>{s(o=>o.filter(m=>m.id!==r)),n(o=>{const m={...o};return delete m[r],m})},[]),_=f.useCallback(r=>{const o=`col_${Date.now()}`,m={id:o,label:r};u(b=>{const h=b.findIndex(v=>v.isYearEnd),y=[...b];return y.splice(h,0,m),n(v=>{const x={...v};for(const E of l)x[E.id]={...x[E.id]},x[E.id][o]={value:null,isEditable:!E.isAutoCalculated};return P(x,l,y)}),y})},[l]),A=f.useCallback(r=>{u(o=>{const m=o.filter(b=>b.id!==r);return n(b=>{const h={...b};for(const y of Object.keys(h)){const{[r]:v,...x}=h[y];h[y]=x}return P(h,l,m)}),m})},[l]),D=f.useCallback((r,o)=>{u(m=>m.map(b=>b.id===r?{...b,label:o}:b))},[]),w=f.useCallback(r=>{if(!c)return;const o=l.filter(x=>!x.isAutoCalculated),m=a.filter(x=>!x.isYearEnd),b=o.findIndex(x=>x.id===c.row),h=m.findIndex(x=>x.id===c.col);if(b===-1||h===-1)return;let y=b,v=h;switch(r){case"up":y=Math.max(0,b-1);break;case"down":y=Math.min(o.length-1,b+1);break;case"left":v=Math.max(0,h-1);break;case"right":v=Math.min(m.length-1,h+1);break}p({row:o[y].id,col:m[v].id})},[c,l,a]),i=f.useCallback(async r=>{if(r)try{const o={year:new Date().getFullYear(),data:d,rows:l,columns:a},m=localStorage.getItem("auth_token");if(!(await fetch("undefined/api/financial-summary/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify(o)})).ok)throw new Error("Failed to save")}catch(o){throw console.error("Save failed",o),o}},[d,l,a]);return{rows:l,columns:a,data:d,activeCell:c,setActiveCell:p,updateCell:g,addRow:C,deleteRow:j,addColumn:_,deleteColumn:A,renameColumn:D,navigateCell:w,saveData:i}}function _e(){const[t,l]=f.useState({from:le(new Date),to:de(new Date)}),{rows:s,columns:a,data:u,activeCell:d,setActiveCell:n,updateCell:c,addRow:p,deleteRow:g,addColumn:C,deleteColumn:j,navigateCell:_,renameColumn:A,saveData:D}=he(t),[w,i]=f.useState(""),[r,o]=f.useState(""),[m,b]=f.useState(!1),[h,y]=f.useState(!1),[v,x]=f.useState(!1),E=()=>{w.trim()&&(p(w.trim()),i(""),b(!1))},R=()=>{r.trim()&&(C(r.trim()),o(""),y(!1))},V=async S=>{await D(S),x(!1)},X=t!=null&&t.from&&(t!=null&&t.to)?`Financial Summary for ${N(t.from,"MMM yyyy")} - ${N(t.to,"MMM yyyy")}`:"Financial Summary";return e.jsx(ee,{noPadding:!0,fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-border bg-card/50 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(te,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-foreground",children:X}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Annual budget and performance spreadsheet"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(oe,{children:[e.jsx(ne,{asChild:!0,children:e.jsxs(k,{variant:"outline",className:O("w-[240px] justify-start text-left font-normal",!t&&"text-muted-foreground"),children:[e.jsx(se,{className:"mr-2 h-4 w-4"}),t!=null&&t.from?t.to?e.jsxs(e.Fragment,{children:[N(t.from,"LLL dd, y")," -"," ",N(t.to,"LLL dd, y")]}):N(t.from,"LLL dd, y"):e.jsx("span",{children:"Pick a date"})]})}),e.jsx(ie,{className:"w-auto p-0",align:"end",children:e.jsx(ae,{initialFocus:!0,mode:"range",defaultMonth:t==null?void 0:t.from,selected:t,onSelect:l,numberOfMonths:2,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsxs(F,{open:m,onOpenChange:b,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(k,{variant:"outline",size:"sm",children:[e.jsx(K,{className:"h-4 w-4 mr-1"})," Add Row"]})}),e.jsxs(H,{children:[e.jsx(I,{children:e.jsx(B,{children:"Add New Row"})}),e.jsx(G,{placeholder:"Row label...",value:w,onChange:S=>i(S.target.value),onKeyDown:S=>S.key==="Enter"&&E()}),e.jsx(z,{children:e.jsx(k,{onClick:E,disabled:!w.trim(),children:"Add"})})]})]}),e.jsxs(F,{open:h,onOpenChange:y,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(k,{variant:"outline",size:"sm",children:[e.jsx(K,{className:"h-4 w-4 mr-1"})," Add Column"]})}),e.jsxs(H,{children:[e.jsx(I,{children:e.jsx(B,{children:"Add New Column"})}),e.jsx(G,{placeholder:"Column label...",value:r,onChange:S=>o(S.target.value),onKeyDown:S=>S.key==="Enter"&&R()}),e.jsx(z,{children:e.jsx(k,{onClick:R,disabled:!r.trim(),children:"Add"})})]})]}),e.jsxs(F,{open:v,onOpenChange:x,children:[e.jsx(Y,{asChild:!0,children:e.jsx(k,{variant:"default",size:"sm",children:"Save Changes"})}),e.jsxs(H,{children:[e.jsx(I,{children:e.jsx(B,{children:"Save Financial Summary?"})}),e.jsx("div",{className:"py-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Do you want to save these changes permanently to the database, or just for this browsing session?"})}),e.jsxs(z,{className:"gap-2 sm:gap-0",children:[e.jsx(k,{variant:"outline",onClick:()=>V(!1),children:"Session Only"}),e.jsx(k,{variant:"default",onClick:()=>V(!0),children:"Save Permanently"})]})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-4",children:e.jsx(fe,{rows:s,columns:a,data:u,activeCell:d,setActiveCell:n,updateCell:c,deleteRow:g,deleteColumn:j,navigateCell:_,onRenameColumn:A})})]})})}export{_e as default};
