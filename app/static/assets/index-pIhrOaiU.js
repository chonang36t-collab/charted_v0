import{r as c,a9 as Q,j as e,B as y,D as g,I as R,X as _}from"./index-Cja0AOya.js";import{D as Y,b as W}from"./DashboardLayout-BdEfiQCb.js";import{C as X,a as G,b as U,d as Z}from"./card-gGKcTzyT.js";import{L as O}from"./label-Dd8Kt-ec.js";import{S as I,a as z,b as q,c as B,d as D}from"./select-Co1F8VT7.js";import{T as ee,a as se,b as E,c as w,d as te,e as d}from"./table-Cp4ow3od.js";import{u as V}from"./useQuery-D9f9NKkL.js";import{u as ae,e as J,P as ne}from"./useRecords-y2OkZ3Xd.js";import{a as re,C as ie}from"./index-CtsPHLjf.js";import"./users-BEH6dxvZ.js";const P=["January","February","March","April","May","June","July","August","September","October","November","December"],pe=()=>{const[a,N]=c.useState(new Date().getFullYear()),[i,f]=c.useState(P[new Date().getMonth()]),[m,j]=c.useState(new Set),[h,b]=c.useState([]),S=Q(),{data:u}=ae(),{data:l}=V({queryKey:["admin-targets",a],queryFn:async()=>{const s=await fetch(`/api/admin/targets?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch targets");return s.json()}}),{data:x}=V({queryKey:["admin-financials",a],queryFn:async()=>{const s=await fetch(`/api/admin/financial-metrics?year=${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(!s.ok)throw new Error("Failed to fetch metrics");return s.json()}}),H=J({mutationFn:async s=>{const t=await fetch("/api/admin/targets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save target");return t.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["admin-targets"]}),g.success("Target saved")},onError:s=>g.error(s.message)}),A=J({mutationFn:async s=>{const t=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to save metric");return t.json()},onSuccess:()=>{S.invalidateQueries({queryKey:["admin-financials"]}),g.success("Metric saved")},onError:s=>g.error(s.message)}),v=c.useMemo(()=>{const s=new Set;return s.add("Overheads"),x==null||x.forEach(t=>s.add(t.name)),h.forEach(t=>s.add(t)),Array.from(s)},[x,h]),C=c.useMemo(()=>{if(!(u!=null&&u.jobs))return{};const s={};return u.jobs.forEach(t=>{t.location&&(s[t.location]||(s[t.location]=new Set),t.site&&s[t.location].add(t.site))}),s},[u]),K=s=>{const t=new Set(m);t.has(s)?t.delete(s):t.add(s),j(t)},L=(s,t)=>{var o;if(t)return((o=l==null?void 0:l.find(p=>p.month===i&&p.location===s&&p.site===t))==null?void 0:o.target)||0;const n=C[s]?Array.from(C[s]):[];let r=0;return n.forEach(p=>{var $;const T=($=l==null?void 0:l.find(k=>k.month===i&&k.location===s&&k.site===p))==null?void 0:$.target;r+=T??1e3}),r},M=(s,t,n)=>{var r;return((r=x==null?void 0:x.find(o=>o.month===i&&o.name===n&&o.location===s&&o.site===t))==null?void 0:r.value)||0};return e.jsxs(Y,{fullWidth:!0,children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Admin Metrics & Targets"})}),e.jsxs(X,{className:"mb-6",children:[e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{children:"Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{children:"Year:"}),e.jsxs(I,{value:a.toString(),onValueChange:s=>N(Number(s)),children:[e.jsx(z,{className:"w-[100px]",children:e.jsx(q,{})}),e.jsx(B,{children:[2024,2025,2026,2027,2028].map(s=>e.jsx(D,{value:s.toString(),children:s},s))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{children:"Month:"}),e.jsxs(I,{value:i,onValueChange:f,children:[e.jsx(z,{className:"w-[120px]",children:e.jsx(q,{})}),e.jsx(B,{children:P.map(s=>e.jsx(D,{value:s,children:s},s))})]})]})]})]})}),e.jsx(Z,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(E,{children:[e.jsx(w,{className:"w-[300px]",children:"Location / Site"}),e.jsx(w,{className:"w-[150px]",children:"Shift Target"}),v.map(s=>e.jsx(w,{className:"w-[150px] group",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("span",{children:s})})},s)),e.jsx(w,{className:"w-[50px]",children:e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>{const s=prompt("Enter new metric name (e.g. Marketing):");s&&!v.includes(s)&&(b(t=>[...t,s]),g.success(`Added column: ${s}`))},children:e.jsx(ne,{className:"h-4 w-4"})})})]})}),e.jsx(te,{children:Object.entries(C).map(([s,t])=>e.jsxs(e.Fragment,{children:[e.jsxs(E,{className:"bg-muted/30",children:[e.jsxs(d,{className:"font-medium",children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 mr-2",onClick:()=>K(s),children:m.has(s)?e.jsx(re,{className:"h-4 w-4"}):e.jsx(W,{className:"h-4 w-4"})}),s]}),e.jsx(d,{children:e.jsxs("span",{className:"text-muted-foreground font-semibold px-2",children:[L(s,null).toLocaleString()," (Sum)"]})}),v.map(n=>e.jsx(d,{children:e.jsx(F,{value:M(s,null,n),prefix:"£",onSave:r=>A.mutate({year:a,month:i,location:s,site:null,name:n,value:r})})},n)),e.jsx(d,{})]},s),m.has(s)&&Array.from(t).map(n=>e.jsxs(E,{children:[e.jsx(d,{className:"pl-10 text-sm text-muted-foreground",children:n}),e.jsx(d,{children:e.jsx(F,{value:L(s,n),onSave:r=>H.mutate({year:a,month:i,location:s,site:n,target:r})})}),v.map(r=>e.jsx(d,{children:e.jsx(F,{value:M(s,n,r),prefix:"£",onSave:o=>A.mutate({year:a,month:i,location:s,site:n,name:r,value:o})})},r)),e.jsx(d,{})]},`${s}-${n}`))]}))})]})})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-4",children:[e.jsx("p",{children:"• Click on any value to edit. Press Check (✔️) to save."}),e.jsx("p",{children:"• Location targets are distributed to sites if site targets are not set (default 1000)."}),e.jsx("p",{children:"• Overheads/Financials can be set per Location or per Site."})]})]})},F=({value:a,onSave:N,prefix:i=""})=>{const[f,m]=c.useState(!1),[j,h]=c.useState(a);c.useEffect(()=>{f||h(a)},[a,f]);const b=()=>{h(a),m(!0)},S=()=>{j!==a&&N(j),m(!1)},u=()=>{m(!1),h(a)};return f?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{type:"number",value:j,onChange:l=>h(Number(l.target.value)),className:"h-7 w-20 px-1",autoFocus:!0}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-green-600 hover:text-green-700",onClick:S,children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsx(y,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-500 hover:text-red-600",onClick:u,children:e.jsx(_,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"cursor-pointer hover:bg-muted/50 p-1 rounded min-h-[24px] flex items-center",onClick:b,children:a?`${i}${a.toLocaleString()}`:e.jsx("span",{className:"text-muted-foreground text-xs italic",children:"-"})})};export{pe as default};
