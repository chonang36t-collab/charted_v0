import{c as St,ab as Ns,R as O,ac as ws,r as m,h as Ss,U as Cs,p as As,j as e,v as Ts,P as _e,q as De,w as ks,e as We,B as ae,I as se,A as ce,L as $s,y as te,ad as _s,u as Es,d as Ms,b as Os,a3 as Ls,a4 as Is,a5 as Ds,a6 as Ps,a7 as Rs,a8 as Fs,a9 as Bs,aa as Ks}from"./index-CbhCuN3x.js";import{D as Us}from"./DashboardLayout-DvChX_N_.js";import{C as F,d as B,a as X,b as Z}from"./card-DtGcmnaw.js";import{c as Ct,R as Hs,I as Ws}from"./index-BJBRBrkA.js";import{D as zs}from"./DashboardHeader-D2efxKg_.js";import{S as ze,Z as Vs,C as Ve,u as Gs,O as qs,T as Ys}from"./TargetPerformanceChart-Cc-Oq8KQ.js";import{u as Qs,L as Js,R as Xs}from"./LoadingOverlay-klDlaMwd.js";import{_ as At,e as Zs,k as Tt,i as Ge,a as kt,b as ea,c as ta,d as sa,f as $t,g as aa,h as _t,s as ra,j as na,l as ia,m as oa,n as qe,o as Et,p as Mt,q as Ot,r as la,t as ca,u as da,v as ha,w as ua,x as ma,y as Lt,z as fa,D as xa,E as ga,F as pa,G as va,H as ja,I as ya,J as we,K as ba,M as Na,N as Pe,O as Re,P as at,Q as rt,S as nt,U as wa,V as Sa,W as Ca,Z as Aa,$ as Ta,a0 as it,a1 as It,T as W,a2 as ka,X as ie,Y as re,a3 as $a,R as ne,C as he,B as Q,a4 as Ye,L as Dt,a5 as ot,a6 as lt}from"./generateCategoricalChart-BC9b7UUs.js";import{B as Pt,L as _a}from"./BarChart-BZE-3T7r.js";import{P as Ea,a as Ma,b as Oa}from"./PieChart-C7Xd7GNp.js";import{T as Rt,a as Ft,b as Ae,c as z,d as Bt,e as V}from"./table-CCz3l2WP.js";import{P as La}from"./pen-B11sHO0X.js";import{T as Ia}from"./trash-2-QzNRaiLE.js";import{L}from"./label-0RpZMrcQ.js";import{f as $,P as Da,a as Pa,b as Ra}from"./popover-ByODH2su.js";import{D as Fa,b as Ba,c as Ka,d as Ua,f as Ha,e as Wa}from"./dialog-XDHMjNqW.js";import{S as me,a as fe,b as xe,c as ge,d as le}from"./select-ZaR9RwWG.js";import{u as za}from"./useRecords-BTKhjtdu.js";import{P as Va}from"./plus-CJZ0_k1n.js";import"./users-C2MrfjhG.js";import"./locationUtils-Bg1RftWu.js";import"./checkbox-BWvqe72T.js";import"./index-CdYr8frA.js";import"./AreaChart-DU26-Wt6.js";import"./useQuery-CGdg7SVi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=St("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qa=St("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);function Ya(t,a){for(var s=-1,r=t==null?0:t.length;++s<r&&a(t[s],s,t)!==!1;);return t}var Qa=Ya,Ja=At,Xa=Zs,Za=Object.prototype,er=Za.hasOwnProperty;function tr(t,a,s){var r=t[a];(!(er.call(t,a)&&Xa(r,s))||s===void 0&&!(a in t))&&Ja(t,a,s)}var Kt=tr,sr=Kt,ar=At;function rr(t,a,s,r){var n=!s;s||(s={});for(var i=-1,l=a.length;++i<l;){var o=a[i],h=r?r(s[o],t[o],o,s,t):void 0;h===void 0&&(h=t[o]),n?ar(s,o,h):sr(s,o,h)}return s}var je=rr,nr=je,ir=Tt;function or(t,a){return t&&nr(a,ir(a),t)}var lr=or;function cr(t){var a=[];if(t!=null)for(var s in Object(t))a.push(s);return a}var dr=cr,hr=Ge,ur=kt,mr=dr,fr=Object.prototype,xr=fr.hasOwnProperty;function gr(t){if(!hr(t))return mr(t);var a=ur(t),s=[];for(var r in t)r=="constructor"&&(a||!xr.call(t,r))||s.push(r);return s}var pr=gr,vr=ea,jr=pr,yr=ta;function br(t){return yr(t)?vr(t,!0):jr(t)}var Qe=br,Nr=je,wr=Qe;function Sr(t,a){return t&&Nr(a,wr(a),t)}var Cr=Sr,Te={exports:{}};Te.exports;(function(t,a){var s=sa,r=a&&!a.nodeType&&a,n=r&&!0&&t&&!t.nodeType&&t,i=n&&n.exports===r,l=i?s.Buffer:void 0,o=l?l.allocUnsafe:void 0;function h(c,u){if(u)return c.slice();var d=c.length,x=o?o(d):new c.constructor(d);return c.copy(x),x}t.exports=h})(Te,Te.exports);var Ar=Te.exports;function Tr(t,a){var s=-1,r=t.length;for(a||(a=Array(r));++s<r;)a[s]=t[s];return a}var kr=Tr,$r=je,_r=$t;function Er(t,a){return $r(t,_r(t),a)}var Mr=Er,Or=aa,Lr=_t,Ir=$t,Dr=ra,Pr=Object.getOwnPropertySymbols,Rr=Pr?function(t){for(var a=[];t;)Or(a,Ir(t)),t=Lr(t);return a}:Dr,Ut=Rr,Fr=je,Br=Ut;function Kr(t,a){return Fr(t,Br(t),a)}var Ur=Kr,Hr=na,Wr=Ut,zr=Qe;function Vr(t){return Hr(t,zr,Wr)}var Ht=Vr,Gr=Object.prototype,qr=Gr.hasOwnProperty;function Yr(t){var a=t.length,s=new t.constructor(a);return a&&typeof t[0]=="string"&&qr.call(t,"index")&&(s.index=t.index,s.input=t.input),s}var Qr=Yr,ct=ia;function Jr(t){var a=new t.constructor(t.byteLength);return new ct(a).set(new ct(t)),a}var Je=Jr,Xr=Je;function Zr(t,a){var s=a?Xr(t.buffer):t.buffer;return new t.constructor(s,t.byteOffset,t.byteLength)}var en=Zr,tn=/\w*$/;function sn(t){var a=new t.constructor(t.source,tn.exec(t));return a.lastIndex=t.lastIndex,a}var an=sn,dt=oa,ht=dt?dt.prototype:void 0,ut=ht?ht.valueOf:void 0;function rn(t){return ut?Object(ut.call(t)):{}}var nn=rn,on=Je;function ln(t,a){var s=a?on(t.buffer):t.buffer;return new t.constructor(s,t.byteOffset,t.length)}var cn=ln,dn=Je,hn=en,un=an,mn=nn,fn=cn,xn="[object Boolean]",gn="[object Date]",pn="[object Map]",vn="[object Number]",jn="[object RegExp]",yn="[object Set]",bn="[object String]",Nn="[object Symbol]",wn="[object ArrayBuffer]",Sn="[object DataView]",Cn="[object Float32Array]",An="[object Float64Array]",Tn="[object Int8Array]",kn="[object Int16Array]",$n="[object Int32Array]",_n="[object Uint8Array]",En="[object Uint8ClampedArray]",Mn="[object Uint16Array]",On="[object Uint32Array]";function Ln(t,a,s){var r=t.constructor;switch(a){case wn:return dn(t);case xn:case gn:return new r(+t);case Sn:return hn(t,s);case Cn:case An:case Tn:case kn:case $n:case _n:case En:case Mn:case On:return fn(t,s);case pn:return new r;case vn:case bn:return new r(t);case jn:return un(t);case yn:return new r;case Nn:return mn(t)}}var In=Ln,Dn=Ge,mt=Object.create,Pn=function(){function t(){}return function(a){if(!Dn(a))return{};if(mt)return mt(a);t.prototype=a;var s=new t;return t.prototype=void 0,s}}(),Rn=Pn,Fn=Rn,Bn=_t,Kn=kt;function Un(t){return typeof t.constructor=="function"&&!Kn(t)?Fn(Bn(t)):{}}var Hn=Un,Wn=qe,zn=Et,Vn="[object Map]";function Gn(t){return zn(t)&&Wn(t)==Vn}var qn=Gn,Yn=qn,Qn=Ot,ft=Mt,xt=ft&&ft.isMap,Jn=xt?Qn(xt):Yn,Xn=Jn,Zn=qe,ei=Et,ti="[object Set]";function si(t){return ei(t)&&Zn(t)==ti}var ai=si,ri=ai,ni=Ot,gt=Mt,pt=gt&&gt.isSet,ii=pt?ni(pt):ri,oi=ii,li=la,ci=Qa,di=Kt,hi=lr,ui=Cr,mi=Ar,fi=kr,xi=Mr,gi=Ur,pi=da,vi=Ht,ji=qe,yi=Qr,bi=In,Ni=Hn,wi=ha,Si=ca,Ci=Xn,Ai=Ge,Ti=oi,ki=Tt,$i=Qe,_i=1,Ei=2,Mi=4,Wt="[object Arguments]",Oi="[object Array]",Li="[object Boolean]",Ii="[object Date]",Di="[object Error]",zt="[object Function]",Pi="[object GeneratorFunction]",Ri="[object Map]",Fi="[object Number]",Vt="[object Object]",Bi="[object RegExp]",Ki="[object Set]",Ui="[object String]",Hi="[object Symbol]",Wi="[object WeakMap]",zi="[object ArrayBuffer]",Vi="[object DataView]",Gi="[object Float32Array]",qi="[object Float64Array]",Yi="[object Int8Array]",Qi="[object Int16Array]",Ji="[object Int32Array]",Xi="[object Uint8Array]",Zi="[object Uint8ClampedArray]",eo="[object Uint16Array]",to="[object Uint32Array]",C={};C[Wt]=C[Oi]=C[zi]=C[Vi]=C[Li]=C[Ii]=C[Gi]=C[qi]=C[Yi]=C[Qi]=C[Ji]=C[Ri]=C[Fi]=C[Vt]=C[Bi]=C[Ki]=C[Ui]=C[Hi]=C[Xi]=C[Zi]=C[eo]=C[to]=!0;C[Di]=C[zt]=C[Wi]=!1;function Ce(t,a,s,r,n,i){var l,o=a&_i,h=a&Ei,c=a&Mi;if(s&&(l=n?s(t,r,n,i):s(t)),l!==void 0)return l;if(!Ai(t))return t;var u=wi(t);if(u){if(l=yi(t),!o)return fi(t,l)}else{var d=ji(t),x=d==zt||d==Pi;if(Si(t))return mi(t,o);if(d==Vt||d==Wt||x&&!n){if(l=h||x?{}:Ni(t),!o)return h?gi(t,ui(l,t)):xi(t,hi(l,t))}else{if(!C[d])return n?t:{};l=bi(t,d,o)}}i||(i=new li);var p=i.get(t);if(p)return p;i.set(t,l),Ti(t)?t.forEach(function(N){l.add(Ce(N,a,s,N,t,i))}):Ci(t)&&t.forEach(function(N,b){l.set(b,Ce(N,a,s,b,t,i))});var T=c?h?vi:pi:h?$i:ki,j=u?void 0:T(t);return ci(j||t,function(N,b){j&&(b=N,N=t[b]),di(l,b,Ce(N,a,s,b,t,i))}),l}var so=Ce,ao=ua,ro=ma;function no(t,a){return a.length<2?t:ao(t,ro(a,0,-1))}var io=no,oo=Lt,lo=fa,co=io,ho=xa;function uo(t,a){return a=oo(a,t),t=co(t,a),t==null||delete t[ho(lo(a))]}var mo=uo,fo=ga;function xo(t){return fo(t)?void 0:t}var go=xo,po=pa;function vo(t){var a=t==null?0:t.length;return a?po(t,1):[]}var jo=vo,yo=jo,bo=va,No=ja;function wo(t){return No(bo(t,void 0,yo),t+"")}var So=wo,Co=ya,Ao=so,To=mo,ko=Lt,$o=je,_o=go,Eo=So,Mo=Ht,Oo=1,Lo=2,Io=4,Do=Eo(function(t,a){var s={};if(t==null)return s;var r=!1;a=Co(a,function(i){return i=ko(i,t),r||(r=i.length>1),i}),$o(t,Mo(t),s),r&&(s=Ao(s,Oo|Lo|Io,_o));for(var n=a.length;n--;)To(s,a[n]);return s}),Po=Do;const Ro=Ns(Po);var Fo=["#1890FF","#66B5FF","#41D9C7","#2FC25B","#6EDB8F","#9AE65C","#FACC14","#E6965C","#57AD71","#223273","#738AE6","#7564CC","#8543E0","#A877ED","#5C8EE6","#13C2C2","#70E0E0","#5CA3E6","#3436C7","#8082FF","#DD81E6","#F04864","#FA7D92","#D598D9"],Bo=["width","height","className","style","children","type"];function de(t){"@babel/helpers - typeof";return de=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},de(t)}function ke(){return ke=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var s=arguments[a];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},ke.apply(this,arguments)}function Ko(t,a){if(t==null)return{};var s=Uo(t,a),r,n;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],!(a.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(t,r)&&(s[r]=t[r])}return s}function Uo(t,a){if(t==null)return{};var s={};for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){if(a.indexOf(r)>=0)continue;s[r]=t[r]}return s}function Ho(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}function vt(t,a){for(var s=0;s<a.length;s++){var r=a[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,qt(r.key),r)}}function Wo(t,a,s){return a&&vt(t.prototype,a),s&&vt(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}function zo(t,a,s){return a=$e(a),Vo(t,Gt()?Reflect.construct(a,s||[],$e(t).constructor):a.apply(t,s))}function Vo(t,a){if(a&&(de(a)==="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Go(t)}function Go(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Gt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Gt=function(){return!!t})()}function $e(t){return $e=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(s){return s.__proto__||Object.getPrototypeOf(s)},$e(t)}function qo(t,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(a&&a.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),a&&He(t,a)}function He(t,a){return He=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},He(t,a)}function jt(t,a){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);a&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),s.push.apply(s,r)}return s}function A(t){for(var a=1;a<arguments.length;a++){var s=arguments[a]!=null?arguments[a]:{};a%2?jt(Object(s),!0).forEach(function(r){J(t,r,s[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):jt(Object(s)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(s,r))})}return t}function J(t,a,s){return a=qt(a),a in t?Object.defineProperty(t,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[a]=s,t}function qt(t){var a=Yo(t,"string");return de(a)=="symbol"?a:a+""}function Yo(t,a){if(de(t)!="object"||!t)return t;var s=t[Symbol.toPrimitive];if(s!==void 0){var r=s.call(t,a||"default");if(de(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(t)}var ve="value",Fe=function t(a){var s=a.depth,r=a.node,n=a.index,i=a.valueKey,l=r.children,o=s+1,h=l&&l.length?l.map(function(u,d){return t({depth:o,node:u,index:d,valueKey:i})}):null,c;return l&&l.length?c=h.reduce(function(u,d){return u+d[ve]},0):c=It(r[i])||r[i]<=0?0:r[i],A(A({},r),{},J(J(J({children:h},ve,c),"depth",s),"index",n))},Qo=function(a){return{x:a.x,y:a.y,width:a.width,height:a.height}},Jo=function(a,s){var r=s<0?0:s;return a.map(function(n){var i=n[ve]*r;return A(A({},n),{},{area:It(i)||i<=0?0:i})})},Xo=function(a,s,r){var n=s*s,i=a.area*a.area,l=a.reduce(function(c,u){return{min:Math.min(c.min,u.area),max:Math.max(c.max,u.area)}},{min:1/0,max:0}),o=l.min,h=l.max;return i?Math.max(n*h*r/i,i/(n*o*r)):1/0},Zo=function(a,s,r,n){var i=s?Math.round(a.area/s):0;(n||i>r.height)&&(i=r.height);for(var l=r.x,o,h=0,c=a.length;h<c;h++)o=a[h],o.x=l,o.y=r.y,o.height=i,o.width=Math.min(i?Math.round(o.area/i):0,r.x+r.width-l),l+=o.width;return o.width+=r.x+r.width-l,A(A({},r),{},{y:r.y+i,height:r.height-i})},el=function(a,s,r,n){var i=s?Math.round(a.area/s):0;(n||i>r.width)&&(i=r.width);for(var l=r.y,o,h=0,c=a.length;h<c;h++)o=a[h],o.x=r.x,o.y=l,o.width=i,o.height=Math.min(i?Math.round(o.area/i):0,r.y+r.height-l),l+=o.height;return o&&(o.height+=r.y+r.height-l),A(A({},r),{},{x:r.x+i,width:r.width-i})},yt=function(a,s,r,n){return s===r.width?Zo(a,s,r,n):el(a,s,r,n)},Be=function t(a,s){var r=a.children;if(r&&r.length){var n=Qo(a),i=[],l=1/0,o,h,c=Math.min(n.width,n.height),u=Jo(r,n.width*n.height/a[ve]),d=u.slice();for(i.area=0;d.length>0;)i.push(o=d[0]),i.area+=o.area,h=Xo(i,c,s),h<=l?(d.shift(),l=h):(i.area-=i.pop().area,n=yt(i,c,n,!1),c=Math.min(n.width,n.height),i.length=i.area=0,l=1/0);return i.length&&(n=yt(i,c,n,!0),i.length=i.area=0),A(A({},a),{},{children:u.map(function(x){return t(x,s)})})}return a},tl={isTooltipActive:!1,isAnimationFinished:!1,activeNode:null,formatRoot:null,currentRoot:null,nestIndex:[]},Xe=function(t){function a(){var s;Ho(this,a);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return s=zo(this,a,[].concat(n)),J(s,"state",A({},tl)),J(s,"handleAnimationEnd",function(){var l=s.props.onAnimationEnd;s.setState({isAnimationFinished:!0}),we(l)&&l()}),J(s,"handleAnimationStart",function(){var l=s.props.onAnimationStart;s.setState({isAnimationFinished:!1}),we(l)&&l()}),s}return qo(a,t),Wo(a,[{key:"handleMouseEnter",value:function(r,n){n.persist();var i=this.props,l=i.onMouseEnter,o=i.children,h=Pe(o,W);h?this.setState({isTooltipActive:!0,activeNode:r},function(){l&&l(r,n)}):l&&l(r,n)}},{key:"handleMouseLeave",value:function(r,n){n.persist();var i=this.props,l=i.onMouseLeave,o=i.children,h=Pe(o,W);h?this.setState({isTooltipActive:!1,activeNode:null},function(){l&&l(r,n)}):l&&l(r,n)}},{key:"handleClick",value:function(r){var n=this.props,i=n.onClick,l=n.type;if(l==="nest"&&r.children){var o=this.props,h=o.width,c=o.height,u=o.dataKey,d=o.aspectRatio,x=Fe({depth:0,node:A(A({},r),{},{x:0,y:0,width:h,height:c}),index:0,valueKey:u}),p=Be(x,d),T=this.state.nestIndex;T.push(r),this.setState({formatRoot:p,currentRoot:x,nestIndex:T})}i&&i(r)}},{key:"handleNestIndex",value:function(r,n){var i=this.state.nestIndex,l=this.props,o=l.width,h=l.height,c=l.dataKey,u=l.aspectRatio,d=Fe({depth:0,node:A(A({},r),{},{x:0,y:0,width:o,height:h}),index:0,valueKey:c}),x=Be(d,u);i=i.slice(0,n+1),this.setState({formatRoot:x,currentRoot:r,nestIndex:i})}},{key:"renderItem",value:function(r,n,i){var l=this,o=this.props,h=o.isAnimationActive,c=o.animationBegin,u=o.animationDuration,d=o.animationEasing,x=o.isUpdateAnimationActive,p=o.type,T=o.animationId,j=o.colorPanel,N=this.state.isAnimationFinished,b=n.width,E=n.height,M=n.x,K=n.y,ee=n.depth,U=parseInt("".concat((Math.random()*2-1)*b),10),I={};return(i||p==="nest")&&(I={onMouseEnter:this.handleMouseEnter.bind(this,n),onMouseLeave:this.handleMouseLeave.bind(this,n),onClick:this.handleClick.bind(this,n)}),h?O.createElement(at,{begin:c,duration:u,isActive:h,easing:d,key:"treemap-".concat(T),from:{x:M,y:K,width:b,height:E},to:{x:M,y:K,width:b,height:E},onAnimationStart:this.handleAnimationStart,onAnimationEnd:this.handleAnimationEnd},function(v){var f=v.x,_=v.y,D=v.width,P=v.height;return O.createElement(at,{from:"translate(".concat(U,"px, ").concat(U,"px)"),to:"translate(0, 0)",attributeName:"transform",begin:c,easing:d,isActive:h,duration:u},O.createElement(Re,I,function(){return ee>2&&!N?null:l.constructor.renderContentItem(r,A(A({},n),{},{isAnimationActive:h,isUpdateAnimationActive:!x,width:D,height:P,x:f,y:_}),p,j)}()))}):O.createElement(Re,I,this.constructor.renderContentItem(r,A(A({},n),{},{isAnimationActive:!1,isUpdateAnimationActive:!1,width:b,height:E,x:M,y:K}),p,j))}},{key:"renderNode",value:function(r,n){var i=this,l=this.props,o=l.content,h=l.type,c=A(A(A({},rt(this.props,!1)),n),{},{root:r}),u=!n.children||!n.children.length,d=this.state.currentRoot,x=(d.children||[]).filter(function(p){return p.depth===n.depth&&p.name===n.name});return!x.length&&r.depth&&h==="nest"?null:O.createElement(Re,{key:"recharts-treemap-node-".concat(c.x,"-").concat(c.y,"-").concat(c.name),className:"recharts-treemap-depth-".concat(n.depth)},this.renderItem(o,c,u),n.children&&n.children.length?n.children.map(function(p){return i.renderNode(n,p)}):null)}},{key:"renderAllNodes",value:function(){var r=this.state.formatRoot;return r?this.renderNode(r,r):null}},{key:"renderTooltip",value:function(){var r=this.props,n=r.children,i=r.nameKey,l=Pe(n,W);if(!l)return null;var o=this.props,h=o.width,c=o.height,u=this.state,d=u.isTooltipActive,x=u.activeNode,p={x:0,y:0,width:h,height:c},T=x?{x:x.x+x.width/2,y:x.y+x.height/2}:null,j=d&&x?[{payload:x,name:nt(x,i,""),value:nt(x,ve)}]:[];return O.cloneElement(l,{viewBox:p,active:d,coordinate:T,label:"",payload:j})}},{key:"renderNestIndex",value:function(){var r=this,n=this.props,i=n.nameKey,l=n.nestIndexContent,o=this.state.nestIndex;return O.createElement("div",{className:"recharts-treemap-nest-index-wrapper",style:{marginTop:"8px",textAlign:"center"}},o.map(function(h,c){var u=wa(h,i,"root"),d=null;return O.isValidElement(l)&&(d=O.cloneElement(l,h,c)),we(l)?d=l(h,c):d=u,O.createElement("div",{onClick:r.handleNestIndex.bind(r,h,c),key:"nest-index-".concat(Sa()),className:"recharts-treemap-nest-index-box",style:{cursor:"pointer",display:"inline-block",padding:"0 7px",background:"#000",color:"#fff",marginRight:"3px"}},d)}))}},{key:"render",value:function(){if(!Ca(this))return null;var r=this.props,n=r.width,i=r.height,l=r.className,o=r.style,h=r.children,c=r.type,u=Ko(r,Bo),d=rt(u,!1);return O.createElement("div",{className:ws("recharts-wrapper",l),style:A(A({},o),{},{position:"relative",cursor:"default",width:n,height:i}),role:"region"},O.createElement(Aa,ke({},d,{width:n,height:c==="nest"?i-30:i}),this.renderAllNodes(),Ta(h)),this.renderTooltip(),c==="nest"&&this.renderNestIndex())}}],[{key:"getDerivedStateFromProps",value:function(r,n){if(r.data!==n.prevData||r.type!==n.prevType||r.width!==n.prevWidth||r.height!==n.prevHeight||r.dataKey!==n.prevDataKey||r.aspectRatio!==n.prevAspectRatio){var i=Fe({depth:0,node:{children:r.data,x:0,y:0,width:r.width,height:r.height},index:0,valueKey:r.dataKey}),l=Be(i,r.aspectRatio);return A(A({},n),{},{formatRoot:l,currentRoot:i,nestIndex:[i],prevAspectRatio:r.aspectRatio,prevData:r.data,prevWidth:r.width,prevHeight:r.height,prevDataKey:r.dataKey,prevType:r.type})}return null}},{key:"renderContentItem",value:function(r,n,i,l){if(O.isValidElement(r))return O.cloneElement(r,n);if(we(r))return r(n);var o=n.x,h=n.y,c=n.width,u=n.height,d=n.index,x=null;c>10&&u>10&&n.children&&i==="nest"&&(x=O.createElement(Ea,{points:[{x:o+2,y:h+u/2},{x:o+6,y:h+u/2+3},{x:o+2,y:h+u/2+6}]}));var p=null,T=ba(n.name);c>20&&u>20&&T.width<c&&T.height<u&&(p=O.createElement("text",{x:o+8,y:h+u/2+7,fontSize:14},n.name));var j=l||Fo;return O.createElement("g",null,O.createElement(Na,ke({fill:n.depth<2?j[d%j.length]:"rgba(255,255,255,0)",stroke:"#fff"},Ro(n,"children"),{role:"img"})),x,p)}}])}(m.PureComponent);J(Xe,"displayName","Treemap");J(Xe,"defaultProps",{aspectRatio:.5*(1+Math.sqrt(5)),dataKey:"value",type:"flat",isAnimationActive:!it.isSsr,isUpdateAnimationActive:!it.isSsr,animationBegin:0,animationDuration:1500,animationEasing:"linear"});var sl=ka({chartName:"ScatterChart",GraphicalChild:ze,defaultTooltipEventType:"item",validateTooltipEventTypes:["item"],axisComponents:[{axisType:"xAxis",AxisComp:ie},{axisType:"yAxis",AxisComp:re},{axisType:"zAxis",AxisComp:Vs}],formatAxisMap:$a}),Ee="Tabs",[al,Ql]=Ss(Ee,[Ct]),Yt=Ct(),[rl,Ze]=al(Ee),Qt=m.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,onValueChange:n,defaultValue:i,orientation:l="horizontal",dir:o,activationMode:h="automatic",...c}=t,u=Cs(o),[d,x]=As({prop:r,onChange:n,defaultProp:i??"",caller:Ee});return e.jsx(rl,{scope:s,baseId:Ts(),value:d,onValueChange:x,orientation:l,dir:u,activationMode:h,children:e.jsx(_e.div,{dir:u,"data-orientation":l,...c,ref:a})})});Qt.displayName=Ee;var Jt="TabsList",Xt=m.forwardRef((t,a)=>{const{__scopeTabs:s,loop:r=!0,...n}=t,i=Ze(Jt,s),l=Yt(s);return e.jsx(Hs,{asChild:!0,...l,orientation:i.orientation,dir:i.dir,loop:r,children:e.jsx(_e.div,{role:"tablist","aria-orientation":i.orientation,...n,ref:a})})});Xt.displayName=Jt;var Zt="TabsTrigger",es=m.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,disabled:n=!1,...i}=t,l=Ze(Zt,s),o=Yt(s),h=as(l.baseId,r),c=rs(l.baseId,r),u=r===l.value;return e.jsx(Ws,{asChild:!0,...o,focusable:!n,active:u,children:e.jsx(_e.button,{type:"button",role:"tab","aria-selected":u,"aria-controls":c,"data-state":u?"active":"inactive","data-disabled":n?"":void 0,disabled:n,id:h,...i,ref:a,onMouseDown:De(t.onMouseDown,d=>{!n&&d.button===0&&d.ctrlKey===!1?l.onValueChange(r):d.preventDefault()}),onKeyDown:De(t.onKeyDown,d=>{[" ","Enter"].includes(d.key)&&l.onValueChange(r)}),onFocus:De(t.onFocus,()=>{const d=l.activationMode!=="manual";!u&&!n&&d&&l.onValueChange(r)})})})});es.displayName=Zt;var ts="TabsContent",ss=m.forwardRef((t,a)=>{const{__scopeTabs:s,value:r,forceMount:n,children:i,...l}=t,o=Ze(ts,s),h=as(o.baseId,r),c=rs(o.baseId,r),u=r===o.value,d=m.useRef(u);return m.useEffect(()=>{const x=requestAnimationFrame(()=>d.current=!1);return()=>cancelAnimationFrame(x)},[]),e.jsx(ks,{present:n||u,children:({present:x})=>e.jsx(_e.div,{"data-state":u?"active":"inactive","data-orientation":o.orientation,role:"tabpanel","aria-labelledby":h,hidden:!x,id:c,tabIndex:0,...l,ref:a,style:{...t.style,animationDuration:d.current?"0s":void 0},children:x&&i})})});ss.displayName=ts;function as(t,a){return`${t}-trigger-${a}`}function rs(t,a){return`${t}-content-${a}`}var nl=Qt,ns=Xt,is=es,os=ss;const et=nl,Me=m.forwardRef(({className:t,...a},s)=>e.jsx(ns,{ref:s,className:We("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...a}));Me.displayName=ns.displayName;const H=m.forwardRef(({className:t,...a},s)=>e.jsx(is,{ref:s,className:We("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...a}));H.displayName=is.displayName;const Y=m.forwardRef(({className:t,...a},s)=>e.jsx(os,{ref:s,className:We("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...a}));Y.displayName=os.displayName;const il=({active:t,payload:a,label:s,metric:r})=>{if(t&&a&&a.length){const n=["clients","employees","shifts","hours","targetAchievement","missedTargets"].includes(r),i=a[0].value;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground",children:s}),e.jsx("p",{className:"text-sm",children:n?i.toLocaleString():i.toLocaleString(void 0,{style:"currency",currency:"GBP"})})]})}return null},Ke=({data:t,metric:a,onBarClick:s})=>!t||t.length===0?e.jsx("div",{className:"h-[300px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No breakdown data available"})}):e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Pt,{data:t,layout:"vertical",margin:{top:5,right:30,left:40,bottom:5},children:[e.jsx(he,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(ie,{type:"number",hide:!0}),e.jsx(re,{dataKey:"name",type:"category",width:120,tick:{fontSize:12}}),e.jsx(W,{content:e.jsx(il,{metric:a})}),e.jsx(Q,{dataKey:"value",fill:"hsl(var(--primary))",radius:[0,4,4,0],onClick:s,children:t.map((r,n)=>e.jsx(Ye,{fill:"hsl(var(--primary))",fillOpacity:.8+n*.05},`cell-${n}`))})]})})})})}),bt=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884d8","#82ca9d","#ffc658","#8dd1e1","#a4de6c","#d0ed57"],ol=({active:t,payload:a,metric:s})=>{if(t&&a&&a.length){const r=["revenue","costs","profit","overheads"].includes(s);return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:a[0].name}),e.jsx("p",{className:"text-sm",children:r?Number(a[0].value).toLocaleString(void 0,{style:"currency",currency:"GBP"}):Number(a[0].value).toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`${(a[0].payload.percentage||0).toFixed(1)}%`})]})}return null},Se=({data:t,metric:a})=>{if(!t||t.length===0)return e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[300px] flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No distribution data available"})})})});const s=[...t].sort((i,l)=>l.value-i.value),r=s.reduce((i,l)=>i+l.value,0),n=s.map(i=>({...i,percentage:r>0?i.value/r*100:0}));return e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("div",{className:"h-[400px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Ma,{children:[e.jsx(Oa,{data:n,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,fill:"#8884d8",dataKey:"value",children:n.map((i,l)=>e.jsx(Ye,{fill:bt[l%bt.length]},`cell-${l}`))}),e.jsx(W,{content:e.jsx(ol,{metric:a})}),e.jsx(Dt,{})]})})})})})},ll=({data:t,onEdit:a,onDelete:s})=>!t||t.length===0?e.jsx("div",{className:"h-[200px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No overhead details available"})}):e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Overheads Details"})}),e.jsx(B,{children:e.jsxs(Rt,{children:[e.jsx(Ft,{children:e.jsxs(Ae,{children:[e.jsx(z,{children:"Title"}),e.jsx(z,{children:"Month"}),e.jsx(z,{children:"Location"}),e.jsx(z,{children:"Site"}),e.jsx(z,{className:"text-right",children:"Amount"}),e.jsx(z,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(Bt,{children:t.map(r=>e.jsxs(Ae,{children:[e.jsx(V,{className:"font-medium",children:r.name}),e.jsxs(V,{children:[r.month," ",r.year]}),e.jsx(V,{children:r.location||"-"}),e.jsx(V,{children:r.site||"-"}),e.jsx(V,{className:"text-right",children:r.value.toLocaleString(void 0,{style:"currency",currency:"GBP"})}),e.jsx(V,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-500 hover:text-blue-600",onClick:()=>a(r),children:e.jsx(La,{className:"h-4 w-4"})}),e.jsx(ae,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx(Ia,{className:"h-4 w-4"})})]})})]},r.id))})]})})]}),cl=t=>{const a=[];for(let s=0;s<t;s++)a.push(s*360/t%360);return a.map(s=>`hsl(${s}, 70%, 60%)`)},dl=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg max-w-xs",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.tierName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Clients:"})," ",s.clientCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Revenue:"})," £",s.totalRevenue.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Avg/Client:"})," £",s.avgRevenue.toLocaleString()]})]}),s.hoveredClient&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border",children:[e.jsx("p",{className:"font-medium text-primary",children:s.hoveredClient.name}),e.jsxs("p",{className:"text-sm",children:["£",s.hoveredClient.revenue.toLocaleString()]})]})]})}return null},hl=({data:t})=>{if(!t||t.length===0)return e.jsx("div",{className:"h-[400px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No tier data available"})});const a=t.map(s=>{const r=cl(s.clients.length);return{tierName:s.name,totalRevenue:s.value,clientCount:s.clientCount,avgRevenue:s.avgRevenue,clients:s.clients,colors:r}});return e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Revenue Distribution by Tier & Client"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each bar is segmented by individual clients within the tier"})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[500px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Pt,{data:a,layout:"vertical",margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(he,{strokeDasharray:"3 3",horizontal:!1}),e.jsx(ie,{type:"number",hide:!0}),e.jsx(re,{dataKey:"tierName",type:"category",width:90,tick:{fontSize:13,fontWeight:500}}),e.jsx(W,{content:e.jsx(dl,{})}),a.map((s,r)=>s.clients.map((n,i)=>e.jsx(Q,{dataKey:()=>n.revenue,stackId:r,fill:s.colors[i],radius:i===s.clients.length-1?[0,4,4,0]:[0,0,0,0],children:a.map((l,o)=>{const h=o===r;return e.jsx(Ye,{fill:h?s.colors[i]:"transparent",stroke:h?"rgba(0,0,0,0.1)":"none",strokeWidth:.5,style:{cursor:"pointer"},onMouseEnter:c=>{h&&(c.target.style.opacity="0.8")},onMouseLeave:c=>{h&&(c.target.style.opacity="1")}},`cell-${r}-${i}-${o}`)})},`${r}-${i}`)))]})})}),e.jsx("div",{className:"mt-4 space-y-3",children:a.map((s,r)=>e.jsxs("div",{className:"border-t pt-3 first:border-t-0 first:pt-0",children:[e.jsx("p",{className:"font-semibold mb-2",children:s.tierName}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:s.clients.map((n,i)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:s.colors[i]}}),e.jsx("span",{className:"truncate",title:`${n.name}: £${n.revenue.toLocaleString()}`,children:n.name})]},i))})]},r))})]})]})},ul=({active:t,payload:a})=>{if(t&&a&&a.length){const s=a[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-2",children:s.clientName}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Hours:"})," ",s.totalHours.toLocaleString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Staff Assigned:"})," ",s.staffCount]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Shifts:"})," ",s.shiftCount]})]})]})}return null},ml=({data:t,medianHours:a,medianStaff:s})=>!t||t.length===0?e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Client Workload vs Staff Coverage"})}),e.jsx(B,{children:e.jsx("div",{className:"h-[500px] flex items-center justify-center border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"No data available for the selected period"})})})]}):e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Client Workload vs Staff Coverage"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Each dot represents a client. Dashed lines show median values."})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[550px]",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(sl,{margin:{top:20,right:30,bottom:70,left:70},children:[e.jsx(he,{strokeDasharray:"3 3"}),e.jsx(ie,{type:"number",dataKey:"totalHours",name:"Total Paid Hours",tickFormatter:r=>r.toLocaleString(),children:e.jsx(ot,{value:"Total Paid Hours",position:"bottom",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(re,{type:"number",dataKey:"staffCount",name:"Staff Count",allowDecimals:!1,children:e.jsx(ot,{value:"Staff Assigned",angle:-90,position:"left",offset:50,style:{fontSize:14,fontWeight:500}})}),e.jsx(W,{content:e.jsx(ul,{}),cursor:{strokeDasharray:"3 3"}}),e.jsx(lt,{x:a,stroke:"hsl(var(--primary))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${a.toLocaleString()}h`,position:"top",fill:"hsl(var(--primary))",fontSize:12}}),e.jsx(lt,{y:s,stroke:"hsl(var(--chart-2))",strokeDasharray:"5 5",strokeWidth:2,label:{value:`Median: ${s} staff`,position:"right",fill:"hsl(var(--chart-2))",fontSize:12}}),e.jsx(ze,{data:t,fill:"hsl(var(--primary))",fillOpacity:.7,strokeWidth:1,stroke:"hsl(var(--primary))"})]})})}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Clients"}),e.jsx("p",{className:"text-2xl font-bold",children:t.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Hours"}),e.jsx("p",{className:"text-2xl font-bold",children:a.toLocaleString()})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Median Staff"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Shifts"}),e.jsx("p",{className:"text-2xl font-bold",children:t.reduce((r,n)=>r+n.shiftCount,0).toLocaleString()})]})]})]})]}),fl=({dateRange:t,locations:a=[],sites:s=[]})=>{const[r,n]=m.useState("calendar"),[i,l]=m.useState([]),[o,h]=m.useState([]),[c,u]=m.useState([]),[d,x]=m.useState([]),[p,T]=m.useState(!1),[j,N]=m.useState(33),[b,E]=m.useState(67),[M,K]=m.useState(!1);m.useEffect(()=>{(async()=>{T(!0);try{const f=new URLSearchParams({start:$(t.from,"yyyy-MM-dd"),end:$(t.to,"yyyy-MM-dd"),view_type:r});a&&a.length>0&&a.forEach(oe=>f.append("locations",oe)),s&&s.length>0&&s.forEach(oe=>f.append("sites",oe));const _={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},D=await fetch(`/api/dashboard/shifts-heatmap?${f.toString()}`,{headers:_,credentials:"include"});if(!D.ok){console.error(`Heatmap API returned ${D.status}`);return}const P=await D.json();P.view_type==="calendar"?l(P.data||[]):(h(P.data||[]),u(P.locations||[]),x(P.dates||[]))}catch(f){console.error("Error fetching heatmap data:",f)}finally{T(!1)}})()},[t,a,s,r]);const ee=()=>Math.max(...r==="calendar"?i.map(v=>v.shift_count):o.map(v=>v.shift_count),1),U=v=>{const f=ee(),_=v/f*100;return _===0?"#f8f9fa":_<j?"#d4edda":_<b?"#fff3cd":"#f8d7da"},I=(v,f)=>{const _=o.find(D=>D.location===v&&D.date===f);return _?_.shift_count:0};return e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Shift Density Heatmap"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualize shift distribution to identify peak workload periods"}),e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(L,{className:"font-semibold",children:"Intensity Thresholds (%)"}),e.jsx(ae,{variant:"outline",size:"sm",onClick:()=>K(!M),children:M?"Done":"Edit"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Low (","<"," ",j,"%)"]}),M?e.jsx(se,{type:"number",min:"0",max:"100",value:j,onChange:v=>N(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsxs("span",{className:"text-sm",children:["0-",j,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["Medium (",j,"-",b,"%)"]}),M?e.jsx(se,{type:"number",min:"0",max:"100",value:b,onChange:v=>E(Number(v.target.value)),className:"mt-1"}):e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsxs("span",{className:"text-sm",children:[j,"-",b,"%"]})]})]}),e.jsxs("div",{children:[e.jsxs(L,{className:"text-xs",children:["High (",">="," ",b,"%)"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsxs("span",{className:"text-sm",children:[b,"-100%"]})]})]})]})]})]}),e.jsx(B,{children:e.jsxs(et,{value:r,onValueChange:v=>n(v),children:[e.jsxs(Me,{className:"mb-4",children:[e.jsx(H,{value:"calendar",children:"Calendar View"}),e.jsx(H,{value:"location_day",children:"By Location"})]}),e.jsx(Y,{value:"calendar",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):i.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No shift data available"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2",children:i.map((v,f)=>e.jsxs("div",{className:"relative p-3 rounded-md border text-center cursor-pointer transition-all hover:shadow-md",style:{backgroundColor:U(v.shift_count)},title:`${v.date} (${v.day_of_week}): ${v.shift_count} shifts`,children:[e.jsx("div",{className:"text-xs font-medium",children:$(new Date(v.date),"MMM d")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:v.day_of_week.slice(0,3)}),e.jsx("div",{className:"text-lg font-bold mt-1",children:v.shift_count})]},f))}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})}),e.jsx(Y,{value:"location_day",children:p?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading..."}):c.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No location data available"}):e.jsxs("div",{className:"overflow-x-scroll max-w-full",children:[e.jsx("div",{className:"inline-block min-w-full",children:e.jsxs("table",{className:"border-collapse",style:{minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 bg-background border p-2 text-left font-medium text-sm",children:"Location"}),d.slice(0,31).map((v,f)=>e.jsx("th",{className:"border p-2 text-center text-xs whitespace-nowrap",children:$(new Date(v),"MMM d")},f))]})}),e.jsx("tbody",{children:c.map((v,f)=>e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 bg-background border p-2 font-medium text-sm",children:v}),d.slice(0,31).map((_,D)=>{const P=I(v,_);return e.jsx("td",{className:"border p-2 text-center text-sm cursor-pointer hover:opacity-80",style:{backgroundColor:U(P)},title:`${v} - ${_}: ${P} shifts`,children:P>0?P:""},D)})]},f))})]})}),d.length>31&&e.jsx("div",{className:"text-center text-sm text-muted-foreground mt-2",children:"Showing first 31 days. Adjust date range for focused view."}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-4 border-t mt-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Intensity:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#d4edda"}}),e.jsx("span",{className:"text-xs",children:"Low"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#fff3cd"}}),e.jsx("span",{className:"text-xs",children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-4 rounded",style:{backgroundColor:"#f8d7da"}}),e.jsx("span",{className:"text-xs",children:"High"})]})]})]})})]})})]})},xl=t=>{const{x:a,y:s,width:r,height:n,stroke:i,fill:l,payload:o}=t;if(!o||!o.median||n===0)return null;const h=n/o.median,c=s+n,u=E=>c-E*h,d=u(o.min),x=u(o.q1),p=u(o.median),T=u(o.q3),j=u(o.max),N=a+r/2,b=r/2;return e.jsxs("g",{children:[e.jsx("line",{x1:N,y1:j,x2:N,y2:d,stroke:i,strokeWidth:1}),e.jsx("line",{x1:N-b/2,y1:j,x2:N+b/2,y2:j,stroke:i,strokeWidth:1}),e.jsx("line",{x1:N-b/2,y1:d,x2:N+b/2,y2:d,stroke:i,strokeWidth:1}),e.jsx("rect",{x:a,y:T,width:r,height:Math.abs(x-T),stroke:i,fill:l,fillOpacity:.6}),e.jsx("line",{x1:a,y1:p,x2:a+r,y2:p,stroke:i,strokeWidth:2}),o.outliers&&o.outliers.map((E,M)=>e.jsx("circle",{cx:N,cy:u(E),r:2,fill:"#ef4444",opacity:.6},M))]})},gl=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a[0].payload;return e.jsxs("div",{className:"bg-popover border text-popover-foreground p-3 rounded-lg shadow-md text-sm",children:[e.jsx("p",{className:"font-semibold mb-2",children:r.name}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Max:"}),e.jsxs("span",{className:"font-medium",children:[r.max.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q3 (75%):"}),e.jsxs("span",{className:"font-medium",children:[r.q3.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Median:"}),e.jsxs("span",{className:"font-medium text-primary",children:[r.median.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Q1 (25%):"}),e.jsxs("span",{className:"font-medium",children:[r.q1.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Min:"}),e.jsxs("span",{className:"font-medium",children:[r.min.toFixed(1),"h"]})]}),r.outliers.length>0&&e.jsxs("div",{className:"flex justify-between gap-4 pt-1 border-t mt-1",children:[e.jsx("span",{className:"text-destructive",children:"Outliers:"}),e.jsx("span",{className:"font-medium",children:r.outliers.length})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2 pt-1 border-t",children:["Sample size: ",r.count," shifts"]})]})]})}return null},pl=({dateRange:t,limit:a=15})=>{const[s,r]=m.useState("client"),[n,i]=m.useState([]),[l,o]=m.useState(!1);return m.useEffect(()=>{(async()=>{o(!0);try{const c=new URLSearchParams({start:$(t.from,"yyyy-MM-dd"),end:$(t.to,"yyyy-MM-dd"),dimension:s,limit:a.toString()}),u={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},d=await fetch(`${ce.HOURS_DISTRIBUTION}?${c.toString()}`,{headers:u});if(d.ok){const x=await d.json();i(x)}}catch(c){console.error("Error fetching distribution data:",c)}finally{o(!1)}})()},[t,s,a]),e.jsxs(F,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Hours Distribution"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Showing spread of shift durations. Box represents middle 50% of data."})]}),e.jsx(B,{children:e.jsxs(et,{value:s,onValueChange:h=>r(h),children:[e.jsxs(Me,{className:"mb-6",children:[e.jsx(H,{value:"client",children:"By Client"}),e.jsx(H,{value:"site",children:"By Site"})]}),e.jsxs("div",{className:"h-[400px] w-full",children:[l?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"Loading distribution data..."}):n.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:"No data available for selected period"}):e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Ve,{data:n,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(he,{strokeDasharray:"3 3",vertical:!1,opacity:.3}),e.jsx(ie,{dataKey:"name",angle:-45,textAnchor:"end",height:80,interval:0,tick:{fontSize:12}}),e.jsx(re,{label:{value:"Hours Worked",angle:-90,position:"insideLeft",style:{textAnchor:"middle"}}}),e.jsx(W,{content:e.jsx(gl,{}),cursor:{fill:"transparent"}}),e.jsx(Q,{dataKey:"max",fill:"transparent",barSize:1}),e.jsx(Q,{dataKey:"median",shape:xl,fill:"#3b82f6",stroke:"#1e40af",barSize:40})]})}),!l&&n.length>0&&e.jsx("div",{className:"text-center text-xs text-muted-foreground mt-2",children:"* Whiskers extend to 1.5x IQR. Dots represent outliers."})]})]})})]})},vl=t=>{const{cx:a,cy:s,payload:r}=t;if(!a||!s)return null;const n=20;return e.jsx("line",{x1:a,y1:s-n/2,x2:a,y2:s+n/2,stroke:"#000",strokeWidth:3})},jl=({active:t,payload:a,label:s})=>{if(t&&a&&a.length){const r=a.find(i=>i.dataKey==="actual"),n=r?r.payload:a[0].payload;return e.jsxs("div",{className:"bg-white p-3 border rounded shadow-lg text-sm",children:[e.jsx("p",{className:"font-bold mb-1",children:n.name}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[e.jsx("span",{className:"text-gray-500",children:"Actual:"}),e.jsx("span",{className:"font-mono font-medium",children:n.actual}),e.jsx("span",{className:"text-gray-500",children:"Target:"}),e.jsx("span",{className:"font-mono font-medium",children:n.target}),e.jsx("span",{className:"text-gray-500",children:"Achievement:"}),e.jsxs("span",{className:`font-mono font-bold ${n.achievement>=100?"text-green-600":n.achievement>=80?"text-yellow-600":"text-red-600"}`,children:[n.achievement,"%"]})]})]})}return null},yl=({dateRange:t,limit:a=15,dimension:s="site"})=>{const[r,n]=m.useState([]),[i,l]=m.useState(!1);return m.useEffect(()=>{(async()=>{if(!(!(t!=null&&t.from)||!(t!=null&&t.to))){l(!0);try{const h=$(t.from,"yyyy-MM-dd"),c=$(t.to,"yyyy-MM-dd"),u=localStorage.getItem("auth_token"),d=await fetch(`${ce.TARGET_ACHIEVEMENT_BULLET}?start=${h}&end=${c}&dimension=${s}&limit=${a}`,{headers:{Authorization:`Bearer ${u}`}});if(d.ok){const x=await d.json();n(x)}}catch(h){console.error("Error fetching bullet chart data:",h)}finally{l(!1)}}})()},[t,a,s]),i?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center",children:"Loading chart data..."}):r.length?e.jsxs("div",{className:"w-full",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Target Achievement by ",s==="client"?"Client":"Site"]}),e.jsx("div",{className:"h-[600px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Ve,{layout:"vertical",data:r,margin:{top:20,right:30,left:100,bottom:20},children:[e.jsx(he,{stroke:"#f5f5f5",horizontal:!0,vertical:!0}),e.jsx(ie,{type:"number"}),e.jsx(re,{type:"category",dataKey:"name",width:100,tick:{fontSize:12}}),e.jsx(W,{content:e.jsx(jl,{}),cursor:{fill:"transparent"}}),e.jsx(Q,{dataKey:"range_poor",stackId:"ranges",fill:"#fee2e2",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"range_good",stackId:"ranges",fill:"#fef3c7",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"range_excellent",stackId:"ranges",fill:"#dcfce7",barSize:30,isAnimationActive:!1}),e.jsx(Q,{dataKey:"actual",barSize:12,fill:"#1f2937"}),e.jsx(ze,{dataKey:"marker",shape:e.jsx(vl,{}),legendType:"none"})]})})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-red-100 border border-red-200 block"}),e.jsx("span",{children:"Poor (<80%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-200 block"}),e.jsx("span",{children:"Good (80-95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-green-100 border border-green-200 block"}),e.jsx("span",{children:"Excellent (>95%)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-1 bg-gray-800 block"}),e.jsx("span",{children:"Actual"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1 h-3 bg-black block"}),e.jsx("span",{children:"Target"})]})]})]}):e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-gray-500",children:"No data available for this period"})},bl={low:10,midLow:20,mid:30,high:40},pe=["#ef4444","#f97316","#eab308","#84cc16","#22c55e"],Nt=({data:t,title:a="Revenue Composition (Margin Color-Coded)"})=>{const[s,r]=m.useState(bl),n=o=>o<s.low?pe[0]:o<s.midLow?pe[1]:o<s.mid?pe[2]:o<s.high?pe[3]:pe[4],i=o=>{const{root:h,depth:c,x:u,y:d,width:x,height:p,index:T,payload:j,colors:N,rank:b,name:E,margin:M}=o;return e.jsxs("g",{children:[e.jsx("rect",{x:u,y:d,width:x,height:p,style:{fill:n(M),stroke:"#fff",strokeWidth:2/(c+1e-10),strokeOpacity:1/(c+1e-10)}}),x>50&&p>30&&e.jsx("text",{x:u+x/2,y:d+p/2,textAnchor:"middle",fill:"#fff",fontSize:12,style:{pointerEvents:"none"},children:E})]})},l=({active:o,payload:h})=>{var c;if(o&&h&&h.length){const u=h[0].payload;return e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:u.name}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Revenue:"}),e.jsxs("span",{className:"font-mono",children:["£",u.revenue.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cost:"}),e.jsxs("span",{className:"font-mono",children:["£",(c=u.cost)==null?void 0:c.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{className:"text-muted-foreground",children:"Profit:"}),e.jsxs("span",{className:`font-mono ${u.profit>=0?"text-green-600":"text-red-600"}`,children:["£",u.profit.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between gap-4 border-t pt-1 mt-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Margin:"}),e.jsxs("span",{className:`font-mono font-bold ${u.margin>=0?"text-green-600":"text-red-600"}`,children:[u.margin.toFixed(1),"%"]})]})]})]})}return null};return!t||t.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"}):e.jsxs(F,{children:[e.jsxs(X,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(Z,{className:"text-base font-medium",children:a}),e.jsxs(Da,{children:[e.jsx(Pa,{asChild:!0,children:e.jsx(ae,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(qa,{className:"h-4 w-4"})})}),e.jsx(Ra,{className:"w-80",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium leading-none",children:"Margin Thresholds (%)"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Adjust color coding boundaries."})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"low",children:"Low (Red)"}),e.jsx(se,{id:"low",type:"number",className:"col-span-2 h-8",value:s.low,onChange:o=>r({...s,low:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"midLow",children:"Mid-Low (Org)"}),e.jsx(se,{id:"midLow",type:"number",className:"col-span-2 h-8",value:s.midLow,onChange:o=>r({...s,midLow:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"mid",children:"Mid (Ylw)"}),e.jsx(se,{id:"mid",type:"number",className:"col-span-2 h-8",value:s.mid,onChange:o=>r({...s,mid:Number(o.target.value)})})]}),e.jsxs("div",{className:"grid grid-cols-3 items-center gap-4",children:[e.jsx(L,{htmlFor:"high",children:"High (Lime)"}),e.jsx(se,{id:"high",type:"number",className:"col-span-2 h-8",value:s.high,onChange:o=>r({...s,high:Number(o.target.value)})})]})]})]})})]})]}),e.jsxs(B,{children:[e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsx(Xe,{data:t,dataKey:"size",aspectRatio:4/3,stroke:"#fff",fill:"#8884d8",content:e.jsx(i,{}),children:e.jsx(W,{content:e.jsx(l,{})})})})}),e.jsxs("div",{className:"mt-4 flex flex-wrap justify-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsxs("span",{children:["< ",s.low,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-orange-500"}),e.jsxs("span",{children:[s.low,"-",s.midLow,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsxs("span",{children:[s.midLow,"-",s.mid,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-lime-500"}),e.jsxs("span",{children:[s.mid,"-",s.high,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsxs("span",{children:["> ",s.high,"%"]})]})]})]})]})},Nl=({active:t,payload:a,label:s})=>t&&a&&a.length?e.jsxs("div",{className:"bg-background border border-border p-3 rounded-lg shadow-lg",children:[e.jsx("p",{className:"font-semibold text-foreground mb-1",children:s}),a.map((r,n)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:r.color}}),e.jsxs("span",{className:"text-muted-foreground",children:[r.name==="value"?"Cost":"Cumulative %",":"]}),e.jsx("span",{className:"font-mono",children:r.name==="value"?`£${r.value.toLocaleString()}`:`${r.value}%`})]},n))]}):null,wl=({data:t})=>!t||t.length===0?e.jsx("div",{className:"h-[400px] w-full flex items-center justify-center text-muted-foreground",children:"No data available"}):e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{className:"text-base font-medium",children:"Overheads Pareto Analysis (80/20 Rule)"})}),e.jsx(B,{children:e.jsx("div",{className:"h-[400px] w-full",children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(Ve,{data:t,margin:{top:20,right:20,bottom:20,left:20},children:[e.jsx(he,{stroke:"#f5f5f5",vertical:!1}),e.jsx(ie,{dataKey:"name",scale:"band",tick:{fontSize:12},interval:0,angle:-20,textAnchor:"end",height:60}),e.jsx(re,{yAxisId:"left",orientation:"left",tickFormatter:a=>`£${a}`,stroke:"#8884d8"}),e.jsx(re,{yAxisId:"right",orientation:"right",domain:[0,100],tickFormatter:a=>`${a}%`,stroke:"#ff7300"}),e.jsx(W,{content:e.jsx(Nl,{})}),e.jsx(Dt,{}),e.jsx(Q,{yAxisId:"left",dataKey:"value",name:"Cost",barSize:40,fill:"#413ea0",radius:[4,4,0,0]}),e.jsx(_a,{yAxisId:"right",type:"monotone",dataKey:"cumulativePercentage",name:"Cumulative %",stroke:"#ff7300",strokeWidth:2,dot:{r:4}})]})})})})]}),Ue=["January","February","March","April","May","June","July","August","September","October","November","December"],wt=["Rent","Salaries","Utilities","Software","Equipment","Marketing","Travel","Insurance","Taxes","Maintenance","Custom..."],Sl=({open:t,onOpenChange:a,initialData:s,onSave:r})=>{var I,v;const{data:n}=za(),[i,l]=m.useState(!1),[o,h]=m.useState(new Date().getFullYear()),[c,u]=m.useState(Ue[new Date().getMonth()]),[d,x]=m.useState(""),[p,T]=m.useState(""),[j,N]=m.useState(""),[b,E]=m.useState(""),[M,K]=m.useState("");m.useEffect(()=>{t&&(s?(h(s.year),u(s.month),x(s.location||""),T(s.site||""),K(s.value.toString()),wt.includes(s.name)?(N(s.name),E("")):(N("Custom..."),E(s.name))):(h(new Date().getFullYear()),u(Ue[new Date().getMonth()]),x(""),T(""),N(""),E(""),K("")))},[t,s]);const ee=async()=>{if(!d||!j||!M){te.error("Please fill in all required fields");return}const f=j==="Custom..."?b:j;if(!f){te.error("Please specify the overhead name");return}l(!0);try{await r({id:s==null?void 0:s.id,year:o,month:c,location:d,site:p||null,name:f,value:parseFloat(M)}),a(!1)}catch(_){console.error("Failed to save overhead:",_)}finally{l(!1)}},U=((I=n==null?void 0:n.jobs)==null?void 0:I.filter(f=>f.location===d&&f.site).map(f=>f.site).filter((f,_,D)=>D.indexOf(f)===_))||[];return e.jsx(Fa,{open:t,onOpenChange:a,children:e.jsxs(Ba,{className:"sm:max-w-[500px]",children:[e.jsxs(Ka,{children:[e.jsx(Ua,{children:s?"Edit Overhead":"Add Overhead"}),e.jsx(Ha,{children:s?"Update existing overhead record.":"Create a new overhead record."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Year"}),e.jsxs(me,{value:o.toString(),onValueChange:f=>h(Number(f)),children:[e.jsx(fe,{children:e.jsx(xe,{})}),e.jsx(ge,{children:[2024,2025,2026,2027,2028].map(f=>e.jsx(le,{value:f.toString(),children:f},f))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Month"}),e.jsxs(me,{value:c,onValueChange:u,children:[e.jsx(fe,{children:e.jsx(xe,{})}),e.jsx(ge,{children:Ue.map(f=>e.jsx(le,{value:f,children:f},f))})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Location"}),e.jsxs(me,{value:d,onValueChange:f=>{x(f),T("")},children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:"Select location..."})}),e.jsx(ge,{children:Array.from(new Set((v=n==null?void 0:n.jobs)==null?void 0:v.map(f=>f.location).filter(Boolean))).map(f=>e.jsx(le,{value:f,children:f},f))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Site (Optional)"}),e.jsxs(me,{value:p,onValueChange:T,disabled:!d||U.length===0,children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:U.length===0?"No sites available":"Select site..."})}),e.jsxs(ge,{children:[e.jsx(le,{value:"all_sites",children:"All Sites (if applicable)"}),U.map(f=>e.jsx(le,{value:f,children:f},f))]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Category"}),e.jsxs(me,{value:j,onValueChange:N,children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:"Select category..."})}),e.jsx(ge,{children:wt.map(f=>e.jsx(le,{value:f,children:f},f))})]})]}),j==="Custom..."&&e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Custom Name"}),e.jsx(se,{placeholder:"Enter overhead name",value:b,onChange:f=>E(f.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{children:"Value (£)"}),e.jsx(se,{type:"number",placeholder:"0.00",value:M,onChange:f=>K(f.target.value)})]})]}),e.jsxs(Wa,{children:[e.jsx(ae,{variant:"outline",onClick:()=>a(!1),children:"Cancel"}),e.jsxs(ae,{onClick:ee,disabled:i,children:[i&&e.jsx($s,{className:"mr-2 h-4 w-4 animate-spin"}),"Save"]})]})]})})},Jl=()=>{const{metricId:t}=_s(),a=Es(),{dateRange:s,setDateRange:r}=Ms(),{role:n}=Os(),[i,l]=m.useState(!1),[o,h]=m.useState(s),[c,u]=m.useState([]),[d,x]=m.useState([]),[p,T]=m.useState("trend"),[j,N]=m.useState([]),[b,E]=m.useState([]),[M,K]=m.useState([]),[ee,U]=m.useState({hours:0,staffCount:0}),[I,v]=m.useState([]),[f,_]=m.useState(!1),[D,P]=m.useState([]),[oe,ls]=m.useState([]);m.useEffect(()=>{if(t!=="revenue"&&t!=="cost"||p!=="trend")return;(async()=>{try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd"),metric:t});c&&c.forEach(w=>g.append("locations",w)),d&&d.forEach(w=>g.append("sites",w));const k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await fetch(`/api/dashboard/client-margin-treemap?${g.toString()}`,{headers:k});if(y.ok){const w=await y.json();ls(w)}}catch(g){console.error("Error fetching treemap:",g)}})()},[t,p,s,c,d]);const[cs,ds]=m.useState([]);m.useEffect(()=>{if(t!=="overheads"||p!=="trend")return;(async()=>{try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd")});c&&c.forEach(w=>g.append("locations",w)),d&&d.forEach(w=>g.append("sites",w));const k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await fetch(`/api/dashboard/overheads-pareto?${g.toString()}`,{headers:k});if(y.ok){const w=await y.json();ds(w)}}catch(g){console.error("Error fetching pareto:",g)}})()},[t,p,s,c,d]);const[hs,ye]=m.useState(!1),[us,tt]=m.useState(null),[be,Oe]=m.useState(null),Ne=["revenue","cost","profit","employees","clientRate","staffRate","overheads"].includes(t||""),Le=["shifts","hours","clients","targetAchievement","missedTargets"].includes(t||""),st=t==="overheads",Ie=n==="admin",{operationalData:G,isLoading:ms}=Gs(s,c,d),{financialData:q,isLoading:fs}=Qs(s,c,d),xs=Ne?fs:Le?ms:!1;m.useEffect(()=>{if(t!=="missedTargets")return;(async()=>{try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd")}),k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await fetch(`${ce.TARGETS_PERFORMANCE}?${g.toString()}`,{headers:k});if(y.ok){const w=await y.json();P(w)}}catch(g){console.error("Error fetching targets performance:",g)}})()},[s,t]),m.useEffect(()=>{if(p==="trend"||!t)return;(async()=>{_(!0);try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd"),metric:t,limit:"20"});c&&c.length>0&&c.forEach(y=>g.append("locations",y)),d&&d.length>0&&d.forEach(y=>g.append("sites",y));const k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(p==="details"&&st){const y=await fetch(`${ce.FINANCIAL_METRICS_LIST}?${g.toString()}`,{headers:k});if(y.ok){const w=await y.json();v(w)}}else if(["location","site","client"].includes(p)){g.append("dimension",p);const y=await fetch(`${ce.BREAKDOWN}?${g.toString()}`,{headers:k});if(y.ok){const w=await y.json();N(w)}}}catch(g){console.error("Error fetching breakdown:",g)}finally{_(!1)}})()},[p,t,s,c,d]),m.useEffect(()=>{t==="clients"&&p==="revenueTier"&&Ie&&(async()=>{try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd")});c&&c.length>0&&c.forEach(w=>g.append("locations",w)),d&&d.length>0&&d.forEach(w=>g.append("sites",w));const k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await fetch(`/api/dashboard/client-revenue-tiers?${g.toString()}`,{headers:k});if(y.ok){const R=(await y.json()).tiers.map(ue=>({name:ue.tier,value:ue.totalRevenue,clientCount:ue.clientCount,avgRevenue:ue.avgRevenue,clients:ue.clients||[]}));E(R)}}catch(g){console.error("Error fetching revenue tiers:",g)}})()},[t,p,Ie,s,c,d]),m.useEffect(()=>{p==="trend"&&(async()=>{try{const g=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd")});c&&c.length>0&&c.forEach(R=>g.append("locations",R)),d&&d.length>0&&d.forEach(R=>g.append("sites",R));const k={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await fetch(`/api/dashboard/client-workload-scatter?${g.toString()}`,{headers:k});if(!y.ok){console.error(`❌ Workload scatter API failed (${y.status}): /api/dashboard/client-workload-scatter`);const R=await y.text();console.error("Response preview:",R.substring(0,200));return}const w=await y.json();K(w.data||[]),U(w.medians||{hours:0,staffCount:0})}catch(g){console.error("Error fetching workload data:",g)}})()},[p,s,c,d]);const gs=()=>{tt(null),ye(!0)},ps=S=>{tt(S),ye(!0)},vs=async()=>{if(be)try{const S=await fetch(`/api/admin/financial-metrics/${be}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(S.ok)te.success("Overhead deleted"),p==="details"&&v(g=>g.filter(k=>k.id!==be));else{const g=await S.json();te.error(g.error||"Failed to delete")}}catch(S){console.error(S),te.error("Failed to delete")}finally{Oe(null)}},js=async S=>{try{const g=await fetch("/api/admin/financial-metrics",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(S)});if(g.ok){te.success("Overhead saved"),ye(!1);const k=new URLSearchParams({start:$(s.from,"yyyy-MM-dd"),end:$(s.to,"yyyy-MM-dd"),metric:t||"overheads",limit:"20"});c&&c.forEach(R=>k.append("locations",R)),d&&d.forEach(R=>k.append("sites",R));const y={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},w=await fetch(`${ce.FINANCIAL_METRICS_LIST}?${k.toString()}`,{headers:y});if(w.ok){const R=await w.json();v(R)}}else{const k=await g.json();te.error(k.error||"Failed to save")}}catch(g){console.error(g),te.error("Failed to save")}},ys=S=>{switch(S){case"revenue":return"Revenue Analysis";case"cost":return"Cost Analysis";case"profit":return"Profit Analysis";case"shifts":return"Shifts Analysis";case"hours":return"Hours Analysis";case"clients":return"Client Analysis";case"employees":return"Employee Analysis";case"targetAchievement":return"Target Achievement Analysis";case"missedTargets":return"Missed Targets Analysis";case"clientRate":return"Client Rate Analysis";case"staffRate":return"Staff Rate Analysis";case"overheads":return"Overheads Analysis";default:return"Metric Analysis"}},bs=m.useMemo(()=>{if(!I||I.length===0)return[];const S=I.reduce((g,k)=>{const y=k.name||"Unknown";return g[y]||(g[y]=0),g[y]+=k.value,g},{});return Object.entries(S).map(([g,k])=>({name:g,value:k}))},[I]);return Ne?q==null||q.timeSeries:G==null||G.timeSeries,e.jsx(Us,{fullWidth:!0,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(zs,{dateRange:s,onDateRangeChange:r,calendarOpen:i,onCalendarOpenChange:l,tempDateRange:o,onTempDateRangeChange:h,selectedLocations:c,onLocationsChange:u,selectedSites:d,onSitesChange:x}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 space-y-6 relative",children:[(xs||f)&&e.jsx(Js,{}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ae,{variant:"ghost",size:"sm",onClick:()=>a(-1),className:"gap-2",children:[e.jsx(Ga,{className:"h-4 w-4"}),"Back"]}),e.jsx("h1",{className:"text-2xl font-bold",children:ys(t)})]}),e.jsxs(et,{value:p,onValueChange:T,className:"space-y-4",children:[e.jsxs(Me,{children:[e.jsx(H,{value:"trend",children:"Trend"}),e.jsx(H,{value:"location",children:"By Location"}),e.jsx(H,{value:"site",children:"By Site"}),t!=="clients"&&t!=="targetAchievement"&&e.jsx(H,{value:"client",children:"By Clients"}),t==="clients"&&Ie&&e.jsx(H,{value:"revenueTier",children:"By Revenue Tier"}),st&&e.jsx(H,{value:"details",children:"All Details"})]}),e.jsx(Y,{value:"trend",className:"space-y-4",children:e.jsxs("div",{className:"grid gap-6",children:[t==="clients"&&e.jsx(ml,{data:M,medianHours:ee.hours,medianStaff:ee.staffCount}),t==="shifts"&&e.jsx(fl,{dateRange:s,locations:c,sites:d}),Ne&&t!=="revenue"&&t!=="cost"&&t!=="overheads"&&e.jsx(Xs,{data:(q==null?void 0:q.timeSeries)||[],aggregationLevel:(q==null?void 0:q.aggregationLevel)||"monthly",selectedMetric:t}),t==="revenue"&&e.jsx(Nt,{data:oe,title:"Revenue Composition (Margin Color-Coded)"}),t==="cost"&&e.jsx(Nt,{data:oe,title:"Cost Composition (Margin Color-Coded)"}),t==="overheads"&&e.jsx(wl,{data:cs}),Le&&t!=="missedTargets"&&t!=="shifts"&&t!=="hours"&&t!=="targetAchievement"&&e.jsx(qs,{data:(G==null?void 0:G.timeSeries)||[],aggregationLevel:(G==null?void 0:G.aggregationLevel)||"monthly",selectedMetric:t}),t==="hours"&&e.jsx(pl,{dateRange:s}),t==="targetAchievement"&&e.jsx(yl,{dateRange:s,dimension:"client"}),t==="missedTargets"&&e.jsx(Ys,{data:D}),!Ne&&!Le&&e.jsx(F,{children:e.jsx(B,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Metric type not recognized or data unavailable."})})})]})}),e.jsx(Y,{value:"location",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:j,metric:t||"revenue"}),e.jsx(Se,{data:j,metric:t||"revenue"})]})}),e.jsx(Y,{value:"site",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:j,metric:t||"revenue"}),e.jsx(Se,{data:j,metric:t||"revenue"})]})}),e.jsx(Y,{value:"client",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(Ke,{data:j,metric:t||"revenue"}),e.jsx(Se,{data:j,metric:t||"revenue"})]})}),e.jsx(Y,{value:"revenueTier",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(hl,{data:b}),e.jsxs(F,{children:[e.jsx(X,{children:e.jsx(Z,{children:"Tier Breakdown"})}),e.jsx(B,{children:e.jsxs(Rt,{children:[e.jsx(Ft,{children:e.jsxs(Ae,{children:[e.jsx(z,{children:"Tier"}),e.jsx(z,{className:"text-right",children:"Clients"}),e.jsx(z,{className:"text-right",children:"Total Revenue"}),e.jsx(z,{className:"text-right",children:"Avg Revenue/Client"})]})}),e.jsx(Bt,{children:b.map(S=>e.jsxs(Ae,{children:[e.jsx(V,{className:"font-medium",children:S.name}),e.jsx(V,{className:"text-right",children:S.clientCount}),e.jsxs(V,{className:"text-right",children:["£",S.value.toLocaleString()]}),e.jsxs(V,{className:"text-right",children:["£",S.avgRevenue.toLocaleString()]})]},S.name))})]})})]})]})}),e.jsx(Y,{value:"details",children:e.jsxs("div",{className:"grid gap-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(Se,{data:bs,metric:"overheads"})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(ae,{onClick:gs,className:"gap-2",children:[e.jsx(Va,{className:"h-4 w-4"}),"Add Overhead"]})}),e.jsx(ll,{data:I,onEdit:ps,onDelete:Oe}),e.jsx(Sl,{open:hs,onOpenChange:ye,initialData:us,onSave:js}),e.jsx(Ls,{open:!!be,onOpenChange:S=>!S&&Oe(null),children:e.jsxs(Is,{children:[e.jsxs(Ds,{children:[e.jsx(Ps,{children:"Are you sure?"}),e.jsx(Rs,{children:"This will permanently delete this overhead record."})]}),e.jsxs(Fs,{children:[e.jsx(Bs,{children:"Cancel"}),e.jsx(Ks,{onClick:vs,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})})]})]})]})})};export{Jl as default};
