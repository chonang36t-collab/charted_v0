const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MetricPalette-B3M_1y-6.js","assets/index-Cv9_qDm_.js","assets/index-zDCRN-hR.css","assets/card-DJHMYo0A.js","assets/useQuery-BWRrcYqm.js","assets/pound-sterling-CvJVBilE.js","assets/users-DGFWB_3Z.js","assets/locationUtils-CKuqvlJY.js","assets/popover-BPemakDr.js","assets/DashboardLayout-CAtP4L-K.js","assets/ChartCanvas-BxFJYMT8.js","assets/badge-B2sFbsr4.js","assets/table-DrWK3iQK.js","assets/generateCategoricalChart-D862MtZE.js","assets/BarChart-NZNJUYHh.js","assets/Line-D3St5UBB.js","assets/AreaChart-Bs7Q7zTI.js"])))=>i.map(i=>d[i]);
import{r as l,j as e,P as me,d as P,B as M,X as he,T as pe,n as fe,o as xe,p as ue,a as ge,v as je,_ as Z}from"./index-Cv9_qDm_.js";import{D as ye}from"./DashboardLayout-CAtP4L-K.js";import{L as G}from"./label-hKazdECY.js";import{S as Se,a as ve,b as Ce,c as Ne,d as R}from"./select-Ci-QEqMp.js";import{P as V,a as J,b as U,f as _}from"./popover-BPemakDr.js";import{g as H,c as we,C as W,a as X}from"./locationUtils-CKuqvlJY.js";import{C as be,a as De,b as Te,c as Ae,d as Me,e as Ee}from"./command-Ok1ypy_E.js";import{C as Le,a as Be,b as Oe,d as ke}from"./card-DJHMYo0A.js";import{C as Ie}from"./index-DG7nKocR.js";import{S as K}from"./switch-BsMLsASx.js";import"./users-DGFWB_3Z.js";import"./dialog-G0OLpRcH.js";const Re=()=>{const[s,i]=l.useState(()=>{const o=localStorage.getItem("chartBuilderState"),r={dimensions:[],metrics:[],chartType:"bar",dateRange:{from:void 0,to:void 0},customMetrics:[],chartData:[],draggedItem:void 0};if(o)try{const c=JSON.parse(o);return{...r,dimensions:c.dimensions||[],metrics:c.metrics||[],chartType:c.chartType||"bar"}}catch(c){console.error("Error parsing saved chart builder state",c)}return r});return l.useEffect(()=>{const{dimensions:o,metrics:r,chartType:c}=s;localStorage.setItem("chartBuilderState",JSON.stringify({dimensions:o,metrics:r,chartType:c}))},[s.dimensions,s.metrics,s.chartType]),{state:s,setDimensions:o=>{i(r=>({...r,dimensions:o}))},setMetrics:o=>{i(r=>({...r,metrics:o}))},setChartType:o=>{i(r=>({...r,chartType:o}))},setDateRange:o=>{i(r=>({...r,dateRange:o}))},addCustomMetric:o=>{i(r=>({...r,customMetrics:[...r.customMetrics,o]}))},setChartData:o=>{i(r=>({...r,chartData:o}))},setDraggedItem:o=>{i(r=>({...r,draggedItem:o}))}}};var _e="Separator",Q="horizontal",Pe=["horizontal","vertical"],ee=l.forwardRef((s,i)=>{const{decorative:d,orientation:x=Q,...S}=s,p=ze(x)?x:Q,j=d?{role:"none"}:{"aria-orientation":p==="vertical"?p:void 0,role:"separator"};return e.jsx(me.div,{"data-orientation":p,...j,...S,ref:i})});ee.displayName=_e;function ze(s){return Pe.includes(s)}var te=ee;const se=l.forwardRef(({className:s,orientation:i="horizontal",decorative:d=!0,...x},S)=>e.jsx(te,{ref:S,decorative:d,orientation:i,className:P("shrink-0 bg-border",i==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...x}));se.displayName=te.displayName;function A({title:s,options:i,selected:d,onChange:x,placeholder:S="Select...",isLocation:p=!1}){const[a,j]=l.useState(!1),m=r=>{d.includes(r)?x(d.filter(c=>c!==r)):x([...d,r])},o=r=>{r.stopPropagation(),x([])};return e.jsxs("div",{className:"flex flex-col gap-1.5 min-w-[180px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:s}),e.jsxs(V,{open:a,onOpenChange:j,children:[e.jsx(J,{asChild:!0,children:e.jsxs(M,{variant:"outline",role:"combobox","aria-expanded":a,className:"w-full justify-between h-9 px-3 text-sm",children:[e.jsxs("div",{className:"flex flex-wrap gap-1 items-center overflow-hidden",children:[d.length===0&&e.jsx("span",{className:"text-muted-foreground font-normal truncate",children:S}),d.length===1&&e.jsx("span",{className:"truncate",children:p?H(d[0]):d[0]}),d.length>1&&e.jsxs("span",{className:"truncate",children:[d.length," selected"]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 opacity-50 ml-2",children:[d.length>0&&e.jsx(he,{className:"h-3 w-3 cursor-pointer hover:opacity-100",onClick:o}),e.jsx(be,{className:"h-3 w-3"})]})]})}),e.jsx(U,{className:"w-[200px] p-0",align:"start",children:e.jsxs(De,{children:[e.jsx(Te,{placeholder:`Search ${s.toLowerCase()}...`}),e.jsxs(Ae,{children:["No ",s.toLowerCase()," found."]}),e.jsx(Me,{className:"max-h-64 overflow-auto",children:i.map(r=>e.jsxs(Ee,{value:r,onSelect:()=>m(r),children:[e.jsx(Ie,{className:P("mr-2 h-4 w-4",d.includes(r)?"opacity-100":"opacity-0")}),p?e.jsx(pe,{delayDuration:300,children:e.jsxs(fe,{children:[e.jsx(xe,{asChild:!0,children:e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-medium",children:H(r)}),e.jsx("span",{className:"text-[10px] text-muted-foreground truncate opacity-70",children:r})]})}),e.jsx(ue,{side:"right",children:e.jsx("p",{children:r})})]})}):r]},r))})]})})]})]})}function $e({availableFilters:s,filters:i,onFilterChange:d,orientation:x="vertical",hideSites:S=!1}){l.useMemo(()=>{if(i.locations.length===0)return s.clients;const o=s.locations.filter(c=>i.locations.includes(c.name)),r=new Set;return o.forEach(c=>{c.clients&&c.clients.forEach(D=>r.add(D))}),Array.from(r).sort()},[s,i.locations]);const p=l.useMemo(()=>{if(i.locations.length===0)return Array.from(new Set(s.locations.flatMap(c=>c.sites))).sort();const o=s.locations.filter(c=>i.locations.includes(c.name)),r=new Set;return o.forEach(c=>{c.sites.forEach(D=>r.add(D))}),Array.from(r).sort()},[s.locations,i.locations]),a=o=>{const r=s.locations.filter(f=>o.includes(f.name)),c=o.length===0?s.clients:Array.from(new Set(r.flatMap(f=>f.clients||[]))),D=o.length===0?Array.from(new Set(s.locations.flatMap(f=>f.sites))):Array.from(new Set(r.flatMap(f=>f.sites)));d({...i,locations:o,clients:i.clients.filter(f=>c.includes(f)),sites:i.sites.filter(f=>D.includes(f))})},j=o=>{d({...i,clients:o})},m=o=>{d({...i,sites:o})};return x==="horizontal"?e.jsxs("div",{className:"flex flex-wrap items-end gap-4 p-1",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground mr-2 pb-2",children:e.jsx("span",{children:"ðŸŒªï¸ Filters:"})}),e.jsx(A,{title:"Clients",options:s.clients,selected:i.clients,onChange:j,placeholder:"All Clients"}),e.jsx(A,{title:"Locations",options:s.locations.map(o=>o.name),selected:i.locations,onChange:a,placeholder:"All Locations",isLocation:!0}),!S&&e.jsx(A,{title:"Sites",options:p,selected:i.sites,onChange:m,placeholder:"All Sites"})]}):e.jsxs(Le,{className:"h-full flex flex-col",children:[e.jsx(Be,{className:"pb-3",children:e.jsx(Oe,{className:"text-lg flex items-center gap-2",children:"ðŸŒªï¸ Filters"})}),e.jsxs(ke,{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsx(A,{title:"Clients",options:s.clients,selected:i.clients,onChange:j,placeholder:"All Clients"}),e.jsx(se,{}),e.jsx(A,{title:"Locations",options:s.locations.map(o=>o.name),selected:i.locations,onChange:a,placeholder:"All Locations",isLocation:!0}),e.jsx(A,{title:"Sites",options:p,selected:i.sites,onChange:m,placeholder:"All Sites"})]})]})}const Ve=l.lazy(()=>Z(()=>import("./MetricPalette-B3M_1y-6.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),B=l.lazy(()=>Z(()=>import("./ChartCanvas-BxFJYMT8.js"),__vite__mapDeps([10,1,2,11,12,13,14,15,16])));function et(){const{state:s,setDimensions:i,setMetrics:d,setChartType:x,setDateRange:S}=Re(),{toast:p}=ge(),[a,j]=l.useState(()=>{const t=localStorage.getItem("chartBuilderDate");if(t)try{const n=JSON.parse(t);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return{from:new Date,to:we(new Date,30)}}),[m,o]=l.useState(()=>{const t=localStorage.getItem("chartBuilderAppliedDate");if(t)try{const n=JSON.parse(t);return{from:n.from?new Date(n.from):void 0,to:n.to?new Date(n.to):void 0}}catch(n){console.error(n)}return a});l.useEffect(()=>{a&&localStorage.setItem("chartBuilderDate",JSON.stringify(a))},[a]),l.useEffect(()=>{m&&localStorage.setItem("chartBuilderAppliedDate",JSON.stringify(m))},[m]);const[r,c]=l.useState(!1),[D,f]=l.useState(!1),[N,Y]=l.useState(()=>localStorage.getItem("chartBuilderSplitByLocation")==="true"),[v,z]=l.useState(()=>localStorage.getItem("chartBuilderSplitBySite")==="true"&&!N);l.useEffect(()=>{localStorage.setItem("chartBuilderSplitByLocation",String(N))},[N]),l.useEffect(()=>{localStorage.setItem("chartBuilderSplitBySite",String(v))},[v]);const[O,ae]=l.useState({clients:[],locations:[]}),[u,re]=l.useState({clients:[],locations:[],sites:[]});l.useEffect(()=>{(async()=>{try{const n=await fetch("/api/filters",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(n.ok){const h=await n.json();ae(h)}}catch(n){console.error("Error fetching filters:",n)}})()},[]);const ne=()=>{o(a)},[T,F]=l.useState("chart"),[C,E]=l.useState([]),[oe,k]=l.useState([]),L=t=>{E(n=>{const h=[...n];return t.forEach(w=>{const I=h.findIndex(b=>b.name===w.name&&(b.location===w.location||!b.location&&!w.location)&&(b.site===w.site||!b.site&&!w.site));I!==-1&&(h[I]=w)}),h})};l.useEffect(()=>{(async()=>{var b;if(s.dimensions.length===0||s.metrics.length===0||!(m!=null&&m.from)||!(m!=null&&m.to)){E([]),k([]);return}const n=s.dimensions[0],h=s.metrics,w=_(m.from,"yyyy-MM-dd"),I=_(m.to,"yyyy-MM-dd");try{const g=new URLSearchParams;g.append("start",w),g.append("end",I),g.append("dimension",n),h.forEach(y=>g.append("metrics",y)),u.clients.forEach(y=>g.append("clients",y)),u.locations.forEach(y=>g.append("locations",y)),u.sites.forEach(y=>g.append("sites",y)),N&&g.append("split_by_location","true"),v&&g.append("split_by_site","true");const q=await fetch(`/api/chart-data?${g.toString()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`},credentials:"include"});if(q.ok){const y=await q.json();E(y.data||[]),k(((b=y.summary)==null?void 0:b.topClients)||[])}else console.error("Failed to fetch chart data"),E([]),k([])}catch(g){console.error("Error fetching chart data:",g),E([]),k([])}})()},[s.dimensions,s.metrics,m,u,N,v]);const{showSiteFilter:ie,showSiteSplit:$}=l.useMemo(()=>{const t=u.locations.length===0?O.locations.flatMap(h=>h.sites):O.locations.filter(h=>u.locations.includes(h.name)).flatMap(h=>h.sites),n=Array.from(new Set(t));return{showSiteFilter:n.length>1,showSiteSplit:n.length>1}},[O.locations,u.locations]);l.useEffect(()=>{!$&&v&&z(!1)},[$,v]);const le=t=>{t.type==="dimension"?s.dimensions.includes(t.name)?(i([]),p({description:`Removed ${t.name} from chart`,duration:2e3})):(i([t.name]),p({description:`Added ${t.name} to chart`,duration:2e3})):t.type==="metric"&&(s.metrics.includes(t.name)?(d(s.metrics.filter(n=>n!==t.name)),p({description:`Removed ${t.name} from chart`,duration:2e3})):(d([...s.metrics,t.name]),p({description:`Added ${t.name} to chart`,duration:2e3})))},ce=t=>{i(s.dimensions.filter(n=>n!==t))},de=t=>{d(s.metrics.filter(n=>n!==t))};return e.jsx(ye,{noPadding:!0,fullWidth:!0,children:e.jsx("div",{className:"p-2 md:p-3 h-full flex flex-col",children:e.jsxs("div",{className:"space-y-4 h-full flex flex-col",children:[e.jsx("div",{className:"sticky lg:top-0 z-30 pb-2 border-b -mx-4 md:-mx-6 px-4 md:px-6 pt-1 shadow-sm bg-background",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-xl font-bold",children:"Chart Builder"})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"flex items-center bg-muted rounded-lg p-0.5 border mr-2",children:[e.jsx(M,{variant:T==="chart"?"secondary":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>F("chart"),children:"Chart"}),e.jsx(M,{variant:T==="table"?"secondary":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>F("table"),children:"Table"})]}),e.jsx("div",{className:"w-32",children:e.jsxs(Se,{value:s.chartType,onValueChange:x,children:[e.jsx(ve,{className:"h-8 text-xs",children:e.jsx(Ce,{placeholder:"Chart Type"})}),e.jsxs(Ne,{children:[e.jsx(R,{value:"bar",children:"Bar Chart"}),e.jsx(R,{value:"line",children:"Line Chart"}),e.jsx(R,{value:"area",children:"Area Chart"}),e.jsx(R,{value:"pie",children:"Pie Chart"})]})]})}),e.jsxs("div",{className:"flex items-center gap-6 px-2 border-l ml-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{id:"split-location",checked:N,onCheckedChange:t=>{Y(t),t&&z(!1)}}),e.jsx(G,{htmlFor:"split-location",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Location"})]}),$&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{id:"split-site",checked:v,onCheckedChange:t=>{z(t),t&&Y(!1)}}),e.jsx(G,{htmlFor:"split-site",className:"text-xs font-medium cursor-pointer flex items-center gap-1.5",children:"Split by Site"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{open:r,onOpenChange:c,children:[e.jsx(J,{asChild:!0,children:e.jsxs(M,{variant:"outline",className:P("w-32 justify-start text-left font-normal h-8 text-xs",!(a!=null&&a.from)&&"text-muted-foreground"),children:[e.jsx(W,{className:"mr-2 h-3 w-3"}),a!=null&&a.from?_(a.from,"MMM dd, y"):e.jsx("span",{children:"From"})]})}),e.jsx(U,{className:"w-auto p-0",align:"start",children:e.jsx(X,{mode:"single",selected:a==null?void 0:a.from,onSelect:t=>{j(n=>({...n,from:t})),c(!1)},defaultMonth:a==null?void 0:a.from,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsxs(V,{open:D,onOpenChange:f,children:[e.jsx(J,{asChild:!0,children:e.jsxs(M,{variant:"outline",className:P("w-32 justify-start text-left font-normal h-8 text-xs",!(a!=null&&a.to)&&"text-muted-foreground"),children:[e.jsx(W,{className:"mr-2 h-3 w-3"}),a!=null&&a.to?_(a.to,"MMM dd, y"):e.jsx("span",{children:"To"})]})}),e.jsx(U,{className:"w-auto p-0",align:"start",children:e.jsx(X,{mode:"single",selected:a==null?void 0:a.to,onSelect:t=>{j(n=>({...n,to:t})),f(!1)},defaultMonth:a==null?void 0:a.to,captionLayout:"dropdown-buttons",fromYear:2020,toYear:2030})})]}),e.jsx(M,{onClick:ne,className:"h-8 text-xs px-4",disabled:!(a!=null&&a.from)||!(a!=null&&a.to),children:"Apply Range"})]})]})]})}),e.jsx(l.Suspense,{fallback:e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(je,{className:"h-8 w-8 rounded-full"})}),children:e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row gap-2 min-h-0 h-full",children:[e.jsx("div",{className:"lg:w-72 shrink-0 h-full flex flex-col overflow-hidden",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2",children:e.jsx(Ve,{selectedDimensions:s.dimensions,selectedMetrics:s.metrics,onItemClick:le})})}),e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"shrink-0 pb-2 border-b mb-2",children:e.jsx($e,{availableFilters:O,filters:u,onFilterChange:re,orientation:"horizontal",hideSites:!ie})}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto pr-2 custom-scrollbar",children:[!N&&!v&&e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 h-full min-h-[500px]",children:e.jsx(B,{chartData:C,chartType:s.chartType,dimensions:s.dimensions,metrics:s.metrics,onRemoveDimension:ce,onRemoveMetric:de,title:"Aggregated View",topClients:oe,viewMode:T,onDataChange:L})}),N&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[u.locations.length>0?u.locations.map(t=>{const n=C.filter(h=>h.location===t);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(B,{chartData:n,chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:T,onDataChange:L})},t)}):Array.from(new Set(C.map(t=>t.location).filter(Boolean))).map(t=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(B,{chartData:C.filter(n=>n.location===t),chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:T,onDataChange:L})},t)),C.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected locations"})]}),v&&e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[u.sites.length>0?u.sites.map(t=>{const n=C.filter(h=>h.site===t);return n.length===0?null:e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(B,{chartData:n,chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:T,onDataChange:L})},t)}):Array.from(new Set(C.map(t=>t.site).filter(Boolean))).map(t=>e.jsx("div",{className:"bg-card rounded-xl border shadow-sm p-4 min-h-[400px]",children:e.jsx(B,{chartData:C.filter(n=>n.site===t),chartType:s.chartType,metrics:s.metrics,title:t,isCompact:!0,viewMode:T,onDataChange:L})},t)),C.length===0&&e.jsx("div",{className:"col-span-full h-64 flex items-center justify-center text-muted-foreground bg-muted/20 rounded-xl border border-dashed",children:"No data available for selected sites"})]})]})]})]})})]})})})}export{et as default};
